# MLM ì‹œìŠ¤í…œ ì„¤ê³„ ë¬¸ì„œ v5.0

**ë²„ì „**: 5.0
**ì‘ì„±ì¼**: 2025ë…„ 10ì›” 11ì¼
**ê¸°ì¤€ ìš”êµ¬ì‚¬í•­**: ì‹œìŠ¤í…œ_ìš”êµ¬ì‚¬í•­_ê²€í† ë¬¸ì„œ v3.0

**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v5.0)**:
- ìŠ¹ê¸‰ ì‹œ ê¸°ì¡´ ì§€ê¸‰ ë³‘í–‰ ì²˜ë¦¬ (ê¸°ì¡´ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ)
- ì¶”ê°€ ì§€ê¸‰ê¸°ê°„ ê°œë… ë„ì… (ë“±ê¸‰ë³„ ìµœëŒ€ ìˆ˜ë ¹ íšŸìˆ˜)
- ì£¼ì°¨ë³„ ì§€ê¸‰ ì´ê³„ ì»¬ë ‰ì…˜ ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
- ì¦ë¶„ ì—…ë°ì´íŠ¸ ì „ëµ (ì „ì²´ ì¬ê³„ì‚° ë¶ˆí•„ìš”)

---

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#2-ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
3. [ì§€ê¸‰ ê³„íš ì²˜ë¦¬ ë°©ì•ˆ](#3-ì§€ê¸‰-ê³„íš-ì²˜ë¦¬-ë°©ì•ˆ)
4. [ìë™í™” í”„ë¡œì„¸ìŠ¤](#4-ìë™í™”-í”„ë¡œì„¸ìŠ¤)
5. [ì›¹ API ì„¤ê³„](#5-ì›¹-api-ì„¤ê³„)
6. [ë°ì´í„° íë¦„ë„](#6-ë°ì´í„°-íë¦„ë„)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 í•µì‹¬ ì›ì¹™

**v3.0 ìš”êµ¬ì‚¬í•­ ê¸°ë°˜ ì„¤ê³„ ì›ì¹™**:

1. **ë³‘í–‰ ì§€ê¸‰**: ìŠ¹ê¸‰ ì‹œ ê¸°ì¡´ ì§€ê¸‰ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  ìƒˆ ì§€ê¸‰ ì¶”ê°€
2. **ì¶”ê°€ ì§€ê¸‰ê¸°ê°„**: 10íšŒ ì™„ë£Œ í›„ ë“±ê¸‰ë³„ ìµœëŒ€ íšŸìˆ˜ê¹Œì§€ ì¶”ê°€ ì§€ê¸‰
3. **ì¦ë¶„ ì—…ë°ì´íŠ¸**: ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ ì²˜ë¦¬ (ì „ì²´ ì¬ê³„ì‚° ë¶ˆí•„ìš”)
4. **ë¯¸ë˜ ì˜ˆì¸¡**: ìš©ì—­ì ë“±ë¡ ì‹œ ì „ì²´ ì§€ê¸‰ ê³„íš ì‚¬ì „ ìƒì„±
5. **ì£¼ê°„ ì§‘ê³„**: ê¸ˆìš”ì¼ë§ˆë‹¤ ìë™ ì§€ê¸‰ ì²˜ë¦¬ ë° í†µê³„ ì—…ë°ì´íŠ¸

### 1.2 ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
[ìš©ì—­ì ë“±ë¡]
    â†“
[íŠ¸ë¦¬/ë“±ê¸‰ ì¬ê³„ì‚°] â† ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ
    â†“
[ì§€ê¸‰ê³„íš ìƒì„±/ê°±ì‹ ]
    â†“
[ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸] â† ë¯¸ë˜ ì˜ˆì¸¡
    â†“
[ë§¤ì£¼ ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰]
    â†“
[í†µê³„ ì¦ë¶„ ì—…ë°ì´íŠ¸]
```

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 2.1 ì»¬ë ‰ì…˜ ê°œìš”

ì „ì²´ **4ê°œ í•µì‹¬ ì»¬ë ‰ì…˜** êµ¬ì„±:

| ì»¬ë ‰ì…˜ëª… | ëª©ì  | ì—…ë°ì´íŠ¸ ì‹œì  | ì¡°íšŒ ë¹ˆë„ |
|---------|------|--------------|----------|
| **monthlyRegistrations** | ì›”ë³„ ë“±ë¡/ë§¤ì¶œ ê´€ë¦¬ | ìš©ì—­ì ë“±ë¡ ì‹œ | ë‚®ìŒ |
| **monthlyTreeSnapshots** | ì›”ë³„ ê³„ì¸µë„/ë“±ê¸‰ í™•ì • | ë“±ë¡ ì‹œ + ì›”ë§ | ì¤‘ê°„ |
| **weeklyPaymentPlans** | ê°œë³„ ì§€ê¸‰ ê³„íš | ë“±ë¡/ìŠ¹ê¸‰ ì‹œ | ë†’ìŒ |
| **weeklyPaymentSummary** | ì£¼ì°¨ë³„ ì´ê³„ (í†µê³„) | ë“±ë¡/ì§€ê¸‰ ì‹œ | ë§¤ìš° ë†’ìŒ |

---

### 2.2 ì»¬ë ‰ì…˜ ìƒì„¸ ì„¤ê³„

#### 2.2.1 monthlyRegistrations (ì›”ë³„ ë“±ë¡ ê´€ë¦¬)

**ëª©ì **: ë§¤ì›” ìš©ì—­ì ë“±ë¡ ë° ë§¤ì¶œ ê´€ë¦¬

```javascript
{
  _id: ObjectId,
  monthKey: String,              // "2025-10" (YYYY-MM)

  // ë“±ë¡ ì •ë³´
  registrationCount: Number,     // í•´ë‹¹ ì›” ë“±ë¡ ì¸ì›
  totalRevenue: Number,          // ì´ë§¤ì¶œ (ì¸ì› Ã— 100ë§Œì›)
  adjustedRevenue: Number,       // ê´€ë¦¬ì ìˆ˜ë™ ì¡°ì • ê¸ˆì•¡ (nullì´ë©´ ìë™)

  // ë“±ë¡ì ëª©ë¡
  registrations: [{
    userId: String,
    userName: String,
    registrationDate: Date,      // ì‹¤ì œ ë“±ë¡ì¼
    sponsorId: String,           // í›„ì›ì
    grade: String,               // ë“±ë¡ ì‹œì  ë“±ê¸‰
    position: String             // 'left' | 'right' | 'root'
  }],

  // ë“±ê¸‰ë³„ ë¶„í¬ (ì›”ë§ ê¸°ì¤€)
  gradeDistribution: {
    F1: Number,
    F2: Number,
    F3: Number,
    F4: Number,
    F5: Number,
    F6: Number,
    F7: Number,
    F8: Number
  },

  // ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ (í•´ë‹¹ ì›” ë§¤ì¶œ ê¸°ì¤€)
  gradePayments: {
    F1: Number,  // ì˜ˆ: 40,000
    F2: Number,  // ì˜ˆ: 175,714
    F3: Number,  // ì˜ˆ: 409,047
    F4: Number,
    F5: Number,
    F6: Number,
    F7: Number,
    F8: Number
  },

  createdAt: Date,
  updatedAt: Date
}

// ì¸ë±ìŠ¤
monthlyRegistrations.createIndex({ monthKey: 1 }, { unique: true })
monthlyRegistrations.createIndex({ 'registrations.userId': 1 })
```

**ìš©ë„**:
- ì›”ë³„ ë§¤ì¶œ ê³„ì‚°
- ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ì‚°ì •
- ê´€ë¦¬ì ìˆ˜ë™ ë§¤ì¶œ ì¡°ì •

---

#### 2.2.2 monthlyTreeSnapshots (ì›”ë³„ ê³„ì¸µë„ ìŠ¤ëƒ…ìƒ·)

**ëª©ì **: ì›”ë³„ ê³„ì¸µë„ ë° ë“±ê¸‰ í™•ì •

```javascript
{
  _id: ObjectId,
  monthKey: String,              // "2025-10"
  snapshotDate: Date,            // ìŠ¤ëƒ…ìƒ· ìƒì„± ì¼ì‹œ
  totalUsers: Number,            // ì „ì²´ ìš©ì—­ì ìˆ˜

  // ì‚¬ìš©ì ìŠ¤ëƒ…ìƒ·
  users: [{
    userId: String,
    userName: String,
    grade: String,               // í•´ë‹¹ ì›” í™•ì • ë“±ê¸‰
    registrationDate: Date,

    // íŠ¸ë¦¬ êµ¬ì¡°
    sponsorId: String,
    leftChildId: String,
    rightChildId: String,
    leftSubtreeCount: Number,
    rightSubtreeCount: Number,
    depth: Number,
    position: String,            // 'left' | 'right' | 'root'

    // ë³´í—˜ ì¡°ê±´ (F3 ì´ìƒ)
    insuranceRequired: Boolean,
    insuranceAmount: Number,
    insuranceMaintained: Boolean, // ë³´í—˜ ìœ ì§€ ì—¬ë¶€

    // í™œì„± ì§€ê¸‰ ê³„íš ì •ë³´
    activePaymentPlans: [{
      planId: ObjectId,
      planType: String,          // 'initial' | 'promotion' | 'additional'
      baseGrade: String,
      startMonth: String,        // ì§€ê¸‰ ì‹œì‘ ì›”
      currentInstallment: Number,
      totalInstallments: Number,
      status: String             // 'active' | 'completed'
    }]
  }],

  // í†µê³„
  gradeDistribution: {
    F1: Number,
    F2: Number,
    F3: Number,
    F4: Number,
    F5: Number,
    F6: Number,
    F7: Number,
    F8: Number
  },

  createdAt: Date
}

// ì¸ë±ìŠ¤
monthlyTreeSnapshots.createIndex({ monthKey: 1 }, { unique: true })
monthlyTreeSnapshots.createIndex({ 'users.userId': 1 })
monthlyTreeSnapshots.createIndex({ 'users.grade': 1 })
```

**ìš©ë„**:
- ì§€ê¸‰ ì‹œ ë“±ê¸‰ ì°¸ì¡° (ì›”ë§ ê¸°ì¤€ ë“±ê¸‰ ì‚¬ìš©)
- ê³¼ê±° ê³„ì¸µë„ ë³µì›
- ê°ì‚¬ ì¶”ì 

**ì—…ë°ì´íŠ¸ ì‹œì **:
- ìš©ì—­ì ë“±ë¡ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜)
- ë§¤ì›” ë§ì¼ ìµœì¢… í™•ì • ìŠ¤ëƒ…ìƒ· ìƒì„±

---

#### 2.2.3 weeklyPaymentPlans (ê°œë³„ ì§€ê¸‰ ê³„íš)

**ëª©ì **: ìš©ì—­ìë³„ ì£¼ì°¨ë³„ ì§€ê¸‰ ê³„íš ìƒì„¸

```javascript
{
  _id: ObjectId,
  userId: String,
  userName: String,

  // ê³„íš ì •ë³´
  planType: String,              // 'initial' | 'promotion' | 'additional'
  baseGrade: String,             // F1~F8
  revenueMonth: String,          // ë§¤ì¶œ ê·€ì† ì›” "2025-10"

  // ì§€ê¸‰ ì •ë³´
  startDate: Date,               // ì§€ê¸‰ ì‹œì‘ì¼ (ë“±ë¡ì¼+1ê°œì›” í›„ ì²« ê¸ˆìš”ì¼)
  totalInstallments: Number,     // ì´ ì§€ê¸‰ íšŸìˆ˜
  completedInstallments: Number, // ì™„ë£Œëœ ì§€ê¸‰ íšŸìˆ˜

  // ì£¼ì°¨ë³„ ì§€ê¸‰ ë‚´ì—­
  installments: [{
    week: Number,                // 1~60 (ë“±ê¸‰ë³„ ìµœëŒ€)
    weekNumber: String,          // "2025-W41" (ISO ì£¼ì°¨)
    scheduledDate: Date,         // ì§€ê¸‰ ì˜ˆì •ì¼ (ê¸ˆìš”ì¼)

    revenueMonth: String,        // ë§¤ì¶œ ê·€ì† ì›”
    gradeAtPayment: String,      // ì§€ê¸‰ ì‹œì  ë“±ê¸‰ (ì›”ë§ ìŠ¤ëƒ…ìƒ· ê¸°ì¤€)

    // ê¸ˆì•¡ (ì£¼ê°„ ì§€ê¸‰ ì‹œ í™•ì •)
    baseAmount: Number,          // null â†’ í™•ì • (ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡)
    installmentAmount: Number,   // íšŒì°¨ë‹¹ ì§€ê¸‰ì•¡
    withholdingTax: Number,      // ì›ì²œì§•ìˆ˜ (3.3%)
    netAmount: Number,           // ì‹¤ì§€ê¸‰ì•¡

    status: String,              // 'pending' | 'paid' | 'terminated'
    paidAt: Date,                // ì‹¤ì œ ì§€ê¸‰ ì¼ì‹œ

    // ì§€ê¸‰ íƒ€ì…
    installmentType: String      // 'initial' (1~10íšŒ) | 'additional' (11íšŒ~)
  }],

  planStatus: String,            // 'active' | 'completed' | 'terminated'

  // ë©”íƒ€ë°ì´í„°
  createdAt: Date,
  updatedAt: Date,
  terminatedAt: Date,
  terminationReason: String      // 'promotion' | 'max_reached' | 'manual'
}

// ì¸ë±ìŠ¤
weeklyPaymentPlans.createIndex({ userId: 1, planStatus: 1 })
weeklyPaymentPlans.createIndex({ 'installments.scheduledDate': 1, 'installments.status': 1 })
weeklyPaymentPlans.createIndex({ planType: 1, baseGrade: 1 })
weeklyPaymentPlans.createIndex({ revenueMonth: 1 })
```

**planType êµ¬ë¶„**:
- `initial`: ë“±ë¡ ì‹œ ìƒì„± (1íšŒ~ìµœëŒ€ íšŸìˆ˜)
- `promotion`: ìŠ¹ê¸‰ ì‹œ ìƒì„± (1~10íšŒë§Œ)
- `additional`: 10íšŒ ì™„ë£Œ í›„ ìƒì„± (11íšŒ~ìµœëŒ€ íšŸìˆ˜)

**íŠ¹ì§•**:
- í•œ ì‚¬ìš©ìê°€ **ì—¬ëŸ¬ ê³„íš ë™ì‹œ ë³´ìœ  ê°€ëŠ¥** (ë³‘í–‰ ì§€ê¸‰)
- ë¯¸ë˜ ì§€ê¸‰ê¹Œì§€ ì‚¬ì „ ìƒì„± (ì˜ˆì¸¡ ê°€ëŠ¥)

---

#### 2.2.4 weeklyPaymentSummary (ì£¼ì°¨ë³„ ì´ê³„)

**ëª©ì **: ì£¼ì°¨ë³„ ì „ì²´ ì§€ê¸‰ í†µê³„ (ì„±ëŠ¥ ìµœì í™”)

```javascript
{
  _id: ObjectId,
  weekDate: Date,                // ê¸ˆìš”ì¼ ë‚ ì§œ (2025-10-11)
  weekNumber: String,            // "2025-W41" (ISO ì£¼ì°¨)
  monthKey: String,              // "2025-10"

  // ì „ì²´ ì´ê³„ (í˜ì´ì§€ ë¬´ê´€)
  totalAmount: Number,           // ì „ì²´ ì§€ê¸‰ì•¡ í•©ê³„
  totalTax: Number,              // ì „ì²´ ì›ì²œì§•ìˆ˜ í•©ê³„
  totalNet: Number,              // ì „ì²´ ì‹¤ì§€ê¸‰ì•¡ í•©ê³„
  totalUserCount: Number,        // ì „ì²´ ì§€ê¸‰ ëŒ€ìƒ ì¸ì›
  totalPaymentCount: Number,     // ì „ì²´ ì§€ê¸‰ ê±´ìˆ˜ (ë³‘í–‰ì§€ê¸‰ í¬í•¨)

  // ë“±ê¸‰ë³„ ì´ê³„
  byGrade: {
    F1: {
      amount: Number,
      tax: Number,
      net: Number,
      userCount: Number,
      paymentCount: Number
    },
    F2: { ... },
    F3: { ... },
    F4: { ... },
    F5: { ... },
    F6: { ... },
    F7: { ... },
    F8: { ... }
  },

  // ê³„íš íƒ€ì…ë³„ ì´ê³„
  byPlanType: {
    initial: {
      amount: Number,
      tax: Number,
      net: Number,
      paymentCount: Number
    },
    promotion: { ... },
    additional: { ... }
  },

  status: String,                // 'scheduled' | 'completed'
  processedAt: Date,

  createdAt: Date,
  updatedAt: Date
}

// ì¸ë±ìŠ¤
weeklyPaymentSummary.createIndex({ weekNumber: 1 }, { unique: true })
weeklyPaymentSummary.createIndex({ weekDate: 1 })
weeklyPaymentSummary.createIndex({ monthKey: 1 })
```

**ìš©ë„**:
- ì›¹ UI ì „ì²´ ì´ê³„ í‘œì‹œ (< 1ms ì¡°íšŒ)
- ë¯¸ë˜ ì§€ê¸‰ ì˜ˆì¸¡ ì¡°íšŒ
- ëŒ€ì‹œë³´ë“œ í†µê³„

**ì—…ë°ì´íŠ¸ ì‹œì **:
- ìš©ì—­ì ë“±ë¡ ì‹œ: ì¦ë¶„ ì—…ë°ì´íŠ¸ (ë¯¸ë˜ ì˜ˆì¸¡ ë°˜ì˜)
- ë§¤ì£¼ ê¸ˆìš”ì¼: ì‹¤ì œ ì§€ê¸‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
- ìŠ¹ê¸‰ ì‹œ: ì°¨ê°/ì¶”ê°€ ì—…ë°ì´íŠ¸

---

## 3. ì§€ê¸‰ ê³„íš ì²˜ë¦¬ ë°©ì•ˆ

### 3.1 ì²˜ë¦¬ ì‹œë‚˜ë¦¬ì˜¤ ë³„ ì „ëµ

#### 3.1.1 ì‹ ê·œ ë“±ë¡ ì‹œ

**ì²˜ë¦¬ íë¦„**:
```
1. íŠ¸ë¦¬ì— ì‚¬ìš©ì ì¶”ê°€
2. ë“±ê¸‰ ì¬ê³„ì‚° (ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ)
3. ë“±ê¸‰ ë³€ë™ìì— ëŒ€í•´:
   - ì‹ ê·œ ì‚¬ìš©ì: initial ê³„íš ìƒì„± (1~ìµœëŒ€ íšŸìˆ˜)
   - ìŠ¹ê¸‰ì: promotion ê³„íš ìƒì„± (1~10íšŒ)
4. monthlyTreeSnapshots ì—…ë°ì´íŠ¸
5. weeklyPaymentSummary ì¦ë¶„ ì—…ë°ì´íŠ¸
```

**ì˜ˆì‹œ**:
```
7ì›” 2ì¼: í™ê¸¸ë™ ë“±ë¡ (F1)
â†’ initial ê³„íš ìƒì„±: 1~20íšŒ (F1 ìµœëŒ€ 20íšŒ)
â†’ 8ì›” ì²« ê¸ˆìš”ì¼ë¶€í„° ì§€ê¸‰ ì‹œì‘
```

---

#### 3.1.2 ìŠ¹ê¸‰ ì‹œ (ë³‘í–‰ ì§€ê¸‰)

**ì²˜ë¦¬ íë¦„**:
```
1. ê¸°ì¡´ ê³„íš ì²˜ë¦¬:
   - initial/promotion ê³„íš: ìœ ì§€ (ê³„ì† ì§€ê¸‰)
   - additional ê³„íš: ì¢…ë£Œ (terminated)
2. ìƒˆ promotion ê³„íš ìƒì„± (1~10íšŒ)
3. weeklyPaymentSummary ì°¨ê°/ì¶”ê°€
```

**ì˜ˆì‹œ**:
```
7ì›” 2ì¼: F1 ë“±ë¡ â†’ initial ê³„íš ìƒì„± (1~20íšŒ)
8ì›” 4ì¼: F1 1íšŒ ì§€ê¸‰
8ì›” 11ì¼: F1 2íšŒ ì§€ê¸‰
8ì›” 18ì¼: F1 3íšŒ ì§€ê¸‰

8ì›” 20ì¼: F3 ìŠ¹ê¸‰! â­
â†’ F1 initial ê³„íš: ìœ ì§€ (4~10íšŒ ê³„ì†)
â†’ F3 promotion ê³„íš ìƒì„± (1~10íšŒ)
â†’ 9ì›”ë¶€í„° ë³‘í–‰ ì§€ê¸‰ ì‹œì‘

9ì›” 1ì¼: F1 4íšŒ + F3 1íšŒ = ë³‘í–‰ ì§€ê¸‰
9ì›” 8ì¼: F1 5íšŒ + F3 2íšŒ = ë³‘í–‰ ì§€ê¸‰
...
10ì›” 13ì¼: F1 10íšŒ (ì™„ë£Œ) + F3 7íšŒ
10ì›” 20ì¼: F3 8íšŒ (F3ë§Œ ì§€ê¸‰)
```

---

#### 3.1.3 ì¶”ê°€ ì§€ê¸‰ê¸°ê°„ (10íšŒ ì™„ë£Œ í›„)

**ì²˜ë¦¬ íë¦„**:
```
1. initial/promotion ê³„íš 10íšŒ ì™„ë£Œ í™•ì¸
2. í˜„ì¬ ë“±ê¸‰ í™•ì¸
3. ë“±ê¸‰ ìœ ì§€ ì‹œ:
   - additional ê³„íš ìƒì„± (11~ìµœëŒ€ íšŸìˆ˜)
4. ë“±ê¸‰ ë³€ë™ ì‹œ:
   - ìƒì„±í•˜ì§€ ì•ŠìŒ (ì´ë¯¸ promotion ê³„íš ì¡´ì¬)
```

**ì˜ˆì‹œ**:
```
F2 ë“±ë¡ â†’ initial 10íšŒ ì™„ë£Œ
â†’ ë“±ê¸‰ ìœ ì§€ ì‹œ: additional ê³„íš ìƒì„± (11~30íšŒ)
â†’ F4 ìŠ¹ê¸‰ ì‹œ: ìƒì„± ì•ˆí•¨ (F4 promotion ì§„í–‰ ì¤‘)
```

---

### 3.2 ë“±ê¸‰ë³„ ìµœëŒ€ ìˆ˜ë ¹ íšŸìˆ˜

| ë“±ê¸‰ | ìµœëŒ€ íšŸìˆ˜ | êµ¬ì„± |
|------|----------|------|
| F1 | 20íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 10íšŒ |
| F2 | 30íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 20íšŒ |
| F3 | 40íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 30íšŒ |
| F4 | 40íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 30íšŒ |
| F5 | 50íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 40íšŒ |
| F6 | 50íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 40íšŒ |
| F7 | 60íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 50íšŒ |
| F8 | 60íšŒ | ê¸°ë³¸ 10íšŒ + ì¶”ê°€ 50íšŒ |

---

### 3.3 ì§€ê¸‰ ê³„íš ìƒì„± ë¡œì§

#### 3.3.1 Initial ê³„íš ìƒì„± (ë“±ë¡ ì‹œ)

```javascript
async function createInitialPaymentPlan(userId, grade, revenueMonth) {
  const maxCounts = {
    F1: 20, F2: 30, F3: 40, F4: 40,
    F5: 50, F6: 50, F7: 60, F8: 60
  };

  const user = await User.findById(userId);
  const startDate = getFirstFridayAfterOneMonth(user.registrationDate);
  const maxCount = maxCounts[grade];

  const installments = [];
  for (let i = 1; i <= maxCount; i++) {
    const scheduledDate = addWeeks(startDate, i - 1);

    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      gradeAtPayment: null,

      baseAmount: null,
      installmentAmount: null,
      withholdingTax: null,
      netAmount: null,

      status: 'pending',
      installmentType: i <= 10 ? 'initial' : 'additional'
    });
  }

  const plan = await WeeklyPaymentPlan.create({
    userId,
    userName: user.name,
    planType: 'initial',
    baseGrade: grade,
    revenueMonth,
    startDate,
    totalInstallments: maxCount,
    completedInstallments: 0,
    installments,
    planStatus: 'active'
  });

  // ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸ (ë¯¸ë˜ ì˜ˆì¸¡ ë°˜ì˜)
  await updateWeeklyProjections(plan, 'add');

  return plan;
}
```

---

#### 3.3.2 Promotion ê³„íš ìƒì„± (ìŠ¹ê¸‰ ì‹œ)

```javascript
async function createPromotionPaymentPlan(userId, newGrade, revenueMonth) {
  const user = await User.findById(userId);

  // 1. ê¸°ì¡´ additional ê³„íš ì¢…ë£Œ
  await terminateAdditionalPlans(userId);

  // 2. ìŠ¹ê¸‰ì›” ë‹¤ìŒë‹¬ ì²« ê¸ˆìš”ì¼ë¶€í„° ì‹œì‘
  const promotionMonth = getCurrentMonthKey();
  const nextMonth = getNextMonth(promotionMonth);
  const startDate = getFirstFridayOfMonth(nextMonth);

  const installments = [];
  for (let i = 1; i <= 10; i++) {  // ìŠ¹ê¸‰ì€ 10íšŒë§Œ
    const scheduledDate = addWeeks(startDate, i - 1);

    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      gradeAtPayment: null,

      baseAmount: null,
      installmentAmount: null,
      withholdingTax: null,
      netAmount: null,

      status: 'pending',
      installmentType: 'initial'  // ìŠ¹ê¸‰ë„ ê¸°ë³¸ 10íšŒ
    });
  }

  const plan = await WeeklyPaymentPlan.create({
    userId,
    userName: user.name,
    planType: 'promotion',
    baseGrade: newGrade,
    revenueMonth,
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    installments,
    planStatus: 'active'
  });

  // ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸
  await updateWeeklyProjections(plan, 'add');

  return plan;
}
```

---

#### 3.3.4 ì§€ê¸‰ì•¡ ê³„ì‚° ë° 100ì› ë‹¨ìœ„ ì ˆì‚­

```javascript
async function calculateInstallmentAmount(baseGrade, revenueMonth, installmentCount = 10) {
  // 1. ì›”ë³„ ë§¤ì¶œ ë° ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ì¡°íšŒ
  const monthlyReg = await MonthlyRegistration.findOne({ monthKey: revenueMonth });
  const revenue = monthlyReg.adjustedRevenue || monthlyReg.totalRevenue;

  // 2. ë“±ê¸‰ë³„ ê°œì¸ ì§€ê¸‰ì•¡ ê³„ì‚° (ëˆ„ì  ë°©ì‹)
  const gradePayments = calculateGradePayments(revenue, monthlyReg.gradeDistribution);
  const baseAmount = gradePayments[baseGrade];

  // 3. 10ë¶„í•  ì‹œ 100ì› ë‹¨ìœ„ ì ˆì‚­
  const installmentAmount = Math.floor(baseAmount / installmentCount / 100) * 100;

  // 4. ì›ì²œì§•ìˆ˜ ê³„ì‚°
  const withholdingTax = Math.round(installmentAmount * 0.033);
  const netAmount = installmentAmount - withholdingTax;

  return {
    baseAmount,        // ë“±ê¸‰ë³„ ì´ ì§€ê¸‰ì•¡ (ì ˆì‚­ ì „)
    installmentAmount, // íšŒì°¨ë‹¹ ì§€ê¸‰ì•¡ (100ì› ë‹¨ìœ„ ì ˆì‚­)
    withholdingTax,    // ì›ì²œì§•ìˆ˜ì•¡
    netAmount          // ì‹¤ì§€ê¸‰ì•¡
  };
}

// ë“±ê¸‰ë³„ ëˆ„ì  ì§€ê¸‰ì•¡ ê³„ì‚°
function calculateGradePayments(totalRevenue, gradeDistribution) {
  const rates = {
    F1: 0.24, F2: 0.19, F3: 0.14, F4: 0.09,
    F5: 0.05, F6: 0.03, F7: 0.02, F8: 0.01
  };

  const payments = {};
  let previousAmount = 0;

  const grades = ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'];

  for (let i = 0; i < grades.length; i++) {
    const grade = grades[i];
    const nextGrade = grades[i + 1];

    const currentCount = gradeDistribution[grade] || 0;
    const nextCount = gradeDistribution[nextGrade] || 0;

    if (currentCount > 0) {
      const poolAmount = totalRevenue * rates[grade];
      const poolCount = currentCount + nextCount;

      if (poolCount > 0) {
        const additionalPerPerson = poolAmount / poolCount;
        payments[grade] = previousAmount + additionalPerPerson;
        previousAmount = payments[grade];
      } else {
        payments[grade] = previousAmount;
      }
    } else {
      payments[grade] = 0;
    }
  }

  return payments;
}
```

---

#### 3.3.5 Additional ê³„íš ìƒì„± (10íšŒ ì™„ë£Œ í›„ ë“±ê¸‰ ìœ ì§€ ì‹œ)

```javascript
async function createAdditionalPaymentPlan(userId, currentGrade, lastPlan) {
  const maxCounts = {
    F1: 20, F2: 30, F3: 40, F4: 40,
    F5: 50, F6: 50, F7: 60, F8: 60
  };

  const user = await User.findById(userId);
  const maxCount = maxCounts[currentGrade];

  // ì´ë¯¸ ìˆ˜ë ¹í•œ íšŒì°¨ í™•ì¸
  const completedCount = lastPlan.completedInstallments;

  // ë‚¨ì€ íšŒì°¨ê°€ ìˆëŠ”ì§€ í™•ì¸
  if (completedCount >= maxCount) {
    console.log(`User ${userId} reached max count for grade ${currentGrade}`);
    return null;
  }

  // Additional ê³„íš ìƒì„± (11íšŒì°¨ë¶€í„°)
  const remainingCount = maxCount - 10; // ì¶”ê°€ ì§€ê¸‰ ê°€ëŠ¥ íšŸìˆ˜
  const installments = [];

  const lastInstallment = lastPlan.installments[9]; // 10íšŒì°¨
  const nextFriday = addWeeks(lastInstallment.scheduledDate, 1);

  for (let i = 11; i <= maxCount; i++) {
    const scheduledDate = addWeeks(nextFriday, i - 11);

    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth: lastPlan.revenueMonth, // ë™ì¼ ë§¤ì¶œì›” ê¸°ì¤€
      gradeAtPayment: null,

      baseAmount: null,
      installmentAmount: null,
      withholdingTax: null,
      netAmount: null,

      status: 'pending',
      installmentType: 'additional'
    });
  }

  const additionalPlan = await WeeklyPaymentPlan.create({
    userId,
    userName: user.name,
    planType: 'additional',
    baseGrade: currentGrade,
    revenueMonth: lastPlan.revenueMonth,
    startDate: nextFriday,
    totalInstallments: remainingCount,
    completedInstallments: 0,
    installments,
    planStatus: 'active'
  });

  // ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸
  await updateWeeklyProjections(additionalPlan, 'add');

  return additionalPlan;
}

// ë§¤ì£¼ ê¸ˆìš”ì¼ ì§€ê¸‰ ì²˜ë¦¬ í›„ í˜¸ì¶œ
async function checkAndCreateAdditionalPlan(plan) {
  // 10íšŒì°¨ ì™„ë£Œ í™•ì¸
  if (plan.completedInstallments === 10 &&
      plan.planType !== 'additional') {

    // í˜„ì¬ ë“±ê¸‰ í™•ì¸
    const currentSnapshot = await MonthlyTreeSnapshot.findOne({
      monthKey: getCurrentMonthKey(),
      'users.userId': plan.userId
    });

    const userSnapshot = currentSnapshot.users.find(u => u.userId === plan.userId);
    const currentGrade = userSnapshot.grade;

    // ë“±ê¸‰ ìœ ì§€ ì—¬ë¶€ í™•ì¸
    if (currentGrade === plan.baseGrade) {
      // ë“±ê¸‰ ìœ ì§€ ì‹œ additional ê³„íš ìƒì„±
      await createAdditionalPaymentPlan(plan.userId, currentGrade, plan);
    }
    // ìŠ¹ê¸‰í•œ ê²½ìš° ì´ë¯¸ promotion ê³„íšì´ ìˆìœ¼ë¯€ë¡œ ìƒì„± ì•ˆí•¨
  }
}
```

---

#### 3.3.3 Additional ê³„íš ì¢…ë£Œ (ìŠ¹ê¸‰ ì‹œ)

```javascript
async function terminateAdditionalPlans(userId) {
  const additionalPlans = await WeeklyPaymentPlan.find({
    userId,
    planStatus: 'active',
    'installments.installmentType': 'additional'
  });

  for (const plan of additionalPlans) {
    for (const inst of plan.installments) {
      if (inst.installmentType === 'additional' && inst.status === 'pending') {
        inst.status = 'terminated';
      }
    }

    plan.planStatus = 'terminated';
    plan.terminatedAt = new Date();
    plan.terminationReason = 'promotion';

    await plan.save();

    // ì£¼ì°¨ë³„ ì´ê³„ì—ì„œ ì œê±°
    await updateWeeklyProjections(plan, 'remove');
  }
}
```

---

## 4. ìë™í™” í”„ë¡œì„¸ìŠ¤

### 4.1 ìš©ì—­ì ë“±ë¡ ì‹œ ìë™ ì²˜ë¦¬

```
[ìš©ì—­ì ë“±ë¡ ìš”ì²­]
    â†“
[1. íŠ¸ë¦¬ì— ì‚¬ìš©ì ì¶”ê°€]
    â†“
[2. ì˜í–¥ë°›ëŠ” ë…¸ë“œ íƒìƒ‰]
   - ì‹ ê·œ ì‚¬ìš©ì
   - í›„ì›ì
   - ì¡°ìƒ ë…¸ë“œë“¤
    â†“
[3. ë“±ê¸‰ ì¬ê³„ì‚°] (ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ)
    â†“
[4. ë“±ê¸‰ ë³€ë™ í™•ì¸]
   â”œâ”€ ì‹ ê·œ: initial ê³„íš ìƒì„±
   â”œâ”€ ìŠ¹ê¸‰: promotion ê³„íš ìƒì„± + additional ì¢…ë£Œ
   â””â”€ ìœ ì§€: ì²˜ë¦¬ ì•ˆí•¨
    â†“
[5. monthlyRegistrations ì—…ë°ì´íŠ¸]
   - ë“±ë¡ì ì¶”ê°€
   - ë§¤ì¶œ ì¬ê³„ì‚°
   - ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ì¬ê³„ì‚°
    â†“
[6. monthlyTreeSnapshots ì—…ë°ì´íŠ¸ (upsert)]
   - í˜„ì¬ ì›” ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸ (ì—†ìœ¼ë©´ ìƒì„±)
   - íŠ¸ë¦¬ êµ¬ì¡° ë°˜ì˜
   - í™œì„± ê³„íš ì •ë³´ ë°˜ì˜
   - ì‹¤ì‹œê°„ ìµœì‹  ìƒíƒœ ìœ ì§€
    â†“
[7. weeklyPaymentSummary ì¦ë¶„ ì—…ë°ì´íŠ¸]
   - ì‹ ê·œ ê³„íš: ë¯¸ë˜ ì£¼ì°¨ì— ì¦ê°€ ë°˜ì˜
   - ì¢…ë£Œ ê³„íš: ë¯¸ë˜ ì£¼ì°¨ì—ì„œ ì°¨ê°
    â†“
[ë“±ë¡ ì™„ë£Œ]
```

**ì²˜ë¦¬ ì‹œê°„**: ì•½ 500ms~1ì´ˆ (10,000ëª… ê·œëª¨)

---

### 4.2 ë§¤ì£¼ ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰ ì²˜ë¦¬

```
[ë§¤ì£¼ ê¸ˆìš”ì¼ 00:00 Cron ì‹¤í–‰]
    â†“
[1. ì˜¤ëŠ˜ ì§€ê¸‰ ëŒ€ìƒ ì¡°íšŒ]
   weeklyPaymentPlans.find({
     'installments.scheduledDate': today,
     'installments.status': 'pending'
   })
    â†“
[2. ê° ì§€ê¸‰ ê±´ ì²˜ë¦¬]
   â”œâ”€ ë§¤ì¶œì›” ìŠ¤ëƒ…ìƒ·ì—ì„œ ë“±ê¸‰ í™•ì¸
   â”œâ”€ ë³´í—˜ ì¡°ê±´ í™•ì¸ (F3 ì´ìƒ)
   â”œâ”€ ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ì¡°íšŒ
   â”œâ”€ ê¸ˆì•¡ í™•ì • (baseAmount, installmentAmount, tax, net)
   â””â”€ status: 'pending' â†’ 'paid'
    â†“
[3. í†µê³„ ì§‘ê³„]
   - ì´ ì§€ê¸‰ì•¡ í•©ì‚°
   - ë“±ê¸‰ë³„ ì§‘ê³„
   - ê³„íš íƒ€ì…ë³„ ì§‘ê³„
    â†“
[4. weeklyPaymentSummary ì—…ë°ì´íŠ¸]
   - totalAmount, totalTax, totalNet
   - byGrade ì—…ë°ì´íŠ¸
   - status: 'completed'
    â†“
[5. 10íšŒ ì™„ë£Œ í™•ì¸]
   - initial/promotion ê³„íš 10íšŒ ì™„ë£Œ ì‹œ
   - ë“±ê¸‰ ìœ ì§€ í™•ì¸
   - additional ê³„íš ìƒì„± (í•„ìš” ì‹œ)
    â†“
[ì§€ê¸‰ ì²˜ë¦¬ ì™„ë£Œ]
```

**Cron ì„¤ì •**: `0 0 * * 5` (ë§¤ì£¼ ê¸ˆìš”ì¼ 00:00)

**ì²˜ë¦¬ ì‹œê°„**: ì•½ 2~5ì´ˆ (2,000~3,000ê±´ ì§€ê¸‰ ê¸°ì¤€)

#### 4.2.1 ë³´í—˜ ì¡°ê±´ ê²€ì¦ ì²˜ë¦¬

**ê´€ë¦¬ì ì„¤ì • ê¸°ë°˜ ë³´í—˜ ì¡°ê±´ ê´€ë¦¬**:

```javascript
async function processWeeklyPayment(date) {
  const pendingInstallments = await WeeklyPaymentPlan.find({
    'installments.scheduledDate': date,
    'installments.status': 'pending'
  });

  for (const plan of pendingInstallments) {
    const user = await User.findById(plan.userId);
    const grade = plan.baseGrade;

    // 1. F3 ì´ìƒ ë“±ê¸‰ì˜ ë³´í—˜ ì¡°ê±´ í™•ì¸
    if (grade >= 'F3') {
      // ê´€ë¦¬ìê°€ ì„¤ì •í•œ ë³´í—˜ ì¡°ê±´ ì¡°íšŒ
      const insuranceSettings = user.insuranceSettings;

      if (insuranceSettings && insuranceSettings.required) {
        // ë³´í—˜ ìœ ì§€ ì—¬ë¶€ í™•ì¸ (ê´€ë¦¬ìê°€ ì„¤ì •í•œ ìƒíƒœ)
        if (!insuranceSettings.maintained) {
          // ë³´í—˜ ë¯¸ìœ ì§€ ì‹œ í•´ë‹¹ íšŒì°¨ ê±´ë„ˆëœ€
          inst.status = 'skipped';
          inst.skipReason = 'insurance_not_maintained';
          continue;
        }

        // ë³´í—˜ ê¸ˆì•¡ ì¡°ê±´ í™•ì¸
        const requiredAmounts = {
          F3: 50000, F4: 50000,
          F5: 70000, F6: 70000,
          F7: 100000, F8: 100000
        };

        if (insuranceSettings.amount < requiredAmounts[grade]) {
          inst.status = 'skipped';
          inst.skipReason = 'insufficient_insurance_amount';
          continue;
        }
      }
    }

    // 2. ì§€ê¸‰ ì²˜ë¦¬
    const amounts = await calculateInstallmentAmount(grade, plan.revenueMonth);
    inst.baseAmount = amounts.baseAmount;
    inst.installmentAmount = amounts.installmentAmount;
    inst.withholdingTax = amounts.withholdingTax;
    inst.netAmount = amounts.netAmount;
    inst.status = 'paid';
    inst.paidAt = new Date();
  }
}
```

**ê´€ë¦¬ì ë³´í—˜ ì„¤ì • UI**:

```javascript
// ìš©ì—­ì í¸ì§‘ í™”ë©´ì—ì„œ ë³´í—˜ ì„¤ì •
{
  userId: "user123",
  insuranceSettings: {
    required: true,           // F3 ì´ìƒ ìë™ í™œì„±í™”
    amount: 70000,            // ê´€ë¦¬ìê°€ ì…ë ¥í•œ ë³´í—˜ê¸ˆì•¡
    maintained: true,         // ê´€ë¦¬ìê°€ ì„¤ì •í•œ ìœ ì§€ ìƒíƒœ
    lastUpdated: Date,        // ë§ˆì§€ë§‰ ìˆ˜ì •ì¼
    updatedBy: "admin123"     // ìˆ˜ì •í•œ ê´€ë¦¬ì
  },

  // ë³´í—˜ ì´ë ¥ ì¶”ì  (ì¬ê°€ì… ì‹œ ê¸°ì¡´ íšŒìˆ˜ ìœ ì§€ìš©)
  insuranceHistory: [{
    period: "2025-01",
    maintained: true,
    amount: 50000
  }, {
    period: "2025-02",
    maintained: false,        // í•´ì§€
    amount: 0
  }, {
    period: "2025-03",
    maintained: true,         // ì¬ê°€ì…
    amount: 50000
  }]
}
```

#### 4.2.2 ë³´í—˜ ì¬ê°€ì… ì‹œ íšŒìˆ˜ ìœ ì§€ ì²˜ë¦¬

**ë³´í—˜ í•´ì§€ ë° ì¬ê°€ì… ì‹œë‚˜ë¦¬ì˜¤**:

```javascript
async function handleInsuranceStatusChange(userId, newStatus, amount) {
  const user = await User.findById(userId);
  const currentMonth = getCurrentMonthKey();

  // 1. ë³´í—˜ ìƒíƒœ ë³€ê²½ ê¸°ë¡
  user.insuranceSettings.maintained = newStatus;
  user.insuranceSettings.amount = amount;
  user.insuranceSettings.lastUpdated = new Date();

  // 2. ì´ë ¥ ì¶”ê°€
  user.insuranceHistory.push({
    period: currentMonth,
    maintained: newStatus,
    amount: amount
  });

  // 3. í™œì„± ì§€ê¸‰ ê³„íš ì¡°íšŒ
  const activePlans = await WeeklyPaymentPlan.find({
    userId: userId,
    planStatus: 'active'
  });

  for (const plan of activePlans) {
    // ë³´í—˜ í•´ì§€ ì‹œ: ì§€ê¸‰ì€ ê±´ë„ˆë›°ì§€ë§Œ íšŒì°¨ëŠ” ê³„ì† ì§„í–‰
    // ë³´í—˜ ì¬ê°€ì… ì‹œ: ê¸°ì¡´ íšŒì°¨ë¶€í„° ì¬ê°œ

    if (!newStatus) {
      // ë³´í—˜ í•´ì§€ - í–¥í›„ ì§€ê¸‰ ê±´ë„ˆëœ€ í‘œì‹œ
      for (const inst of plan.installments) {
        if (inst.status === 'pending' && inst.scheduledDate > new Date()) {
          inst.insuranceSkipped = true; // ê±´ë„ˆëœ€ í‘œì‹œë§Œ, statusëŠ” ê·¸ëŒ€ë¡œ
        }
      }
    } else {
      // ë³´í—˜ ì¬ê°€ì… - ê±´ë„ˆëœ€ í‘œì‹œ ì œê±° (ê¸°ì¡´ íšŒì°¨ ìœ ì§€)
      for (const inst of plan.installments) {
        if (inst.insuranceSkipped && inst.status === 'pending') {
          delete inst.insuranceSkipped; // ë‹¤ì‹œ ì§€ê¸‰ ëŒ€ìƒìœ¼ë¡œ
        }
      }
    }
  }

  await user.save();
}

// ì‹¤ì œ ì§€ê¸‰ ì²˜ë¦¬ ì‹œ
async function processPaymentWithInsurance(installment, user) {
  // insuranceSkipped í”Œë˜ê·¸ í™•ì¸
  if (installment.insuranceSkipped) {
    installment.status = 'skipped';
    installment.skipReason = 'insurance_not_maintained';

    // íšŒì°¨ëŠ” ì¦ê°€í•˜ì§€ë§Œ ì§€ê¸‰ì€ ì•ˆí•¨
    plan.completedInstallments++; // íšŒì°¨ëŠ” ê³„ì† ì¹´ìš´íŠ¸
    return;
  }

  // ì •ìƒ ì§€ê¸‰ ì²˜ë¦¬
  // ...
}
```

**ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤**:

```
1ì›”: F3, ë³´í—˜ ìœ ì§€ â†’ 1~3íšŒì°¨ ì •ìƒ ì§€ê¸‰
2ì›”: ë³´í—˜ í•´ì§€ â†’ 4~6íšŒì°¨ ê±´ë„ˆëœ€ (íšŒì°¨ëŠ” ì§„í–‰)
3ì›”: ë³´í—˜ ì¬ê°€ì… â†’ 7íšŒì°¨ë¶€í„° ë‹¤ì‹œ ì§€ê¸‰ (íšŒì°¨ ì—°ì†ì„± ìœ ì§€)
4ì›”: 10íšŒì°¨ ì™„ë£Œ â†’ ì¶”ê°€ ì§€ê¸‰ 11íšŒì°¨ë¶€í„° ê³„ì†

â†’ ë³´í—˜ í•´ì§€ ê¸°ê°„ì—ë„ íšŒì°¨ëŠ” ê³„ì† ì§„í–‰ë˜ì–´ ì¬ê°€ì… ì‹œ ê¸°ì¡´ íšŒì°¨ ìœ ì§€
```

---

### 4.3 monthlyTreeSnapshots ê´€ë¦¬ ë° ì›”ë§ ë“±ê¸‰ í™•ì •

**ì›”ë§ ë“±ê¸‰ í™•ì • ì›ì¹™**:

```
ìš©ì—­ì ë“±ë¡ ì‹œë§ˆë‹¤ monthlyTreeSnapshotsê°€ ì—…ë°ì´íŠ¸ë˜ì–´
í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ì‹œì ê¹Œì§€ ê³„ì† ë°˜ì˜ë¨
â†’ ì›”ë§ ì‹œì ì˜ ìŠ¤ëƒ…ìƒ·ì´ ìì—°ìŠ¤ëŸ½ê²Œ ê·¸ ì›”ì˜ í™•ì • ë“±ê¸‰ì´ ë¨
```

**ì—…ë°ì´íŠ¸ í”„ë¡œì„¸ìŠ¤**:

```
[ìš©ì—­ì ë“±ë¡]
    â†“
[íŠ¸ë¦¬/ë“±ê¸‰ ì¬ê³„ì‚°]
    â†“
[í˜„ì¬ ì›” monthlyTreeSnapshots ì—…ë°ì´íŠ¸ (upsert)]
   - ìŠ¤ëƒ…ìƒ· ì—†ìœ¼ë©´: ìƒì„±
   - ìŠ¤ëƒ…ìƒ· ìˆìœ¼ë©´: ì—…ë°ì´íŠ¸
   - ìµœì‹  ë“±ê¸‰ ì •ë³´ ë°˜ì˜
    â†“
[ì›”ë§ê¹Œì§€ ê³„ì† ìµœì‹  ìƒíƒœ ìœ ì§€]
    â†“
[ë‹¤ìŒ ì›” 1ì¼ 00:00]
   - ì´ì „ ì›” ìŠ¤ëƒ…ìƒ· ìë™ í™•ì • (ë” ì´ìƒ ìˆ˜ì • ì•ˆë¨)
   - ìƒˆë¡œìš´ ì›” ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹œì‘
```

**ë“±ê¸‰ ì°¸ì¡° ë¡œì§**:

```javascript
async function getConfirmedGradeForPayment(userId, revenueMonth) {
  // ë§¤ì¶œ ë°œìƒ ì›”ì˜ ìŠ¤ëƒ…ìƒ·ì—ì„œ ë“±ê¸‰ ì¡°íšŒ
  // ì˜ˆ: 7ì›” ë§¤ì¶œ â†’ 7ì›” ë§ ìŠ¤ëƒ…ìƒ·ì˜ ë“±ê¸‰ ì‚¬ìš©
  const snapshot = await MonthlyTreeSnapshot.findOne({
    monthKey: revenueMonth,
    'users.userId': userId
  });

  const userSnapshot = snapshot.users.find(u => u.userId === userId);
  return userSnapshot.grade; // ì´ê²ƒì´ í™•ì • ë“±ê¸‰
}

// ì§€ê¸‰ ì²˜ë¦¬ ì‹œ ì‚¬ìš©
async function processPayment(installment, plan) {
  // ë§¤ì¶œì›”ì˜ í™•ì • ë“±ê¸‰ìœ¼ë¡œ ì§€ê¸‰ì•¡ ê³„ì‚°
  const confirmedGrade = await getConfirmedGradeForPayment(
    plan.userId,
    installment.revenueMonth
  );

  // ì´ ë“±ê¸‰ìœ¼ë¡œ 10íšŒ ëª¨ë‘ ë™ì¼í•˜ê²Œ ì§€ê¸‰
  const amounts = await calculateInstallmentAmount(
    confirmedGrade,
    installment.revenueMonth
  );
}
```

**íŠ¹ì§•**:
- ë³„ë„ ì›”ë§ ìŠ¤ëƒ…ìƒ· ìƒì„± Cron ë¶ˆí•„ìš”
- ìš©ì—­ì ë“±ë¡í•  ë•Œë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
- ì›”ì´ ë°”ë€Œë©´ ì´ì „ ì›”ì€ ìë™ìœ¼ë¡œ í™•ì • ìƒíƒœ
- ì§€ê¸‰ ì‹œ í•­ìƒ ë§¤ì¶œì›”ì˜ í™•ì • ë“±ê¸‰ ì°¸ì¡°

---

## 5. ì›¹ API ì„¤ê³„

### 5.1 ìš©ì—­ë¹„ ì§€ê¸‰ëª…ë¶€ API

#### 5.1.1 ì£¼ì°¨ë³„ ì§€ê¸‰ ë‚´ì—­ ì¡°íšŒ

**ì—”ë“œí¬ì¸íŠ¸**: `GET /api/admin/payment/weekly`

**ìš”ì²­ íŒŒë¼ë¯¸í„°**:
```javascript
{
  // ë‹¨ì¼ ë‚ ì§œ ì¡°íšŒ
  date: "2025-10-11",         // ë‚ ì§œ

  // ë˜ëŠ” ê¸°ê°„ ì¡°íšŒ
  startYear: 2025,
  startMonth: 10,
  endYear: 2025,
  endMonth: 12,

  // í˜ì´ì§•
  page: 1,
  limit: 20,

  // ê²€ìƒ‰
  search: "í™ê¸¸ë™",
  searchCategory: "name"       // 'name' | 'planner'
}
```

**ì‘ë‹µ êµ¬ì¡°**:
```javascript
{
  success: true,
  data: {
    // ì „ì²´ ì´ê³„ (í˜ì´ì§€ ë¬´ê´€)
    grandTotal: {
      totalAmount: 125450000,
      totalTax: 4139850,
      totalNet: 121310150
    },

    // í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´
    pagination: {
      page: 1,
      totalPages: 245,
      totalItems: 2450,        // ì „ì²´ ì¸ì›
      itemsPerPage: 20
    },

    // í˜„ì¬ í˜ì´ì§€ ì‚¬ìš©ì ëª©ë¡ (20ëª…)
    payments: [
      {
        userId: "user1",
        userName: "í™ê¸¸ë™1",
        planner: "ê¹€ì„¤ê³„",
        bank: "í•˜ë‚˜",
        accountNumber: "1002-066-361313",
        grade: "F3",
        actualAmount: 150000,
        taxAmount: 4950,
        netAmount: 145050,
        installments: [
          {
            revenueMonth: "2025-09",
            installmentNumber: 5,
            planType: "initial"
          }
        ]
      },
      // ... 19ëª… more
    ],

    year: 2025,
    monthNumber: 10,
    weekNumber: 2,
    week: "10ì›” 2ì£¼"
  }
}
```

---

#### 5.1.2 êµ¬í˜„ ë¡œì§

```javascript
async function getWeeklyPaymentData(params) {
  const { date, page, limit, search, searchCategory } = params;

  // 1. ì£¼ì°¨ë³„ ì´ê³„ ì¡°íšŒ (ë‹¨ì¼ ë¬¸ì„œ)
  const weekNumber = getISOWeek(new Date(date));
  const summary = await WeeklyPaymentSummary.findOne({ weekNumber });

  // 2. ê°œë³„ ì‚¬ìš©ì ì§€ê¸‰ ë‚´ì—­ ì¡°íšŒ (aggregation + í˜ì´ì§•)
  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);
  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);

  let matchStage = {
    'installments': {
      $elemMatch: {
        scheduledDate: { $gte: startOfDay, $lte: endOfDay },
        status: 'paid'
      }
    }
  };

  // ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
  if (search) {
    if (searchCategory === 'name') {
      matchStage.userName = { $regex: search, $options: 'i' };
    } else if (searchCategory === 'planner') {
      matchStage.planner = { $regex: search, $options: 'i' };
    }
  }

  // aggregation pipeline
  const pipeline = [
    { $match: matchStage },
    { $unwind: '$installments' },
    {
      $match: {
        'installments.scheduledDate': { $gte: startOfDay, $lte: endOfDay },
        'installments.status': 'paid'
      }
    },
    {
      $group: {
        _id: '$userId',
        userName: { $first: '$userName' },
        planner: { $first: '$planner' },
        bank: { $first: '$bank' },
        accountNumber: { $first: '$accountNumber' },
        grade: { $first: '$baseGrade' },
        payments: {
          $push: {
            planType: '$planType',
            amount: '$installments.installmentAmount',
            tax: '$installments.withholdingTax',
            net: '$installments.netAmount',
            revenueMonth: '$installments.revenueMonth',
            installmentNumber: '$installments.week'
          }
        }
      }
    },
    {
      $project: {
        userId: '$_id',
        userName: 1,
        planner: 1,
        bank: 1,
        accountNumber: 1,
        grade: 1,
        actualAmount: { $sum: '$payments.amount' },
        taxAmount: { $sum: '$payments.tax' },
        netAmount: { $sum: '$payments.net' },
        installments: '$payments'
      }
    },
    { $sort: { userName: 1 } },
    { $skip: (page - 1) * limit },
    { $limit: limit }
  ];

  const payments = await WeeklyPaymentPlan.aggregate(pipeline);

  return {
    grandTotal: {
      totalAmount: summary.totalAmount,
      totalTax: summary.totalTax,
      totalNet: summary.totalNet
    },
    pagination: {
      page,
      totalPages: Math.ceil(summary.totalUserCount / limit),
      totalItems: summary.totalUserCount,
      itemsPerPage: limit
    },
    payments: payments.map((p, idx) => ({
      ...p,
      no: (page - 1) * limit + idx + 1
    })),
    year: new Date(date).getFullYear(),
    monthNumber: new Date(date).getMonth() + 1,
    weekNumber: getWeekOfMonthByFriday(new Date(date)).week,
    week: `${new Date(date).getMonth() + 1}ì›” ${getWeekOfMonthByFriday(new Date(date)).week}ì£¼`
  };
}
```

---

### 5.2 ì„±ëŠ¥ ìµœì í™”

#### 5.2.1 ì¡°íšŒ ì„±ëŠ¥

| ì¡°íšŒ ì¢…ë¥˜ | ë°©ë²• | ì˜ˆìƒ ì‹œê°„ |
|----------|------|----------|
| ì „ì²´ ì´ê³„ | weeklyPaymentSummary ë‹¨ì¼ ë¬¸ì„œ | < 1ms |
| í˜ì´ì§€ ëª©ë¡ | aggregation + skip/limit | < 100ms |
| ì „ì²´ ì—‘ì…€ | aggregation (limit 10000) | < 3ì´ˆ |

#### 5.2.2 ì¸ë±ìŠ¤ ì „ëµ

```javascript
// ì£¼ì°¨ë³„ ì¡°íšŒ ìµœì í™”
weeklyPaymentPlans.createIndex({
  'installments.scheduledDate': 1,
  'installments.status': 1
})

// ì‚¬ìš©ì ê²€ìƒ‰ ìµœì í™”
weeklyPaymentPlans.createIndex({
  userName: 'text',
  planner: 'text'
})

// ì£¼ì°¨ë³„ ì´ê³„ ì¡°íšŒ ìµœì í™”
weeklyPaymentSummary.createIndex({ weekDate: 1 })
weeklyPaymentSummary.createIndex({ weekNumber: 1 }, { unique: true })
```

---

## 6. ë°ì´í„° íë¦„ë„

### 6.1 ìš©ì—­ì ë“±ë¡ íë¦„

```mermaid
graph TD
    A[ìš©ì—­ì ë“±ë¡ ìš”ì²­] --> B[íŠ¸ë¦¬ì— ì¶”ê°€]
    B --> C[ì˜í–¥ ë…¸ë“œ íƒìƒ‰]
    C --> D[ë“±ê¸‰ ì¬ê³„ì‚°]
    D --> E{ë“±ê¸‰ ë³€ë™?}

    E -->|ì‹ ê·œ| F1["initial ê³„íš ìƒì„±<br/>1~ìµœëŒ€íšŸìˆ˜"]
    E -->|ìŠ¹ê¸‰| F2["promotion ê³„íš ìƒì„±<br/>1~10íšŒ"]
    E -->|ìœ ì§€| F3[ì²˜ë¦¬ ì•ˆí•¨]

    F1 --> G["monthlyRegistrations<br/>ì—…ë°ì´íŠ¸"]
    F2 --> G
    F3 --> G

    G --> H["monthlyTreeSnapshots<br/>ì—…ë°ì´íŠ¸"]
    H --> I["weeklyPaymentSummary<br/>ì¦ë¶„ ì—…ë°ì´íŠ¸"]
    I --> J[ë“±ë¡ ì™„ë£Œ]

    F2 --> K["ê¸°ì¡´ additional<br/>ê³„íš ì¢…ë£Œ"]
    K --> I
```

---

### 6.2 ë§¤ì£¼ ê¸ˆìš”ì¼ ì§€ê¸‰ ì²˜ë¦¬ íë¦„

```mermaid
graph TD
    A["ê¸ˆìš”ì¼ 00:00<br/>Cron ì‹¤í–‰"] --> B["ì˜¤ëŠ˜ ì§€ê¸‰ ëŒ€ìƒ<br/>ì¡°íšŒ"]
    B --> C{"ë³´í—˜ ì¡°ê±´<br/>ë§Œì¡±?"}

    C -->|ì˜ˆ| D["ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡<br/>ì¡°íšŒ"]
    C -->|ì•„ë‹ˆì˜¤| E[ì§€ê¸‰ ê±´ë„ˆëœ€]

    D --> F["ê¸ˆì•¡ í™•ì •<br/>status: paid"]
    F --> G[í†µê³„ ì§‘ê³„]
    G --> H["weeklyPaymentSummary<br/>ì—…ë°ì´íŠ¸"]
    H --> I{"10íšŒ<br/>ì™„ë£Œ?"}

    I -->|ì˜ˆ| J{"ë“±ê¸‰<br/>ìœ ì§€?"}
    I -->|ì•„ë‹ˆì˜¤| K[ì§€ê¸‰ ì™„ë£Œ]

    J -->|ì˜ˆ| L["additional<br/>ê³„íš ìƒì„±"]
    J -->|ì•„ë‹ˆì˜¤| K

    L --> K
    E --> K
```

---

### 6.3 ë°ì´í„° ì¦ë¶„ ì—…ë°ì´íŠ¸ ì „ëµ

```mermaid
graph LR
    A[ìš©ì—­ì ë“±ë¡] --> B{ì˜í–¥ ë²”ìœ„}
    B --> C["ì‹ ê·œ: 1ëª…"]
    B --> D["í›„ì›ì: 1ëª…"]
    B --> E["ì¡°ìƒ: 5ëª…"]

    C --> F["7ëª…ë§Œ<br/>ì²˜ë¦¬"]
    D --> F
    E --> F

    F --> G["ê° ì‚¬ìš©ìë³„<br/>ê³„íš ìƒì„±/ê°±ì‹ "]
    G --> H["ì£¼ì°¨ë³„ ì´ê³„<br/>ì¦ë¶„ ì—…ë°ì´íŠ¸"]

    H --> I["ì²˜ë¦¬ ì™„ë£Œ<br/>1ì´ˆ ì´ë‚´"]

    style F fill:#ffffcc
    style I fill:#ccffcc
```

**ì „ì²´ ì¬ê³„ì‚° ë¶ˆí•„ìš”** â†’ **ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ ì²˜ë¦¬**

---

## 7. ìš”êµ¬ì‚¬í•­ ì¶©ì¡± ê²€ì¦

### 7.1 v3.0 ìš”êµ¬ì‚¬í•­ ëŒ€ì‘

| ìš”êµ¬ì‚¬í•­ | ì„¤ê³„ ë°©ì•ˆ | ê²€ì¦ |
|---------|----------|------|
| ìŠ¹ê¸‰ ì‹œ ê¸°ì¡´ ì§€ê¸‰ ìœ ì§€ | planType êµ¬ë¶„ (initial, promotion) | âœ… |
| ì¶”ê°€ ì§€ê¸‰ê¸°ê°„ | additional ê³„íš ìƒì„± (11~ìµœëŒ€) | âœ… |
| ë“±ê¸‰ë³„ ìµœëŒ€ íšŸìˆ˜ | ë“±ë¡ ì‹œ ì „ì²´ ìƒì„± (F1: 20íšŒ, F2: 30íšŒ, ...) | âœ… |
| ë¯¸ë˜ ì§€ê¸‰ ì˜ˆì¸¡ | weeklyPaymentSummary ì‚¬ì „ ìƒì„± | âœ… |
| í˜ì´ì§€ ë¬´ê´€ ì „ì²´ ì´ê³„ | weeklyPaymentSummary ë‹¨ì¼ ì¡°íšŒ | âœ… |
| ê°œë³„ ì‚¬ìš©ì í˜ì´ì§• | aggregation + skip/limit | âœ… |
| 3ë…„ ì´ë ¥ ë³´ê´€ | monthlyTreeSnapshots ì˜êµ¬ ë³´ê´€ | âœ… |
| ì„±ëŠ¥ ìµœì í™” | ì¦ë¶„ ì—…ë°ì´íŠ¸ ì „ëµ | âœ… |

---

### 7.2 ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„±

| í•­ëª© | ëª©í‘œ | ì‹¤ì œ ì˜ˆìƒ | ê²€ì¦ |
|------|------|----------|------|
| ìš©ì—­ì ë“±ë¡ ì²˜ë¦¬ | < 2ì´ˆ | ~1ì´ˆ | âœ… |
| ì£¼ê°„ ì§€ê¸‰ ì²˜ë¦¬ | < 10ì´ˆ | ~3ì´ˆ | âœ… |
| ì „ì²´ ì´ê³„ ì¡°íšŒ | < 10ms | < 1ms | âœ… |
| í˜ì´ì§• ëª©ë¡ ì¡°íšŒ | < 200ms | < 100ms | âœ… |
| ì—‘ì…€ ì „ì²´ ë‹¤ìš´ë¡œë“œ | < 10ì´ˆ | ~3ì´ˆ | âœ… |

---

## 8. í–¥í›„ í™•ì¥ ê³„íš

### 8.1 Phase 1 (í˜„ì¬)
- âœ… ê¸°ë³¸ ì§€ê¸‰ ê³„íš ì²˜ë¦¬
- âœ… ë³‘í–‰ ì§€ê¸‰ ì§€ì›
- âœ… ì£¼ì°¨ë³„ í†µê³„

### 8.2 Phase 2 (í–¥í›„)
- ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ
- ì§€ê¸‰ ì˜ˆì¸¡ ì•Œë¦¼
- ìë™ ë³´ê³ ì„œ ìƒì„±

### 8.3 Phase 3 (ë¯¸ë˜)
- AI ê¸°ë°˜ ì˜ˆì¸¡
- ì´ìƒ íƒì§€
- ìµœì í™” ì œì•ˆ

---

## ë¶€ë¡

### A. ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ê³„ì‚° ê³µì‹

```
ì´ë§¤ì¶œ = í•´ë‹¹ ì›” ì‹ ê·œ ê°€ì… ì¸ì› Ã— 100ë§Œì›

F1 ê°œì¸ ì§€ê¸‰ì•¡ = (ì´ë§¤ì¶œ Ã— 24%) Ã· (F1 ì¸ì› + F2 ì¸ì›)
F2 ê°œì¸ ì§€ê¸‰ì•¡ = F1 ì§€ê¸‰ì•¡ + (ì´ë§¤ì¶œ Ã— 19%) Ã· (F2 ì¸ì› + F3 ì¸ì›)
F3 ê°œì¸ ì§€ê¸‰ì•¡ = F2 ì§€ê¸‰ì•¡ + (ì´ë§¤ì¶œ Ã— 14%) Ã· (F3 ì¸ì› + F4 ì¸ì›)
...
```

### B. ì£¼ì°¨ ê³„ì‚° ë¡œì§

```javascript
// ISO ì£¼ì°¨ ê³„ì‚°
function getISOWeek(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  const yearStart = new Date(d.getFullYear(), 0, 1);
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
}

// ê¸ˆìš”ì¼ ê¸°ì¤€ ì›”ë³„ ì£¼ì°¨
function getWeekOfMonthByFriday(date) {
  const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
  const firstFriday = getFirstFridayOfMonth(date);
  const daysDiff = Math.floor((date - firstFriday) / (1000 * 60 * 60 * 24));
  const week = Math.floor(daysDiff / 7) + 1;
  return { week, weekNumber: getISOWeek(date) };
}
```

---

**ë¬¸ì„œ ë**

_ì´ ë¬¸ì„œëŠ” ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ ê²€í† ë¬¸ì„œ v3.0 ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤._
