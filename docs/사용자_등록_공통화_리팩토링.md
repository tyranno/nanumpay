# 사용자 등록 공통화 리팩토링 (v7.0)

**작성일**: 2025-10-13
**목적**: bulk(일괄 등록)와 register(개별 등록)의 공통 로직 추출 및 통합

---

## 📌 리팩토링 배경

### 문제점
1. **코드 중복**: bulk와 register에 동일한 로직이 중복됨
   - loginId 자동 생성
   - sequence 할당
   - 비밀번호 처리
   - User 생성 기본 필드
   - 배치 처리 호출

2. **검증 불일치**: register는 간단한 검증만 수행
   - bulk: 판매인 순서 검증, 트리 재구성
   - register: 부모 노드만 확인, 트리 재구성 없음

3. **유지보수 어려움**: 두 엔드포인트를 따로 수정해야 함

### 해결 방안
- **핵심 아이디어**: register는 "1명짜리 bulk"로 처리
- bulk의 검증된 로직을 공통 서비스로 추출
- 두 엔드포인트 모두 동일한 서비스 사용

---

## 🏗️ 새로운 구조

### Before (리팩토링 전)
```
bulk/+server.js (535줄)
├── 엑셀 파싱 및 검증
├── 사용자 생성
├── 트리 재구성
└── 배치 처리

register/+server.js (192줄)
├── 사용자 생성 (부모 설정)
├── 부모 노드 업데이트
└── 배치 처리 (batchProcessor)

batchProcessor.js (46줄)
└── registrationService로 위임만

총: 773줄 (중복 많음)
```

### After (리팩토링 후)
```
userRegistrationService.js (신규, 558줄) ⭐
├── validateUsers() - 판매인 검증, 루트 제한
├── createUsers() - loginId 생성, User.save()
├── restructureTree() - smartTreeRestructure 호출
└── processBatch() - registrationService 호출

bulk/+server.js (130줄) ⭐
├── 엑셀 파싱
└── userRegistrationService.registerUsers() 호출

register/+server.js (119줄) ⭐
├── 1명 데이터를 배열로 변환
└── userRegistrationService.registerUsers() 호출 ⭐

총: 807줄 (중복 제거, 명확한 책임 분리)
```

---

## 📊 코드 감소 효과

| 파일 | Before | After | 변화 |
|-----|--------|-------|------|
| bulk/+server.js | 535줄 | 130줄 | **-405줄** ⭐ |
| register/+server.js | 192줄 | 119줄 | **-73줄** |
| userRegistrationService.js | 0줄 | 558줄 | **+558줄** (신규) |
| **총계** | **727줄** | **807줄** | **+80줄** |

**결과**:
- 중복 로직 완전 제거
- 코드는 80줄 증가했지만 명확한 책임 분리
- 유지보수성 대폭 향상

---

## 🔧 주요 변경 사항

### 1. userRegistrationService.js (신규)

#### 클래스 구조
```javascript
export class UserRegistrationService {
  constructor() {
    this.registeredUsers = new Map();
    this.excelUserNames = new Set();
  }

  async registerUsers(users, options = {}) {
    // 메인 등록 함수
    // 1. validateUsers()
    // 2. createUsers()
    // 3. restructureTree()
    // 4. processBatch()
  }

  async validateUsers(users) {
    // 판매인 검증
    // 최상위 루트 1개 제한
    // 순서 검증
  }

  async createUsers(users) {
    // loginId 자동 생성
    // sequence 할당
    // User.save()
  }

  async restructureTree() {
    // smartTreeRestructure 호출
  }

  async processBatch() {
    // registrationService 호출
  }
}
```

#### 핵심 로직
```javascript
// bulk의 라인 64-519 로직 추출
// - 사전 검증 (64-195)
// - 사용자 생성 (197-406)
// - 트리 재구성 (408-461)
// - 배치 처리 (474-519)
```

### 2. bulk/+server.js (간소화)

#### Before (535줄)
```javascript
// 1. 사전 검증 (130줄)
// 2. 사용자 생성 (210줄)
// 3. 트리 재구성 (50줄)
// 4. 배치 처리 (45줄)
// 5. 엑셀 템플릿 (100줄)
```

#### After (130줄)
```javascript
import { userRegistrationService } from '$lib/server/services/userRegistrationService.js';

export async function POST({ request, locals }) {
  // 권한 확인
  const { users } = await request.json();

  // 공통 등록 서비스 호출
  const results = await userRegistrationService.registerUsers(users, {
    source: 'bulk',
    admin: locals.user
  });

  return json(results);
}

export async function GET({ locals }) {
  // 엑셀 템플릿 다운로드 (유지)
}
```

### 3. register/+server.js (간소화)

#### Before (192줄)
```javascript
// 1. loginId 생성 (15줄)
// 2. 부모 찾기 (40줄)
// 3. 위치 자동 할당 (30줄)
// 4. sequence 할당 (5줄)
// 5. User 생성 (30줄)
// 6. 부모 노드 업데이트 (20줄)
// 7. 배치 처리 (10줄)
```

#### After (119줄) ⭐
```javascript
import { userRegistrationService } from '$lib/server/services/userRegistrationService.js';

export async function POST({ request, locals }) {
  // 권한 확인
  const data = await request.json();

  // 단일 사용자를 배열로 변환 (bulk 형식)
  const singleUserArray = [{
    '성명': data.name,
    '연락처': data.phone,
    '판매인': data.salesperson || '',
    '날짜': data.registrationDate || new Date().toISOString(),
    ...data
  }];

  // 공통 등록 서비스 호출 (1명짜리 bulk) ⭐
  const results = await userRegistrationService.registerUsers(singleUserArray, {
    source: 'register',
    admin: locals.user
  });

  return json({
    user: results.users[0],
    message: '사용자 등록 완료'
  });
}
```

---

## ✅ 장점

### 1. 코드 중복 제거
- loginId 생성 로직: 1곳에만 존재
- sequence 할당: 1곳에만 존재
- 비밀번호 처리: 1곳에만 존재
- User 생성: 1곳에만 존재

### 2. 검증 로직 통일
- **Before**: register는 간단한 부모 확인만
- **After**: register도 bulk와 동일한 판매인 검증 + 트리 재구성

### 3. 일관성 보장
- 개별 등록이든 일괄 등록이든 동일한 처리 흐름
- 동일한 검증 규칙 적용
- 동일한 트리 재구성 로직

### 4. 유지보수 용이
- 한 곳만 수정하면 bulk/register 모두 반영
- 버그 수정 시 일관성 유지
- 새 기능 추가 시 자동 적용

### 5. 테스트 용이
- userRegistrationService만 단위 테스트하면 됨
- bulk/register는 통합 테스트만 수행

---

## 🔄 처리 흐름

### 개별 등록 (register)
```
1. 사용자 입력
   ↓
2. register/+server.js
   - 1명 데이터를 배열로 변환 [{name, phone, ...}]
   ↓
3. userRegistrationService.registerUsers([1명])
   ├─ validateUsers(): 판매인 검증 (DB만 확인, 1명이므로 순서 자동 통과)
   ├─ createUsers(): User 생성
   ├─ restructureTree(): smartTreeRestructure (1명도 처리)
   └─ processBatch(): 등급 계산, 매출, 지급계획
   ↓
4. 결과 반환
```

### 일괄 등록 (bulk)
```
1. 엑셀 파일 업로드
   ↓
2. bulk/+server.js
   - 엑셀 파싱 → users 배열
   ↓
3. userRegistrationService.registerUsers(users)
   ├─ validateUsers(): 판매인 검증 (엑셀 내 + DB)
   ├─ createUsers(): User 생성
   ├─ restructureTree(): smartTreeRestructure (전체)
   └─ processBatch(): 등급 계산, 매출, 지급계획
   ↓
4. 결과 반환
```

---

## 🎯 향후 개선 방향

### 1. batchProcessor.js 제거 검토
- 현재: registrationService로 단순 위임만
- 옵션 1: 제거하고 userRegistrationService에서 직접 호출
- 옵션 2: 큐 관리 등 추가 기능 구현

### 2. 헬퍼 함수 추출
```javascript
// 중복되는 getValue 함수 추출
export function getExcelValue(obj, keys) {
  for (const key of keys) {
    const value = obj[key];
    if (value !== undefined && value !== null && value !== '') {
      return String(value).trim();
    }
  }
  return '';
}
```

### 3. 날짜 처리 로직 분리
```javascript
// 엑셀 날짜 변환 로직 별도 함수로
export function parseExcelDate(dateValue) {
  if (!dateValue) return new Date();

  if (!isNaN(dateValue)) {
    // Excel 날짜 숫자
    return new Date((parseInt(dateValue) - 25569) * 86400 * 1000);
  }

  // 문자열 날짜
  const parsed = new Date(dateValue);
  return isNaN(parsed.getTime()) ? new Date() : parsed;
}
```

### 4. 에러 메시지 개선
- 사용자 친화적인 에러 메시지
- 다국어 지원 준비

---

## 📝 테스트 체크리스트

### 개별 등록 (register)
- [ ] 정상 등록 (판매인 있음)
- [ ] 정상 등록 (판매인 없음 - 루트)
- [ ] 판매인 없음 에러
- [ ] 자기 자신 판매인 에러
- [ ] 필수 필드 누락 에러
- [ ] 중복 등록 에러
- [ ] 트리 재구성 확인
- [ ] 배치 처리 확인 (등급, 매출, 지급계획)

### 일괄 등록 (bulk)
- [ ] 정상 등록 (다수)
- [ ] 판매인 순서 검증
- [ ] 최상위 루트 1개 제한
- [ ] 엑셀 내 판매인 참조
- [ ] DB 판매인 참조
- [ ] 혼합 (엑셀 + DB 판매인)
- [ ] 트리 재구성 확인
- [ ] 배치 처리 확인

### 엣지 케이스
- [ ] 1명 일괄 등록 (bulk → register와 동일 결과)
- [ ] 판매인이 나중에 등록되는 경우
- [ ] 날짜 필드 다양한 형식

---

## 🔗 관련 파일

### 신규 파일
- [apps/web/src/lib/server/services/userRegistrationService.js](../apps/web/src/lib/server/services/userRegistrationService.js)

### 수정된 파일
- [apps/web/src/routes/api/admin/users/bulk/+server.js](../apps/web/src/routes/api/admin/users/bulk/+server.js)
- [apps/web/src/routes/api/admin/users/register/+server.js](../apps/web/src/routes/api/admin/users/register/+server.js)

### 관련 서비스
- [apps/web/src/lib/server/services/treeRestructure.js](../apps/web/src/lib/server/services/treeRestructure.js) - 트리 재구성
- [apps/web/src/lib/server/services/validationService.js](../apps/web/src/lib/server/services/validationService.js) - 검증
- [apps/web/src/lib/server/services/registrationService.js](../apps/web/src/lib/server/services/registrationService.js) - 배치 처리

---

**작성자**: Claude (AI Assistant)
**마지막 업데이트**: 2025-10-13
