# ì‚¬ìš©ì ë“±ë¡ ê³µí†µí™” ë¦¬íŒ©í† ë§ (v7.0)

**ì‘ì„±ì¼**: 2025-10-13
**ëª©ì **: bulk(ì¼ê´„ ë“±ë¡)ì™€ register(ê°œë³„ ë“±ë¡)ì˜ ê³µí†µ ë¡œì§ ì¶”ì¶œ ë° í†µí•©

---

## ğŸ“Œ ë¦¬íŒ©í† ë§ ë°°ê²½

### ë¬¸ì œì 
1. **ì½”ë“œ ì¤‘ë³µ**: bulkì™€ registerì— ë™ì¼í•œ ë¡œì§ì´ ì¤‘ë³µë¨
   - loginId ìë™ ìƒì„±
   - sequence í• ë‹¹
   - ë¹„ë°€ë²ˆí˜¸ ì²˜ë¦¬
   - User ìƒì„± ê¸°ë³¸ í•„ë“œ
   - ë°°ì¹˜ ì²˜ë¦¬ í˜¸ì¶œ

2. **ê²€ì¦ ë¶ˆì¼ì¹˜**: registerëŠ” ê°„ë‹¨í•œ ê²€ì¦ë§Œ ìˆ˜í–‰
   - bulk: íŒë§¤ì¸ ìˆœì„œ ê²€ì¦, íŠ¸ë¦¬ ì¬êµ¬ì„±
   - register: ë¶€ëª¨ ë…¸ë“œë§Œ í™•ì¸, íŠ¸ë¦¬ ì¬êµ¬ì„± ì—†ìŒ

3. **ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€**: ë‘ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë”°ë¡œ ìˆ˜ì •í•´ì•¼ í•¨

### í•´ê²° ë°©ì•ˆ
- **í•µì‹¬ ì•„ì´ë””ì–´**: registerëŠ” "1ëª…ì§œë¦¬ bulk"ë¡œ ì²˜ë¦¬
- bulkì˜ ê²€ì¦ëœ ë¡œì§ì„ ê³µí†µ ì„œë¹„ìŠ¤ë¡œ ì¶”ì¶œ
- ë‘ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ ë™ì¼í•œ ì„œë¹„ìŠ¤ ì‚¬ìš©

---

## ğŸ—ï¸ ìƒˆë¡œìš´ êµ¬ì¡°

### Before (ë¦¬íŒ©í† ë§ ì „)
```
bulk/+server.js (535ì¤„)
â”œâ”€â”€ ì—‘ì…€ íŒŒì‹± ë° ê²€ì¦
â”œâ”€â”€ ì‚¬ìš©ì ìƒì„±
â”œâ”€â”€ íŠ¸ë¦¬ ì¬êµ¬ì„±
â””â”€â”€ ë°°ì¹˜ ì²˜ë¦¬

register/+server.js (192ì¤„)
â”œâ”€â”€ ì‚¬ìš©ì ìƒì„± (ë¶€ëª¨ ì„¤ì •)
â”œâ”€â”€ ë¶€ëª¨ ë…¸ë“œ ì—…ë°ì´íŠ¸
â””â”€â”€ ë°°ì¹˜ ì²˜ë¦¬ (batchProcessor)

batchProcessor.js (46ì¤„)
â””â”€â”€ registrationServiceë¡œ ìœ„ì„ë§Œ

ì´: 773ì¤„ (ì¤‘ë³µ ë§ìŒ)
```

### After (ë¦¬íŒ©í† ë§ í›„)
```
userRegistrationService.js (ì‹ ê·œ, 558ì¤„) â­
â”œâ”€â”€ validateUsers() - íŒë§¤ì¸ ê²€ì¦, ë£¨íŠ¸ ì œí•œ
â”œâ”€â”€ createUsers() - loginId ìƒì„±, User.save()
â”œâ”€â”€ restructureTree() - smartTreeRestructure í˜¸ì¶œ
â””â”€â”€ processBatch() - registrationService í˜¸ì¶œ

bulk/+server.js (130ì¤„) â­
â”œâ”€â”€ ì—‘ì…€ íŒŒì‹±
â””â”€â”€ userRegistrationService.registerUsers() í˜¸ì¶œ

register/+server.js (119ì¤„) â­
â”œâ”€â”€ 1ëª… ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
â””â”€â”€ userRegistrationService.registerUsers() í˜¸ì¶œ â­

ì´: 807ì¤„ (ì¤‘ë³µ ì œê±°, ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬)
```

---

## ğŸ“Š ì½”ë“œ ê°ì†Œ íš¨ê³¼

| íŒŒì¼ | Before | After | ë³€í™” |
|-----|--------|-------|------|
| bulk/+server.js | 535ì¤„ | 130ì¤„ | **-405ì¤„** â­ |
| register/+server.js | 192ì¤„ | 119ì¤„ | **-73ì¤„** |
| userRegistrationService.js | 0ì¤„ | 558ì¤„ | **+558ì¤„** (ì‹ ê·œ) |
| **ì´ê³„** | **727ì¤„** | **807ì¤„** | **+80ì¤„** |

**ê²°ê³¼**:
- ì¤‘ë³µ ë¡œì§ ì™„ì „ ì œê±°
- ì½”ë“œëŠ” 80ì¤„ ì¦ê°€í–ˆì§€ë§Œ ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬
- ìœ ì§€ë³´ìˆ˜ì„± ëŒ€í­ í–¥ìƒ

---

## ğŸ”§ ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 1. userRegistrationService.js (ì‹ ê·œ)

#### í´ë˜ìŠ¤ êµ¬ì¡°
```javascript
export class UserRegistrationService {
  constructor() {
    this.registeredUsers = new Map();
    this.excelUserNames = new Set();
  }

  async registerUsers(users, options = {}) {
    // ë©”ì¸ ë“±ë¡ í•¨ìˆ˜
    // 1. validateUsers()
    // 2. createUsers()
    // 3. restructureTree()
    // 4. processBatch()
  }

  async validateUsers(users) {
    // íŒë§¤ì¸ ê²€ì¦
    // ìµœìƒìœ„ ë£¨íŠ¸ 1ê°œ ì œí•œ
    // ìˆœì„œ ê²€ì¦
  }

  async createUsers(users) {
    // loginId ìë™ ìƒì„±
    // sequence í• ë‹¹
    // User.save()
  }

  async restructureTree() {
    // smartTreeRestructure í˜¸ì¶œ
  }

  async processBatch() {
    // registrationService í˜¸ì¶œ
  }
}
```

#### í•µì‹¬ ë¡œì§
```javascript
// bulkì˜ ë¼ì¸ 64-519 ë¡œì§ ì¶”ì¶œ
// - ì‚¬ì „ ê²€ì¦ (64-195)
// - ì‚¬ìš©ì ìƒì„± (197-406)
// - íŠ¸ë¦¬ ì¬êµ¬ì„± (408-461)
// - ë°°ì¹˜ ì²˜ë¦¬ (474-519)
```

### 2. bulk/+server.js (ê°„ì†Œí™”)

#### Before (535ì¤„)
```javascript
// 1. ì‚¬ì „ ê²€ì¦ (130ì¤„)
// 2. ì‚¬ìš©ì ìƒì„± (210ì¤„)
// 3. íŠ¸ë¦¬ ì¬êµ¬ì„± (50ì¤„)
// 4. ë°°ì¹˜ ì²˜ë¦¬ (45ì¤„)
// 5. ì—‘ì…€ í…œí”Œë¦¿ (100ì¤„)
```

#### After (130ì¤„)
```javascript
import { userRegistrationService } from '$lib/server/services/userRegistrationService.js';

export async function POST({ request, locals }) {
  // ê¶Œí•œ í™•ì¸
  const { users } = await request.json();

  // ê³µí†µ ë“±ë¡ ì„œë¹„ìŠ¤ í˜¸ì¶œ
  const results = await userRegistrationService.registerUsers(users, {
    source: 'bulk',
    admin: locals.user
  });

  return json(results);
}

export async function GET({ locals }) {
  // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ (ìœ ì§€)
}
```

### 3. register/+server.js (ê°„ì†Œí™”)

#### Before (192ì¤„)
```javascript
// 1. loginId ìƒì„± (15ì¤„)
// 2. ë¶€ëª¨ ì°¾ê¸° (40ì¤„)
// 3. ìœ„ì¹˜ ìë™ í• ë‹¹ (30ì¤„)
// 4. sequence í• ë‹¹ (5ì¤„)
// 5. User ìƒì„± (30ì¤„)
// 6. ë¶€ëª¨ ë…¸ë“œ ì—…ë°ì´íŠ¸ (20ì¤„)
// 7. ë°°ì¹˜ ì²˜ë¦¬ (10ì¤„)
```

#### After (119ì¤„) â­
```javascript
import { userRegistrationService } from '$lib/server/services/userRegistrationService.js';

export async function POST({ request, locals }) {
  // ê¶Œí•œ í™•ì¸
  const data = await request.json();

  // ë‹¨ì¼ ì‚¬ìš©ìë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (bulk í˜•ì‹)
  const singleUserArray = [{
    'ì„±ëª…': data.name,
    'ì—°ë½ì²˜': data.phone,
    'íŒë§¤ì¸': data.salesperson || '',
    'ë‚ ì§œ': data.registrationDate || new Date().toISOString(),
    ...data
  }];

  // ê³µí†µ ë“±ë¡ ì„œë¹„ìŠ¤ í˜¸ì¶œ (1ëª…ì§œë¦¬ bulk) â­
  const results = await userRegistrationService.registerUsers(singleUserArray, {
    source: 'register',
    admin: locals.user
  });

  return json({
    user: results.users[0],
    message: 'ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ'
  });
}
```

---

## âœ… ì¥ì 

### 1. ì½”ë“œ ì¤‘ë³µ ì œê±°
- loginId ìƒì„± ë¡œì§: 1ê³³ì—ë§Œ ì¡´ì¬
- sequence í• ë‹¹: 1ê³³ì—ë§Œ ì¡´ì¬
- ë¹„ë°€ë²ˆí˜¸ ì²˜ë¦¬: 1ê³³ì—ë§Œ ì¡´ì¬
- User ìƒì„±: 1ê³³ì—ë§Œ ì¡´ì¬

### 2. ê²€ì¦ ë¡œì§ í†µì¼
- **Before**: registerëŠ” ê°„ë‹¨í•œ ë¶€ëª¨ í™•ì¸ë§Œ
- **After**: registerë„ bulkì™€ ë™ì¼í•œ íŒë§¤ì¸ ê²€ì¦ + íŠ¸ë¦¬ ì¬êµ¬ì„±

### 3. ì¼ê´€ì„± ë³´ì¥
- ê°œë³„ ë“±ë¡ì´ë“  ì¼ê´„ ë“±ë¡ì´ë“  ë™ì¼í•œ ì²˜ë¦¬ íë¦„
- ë™ì¼í•œ ê²€ì¦ ê·œì¹™ ì ìš©
- ë™ì¼í•œ íŠ¸ë¦¬ ì¬êµ¬ì„± ë¡œì§

### 4. ìœ ì§€ë³´ìˆ˜ ìš©ì´
- í•œ ê³³ë§Œ ìˆ˜ì •í•˜ë©´ bulk/register ëª¨ë‘ ë°˜ì˜
- ë²„ê·¸ ìˆ˜ì • ì‹œ ì¼ê´€ì„± ìœ ì§€
- ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ìë™ ì ìš©

### 5. í…ŒìŠ¤íŠ¸ ìš©ì´
- userRegistrationServiceë§Œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ë©´ ë¨
- bulk/registerëŠ” í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ìˆ˜í–‰

---

## ğŸ”„ ì²˜ë¦¬ íë¦„

### ê°œë³„ ë“±ë¡ (register)
```
1. ì‚¬ìš©ì ì…ë ¥
   â†“
2. register/+server.js
   - 1ëª… ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜ [{name, phone, ...}]
   â†“
3. userRegistrationService.registerUsers([1ëª…])
   â”œâ”€ validateUsers(): íŒë§¤ì¸ ê²€ì¦ (DBë§Œ í™•ì¸, 1ëª…ì´ë¯€ë¡œ ìˆœì„œ ìë™ í†µê³¼)
   â”œâ”€ createUsers(): User ìƒì„±
   â”œâ”€ restructureTree(): smartTreeRestructure (1ëª…ë„ ì²˜ë¦¬)
   â””â”€ processBatch(): ë“±ê¸‰ ê³„ì‚°, ë§¤ì¶œ, ì§€ê¸‰ê³„íš
   â†“
4. ê²°ê³¼ ë°˜í™˜
```

### ì¼ê´„ ë“±ë¡ (bulk)
```
1. ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
   â†“
2. bulk/+server.js
   - ì—‘ì…€ íŒŒì‹± â†’ users ë°°ì—´
   â†“
3. userRegistrationService.registerUsers(users)
   â”œâ”€ validateUsers(): íŒë§¤ì¸ ê²€ì¦ (ì—‘ì…€ ë‚´ + DB)
   â”œâ”€ createUsers(): User ìƒì„±
   â”œâ”€ restructureTree(): smartTreeRestructure (ì „ì²´)
   â””â”€ processBatch(): ë“±ê¸‰ ê³„ì‚°, ë§¤ì¶œ, ì§€ê¸‰ê³„íš
   â†“
4. ê²°ê³¼ ë°˜í™˜
```

---

## ğŸ¯ í–¥í›„ ê°œì„  ë°©í–¥

### 1. batchProcessor.js ì œê±° ê²€í† 
- í˜„ì¬: registrationServiceë¡œ ë‹¨ìˆœ ìœ„ì„ë§Œ
- ì˜µì…˜ 1: ì œê±°í•˜ê³  userRegistrationServiceì—ì„œ ì§ì ‘ í˜¸ì¶œ
- ì˜µì…˜ 2: í ê´€ë¦¬ ë“± ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„

### 2. í—¬í¼ í•¨ìˆ˜ ì¶”ì¶œ
```javascript
// ì¤‘ë³µë˜ëŠ” getValue í•¨ìˆ˜ ì¶”ì¶œ
export function getExcelValue(obj, keys) {
  for (const key of keys) {
    const value = obj[key];
    if (value !== undefined && value !== null && value !== '') {
      return String(value).trim();
    }
  }
  return '';
}
```

### 3. ë‚ ì§œ ì²˜ë¦¬ ë¡œì§ ë¶„ë¦¬
```javascript
// ì—‘ì…€ ë‚ ì§œ ë³€í™˜ ë¡œì§ ë³„ë„ í•¨ìˆ˜ë¡œ
export function parseExcelDate(dateValue) {
  if (!dateValue) return new Date();

  if (!isNaN(dateValue)) {
    // Excel ë‚ ì§œ ìˆ«ì
    return new Date((parseInt(dateValue) - 25569) * 86400 * 1000);
  }

  // ë¬¸ìì—´ ë‚ ì§œ
  const parsed = new Date(dateValue);
  return isNaN(parsed.getTime()) ? new Date() : parsed;
}
```

### 4. ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 
- ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
- ë‹¤êµ­ì–´ ì§€ì› ì¤€ë¹„

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê°œë³„ ë“±ë¡ (register)
- [ ] ì •ìƒ ë“±ë¡ (íŒë§¤ì¸ ìˆìŒ)
- [ ] ì •ìƒ ë“±ë¡ (íŒë§¤ì¸ ì—†ìŒ - ë£¨íŠ¸)
- [ ] íŒë§¤ì¸ ì—†ìŒ ì—ëŸ¬
- [ ] ìê¸° ìì‹  íŒë§¤ì¸ ì—ëŸ¬
- [ ] í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ì—ëŸ¬
- [ ] ì¤‘ë³µ ë“±ë¡ ì—ëŸ¬
- [ ] íŠ¸ë¦¬ ì¬êµ¬ì„± í™•ì¸
- [ ] ë°°ì¹˜ ì²˜ë¦¬ í™•ì¸ (ë“±ê¸‰, ë§¤ì¶œ, ì§€ê¸‰ê³„íš)

### ì¼ê´„ ë“±ë¡ (bulk)
- [ ] ì •ìƒ ë“±ë¡ (ë‹¤ìˆ˜)
- [ ] íŒë§¤ì¸ ìˆœì„œ ê²€ì¦
- [ ] ìµœìƒìœ„ ë£¨íŠ¸ 1ê°œ ì œí•œ
- [ ] ì—‘ì…€ ë‚´ íŒë§¤ì¸ ì°¸ì¡°
- [ ] DB íŒë§¤ì¸ ì°¸ì¡°
- [ ] í˜¼í•© (ì—‘ì…€ + DB íŒë§¤ì¸)
- [ ] íŠ¸ë¦¬ ì¬êµ¬ì„± í™•ì¸
- [ ] ë°°ì¹˜ ì²˜ë¦¬ í™•ì¸

### ì—£ì§€ ì¼€ì´ìŠ¤
- [ ] 1ëª… ì¼ê´„ ë“±ë¡ (bulk â†’ registerì™€ ë™ì¼ ê²°ê³¼)
- [ ] íŒë§¤ì¸ì´ ë‚˜ì¤‘ì— ë“±ë¡ë˜ëŠ” ê²½ìš°
- [ ] ë‚ ì§œ í•„ë“œ ë‹¤ì–‘í•œ í˜•ì‹

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

### ì‹ ê·œ íŒŒì¼
- [apps/web/src/lib/server/services/userRegistrationService.js](../apps/web/src/lib/server/services/userRegistrationService.js)

### ìˆ˜ì •ëœ íŒŒì¼
- [apps/web/src/routes/api/admin/users/bulk/+server.js](../apps/web/src/routes/api/admin/users/bulk/+server.js)
- [apps/web/src/routes/api/admin/users/register/+server.js](../apps/web/src/routes/api/admin/users/register/+server.js)

### ê´€ë ¨ ì„œë¹„ìŠ¤
- [apps/web/src/lib/server/services/treeRestructure.js](../apps/web/src/lib/server/services/treeRestructure.js) - íŠ¸ë¦¬ ì¬êµ¬ì„±
- [apps/web/src/lib/server/services/validationService.js](../apps/web/src/lib/server/services/validationService.js) - ê²€ì¦
- [apps/web/src/lib/server/services/registrationService.js](../apps/web/src/lib/server/services/registrationService.js) - ë°°ì¹˜ ì²˜ë¦¬

---

**ì‘ì„±ì**: Claude (AI Assistant)
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-13
