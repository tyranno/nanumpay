# 고급 설정 - 개발 시 주의사항

## 1. SystemConfig 개요

`SystemConfig`는 비즈니스 로직에 영향을 미치는 시스템 설정을 관리하는 모델입니다.

**파일 위치**: `apps/web/src/lib/server/models/SystemConfig.js`

### 특징
- 코드에서 기본값 정의 (상수처럼 동작)
- UI 없음 → MongoDB에서 직접 수정
- 변경 시 비즈니스 로직 전체에 영향

---

## 2. 현재 설정 항목

### 등급별 비율 (gradeRatios)
```javascript
gradeRatios: {
    F1: 0.24,
    F2: 0.19,
    F3: 0.14,
    F4: 0.09,
    F5: 0.05,
    F6: 0.03,
    F7: 0.02,
    F8: 0.01
}
```

### 등급별 최대 지급 횟수 (maxPaymentCounts)
```javascript
maxPaymentCounts: {
    F1: 20,
    F2: 30,
    F3: 30,
    F4: 40,
    F5: 40,
    F6: 50,
    F7: 50,
    F8: 50
}
```

### F4+ 보험 최소 금액 (minInsuranceAmounts)
```javascript
minInsuranceAmounts: {
    F4: 70000,
    F5: 70000,
    F6: 90000,
    F7: 90000,
    F8: 110000
}
```

### 시스템 설정
```javascript
withholdingTaxRate: 0.033,      // 원천징수율 3.3%
revenuePerUser: 1000000,        // 용역자 1명당 매출 100만원
installmentCount: 10            // 분할 횟수 10회
```

### 설계사 수당 설정
```javascript
plannerCommissionByRatio: false  // false: 10만원 고정, true: 비율 적용
```

---

## 3. 설정 변경 방법

### MongoDB에서 직접 수정

```bash
# MongoDB 접속
mongosh mongodb://localhost:27017/nanumpay
```

```javascript
// 현재 설정 확인
db.systemconfigs.findOne({ configType: 'current' })

// 설계사 수당 비율 적용 활성화
db.systemconfigs.updateOne(
  { configType: 'current' },
  { $set: { plannerCommissionByRatio: true, updatedAt: new Date() } }
)

// 등급별 비율 변경 예시
db.systemconfigs.updateOne(
  { configType: 'current' },
  { $set: { 'gradeRatios.F1': 0.25, updatedAt: new Date() } }
)
```

### 코드에서 사용
```javascript
import SystemConfig from '$lib/server/models/SystemConfig.js';

// 현재 설정 로드
const config = await SystemConfig.getCurrent();

// 사용 예시
const useRatioCommission = config.plannerCommissionByRatio ?? false;
const taxRate = config.withholdingTaxRate ?? 0.033;
```

---

## 4. 주의사항

### 변경 전 필수 확인
1. **영향 범위 파악**: 설정 변경 시 어떤 로직이 영향받는지 확인
2. **기존 데이터**: 이미 생성된 지급 계획은 영향받지 않음 (새로 생성되는 것만)
3. **재처리 필요 여부**: 기존 데이터도 반영하려면 월 재처리 필요

### 설정별 영향 범위

| 설정 | 영향 받는 로직 | 재처리 필요 |
|------|--------------|------------|
| `gradeRatios` | 지급 금액 계산 | O |
| `maxPaymentCounts` | 추가지급 생성 조건 | X |
| `minInsuranceAmounts` | 보험 조건 확인 | X |
| `withholdingTaxRate` | 세금 계산 | O |
| `revenuePerUser` | 매출 계산 | O |
| `plannerCommissionByRatio` | 설계사 수당 계산 | O |

### 절대 변경 금지 (운영 중)
- `installmentCount`: 10회 고정 (변경 시 전체 로직 붕괴)
- `revenuePerUser`: 100만원 고정 (계약 기준)

---

## 5. UI 구현 시 고려사항 (향후)

### 필수 보안 기능
1. **별도 탭 분리**: "고급 설정" 또는 "위험 설정" 탭
2. **2단계 확인**: 확인 모달 2번 (변경 확인 → 재처리 경고)
3. **변경 이력 로깅**: 누가, 언제, 무엇을 변경했는지 기록
4. **권한 분리**: 슈퍼관리자만 접근 가능

### UI 구조 예시
```
관리자 설정
├── 관리자 정보
├── 암호 변경
├── 시스템 설정 (백업 등)
└── 고급 설정 (위험) ← 새 탭
    ├── 설계사 수당 비율 적용 [토글]
    ├── 등급별 비율 [표]
    └── ...
```

### 변경 프로세스
```
1. 설정 변경 요청
   ↓
2. 1차 확인: "정말 변경하시겠습니까?"
   ↓
3. 2차 경고: "기존 데이터는 영향받지 않습니다. 재처리가 필요할 수 있습니다."
   ↓
4. 변경 실행
   ↓
5. 변경 이력 저장 (변경 전/후 값, 시간, 관리자)
   ↓
6. 완료 메시지 + 재처리 안내
```

---

## 6. 관련 파일

| 파일 | 역할 |
|------|------|
| `models/SystemConfig.js` | 설정 스키마 정의 |
| `services/registration/step2_gradeAndMonthly.js` | 설계사 수당 계산 |
| `services/paymentPlanService.js` | 지급 계획 생성 |
| `services/weeklyPaymentService.js` | 주간 지급 처리 |

---

## 7. 변경 이력

| 날짜 | 항목 | 변경 내용 |
|------|------|----------|
| 2024-12-14 | `plannerCommissionByRatio` | 신규 추가 (설계사 수당 비율 옵션) |

---

**작성일**: 2024-12-14
**작성자**: Claude (AI Assistant)
