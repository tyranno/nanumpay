# 보안 강화: 로그아웃 및 세션 관리 개선

**작성일**: 2025-10-18
**버전**: v1.0
**작성자**: Claude AI Assistant

---

## 📋 목차

1. [문제 상황](#문제-상황)
2. [해결 방법](#해결-방법)
3. [적용된 보안 조치](#적용된-보안-조치)
4. [수정된 파일 목록](#수정된-파일-목록)
5. [테스트 방법](#테스트-방법)
6. [보안 강화 요약](#보안-강화-요약)

---

## 🚨 문제 상황

### 발견된 보안 취약점

1. **로그아웃 후 브라우저 뒤로가기로 복귀 가능**
   - 로그아웃 버튼 클릭 → 로그인 페이지 이동
   - 브라우저 뒤로가기 → 이전 페이지 캐시 표시
   - **취약점**: 로그아웃했는데도 이전 화면 접근 가능

2. **브라우저 종료 후에도 로그인 상태 유지**
   - 브라우저 완전 종료
   - 브라우저 재시작 후 사이트 접속
   - **취약점**: 자동으로 로그인된 상태로 접속 (공용 PC 위험)

3. **로컬스토리지/세션스토리지 미정리**
   - 로그아웃 시 클라이언트 저장소가 남아있음
   - **취약점**: 이전 사용자 정보 노출 가능

4. **쿠키 삭제 불완전**
   - 로그아웃 API에서 쿠키 삭제 옵션 불일치
   - **취약점**: 쿠키가 완전히 삭제되지 않음

---

## 💡 해결 방법

### 1. 세션 쿠키로 변경 (가장 중요!)

**문제**: 영구 쿠키 사용으로 브라우저 종료 후에도 로그인 유지

**해결**: `maxAge` 제거 → 세션 쿠키로 변경

#### 변경 전 (영구 쿠키)
```javascript
cookies.set('token', accessToken, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 60 * 60,  // 1시간 - 영구 저장 ❌
    path: '/'
});
```

#### 변경 후 (세션 쿠키)
```javascript
cookies.set('token', accessToken, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    path: '/'
    // maxAge 제거 → 브라우저 종료 시 자동 삭제 ✅
});
```

### 2. 로그인 페이지 접근 시 강제 정리

**문제**: `/login` 페이지 접근해도 기존 인증 정보 남아있음

**해결**: hooks.server.js에서 `/login` 접근 시 쿠키 강제 삭제

```javascript
// hooks.server.js
if (event.url.pathname === '/login') {
    event.cookies.delete('token', { path: '/', ... });
    event.cookies.delete('refreshToken', { path: '/', ... });
    event.locals.user = null;
}
```

### 3. 로그아웃 시 3중 방어

**문제**: 로그아웃 시 일부 저장소만 정리됨

**해결**: 서버 쿠키 + 클라이언트 저장소 모두 정리

```javascript
async function logout() {
    // 1. 서버 세션 삭제
    await fetch('/api/auth/logout', { method: 'POST' });

    // 2. 클라이언트 저장소 완전 정리
    localStorage.clear();
    sessionStorage.clear();

    // 3. 히스토리 대체 (뒤로가기 방지)
    goto('/login', { replaceState: true, invalidateAll: true });
}
```

### 4. 브라우저 캐시 방지

**문제**: 뒤로가기 시 캐시된 페이지 표시

**해결**: Cache-Control 헤더 추가

```javascript
// hooks.server.js
if (isProtectedRoute) {
    response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');
    response.headers.set('Pragma', 'no-cache');
    response.headers.set('Expires', '0');
}
```

---

## 🔒 적용된 보안 조치

### 보안 레벨 비교

| 항목 | 이전 | 현재 |
|------|------|------|
| **쿠키 타입** | 영구 쿠키 (7일) | 세션 쿠키 (브라우저 종료 시 삭제) |
| **브라우저 종료** | 로그인 유지 ❌ | 자동 로그아웃 ✅ |
| **로그아웃 처리** | 쿠키만 삭제 | 쿠키 + localStorage + sessionStorage |
| **뒤로가기 방지** | 없음 ❌ | replaceState + Cache-Control ✅ |
| **로그인 페이지** | 기존 쿠키 유지 | 강제 삭제 ✅ |
| **쿠키 삭제** | 옵션 불일치 | 완전 일치 ✅ |

### 보안 흐름도

```
┌─────────────────────────────────────────────────────────┐
│                    로그인 프로세스                        │
└─────────────────────────────────────────────────────────┘
                           ↓
              세션 쿠키 생성 (maxAge 없음)
                           ↓
         ┌─────────────────┴─────────────────┐
         ↓                                   ↓
    브라우저 사용                         브라우저 종료
         ↓                                   ↓
    작업 진행                         세션 쿠키 자동 삭제
         ↓                                   ↓
    로그아웃 버튼                        브라우저 재시작
         ↓                                   ↓
┌────────────────────┐              /login으로 리다이렉트
│   3중 삭제 처리     │
│  1. 서버 쿠키      │
│  2. localStorage   │
│  3. sessionStorage │
└────────────────────┘
         ↓
    /login (replaceState)
         ↓
    강제 쿠키 삭제
         ↓
    완전히 깨끗한 로그인 페이지
```

---

## 📁 수정된 파일 목록

### 1. `/apps/web/src/routes/api/auth/login/+server.js`

**변경 내용**: 세션 쿠키로 변경

```javascript
// 변경 전
cookies.set('token', accessToken, {
    maxAge: 60 * 60  // 영구 쿠키
});

// 변경 후
cookies.set('token', accessToken, {
    // maxAge 제거 → 세션 쿠키
});
```

**라인**: 60-75

### 2. `/apps/web/src/routes/api/auth/logout/+server.js`

**변경 내용**: 쿠키 삭제 옵션 강화

```javascript
cookies.delete('token', {
    path: '/',
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict'
    // 로그인 시 설정한 옵션과 완전히 일치
});
```

**라인**: 5-17

### 3. `/apps/web/src/hooks.server.js`

**변경 내용**:
- 로그인 페이지 접근 시 강제 쿠키 삭제
- 토큰 갱신 시 세션 쿠키 사용
- 보호된 페이지 캐시 방지 헤더 추가

```javascript
// 1. 로그인 페이지 접근 시 강제 삭제 (7-22라인)
if (event.url.pathname === '/login') {
    event.cookies.delete('token', { ... });
    event.cookies.delete('refreshToken', { ... });
    event.locals.user = null;
}

// 2. 토큰 갱신 시 세션 쿠키 (63-69라인)
event.cookies.set('token', newToken, {
    // maxAge 제거
});

// 3. 캐시 방지 헤더 (123-127라인)
if (isProtectedRoute) {
    response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');
}
```

### 4. `/apps/web/src/routes/login/+page.server.js` (신규 생성)

**변경 내용**: 로그인 페이지 로드 시 쿠키 강제 삭제 (2중 방어)

```javascript
export async function load({ cookies }) {
    cookies.delete('token', { ... });
    cookies.delete('refreshToken', { ... });
    return {};
}
```

### 5. `/apps/web/src/routes/login/+page.svelte`

**변경 내용**: onMount에서 클라이언트 저장소 정리

```javascript
import { onMount } from 'svelte';

onMount(() => {
    localStorage.clear();
    sessionStorage.clear();
});
```

**라인**: 12-15

### 6. `/apps/web/src/routes/(admin)/+layout.svelte`

**변경 내용**: 로그아웃 시 저장소 완전 정리

```javascript
async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    localStorage.clear();
    sessionStorage.clear();
    goto('/login', { replaceState: true, invalidateAll: true });
}
```

**라인**: 8-18

### 7. `/apps/web/src/routes/(user)/+layout.svelte`

**변경 내용**: 로그아웃 시 저장소 완전 정리 (관리자와 동일)

**라인**: 7-17

---

## 🧪 테스트 방법

### 사전 준비

```bash
# 1. 서버 재시작
pnpm dev:web --host

# 2. 기존 영구 쿠키 수동 삭제 (필수!)
# 브라우저 개발자 도구(F12) → Application → Cookies → 모두 삭제
```

### 테스트 시나리오 1: 브라우저 종료 시 자동 로그아웃

```
1. 로그인
   http://192.168.56.104:3100/login
   → 관리자 계정 로그인

2. 개발자 도구 확인 (F12)
   Application → Cookies → token
   → Expires / Max-Age: Session ✅

3. 브라우저 완전 종료 (모든 탭 닫기)

4. 브라우저 재시작 후 접속
   http://192.168.56.104:3100/admin
   → /login으로 리다이렉트 ✅

5. 개발자 도구 확인
   Application → Cookies
   → 비어있음 ✅
```

### 테스트 시나리오 2: 로그아웃 후 뒤로가기 차단

```
1. 로그인 → /admin 접속

2. 여러 페이지 이동
   /admin → /admin/payment → /admin/members

3. 로그아웃 버튼 클릭
   → /login으로 이동

4. 개발자 도구 확인
   - Cookies: 비어있음 ✅
   - localStorage: 비어있음 ✅
   - sessionStorage: 비어있음 ✅

5. 브라우저 뒤로가기 버튼 클릭
   → /login 페이지 유지 (이전 페이지로 안 감) ✅
```

### 테스트 시나리오 3: 로그인 페이지 직접 접근

```
1. 로그인된 상태에서 URL 직접 입력
   http://192.168.56.104:3100/login

2. 터미널 로그 확인
   🔍 [AUTH CHECK] {
     path: '/login',
     hasToken: false,  ← 쿠키 삭제됨! ✅
     hasRefreshToken: false
   }

3. 개발자 도구 확인
   → 모든 쿠키 삭제됨 ✅
```

### 테스트 시나리오 4: 로컬스토리지 정리 확인

```
1. 관리자 로그인

2. 용역자 관리 페이지 방문
   /admin/members
   → 컬럼 설정 변경 (tableColumns 저장됨)

3. 개발자 도구 확인
   Application → Local Storage
   → tableColumns 확인

4. 로그아웃

5. 개발자 도구 확인
   Application → Local Storage
   → 완전히 비어있음 ✅
```

### 개발자 도구 체크리스트

로그아웃 후 다음을 모두 확인:

```
F12 → Application 탭

✅ Cookies
   └─ http://192.168.56.104:3100
      └─ (비어있음)

✅ Local Storage
   └─ http://192.168.56.104:3100
      └─ (비어있음)

✅ Session Storage
   └─ http://192.168.56.104:3100
      └─ (비어있음)
```

---

## 📊 보안 강화 요약

### 적용된 보안 조치 (총 6가지)

| # | 보안 조치 | 효과 | 파일 |
|---|----------|------|------|
| 1 | **세션 쿠키 사용** | 브라우저 종료 시 자동 로그아웃 | login/+server.js, hooks.server.js |
| 2 | **로그인 페이지 강제 정리** | `/login` 접근만으로 쿠키 삭제 | hooks.server.js, login/+page.server.js |
| 3 | **로그아웃 3중 정리** | 서버 쿠키 + localStorage + sessionStorage | (admin)/+layout.svelte, (user)/+layout.svelte |
| 4 | **히스토리 대체** | 뒤로가기로 이전 페이지 접근 차단 | (admin)/+layout.svelte, (user)/+layout.svelte |
| 5 | **캐시 방지 헤더** | 보호된 페이지 캐시 방지 | hooks.server.js |
| 6 | **쿠키 삭제 옵션 일치** | 쿠키 완전 삭제 보장 | logout/+server.js |

### 보안 레벨 평가

| 항목 | 이전 | 현재 |
|------|------|------|
| 공용 PC 안전성 | ⚠️ 위험 | ✅ 안전 |
| 브라우저 종료 시 | ❌ 로그인 유지 | ✅ 자동 로그아웃 |
| 로그아웃 완전성 | ⚠️ 부분적 | ✅ 완전 |
| 뒤로가기 보안 | ❌ 취약 | ✅ 차단 |
| 저장소 정리 | ❌ 미흡 | ✅ 완전 |
| **종합 평가** | **보안 취약** | **보안 강화 완료** |

### 보안 개선 효과

✅ **공용 PC에서도 안전하게 사용 가능**
✅ **브라우저 종료만으로 자동 로그아웃**
✅ **이전 사용자 정보 완전 삭제**
✅ **뒤로가기 공격 차단**
✅ **페이지 캐시 공격 차단**
✅ **클라이언트/서버 모두 정리**

---

## 🔍 기술 상세

### 세션 쿠키 vs 영구 쿠키

#### 세션 쿠키 (Session Cookie)
- **설정**: `maxAge` 또는 `expires` 옵션 없음
- **수명**: 브라우저 세션 동안만 유지
- **삭제 시점**: 브라우저 종료 시 자동 삭제
- **용도**: 보안이 중요한 인증 정보
- **장점**: 공용 PC 안전, 자동 로그아웃
- **단점**: 브라우저 닫으면 재로그인 필요

#### 영구 쿠키 (Persistent Cookie)
- **설정**: `maxAge` 또는 `expires` 옵션 지정
- **수명**: 지정된 기간까지 유지 (예: 7일)
- **삭제 시점**: 만료일까지 유지 또는 수동 삭제
- **용도**: "로그인 유지" 기능
- **장점**: 재로그인 불필요
- **단점**: 공용 PC 위험, 보안 취약

### SvelteKit 쿠키 API

```javascript
// 쿠키 설정
cookies.set('name', value, {
    httpOnly: true,      // JavaScript 접근 차단
    secure: true,        // HTTPS만 전송
    sameSite: 'strict',  // CSRF 공격 방지
    path: '/',           // 모든 경로에서 접근
    maxAge: 3600         // 생략 시 세션 쿠키
});

// 쿠키 삭제 (설정 시 옵션과 일치해야 함!)
cookies.delete('name', {
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    path: '/'
});
```

### HTTP 캐시 제어 헤더

```javascript
// 강력한 캐시 방지 (모든 브라우저 대응)
response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
response.headers.set('Pragma', 'no-cache');  // HTTP/1.0 호환
response.headers.set('Expires', '0');         // 만료일 과거로 설정
```

- **no-store**: 캐시 자체를 저장하지 않음
- **no-cache**: 캐시 저장은 하되 매번 서버 검증
- **must-revalidate**: 만료된 캐시 사용 금지
- **proxy-revalidate**: 프록시 서버 캐시도 재검증

### SvelteKit Navigation API

```javascript
// 일반 이동 (히스토리 추가)
goto('/login');

// 히스토리 대체 (뒤로가기 방지)
goto('/login', {
    replaceState: true,    // 현재 히스토리 항목 대체
    invalidateAll: true    // 모든 load 함수 재실행
});
```

---

## 📝 주의사항

### 1. 기존 영구 쿠키 수동 삭제 필요

이번 보안 강화 적용 **전에 로그인한 사용자**는 여전히 영구 쿠키를 가지고 있습니다.

**해결 방법**:
- 사용자에게 로그아웃 요청
- 또는 `/login` 페이지 접근 시 자동 삭제됨
- 또는 브라우저 쿠키 수동 삭제

### 2. 개발 중 테스트 주의

개발자 도구에서 "Disable cache" 체크 시 캐시 방지 테스트가 어려울 수 있음.

**해결 방법**:
- Network 탭에서 "Disable cache" 해제
- 일반 사용자 모드로 테스트

### 3. 프로덕션 배포 전 확인

```bash
# .env 파일 확인
NODE_ENV=production  # secure 쿠키 활성화
```

**프로덕션 환경**에서는 반드시 **HTTPS**를 사용해야 `secure` 쿠키가 작동합니다.

### 4. Remember Me 기능 추가 시

사용자 편의를 위해 "로그인 유지" 기능이 필요하면:

```javascript
// 로그인 시 체크박스 추가
<input type="checkbox" bind:checked={rememberMe} />

// 체크된 경우에만 영구 쿠키 사용
if (rememberMe) {
    cookies.set('token', accessToken, {
        maxAge: 60 * 60 * 24 * 7  // 7일
    });
} else {
    cookies.set('token', accessToken, {
        // 세션 쿠키 (기본)
    });
}
```

---

## 🎯 결론

### 달성한 보안 목표

✅ **브라우저 종료 = 자동 로그아웃**
✅ **로그아웃 = 완전한 정보 삭제**
✅ **뒤로가기 = 이전 페이지 접근 차단**
✅ **공용 PC = 안전하게 사용 가능**

### 보안 원칙

1. **최소 권한 원칙**: 세션 쿠키로 필요한 시간만 유지
2. **심층 방어**: 서버 + 클라이언트 다중 정리
3. **안전한 기본값**: 로그인 유지 기본 OFF
4. **완전한 삭제**: 모든 저장소 정리

### 다음 단계 권장사항

- [ ] 세션 타임아웃 추가 (일정 시간 활동 없으면 자동 로그아웃)
- [ ] "로그인 유지" 옵션 추가 (사용자 선택)
- [ ] 로그인 활동 로그 기록 (감사 추적)
- [ ] 다중 기기 세션 관리 (다른 기기에서 로그아웃)
- [ ] 2단계 인증 (2FA) 추가

---

**문서 버전**: v1.0
**최종 수정일**: 2025-10-18
**관련 문서**: [CLAUDE.md](../CLAUDE.md)
**프로젝트**: Nanumpay MLM 시스템
