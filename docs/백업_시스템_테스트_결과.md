# ë°±ì—… ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

**í…ŒìŠ¤íŠ¸ ì¼ì‹œ**: 2025-10-26 11:15
**í…ŒìŠ¤íŠ¸ í™˜ê²½**: ê°œë°œ ì„œë²„ (localhost)
**í…ŒìŠ¤íŠ¸ ìƒíƒœ**: âœ… í†µê³¼

---

## ğŸ“‹ í…ŒìŠ¤íŠ¸ í•­ëª©

### 1. í™˜ê²½ í™•ì¸ âœ…

| í•­ëª© | ìƒíƒœ | ë²„ì „/ì •ë³´ |
|------|------|----------|
| Bun | âœ… | v1.2.21 |
| MongoDB | âœ… | ì—°ê²° ì •ìƒ |
| mongodump | âœ… | ì„¤ì¹˜ë¨ |

### 2. ë°±ì—… ì•± ë¹Œë“œ âœ…

```bash
cd apps/backup
./build.sh
```

**ê²°ê³¼**:
- ë¹Œë“œ ì„±ê³µ: âœ…
- ì‹¤í–‰ íŒŒì¼ ìƒì„±: `build/nanumpay-backup`
- íŒŒì¼ í¬ê¸°: **123MB**
- ì‹¤í–‰ ê¶Œí•œ: âœ…

**ë¹Œë“œ ë¡œê·¸**:
```
ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...
+ aws-sdk@2.1692.0
+ ftp@0.3.10
+ mongoose@8.19.2
70 packages installed [2.41s]

ğŸ”§ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ ì¤‘...
 [450ms]  bundle  1912 modules
 [891ms] compile  build/nanumpay-backup

âœ… ë¹Œë“œ ì™„ë£Œ!
   íŒŒì¼: build/nanumpay-backup
   í¬ê¸°: 123M
```

### 3. MongoDB ì„¤ì • ì—…ë°ì´íŠ¸ âœ…

```javascript
db.admins.updateOne({}, {
  $set: {
    'systemSettings.backupSettings.enabled': true,
    'systemSettings.backupSettings.backupPath': '/tmp/nanumpay-backups-test',
    'systemSettings.backupSettings.retentionDays': 7,
    'systemSettings.backupSettings.retentionCount': 5,
    'systemSettings.backupSettings.s3.enabled': false,
    'systemSettings.backupSettings.ftp.enabled': false
  }
})
```

**ê²°ê³¼**: âœ… ì„¤ì • ì—…ë°ì´íŠ¸ ì„±ê³µ

### 4. ë°±ì—… ì‹¤í–‰ í…ŒìŠ¤íŠ¸ âœ…

```bash
./build/nanumpay-backup
```

**ì‹¤í–‰ ë¡œê·¸**:
```
ğŸš€ NanumPay ë°±ì—… ì‹œìŠ¤í…œ ì‹œì‘
==============================
ì‹¤í–‰ ì‹œê°„: 2025. 10. 26. ì˜¤ì „ 11:15:19

âœ… MongoDB ì—°ê²° ì„±ê³µ
âœ… ë°±ì—… ì„¤ì • ë¡œë“œ ì™„ë£Œ
   ë°±ì—… ê²½ë¡œ: /tmp/nanumpay-backups-test
   ë³´ê´€ ê¸°ê°„: 7ì¼
   ë³´ê´€ ê°œìˆ˜: 5ê°œ
   S3 ì—…ë¡œë“œ: ë¹„í™œì„±í™”
   FTP ì—…ë¡œë“œ: ë¹„í™œì„±í™”

ğŸ“¦ ë°±ì—… ì‹œì‘: nanumpay-backup-2025-10-26T02-15-19
ğŸ—„ï¸  mongodump ì‹¤í–‰ ì¤‘...
2025-10-26T11:15:19.834+0900	writing nanumpay.weeklypaymentplans to ...
2025-10-26T11:15:19.835+0900	writing nanumpay.weeklypaymentsummaries to ...
2025-10-26T11:15:19.836+0900	writing nanumpay.users to ...
2025-10-26T11:15:19.837+0900	writing nanumpay.planneraccounts to ...
2025-10-26T11:15:19.839+0900	done dumping nanumpay.weeklypaymentsummaries (24 documents)
2025-10-26T11:15:19.839+0900	done dumping nanumpay.weeklypaymentplans (30 documents)
2025-10-26T11:15:19.840+0900	done dumping nanumpay.planneraccounts (15 documents)
2025-10-26T11:15:19.840+0900	done dumping nanumpay.users (15 documents)
2025-10-26T11:15:19.840+0900	done dumping nanumpay.useraccounts (11 documents)
2025-10-26T11:15:19.841+0900	done dumping nanumpay.admins (1 document)
2025-10-26T11:15:19.850+0900	done dumping nanumpay.monthlyregistrations (4 documents)
âœ… mongodump ì™„ë£Œ
ğŸ—œï¸  ì••ì¶• ì¤‘...
âœ… ì••ì¶• ì™„ë£Œ: nanumpay-backup-2025-10-26T02-15-19.tar.gz

ğŸ§¹ ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ ì¤‘...
ğŸ“Š ì „ì²´ ë°±ì—… íŒŒì¼ ìˆ˜: 1ê°œ
ğŸ”¢ ê°œìˆ˜ ê¸°ì¤€ ì‚­ì œ ëŒ€ìƒ: 0ê°œ (ìµœëŒ€ 5ê°œ ìœ ì§€)
ğŸ“… ë‚ ì§œ ê¸°ì¤€ ì‚­ì œ ëŒ€ìƒ: 0ê°œ (7ì¼ ì´ìƒ ê²½ê³¼)
âœ… ì •ë¦¬ ì™„ë£Œ: 0ê°œ íŒŒì¼ ì‚­ì œ
ğŸ“Š ë‚¨ì€ ë°±ì—… íŒŒì¼ ìˆ˜: 1ê°œ

âœ… MongoDB ì—°ê²° ì¢…ë£Œ
==============================
âœ… ë°±ì—… ì™„ë£Œ!
ì¢…ë£Œ ì‹œê°„: 2025. 10. 26. ì˜¤ì „ 11:15:19
```

**ê²°ê³¼**:
- MongoDB ì—°ê²°: âœ…
- ì„¤ì • ë¡œë“œ: âœ…
- mongodump ì‹¤í–‰: âœ… (100 documents)
- ì••ì¶•: âœ…
- ë°±ì—… íŒŒì¼ ìƒì„±: âœ…

### 5. ë°±ì—… íŒŒì¼ í™•ì¸ âœ…

```bash
ls -lh /tmp/nanumpay-backups-test/
```

**ê²°ê³¼**:
```
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:15 nanumpay-backup-2025-10-26T02-15-19.tar.gz
```

**ì••ì¶• íŒŒì¼ ë‚´ìš©**:
```
nanumpay-backup-2025-10-26T02-15-19/
â”œâ”€â”€ nanumpay/
    â”œâ”€â”€ admins.bson
    â”œâ”€â”€ admins.metadata.json
    â”œâ”€â”€ monthlyregistrations.bson
    â”œâ”€â”€ monthlyregistrations.metadata.json
    â”œâ”€â”€ planneraccounts.bson
    â”œâ”€â”€ planneraccounts.metadata.json
    â”œâ”€â”€ users.bson
    â”œâ”€â”€ users.metadata.json
    â”œâ”€â”€ useraccounts.bson
    â”œâ”€â”€ useraccounts.metadata.json
    â”œâ”€â”€ weeklypaymentplans.bson
    â”œâ”€â”€ weeklypaymentplans.metadata.json
    â”œâ”€â”€ weeklypaymentsummaries.bson
    â”œâ”€â”€ weeklypaymentsummaries.metadata.json
    â””â”€â”€ prelude.json
```

### 6. ë³´ê´€ ì •ì±… í…ŒìŠ¤íŠ¸ âœ…

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**: 10ê°œ ë°±ì—… ìƒì„±, retentionCount=5

```bash
for i in 1 2 3 4 5 6 7 8 9 10; do
  ./build/nanumpay-backup
  sleep 1
done
```

**ìµœì¢… íŒŒì¼ ëª©ë¡**:
```bash
ls -1 /tmp/nanumpay-backups-test/*.tar.gz | wc -l
# ê²°ê³¼: 5
```

```bash
ls -lh /tmp/nanumpay-backups-test/
```

```
í•©ê³„ 60K
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:17 nanumpay-backup-2025-10-26T02-17-12.tar.gz
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:17 nanumpay-backup-2025-10-26T02-17-13.tar.gz
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:17 nanumpay-backup-2025-10-26T02-17-15.tar.gz
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:17 nanumpay-backup-2025-10-26T02-17-16.tar.gz
-rw-rw-r-- 1 tyranno tyranno 12K 10ì›” 26 11:17 nanumpay-backup-2025-10-26T02-17-18.tar.gz
```

**ê²°ê³¼**: âœ… ë³´ê´€ ì •ì±… ì •ìƒ ì‘ë™ (ìµœì‹  5ê°œë§Œ ìœ ì§€)

### 7. DEB ë¹Œë“œ í†µí•© í™•ì¸ âœ…

**íŒŒì¼**: [apps/web/scripts/release-linux.cjs](apps/web/scripts/release-linux.cjs)

**í™•ì¸ í•­ëª©**:
- [x] binDir ìƒì„± ì½”ë“œ (line 40)
- [x] ë°±ì—… ì•± ë¹Œë“œ ì½”ë“œ (line 80-108)
- [x] ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± ì½”ë“œ (postinst, line 191-197)
- [x] crontab ì •ë¦¬ ì½”ë“œ (prerm, line 234-236)

### 8. Admin ëª¨ë¸ í™•ì¸ âœ…

**íŒŒì¼**: [apps/web/src/lib/server/models/Admin.js](apps/web/src/lib/server/models/Admin.js)

**í™•ì¸ í•­ëª©**:
- [x] `systemSettings.backupSettings` ìŠ¤í‚¤ë§ˆ
- [x] `schedule` í•„ë“œ (cron í˜•ì‹)
- [x] `backupPath` í•„ë“œ
- [x] `retentionDays` í•„ë“œ
- [x] `retentionCount` í•„ë“œ
- [x] `s3` ì„¤ì •
- [x] `ftp` ì„¤ì •

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

| ì¹´í…Œê³ ë¦¬ | í†µê³¼/ì‹¤íŒ¨ | ë¹„ê³  |
|---------|---------|-----|
| í™˜ê²½ í™•ì¸ | âœ… í†µê³¼ | Bun, MongoDB, mongodump ëª¨ë‘ ì •ìƒ |
| ë°±ì—… ì•± ë¹Œë“œ | âœ… í†µê³¼ | 123MB ì‹¤í–‰ íŒŒì¼ ìƒì„± |
| MongoDB ì„¤ì • | âœ… í†µê³¼ | backupSettings ì—…ë°ì´íŠ¸ ì„±ê³µ |
| ë°±ì—… ì‹¤í–‰ | âœ… í†µê³¼ | 12KB ì••ì¶• íŒŒì¼ ìƒì„± |
| ë°±ì—… íŒŒì¼ ê²€ì¦ | âœ… í†µê³¼ | mongodump ë°ì´í„° í™•ì¸ |
| ë³´ê´€ ì •ì±… | âœ… í†µê³¼ | 10ê°œ â†’ 5ê°œ ìë™ ì •ë¦¬ |
| DEB í†µí•© | âœ… í†µê³¼ | release-linux.cjs ì½”ë“œ í™•ì¸ |
| Admin ëª¨ë¸ | âœ… í†µê³¼ | backupSettings ìŠ¤í‚¤ë§ˆ í™•ì¸ |

**ì „ì²´**: 8/8 í†µê³¼ (100%)

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### 1. DEB íŒ¨í‚¤ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸

```bash
cd /home/tyranno/project/bill/nanumpay
pnpm release:linux
```

**ì˜ˆìƒ ê²°ê³¼**:
- ë°±ì—… ì•± ìë™ ë¹Œë“œ
- DEB íŒ¨í‚¤ì§€ì— `nanumpay-backup` í¬í•¨
- íŒŒì¼ ìœ„ì¹˜: `apps/web/release/nanumpay_0.0.1-YYYYMMDD_amd64.deb`

**ê²€ì¦ ëª…ë ¹ì–´**:
```bash
dpkg-deb -c apps/web/release/nanumpay_*.deb | grep backup
# ì˜ˆìƒ ì¶œë ¥:
# ./opt/nanumpay/bin/nanumpay-backup
```

### 2. ë‚¨ì€ êµ¬í˜„ ì‘ì—… (UI/API)

#### API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- `GET /api/admin/backup/settings` - ì„¤ì • ì¡°íšŒ
- `POST /api/admin/backup/settings` - ì„¤ì • ì €ì¥ + crontab ì—…ë°ì´íŠ¸
- `POST /api/admin/backup/execute` - ì¦‰ì‹œ ë°±ì—…
- `GET /api/admin/backup/files` - ë°±ì—… íŒŒì¼ ëª©ë¡
- `GET /api/admin/backup/download/:filename` - ë‹¤ìš´ë¡œë“œ
- `DELETE /api/admin/backup/files/:filename` - ì‚­ì œ
- `GET /api/admin/backup/logs` - ë¡œê·¸ ì¡°íšŒ

#### UI êµ¬í˜„
- `/admin/settings` í˜ì´ì§€ì— "ë°±ì—… ì„¤ì •" íƒ­ ì¶”ê°€
- ë°±ì—… í™œì„±í™” í† ê¸€
- cron ìŠ¤ì¼€ì¤„ ì…ë ¥
- ë³´ê´€ ì •ì±… ì„¤ì •
- S3/FTP ì„¤ì •
- ì¦‰ì‹œ ë°±ì—… ë²„íŠ¼
- ë°±ì—… íŒŒì¼ ëª©ë¡
- ë¡œê·¸ ë·°ì–´

#### Crontab ê´€ë¦¬ í—¬í¼
- `apps/web/src/lib/server/utils/crontab.js`
- ì„¤ì • ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ crontab ë“±ë¡/ì œê±°

### 3. í”„ë¡œë•ì…˜ ë°°í¬ í…ŒìŠ¤íŠ¸

```bash
# 1. ë¹Œë“œ
pnpm release:linux

# 2. ë°°í¬
node apps/web/scripts/deploy.cjs

# 3. ì„œë²„ í™•ì¸
ssh -i ~/.ssh/ocp_tyranno tyranno@34.170.107.151
ls -l /opt/nanumpay/bin/nanumpay-backup
/opt/nanumpay/bin/nanumpay-backup

# 4. ë¡œê·¸ í™•ì¸
tail -f /opt/nanumpay/logs/backup.log
```

---

## ğŸ“ ì°¸ê³  ë¬¸ì„œ

1. [ë°±ì—…_ì‹œìŠ¤í…œ_êµ¬í˜„_ì™„ë£Œ.md](ë°±ì—…_ì‹œìŠ¤í…œ_êµ¬í˜„_ì™„ë£Œ.md) - ì „ì²´ êµ¬í˜„ ë‚´ìš©
2. [ë°±ì—…_ì‹œìŠ¤í…œ_ìµœì¢…_ì„¤ê³„.md](ë°±ì—…_ì‹œìŠ¤í…œ_ìµœì¢…_ì„¤ê³„.md) - ì„¤ê³„ ë¬¸ì„œ
3. [apps/backup/README.md](../apps/backup/README.md) - ë°±ì—… ì•± ì‚¬ìš©ë²•

---

## ğŸ” ì•Œë ¤ì§„ ì´ìŠˆ

### AWS SDK v2 Deprecation Warning

**ê²½ê³  ë©”ì‹œì§€**:
```
NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
SDK releases are limited to address critical bug fixes and security issues only.
Please migrate your code to use AWS SDK for JavaScript (v3).
```

**ì˜í–¥**: ì—†ìŒ (ê²½ê³ ë§Œ í‘œì‹œë¨)

**í•´ê²° ë°©ë²•** (ì„ íƒ):
- `aws-sdk@2.x` â†’ `@aws-sdk/client-s3@3.x`ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
- ë˜ëŠ” ê²½ê³  ë¬´ì‹œ (ê¸°ëŠ¥ìƒ ë¬¸ì œ ì—†ìŒ)

---

**ì‘ì„±ì**: Claude AI Assistant
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-26
