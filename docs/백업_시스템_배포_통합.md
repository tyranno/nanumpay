# 백업 시스템 배포 통합 방안

**작성일**: 2025-10-26  
**목적**: 기존 배포 프로세스에 백업 시스템 통합

---

## 📋 현재 배포 프로세스

```
1. pnpm release:linux        # DEB 패키지 빌드
2. node scripts/deploy.cjs    # 서버에 배포
   ↓
   - .deb 파일 업로드
   - dpkg -i 설치
   - 서비스 시작
```

---

## 🎯 백업 시스템 통합 포인트

### 1. **빌드 단계** (pnpm release:linux)

**현재**: 웹 앱만 빌드  
**수정 필요**: 백업 앱도 함께 빌드

```bash
# package.json scripts 수정
{
  "scripts": {
    "build:backup": "cd apps/backup && bun run build",
    "release:linux": "npm run build:backup && ..."
  }
}
```

**과정**:
```
1. apps/backup 빌드 (Bun)
   → build/nanumpay-backup 생성

2. apps/web/install/linux/bin/에 복사
   → bin/nanumpay-backup

3. DEB 패키지에 포함
   → /opt/nanumpay/bin/nanumpay-backup
```

---

### 2. **DEB 패키지 구조**

```
nanumpay_x.x.x_amd64.deb
├── opt/nanumpay/
│   ├── bin/
│   │   └── nanumpay-backup       # ← 새로 추가
│   ├── data/
│   │   └── backups/              # ← 새로 추가 (빈 디렉토리)
│   ├── web/
│   │   └── ... (기존)
│   └── tools/
│       └── db_init.sh
├── etc/systemd/system/
│   └── nanumpay.service
└── DEBIAN/
    ├── control
    ├── postinst                  # ← 수정 필요
    └── prerm                     # ← 수정 필요
```

---

### 3. **postinst 수정** (설치 후 스크립트)

**현재**: 웹 서버만 설정  
**추가 필요**: 백업 디렉토리 생성, 실행 권한 부여

```bash
#!/usr/bin/env bash
set -e

APP=nanumpay
APPDIR=/opt/$APP
USER=$APP

# ... 기존 코드 ...

# ========== 백업 시스템 설정 시작 ==========

echo "🗄️ 백업 시스템 설치 중..."

# 1. 백업 디렉토리 생성
BACKUP_DATA_DIR="$APPDIR/data/backups"
if [ ! -d "$BACKUP_DATA_DIR" ]; then
  mkdir -p "$BACKUP_DATA_DIR"
  echo "✅ 백업 디렉토리 생성: $BACKUP_DATA_DIR"
fi
chown -R $USER:$USER "$BACKUP_DATA_DIR"
chmod 755 "$BACKUP_DATA_DIR"

# 2. 백업 실행파일 권한 설정
BACKUP_BIN="$APPDIR/bin/nanumpay-backup"
if [ -f "$BACKUP_BIN" ]; then
  chmod +x "$BACKUP_BIN"
  chown $USER:$USER "$BACKUP_BIN"
  echo "✅ 백업 실행파일 권한 설정 완료"
else
  echo "⚠️  백업 실행파일을 찾을 수 없습니다: $BACKUP_BIN"
fi

# 3. Bun 설치 확인 (선택 - 개발 환경용)
# 운영 환경에서는 Bun 불필요 (컴파일된 실행파일 사용)
echo "ℹ️  백업 시스템은 독립 실행파일로 동작합니다 (Bun 런타임 불필요)"

# 4. 백업 로그 디렉토리
BACKUP_LOG="/logs/backup.log"
touch "$BACKUP_LOG" || true
chown $USER:$USER "$BACKUP_LOG" || true
chmod 644 "$BACKUP_LOG" || true

echo "✅ 백업 시스템 설치 완료"
echo "ℹ️  웹 UI > 관리자 설정 > 시스템 설정 > 백업 설정에서 활성화하세요"

# ========== 백업 시스템 설정 끝 ==========

# ... 기존 코드 계속 ...
```

---

### 4. **prerm 수정** (제거 전 스크립트)

**추가 필요**: Crontab 정리

```bash
#!/usr/bin/env bash
set -e

APP=nanumpay

# ... 기존 코드 ...

# ========== 백업 시스템 정리 시작 ==========

echo "🗑️ 백업 Crontab 정리 중..."

# Crontab에서 nanumpay-backup 제거
if command -v crontab >/dev/null 2>&1; then
  # 현재 사용자의 crontab 정리
  crontab -l 2>/dev/null | grep -v "nanumpay-backup" | crontab - || true
  
  # nanumpay 사용자의 crontab 정리
  sudo -u $APP crontab -l 2>/dev/null | grep -v "nanumpay-backup" | sudo -u $APP crontab - || true
  
  echo "✅ 백업 Crontab 정리 완료"
fi

# 백업 데이터는 유지 (/opt/nanumpay/data/backups)
echo "ℹ️  백업 데이터는 유지됩니다: /opt/nanumpay/data/backups"

# ========== 백업 시스템 정리 끝 ==========

# ... 기존 코드 계속 ...
```

---

### 5. **빌드 스크립트 수정**

#### 방법 A: package.json 수정 (권장)

```json
{
  "scripts": {
    "prebuild:backup": "echo '🔨 백업 앱 빌드 시작...'",
    "build:backup": "cd apps/backup && bun install && bun run build",
    "postbuild:backup": "cp apps/backup/build/nanumpay-backup apps/web/install/linux/bin/",
    
    "release:linux": "pnpm run build:backup && ...(기존 명령)",
    "release:deploy:web:dev": "pnpm release:linux && node apps/web/scripts/deploy.cjs"
  }
}
```

#### 방법 B: 별도 빌드 스크립트 (apps/backup/deploy.sh)

```bash
#!/bin/bash
set -e

echo "🔨 백업 앱 빌드 & 배포 준비"

# 1. Bun 설치 확인
if ! command -v bun &> /dev/null; then
    echo "❌ Bun이 설치되어 있지 않습니다"
    echo "   다음 명령으로 설치: curl -fsSL https://bun.sh/install | bash"
    exit 1
fi

# 2. 빌드
cd "$(dirname "$0")"
bun install
bun run build

# 3. DEB 패키지 디렉토리로 복사
DEST="../../web/install/linux/bin"
mkdir -p "$DEST"
cp build/nanumpay-backup "$DEST/"

echo "✅ 백업 실행파일 복사 완료: $DEST/nanumpay-backup"
ls -lh "$DEST/nanumpay-backup"
```

---

### 6. **deploy.cjs 수정** (선택)

**추가**: 백업 시스템 설치 확인

```javascript
// installPackage() 함수 내 추가

const commands = [
  // ... 기존 명령 ...
  
  '# 백업 시스템 확인',
  'echo "🗄️ 백업 시스템 확인..."',
  'if [ -f /opt/nanumpay/bin/nanumpay-backup ]; then',
  '  echo "✅ 백업 실행파일 설치됨"',
  '  ls -lh /opt/nanumpay/bin/nanumpay-backup',
  '  # 테스트 실행 (dry-run)',
  '  sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup --version || echo "버전 확인 실패 (정상)"',
  'else',
  '  echo "⚠️  백업 실행파일이 설치되지 않음"',
  'fi',
  
  // ... 기존 명령 계속 ...
];
```

---

## 🔄 전체 배포 프로세스 (업데이트)

```
┌─────────────────────────────────────────────┐
│ 1. 개발자 로컬 환경                           │
├─────────────────────────────────────────────┤
│ a. 백업 앱 개발 (apps/backup/)                │
│    - src/*.js 작성                            │
│    - 로컬 테스트: bun run dev                 │
│                                              │
│ b. 백업 앱 빌드                                │
│    - cd apps/backup                          │
│    - bun run build                           │
│    - 결과: build/nanumpay-backup (~25MB)    │
│                                              │
│ c. DEB 패키지 빌드                             │
│    - pnpm release:linux                      │
│    - 결과: apps/web/release/nanumpay_x.deb  │
│    - 포함: /opt/nanumpay/bin/nanumpay-backup│
└─────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────┐
│ 2. 배포 스크립트 실행                          │
├─────────────────────────────────────────────┤
│ node apps/web/scripts/deploy.cjs             │
│                                              │
│ a. .deb 파일 서버에 업로드                     │
│ b. dpkg -i nanumpay_x.deb                    │
│    - postinst 실행:                          │
│      ✓ /opt/nanumpay/data/backups 생성      │
│      ✓ nanumpay-backup 실행 권한 부여        │
│      ✓ 로그 파일 생성                         │
│ c. 서비스 시작                                 │
└─────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────┐
│ 3. 프로덕션 서버                               │
├─────────────────────────────────────────────┤
│ /opt/nanumpay/                               │
│ ├── bin/nanumpay-backup      (실행파일)      │
│ ├── data/backups/             (백업 저장소)   │
│ └── ...                                      │
│                                              │
│ 관리자 웹 UI:                                  │
│ - 설정 > 시스템 > 백업 설정                    │
│ - 활성화 ON → Crontab 자동 업데이트           │
└─────────────────────────────────────────────┘
```

---

## ✅ 체크리스트

### 개발 단계
- [ ] `apps/backup/` 프로젝트 생성
- [ ] Bun 빌드 스크립트 작성 (`build.sh`)
- [ ] 로컬 테스트 성공

### 빌드 통합
- [ ] `package.json`에 `build:backup` 스크립트 추가
- [ ] `release:linux`에 백업 빌드 포함
- [ ] `apps/web/install/linux/bin/` 경로 설정

### DEB 패키지
- [ ] `postinst` 수정 (백업 디렉토리 생성)
- [ ] `prerm` 수정 (Crontab 정리)
- [ ] `control` 의존성 확인 (mongodb-mongosh 포함)

### 배포 테스트
- [ ] 로컬 DEB 빌드 테스트
- [ ] 개발 서버 배포 테스트
- [ ] 백업 실행파일 설치 확인
- [ ] 웹 UI에서 백업 설정 확인

### 운영 확인
- [ ] Crontab 동작 확인
- [ ] 수동 백업 실행 테스트
- [ ] S3/FTP 업로드 테스트
- [ ] 로그 확인 (`/logs/backup.log`)

---

## 🚨 주의사항

### 1. Bun 런타임 불필요
- 운영 서버에 Bun 설치 **불필요**
- `bun build --compile`로 독립 실행파일 생성
- Node.js도 백업 앱 실행에 불필요

### 2. 의존성
DEB 패키지 `control` 파일에 추가:
```
Depends: mongodb-mongosh (>= 1.0.0)
Recommends: lftp (FTP 사용 시), awscli (S3 사용 시)
```

### 3. 백업 데이터 보관
- `/opt/nanumpay/data/backups/`는 패키지 제거 시에도 유지
- `postrm`에서 삭제하지 않음

### 4. Crontab 사용자
- `nanumpay` 사용자의 crontab 사용
- root crontab 사용 금지

---

## 📝 다음 단계

1. **백업 앱 개발 완료**
   - `apps/backup/src/` 구현
   - 로컬 테스트

2. **빌드 스크립트 통합**
   - `package.json` 수정
   - `apps/backup/build.sh` 작성

3. **DEB 패키지 수정**
   - `postinst`, `prerm` 업데이트
   - `control` 의존성 추가

4. **배포 테스트**
   - 개발 서버에 배포
   - 전체 프로세스 검증

5. **문서화**
   - 운영 가이드 작성
   - 트러블슈팅 가이드

---

**준비 완료!** 백업 시스템을 기존 배포 프로세스에 통합할 수 있습니다.
