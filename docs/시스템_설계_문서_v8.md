# MLM 시스템 설계 문서 v8.0

**버전**: 8.0
**작성일**: 2025년 12월 4일
**기준 요구사항**: 시스템_요구사항_검토문서_v5.0

**주요 변경사항 (v8.0)**:
- **추가지급 시작 시점 변경**: 매월 승급 확인 즉시 → **등록/승급일 + 2개월 후** 첫 금요일
- **추가지급 간격 변경**: 추가2차 이후는 **이전 추가지급 시작 + 1개월** 후 첫 금요일
- **추가지급 중단 시점 변경**: 승급 즉시 → **승급 지급 시작일**(승급 다음달 첫주)부터

---

## 1. 핵심 규칙 요약

### 1.1 지급 시작 시점

| 구분 | 시작 기준 | 예시 (10/28 등록) |
|------|----------|------------------|
| **기본지급** (10회) | 등록/승급 **다음달 첫 금요일** | 11/7 |
| **추가1차** (10회) | 등록/승급일 **+ 2개월** 후 첫 금요일 | 12/28 이후 → 1/3 |
| **추가2차** (10회) | 추가1차 시작 **+ 1개월** 후 첫 금요일 | 1/3 + 1개월 → 2/7 |
| **추가N차** | 추가(N-1)차 시작 **+ 1개월** 후 첫 금요일 | ... |

### 1.2 승급 시 처리

| 항목 | 처리 |
|------|------|
| 기존 **기본지급** | ✅ 계속 진행 |
| 기존 **추가지급** | ❌ **승급 지급 시작일**부터 중단 |
| 새 등급 **기본지급** | ✅ 승급 다음달 첫 금요일부터 시작 |
| 새 등급 **추가지급** | 승급일 + 2개월 후 (미승급 시) |

### 1.3 예시: 8/28 등록 → 11/15 승급(F1→F2)

```
[8/28 등록 F1]
├─ F1 기본: 9/5 시작 (10회)
└─ F1 추가1차 예정: 10/28 이후 첫 금요일 (11/1) 시작

[11/15 승급 F2]
├─ F2 기본: 12/5 시작 (10회)
├─ F1 기본: 계속 진행 ✅
└─ F1 추가1차: 11월까지 진행 → 12/5부터 중단 ❌
```

| 날짜 | F1 기본 | F1 추가1차 | F2 기본 | 비고 |
|------|---------|-----------|---------|------|
| 11/1 | 9회 | 1회 ✅ | - | |
| 11/8 | 10회 완료 | 2회 ✅ | - | |
| 11/15 | - | 3회 ✅ | - | 승급일 |
| 11/22 | - | 4회 ✅ | - | |
| 11/29 | - | 5회 ✅ | - | 11월 마지막 |
| **12/5** | - | **중단** ❌ | 1회 시작 | F2 지급 시작 |

---

## 2. 데이터베이스 설계

### 2.1 weeklyPaymentPlans 스키마 변경

```javascript
{
  _id: ObjectId,
  userId: String,
  userName: String,

  // 계획 유형
  planType: String,              // 'initial' | 'promotion'
  추가지급단계: Number,          // 0: 기본, 1: 추가1차, 2: 추가2차, ...
  installmentType: String,       // 'basic' | 'additional'

  // 기준 정보
  baseGrade: String,             // 계획 생성 시점 등급
  revenueMonth: String,          // 매출 귀속 월 (YYYY-MM)

  // ⭐ v8.0 신규: 추가지급 시작 기준일
  additionalPaymentBaseDate: Date,  // 등록/승급일 (추가지급 시작 계산 기준)

  startDate: Date,               // 지급 시작일 (첫 금요일)

  // 진행 정보
  totalInstallments: Number,     // 총 할부 횟수 (항상 10)
  completedInstallments: Number, // 완료된 횟수
  planStatus: String,            // 'active' | 'completed' | 'terminated'

  // 할부 상세 (10개)
  installments: [{
    week: Number,
    weekNumber: String,
    scheduledDate: Date,
    revenueMonth: String,
    gradeAtPayment: String,
    baseAmount: Number,
    installmentAmount: Number,
    withholdingTax: Number,
    netAmount: Number,
    status: String,              // 'pending' | 'paid' | 'skipped' | 'terminated'
    paidDate: Date,
    insuranceSkipped: Boolean,
    terminatedReason: String     // 'promotion'
  }],

  // 추가 정보
  parentPlanId: ObjectId,
  createdBy: String,             // 'registration' | 'promotion' | 'additional_payment'
  terminatedBy: String,          // 'promotion'
  terminatedAt: Date,

  createdAt: Date,
  updatedAt: Date
}
```

---

## 3. 추가지급 생성 로직 (v8.0)

### 3.1 추가지급 시작일 계산

```javascript
/**
 * 추가지급 시작일 계산
 * @param {Date} baseDate - 등록/승급일 또는 이전 추가지급 시작일
 * @param {Number} 추가지급단계 - 0이면 등록/승급일+2개월, 1+이면 이전+1개월
 * @returns {Date} 추가지급 시작 금요일
 */
function calculateAdditionalPaymentStartDate(baseDate, 추가지급단계) {
  let targetDate;

  if (추가지급단계 === 0) {
    // 기본지급 완료 후 첫 추가지급: 등록/승급일 + 2개월
    targetDate = addMonths(baseDate, 2);
  } else {
    // 추가2차 이후: 이전 추가지급 시작일 + 1개월
    targetDate = addMonths(baseDate, 1);
  }

  // targetDate 이후 첫 금요일 찾기
  return getNextFridayOnOrAfter(targetDate);
}
```

### 3.2 추가지급 생성 조건

```javascript
async function shouldCreateAdditionalPayment(userId, baseGrade, 추가지급단계) {
  // 1. 최대 횟수 확인
  const MAX_INSTALLMENTS = {
    F1: 20, F2: 30, F3: 40, F4: 40,
    F5: 50, F6: 50, F7: 60, F8: 60
  };

  const totalPlanned = await WeeklyPaymentPlans.aggregate([
    { $match: { userId, baseGrade } },
    { $group: { _id: null, total: { $sum: '$totalInstallments' } } }
  ]);

  if (totalPlanned >= MAX_INSTALLMENTS[baseGrade]) {
    return { create: false, reason: '최대 횟수 도달' };
  }

  // 2. 현재 등급 확인 (하락 시 생성 안 함)
  const user = await User.findOne({ loginId: userId });
  if (user.grade < baseGrade) {
    return { create: false, reason: '등급 하락' };
  }

  // 3. 보험 확인 (F3 이상)
  if (baseGrade >= 'F3' && !user.insuranceActive) {
    return { create: false, reason: '보험 미가입' };
  }

  // 4. 승급 여부 확인 - 승급 지급 시작일 이후면 생성 안 함
  const hasPromotionPlan = await WeeklyPaymentPlans.findOne({
    userId,
    planType: 'promotion',
    baseGrade: { $gt: baseGrade },
    startDate: { $lte: new Date() }  // 승급 지급이 이미 시작됨
  });

  if (hasPromotionPlan) {
    return { create: false, reason: '승급으로 인한 중단' };
  }

  return { create: true };
}
```

### 3.3 추가지급 계획 생성

```javascript
async function createAdditionalPaymentPlan(userId, previousPlan) {
  const user = await User.findOne({ loginId: userId });
  const baseGrade = previousPlan.baseGrade;
  const 추가지급단계 = previousPlan.추가지급단계 + 1;

  // 시작일 계산
  let baseDate;
  if (previousPlan.추가지급단계 === 0) {
    // 기본지급 → 추가1차: 등록/승급일 + 2개월
    baseDate = previousPlan.additionalPaymentBaseDate;
  } else {
    // 추가N차 → 추가(N+1)차: 이전 추가지급 시작일 + 1개월
    baseDate = previousPlan.startDate;
  }

  const startDate = calculateAdditionalPaymentStartDate(baseDate, previousPlan.추가지급단계);

  // 매출월 결정 (시작일 기준 이전 월)
  const revenueMonth = format(subMonths(startDate, 1), 'yyyy-MM');

  // 금액 계산
  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: revenueMonth });
  const gradePayments = calculateGradePayments(monthlyReg);
  const baseAmount = gradePayments[baseGrade];
  const installmentAmount = Math.floor(baseAmount / 10 / 100) * 100;

  // 10회 할부 생성
  const installments = [];
  for (let i = 1; i <= 10; i++) {
    const scheduledDate = addWeeks(startDate, i - 1);
    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      baseAmount,
      installmentAmount,
      withholdingTax: Math.round(installmentAmount * 0.033),
      netAmount: installmentAmount - Math.round(installmentAmount * 0.033),
      status: 'pending'
    });
  }

  // DB 저장
  const newPlan = await WeeklyPaymentPlans.create({
    userId,
    userName: user.name,
    planType: previousPlan.planType,
    추가지급단계,
    installmentType: 'additional',
    baseGrade,
    revenueMonth,
    additionalPaymentBaseDate: previousPlan.additionalPaymentBaseDate,
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    planStatus: 'active',
    installments,
    parentPlanId: previousPlan._id,
    createdBy: 'additional_payment'
  });

  // WeeklyPaymentSummary 업데이트
  await updateWeeklyProjections(newPlan, 'add');

  return newPlan;
}
```

---

## 4. 추가지급 중단 로직 (v8.0)

### 4.1 승급 시 추가지급 중단

```javascript
/**
 * 승급 시 추가지급 중단
 * 중단 시점: 승급 지급 시작일 (승급 다음달 첫 금요일)
 */
async function terminateAdditionalPaymentsOnPromotion(userId, promotionDate, newGrade) {
  // 승급 지급 시작일 계산
  const promotionPaymentStartDate = getNextMonthFirstFriday(promotionDate);

  // 진행 중인 추가지급 계획 조회
  const additionalPlans = await WeeklyPaymentPlans.find({
    userId,
    installmentType: 'additional',
    planStatus: 'active',
    baseGrade: { $lt: newGrade }  // 이전 등급의 추가지급만
  });

  for (const plan of additionalPlans) {
    let hasTerminated = false;

    for (const inst of plan.installments) {
      // 승급 지급 시작일 이후의 pending 할부만 중단
      if (inst.status === 'pending' && inst.scheduledDate >= promotionPaymentStartDate) {
        inst.status = 'terminated';
        inst.terminatedReason = 'promotion';
        hasTerminated = true;
      }
    }

    if (hasTerminated) {
      // 모든 할부가 완료/중단되었으면 계획도 종료
      const pendingCount = plan.installments.filter(i => i.status === 'pending').length;
      if (pendingCount === 0) {
        plan.planStatus = 'terminated';
        plan.terminatedBy = 'promotion';
        plan.terminatedAt = promotionPaymentStartDate;
      }

      await plan.save();

      // WeeklyPaymentSummary에서 예상 금액 제거
      await updateWeeklyProjections(plan, 'remove', promotionPaymentStartDate);

      console.log(`[${userId}] 추가지급 중단: ${plan.baseGrade} ${plan.추가지급단계}단계, 중단일: ${promotionPaymentStartDate}`);
    }
  }
}
```

### 4.2 중단 시점 예시

```
[8/28 등록 F1]
├─ F1 기본: 9/5 시작
└─ F1 추가1차: 11/1 시작 (8/28 + 2개월 = 10/28 이후 첫 금요일)

[11/15 승급 F2]
├─ F2 기본 시작일: 12/5 (11월 다음달 첫 금요일)
└─ F1 추가1차 중단 시작일: 12/5

F1 추가1차 상태:
- 11/1: paid ✅ (1회)
- 11/8: paid ✅ (2회)
- 11/15: paid ✅ (3회)
- 11/22: paid ✅ (4회)
- 11/29: paid ✅ (5회)
- 12/5: terminated ❌ (6회 - 승급 지급 시작일)
- 12/12: terminated ❌ (7회)
- 12/19: terminated ❌ (8회)
- 12/26: terminated ❌ (9회)
- 1/2: terminated ❌ (10회)
```

---

## 5. 금요일 자동 지급 프로세스

### 5.1 지급 처리 (변경 없음)

```javascript
async function processFridayPayments() {
  const today = new Date();
  const weekNumber = getISOWeek(today);

  // 지급 대상 조회
  const plans = await WeeklyPaymentPlans.find({
    'installments': {
      $elemMatch: {
        weekNumber: weekNumber,
        status: 'pending'
      }
    },
    planStatus: 'active'
  });

  for (const plan of plans) {
    const installment = plan.installments.find(
      inst => inst.weekNumber === weekNumber && inst.status === 'pending'
    );

    // 보험 확인
    const user = await User.findOne({ loginId: plan.userId });
    if (plan.baseGrade >= 'F3' && !user.insuranceActive) {
      installment.status = 'skipped';
      installment.insuranceSkipped = true;
      continue;
    }

    // 지급 처리
    installment.status = 'paid';
    installment.paidDate = today;
    installment.gradeAtPayment = user.grade;

    plan.completedInstallments++;

    if (plan.completedInstallments === plan.totalInstallments) {
      plan.planStatus = 'completed';
    }

    await plan.save();
  }

  // WeeklyPaymentSummary 업데이트
  await updateWeeklySummary(weekNumber);
}
```

### 5.2 추가지급 생성 체크 (매주 금요일)

```javascript
/**
 * 매주 금요일 지급 후 추가지급 생성 체크
 * v8.0: 날짜 기반으로 추가지급 시작일이 도래했는지 확인
 */
async function checkAndCreateAdditionalPayments() {
  const today = new Date();

  // 추가지급 시작일이 오늘인 계획 후보 조회
  // 1. 기본지급 완료된 계획 중 추가1차 시작일이 오늘인 것
  // 2. 추가N차 완료된 계획 중 추가(N+1)차 시작일이 오늘인 것

  const completedPlans = await WeeklyPaymentPlans.find({
    planStatus: 'completed',
    installmentType: { $in: ['basic', 'additional'] }
  });

  for (const plan of completedPlans) {
    // 이미 다음 단계 추가지급이 있는지 확인
    const nextPlan = await WeeklyPaymentPlans.findOne({
      parentPlanId: plan._id
    });

    if (nextPlan) continue;

    // 추가지급 시작일 계산
    let baseDate;
    if (plan.추가지급단계 === 0) {
      baseDate = plan.additionalPaymentBaseDate;  // 등록/승급일 + 2개월
    } else {
      baseDate = plan.startDate;  // 이전 추가지급 시작일 + 1개월
    }

    const additionalStartDate = calculateAdditionalPaymentStartDate(baseDate, plan.추가지급단계);

    // 시작일이 오늘 이전이면 생성
    if (additionalStartDate <= today) {
      const condition = await shouldCreateAdditionalPayment(
        plan.userId,
        plan.baseGrade,
        plan.추가지급단계 + 1
      );

      if (condition.create) {
        await createAdditionalPaymentPlan(plan.userId, plan);
        console.log(`[${plan.userId}] 추가지급 생성: ${plan.baseGrade} ${plan.추가지급단계 + 1}단계`);
      } else {
        console.log(`[${plan.userId}] 추가지급 생성 안 함: ${condition.reason}`);
      }
    }
  }
}
```

---

## 6. 등록/승급 처리 프로세스

### 6.1 등록 시 Initial 계획 생성

```javascript
async function createInitialPaymentPlan(user, registrationDate) {
  const startDate = getNextMonthFirstFriday(registrationDate);
  const revenueMonth = format(registrationDate, 'yyyy-MM');

  // 금액 계산
  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: revenueMonth });
  const gradePayments = calculateGradePayments(monthlyReg);
  const baseAmount = gradePayments[user.grade];
  const installmentAmount = Math.floor(baseAmount / 10 / 100) * 100;

  // 10회 할부 생성
  const installments = [];
  for (let i = 1; i <= 10; i++) {
    const scheduledDate = addWeeks(startDate, i - 1);
    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      baseAmount,
      installmentAmount,
      withholdingTax: Math.round(installmentAmount * 0.033),
      netAmount: installmentAmount - Math.round(installmentAmount * 0.033),
      status: 'pending'
    });
  }

  return await WeeklyPaymentPlans.create({
    userId: user.loginId,
    userName: user.name,
    planType: 'initial',
    추가지급단계: 0,
    installmentType: 'basic',
    baseGrade: user.grade,
    revenueMonth,
    additionalPaymentBaseDate: registrationDate,  // ⭐ v8.0: 추가지급 기준일
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    planStatus: 'active',
    installments,
    createdBy: 'registration'
  });
}
```

### 6.2 승급 시 Promotion 계획 생성 + 추가지급 중단

```javascript
async function handlePromotion(user, oldGrade, newGrade, promotionDate) {
  // 1. 추가지급 중단 (승급 지급 시작일부터)
  await terminateAdditionalPaymentsOnPromotion(user.loginId, promotionDate, newGrade);

  // 2. 새 등급 기본지급 계획 생성
  const startDate = getNextMonthFirstFriday(promotionDate);
  const revenueMonth = format(promotionDate, 'yyyy-MM');

  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: revenueMonth });
  const gradePayments = calculateGradePayments(monthlyReg);
  const baseAmount = gradePayments[newGrade];
  const installmentAmount = Math.floor(baseAmount / 10 / 100) * 100;

  const installments = [];
  for (let i = 1; i <= 10; i++) {
    const scheduledDate = addWeeks(startDate, i - 1);
    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      baseAmount,
      installmentAmount,
      withholdingTax: Math.round(installmentAmount * 0.033),
      netAmount: installmentAmount - Math.round(installmentAmount * 0.033),
      status: 'pending'
    });
  }

  return await WeeklyPaymentPlans.create({
    userId: user.loginId,
    userName: user.name,
    planType: 'promotion',
    추가지급단계: 0,
    installmentType: 'basic',
    baseGrade: newGrade,
    revenueMonth,
    additionalPaymentBaseDate: promotionDate,  // ⭐ v8.0: 추가지급 기준일 (승급일)
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    planStatus: 'active',
    installments,
    createdBy: 'promotion'
  });
}
```

---

## 7. v7.0 → v8.0 변경사항 요약

| 항목 | v7.0 | v8.0 |
|------|------|------|
| **추가지급 시작 시점** | 매월 등록/승급 처리 시 즉시 | **등록/승급일 + 2개월** 후 첫 금요일 |
| **추가2차 이후** | 이전 완료 후 즉시 | **이전 시작일 + 1개월** 후 첫 금요일 |
| **추가지급 중단 시점** | 승급 즉시 | **승급 지급 시작일**(다음달 첫주)부터 |
| **추가지급 생성 트리거** | 매월 등록/승급 처리 | **매주 금요일** 날짜 기반 체크 |
| **additionalPaymentBaseDate** | 없음 | ⭐ 신규 (등록/승급일 저장) |

---

## 8. 전체 예시: 복잡한 시나리오

### 8.1 시나리오: 8/28 등록 → 11/15 승급 → 2/10 재승급

```
[8/28 등록 F1]
├─ F1 기본: 9/5 시작 (10회, ~11/7 완료)
└─ F1 추가1차 예정: 10/28+첫금 = 11/1 시작

[11/15 승급 F1→F2]
├─ F2 기본: 12/5 시작 (10회, ~2/6 완료)
├─ F1 기본: 계속 진행 ✅ (11/7 완료)
└─ F1 추가1차: 12/5부터 중단 ❌ (5회 지급, 5회 중단)
└─ F2 추가1차 예정: 1/15+첫금 = 1/17 시작

[2/10 승급 F2→F3]
├─ F3 기본: 3/7 시작
├─ F2 기본: 계속 진행 ✅ (2/6 완료)
└─ F2 추가1차: 3/7부터 중단 ❌ (7회 지급, 3회 중단)
```

### 8.2 지급 일정표

| 날짜 | F1 기본 | F1 추가1차 | F2 기본 | F2 추가1차 | F3 기본 |
|------|---------|-----------|---------|-----------|---------|
| 9/5 | 1회 | - | - | - | - |
| ... | ... | - | - | - | - |
| 11/1 | 9회 | 1회 | - | - | - |
| 11/7 | 10회 ✅ | 2회 | - | - | - |
| 11/15 | - | 3회 | - | - | - |
| 11/22 | - | 4회 | - | - | - |
| 11/29 | - | 5회 | - | - | - |
| **12/5** | - | **중단** | 1회 | - | - |
| ... | - | - | ... | - | - |
| 1/17 | - | - | 7회 | 1회 | - |
| ... | - | - | ... | ... | - |
| 2/6 | - | - | 10회 ✅ | 3회 | - |
| 2/14 | - | - | - | 4회 | - |
| ... | - | - | - | ... | - |
| 2/28 | - | - | - | 6회 | - |
| **3/7** | - | - | - | **중단** | 1회 |

---

**문서 버전 히스토리:**

- v8.0 (2025-12-04): 추가지급 시작 시점 변경 (등록/승급일+2개월), 추가지급 중단 시점 변경 (승급 지급 시작일)
- v7.0 (2025-10-12): 추가지급 시기 변경 (매월 승급 확인), 매출 계산 변경 (등록자만), 승급 시 추가지급 중단
- v6.0 (2025-10-11): 동적 지급 계획 생성 방식으로 변경
- v5.0 (2025-10-11): 병행 지급 및 추가 지급기간 도입
