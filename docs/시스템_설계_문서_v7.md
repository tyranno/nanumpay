# MLM ì‹œìŠ¤í…œ ì„¤ê³„ ë¬¸ì„œ v7.0

**ë²„ì „**: 7.0
**ì‘ì„±ì¼**: 2025ë…„ 10ì›” 12ì¼
**ê¸°ì¤€ ìš”êµ¬ì‚¬í•­**: ì‹œìŠ¤í…œ_ìš”êµ¬ì‚¬í•­_ê²€í† ë¬¸ì„œ_v5.0

**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v7.0)**:
- **ì¶”ê°€ì§€ê¸‰ ì‹œê¸° ë³€ê²½**: 10íšŒ ì™„ë£Œ ì¦‰ì‹œ ìƒì„± â†’ ë§¤ì›” ìŠ¹ê¸‰ ì—†ëŠ” ê²½ìš° ë‹¤ìŒë‹¬ ìƒì„±
- **ì§€ê¸‰ ëŒ€ìƒì ëª…í™•í™”**: ë“±ë¡ì(ë§¤ì¶œ ê¸°ì—¬) + ìŠ¹ê¸‰ì + ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì
- **ë§¤ì¶œ ê³„ì‚° ë³€ê²½**: ë“±ë¡ì ìˆ˜ë§Œ ë§¤ì¶œ ê¸°ì—¬ (ìŠ¹ê¸‰ì/ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì ì œì™¸)
- **ë§¤ì¶œì›” ê¸°ì¤€ ë³‘í–‰ ì§€ê¸‰**: 7ì›”ë¶„+8ì›”ë¶„+9ì›”ë¶„ ë™ì‹œ ì§€ê¸‰ ê°€ëŠ¥
- **ìŠ¹ê¸‰ ì‹œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨**: ê¸°ë³¸ì§€ê¸‰ ìœ ì§€, ì¶”ê°€ì§€ê¸‰ ì¦‰ì‹œ ì¤‘ë‹¨, ìƒˆ ë“±ê¸‰ ì‹œì‘

---

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#2-ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
3. [ì§€ê¸‰ ê³„íš ì²˜ë¦¬ ë°©ì•ˆ](#3-ì§€ê¸‰-ê³„íš-ì²˜ë¦¬-ë°©ì•ˆ)
4. [ìë™í™” í”„ë¡œì„¸ìŠ¤](#4-ìë™í™”-í”„ë¡œì„¸ìŠ¤)
5. [ì›¹ API ì„¤ê³„](#5-ì›¹-api-ì„¤ê³„)
6. [ë°ì´í„° íë¦„ë„](#6-ë°ì´í„°-íë¦„ë„)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 í•µì‹¬ ì›ì¹™

**v5.0 ìš”êµ¬ì‚¬í•­ ê¸°ë°˜ ì„¤ê³„ ì›ì¹™**:

1. **ë³‘í–‰ ì§€ê¸‰**: ìŠ¹ê¸‰ ì‹œ ê¸°ì¡´ ê¸°ë³¸ì§€ê¸‰ ìœ ì§€ + ìƒˆ ë“±ê¸‰ ì§€ê¸‰ ì¶”ê°€
2. **ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨**: ìŠ¹ê¸‰ ì‹œ ê¸°ì¡´ ì¶”ê°€ì§€ê¸‰ ì¦‰ì‹œ ì¤‘ë‹¨ â­ v7.0 ì‹ ê·œ
3. **ë§¤ì›” ìŠ¹ê¸‰ í™•ì¸**: ë§¤ë‹¬ ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸ í›„ ì¶”ê°€ì§€ê¸‰ ìƒì„± â­ v7.0 ì‹ ê·œ
4. **ë§¤ì¶œì›” ê¸°ì¤€ ë³‘í–‰**: 7ì›”ë¶„+8ì›”ë¶„+9ì›”ë¶„ ë™ì‹œ ì§€ê¸‰ ê°€ëŠ¥ â­ v7.0 ì‹ ê·œ
5. **ì§€ê¸‰ ëŒ€ìƒì 3ìœ í˜•**: ë“±ë¡ì(ë§¤ì¶œ ê¸°ì—¬) + ìŠ¹ê¸‰ì + ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì â­ v7.0 ì‹ ê·œ
6. **ì£¼ê°„ ì§‘ê³„**: ê¸ˆìš”ì¼ë§ˆë‹¤ ìë™ ì§€ê¸‰ (WeeklyPaymentSummary ê¸°ë°˜)

### 1.2 ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
[ìš©ì—­ì ë“±ë¡]
    â†“
[íŠ¸ë¦¬/ë“±ê¸‰ ì¬ê³„ì‚°] â† ì˜í–¥ë°›ëŠ” ì‚¬ìš©ìë§Œ
    â†“
[ì§€ê¸‰ ëŒ€ìƒì ë¶„ë¥˜] â­ v7.0 ì‹ ê·œ
    â”œâ”€ ë“±ë¡ì (ì‹ ê·œ)
    â”œâ”€ ìŠ¹ê¸‰ì (ë“±ê¸‰ ìƒìŠ¹)
    â””â”€ ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì (ì´ì „ ì›” ë“±ë¡/ìŠ¹ê¸‰, í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—†ìŒ)
    â†“
[ì§€ê¸‰ ê³„íš ìƒì„±]
    â”œâ”€ ë“±ë¡ì: ë“±ë¡ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„±
    â”œâ”€ ìŠ¹ê¸‰ì: ìŠ¹ê¸‰ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„±, ê¸°ì¡´ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨ â­
    â””â”€ ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì: ì´ì „ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ìµœëŒ€ íšŸìˆ˜ ë¯¸ë§Œ)
    â†“
[ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸]
    â†“
[ë§¤ì£¼ ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰]
    â†“
[í†µê³„ ì—…ë°ì´íŠ¸]
```

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 2.1 ì»¬ë ‰ì…˜ ê°œìš”

ì „ì²´ **4ê°œ í•µì‹¬ ì»¬ë ‰ì…˜** êµ¬ì„±:

| ì»¬ë ‰ì…˜ëª… | ëª©ì  | ì—…ë°ì´íŠ¸ ì‹œì  | ì¡°íšŒ ë¹ˆë„ |
|---------|------|--------------|----------|
| **monthlyRegistrations** | ì›”ë³„ ë“±ë¡/ë§¤ì¶œ ê´€ë¦¬ â­ ë“±ë¡ìë§Œ | ìš©ì—­ì ë“±ë¡ ì‹œ | ë‚®ìŒ |
| **monthlyTreeSnapshots** | ì›”ë³„ ê³„ì¸µë„/ë“±ê¸‰ í™•ì • | ë“±ë¡ ì‹œ + ì›”ë§ | ì¤‘ê°„ |
| **weeklyPaymentPlans** | ê°œë³„ ì§€ê¸‰ ê³„íš | ë“±ë¡/ìŠ¹ê¸‰/ì¶”ê°€ì§€ê¸‰ ì‹œ â­ | ë†’ìŒ |
| **weeklyPaymentSummary** | ì£¼ì°¨ë³„ ì´ê³„ (í†µê³„) | ë“±ë¡/ì§€ê¸‰ ì‹œ | ë§¤ìš° ë†’ìŒ |

---

### 2.2 ì»¬ë ‰ì…˜ ìƒì„¸ ì„¤ê³„

#### 2.2.1 monthlyRegistrations (ì›”ë³„ ë“±ë¡ ê´€ë¦¬) â­ v7.0 ë³€ê²½

**ëª©ì **: ë§¤ì›” ìš©ì—­ì **ë“±ë¡(ì‹ ê·œ ë“±ë¡ì)** ë° ë§¤ì¶œ ê´€ë¦¬

**â­ v7.0 ì¤‘ìš” ë³€ê²½**: ìŠ¹ê¸‰ìëŠ” registrationsì— í¬í•¨ë˜ì§€ ì•ŠìŒ (ë“±ë¡ìë§Œ)

```javascript
{
  _id: ObjectId,
  monthKey: String,              // "2025-10" (YYYY-MM)

  // ë“±ë¡ ì •ë³´ â­ ë“±ë¡ìë§Œ (ì‹ ê·œ ë“±ë¡ì)
  registrationCount: Number,     // í•´ë‹¹ ì›” ì‹ ê·œ ë“±ë¡ ì¸ì›
  totalRevenue: Number,          // ì´ë§¤ì¶œ (ë“±ë¡ ì¸ì› Ã— 100ë§Œì›) â­
  adjustedRevenue: Number,       // ê´€ë¦¬ì ìˆ˜ë™ ì¡°ì • ê¸ˆì•¡ (nullì´ë©´ ìë™)

  // ë“±ë¡ì ëª©ë¡ â­ ì‹ ê·œ ë“±ë¡ìë§Œ
  registrations: [{
    userId: String,
    userName: String,
    registrationDate: Date,      // ì‹¤ì œ ë“±ë¡ì¼
    sponsorId: String,           // í›„ì›ì
    grade: String,               // ë“±ë¡ ì‹œì  ë“±ê¸‰ (ë“±ê¸‰ ì¬ê³„ì‚° í›„)
    position: String             // 'left' | 'right' | 'root'
  }],

  // ì§€ê¸‰ ëŒ€ìƒì ì •ë³´ â­ v7.0 ì‹ ê·œ
  paymentTargets: {
    // ì‹ ê·œ ë“±ë¡ì
    registrants: [{
      userId: String,
      userName: String,
      grade: String
    }],

    // ìŠ¹ê¸‰ì (ë§¤ì¶œ ê¸°ì—¬ ì—†ìŒ)
    promoted: [{
      userId: String,
      userName: String,
      oldGrade: String,
      newGrade: String,
      promotionDate: Date
    }],

    // ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì (ë§¤ì¶œ ê¸°ì—¬ ì—†ìŒ)
    additionalPayments: [{
      userId: String,
      userName: String,
      grade: String,
      ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: Number  // ëª‡ ë²ˆì§¸ ì¶”ê°€ì§€ê¸‰ì¸ì§€
    }]
  },

  // ë“±ê¸‰ë³„ ë¶„í¬ (ì§€ê¸‰ ëŒ€ìƒì ì „ì²´ ê¸°ì¤€) â­ v7.0 ì¤‘ìš”
  gradeDistribution: {
    F1: Number,  // ë“±ë¡ì + ìŠ¹ê¸‰ì + ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì ì¤‘ F1
    F2: Number,
    F3: Number,
    F4: Number,
    F5: Number,
    F6: Number,
    F7: Number,
    F8: Number
  },

  // ë“±ê¸‰ë³„ ë°°ë¶„ ê¸ˆì•¡ (ëˆ„ì  ë°©ì‹)
  gradePayments: {
    F1: Number,  // 8%
    F2: Number,  // 27%
    F3: Number,  // 42%
    F4: Number,  // 55%
    F5: Number,  // 67%
    F6: Number,  // 78%
    F7: Number,  // 88%
    F8: Number   // 97%
  },

  createdAt: Date,
  updatedAt: Date
}
```

**â­ v7.0 í•µì‹¬ ë³€ê²½:**
- **ë§¤ì¶œ ê³„ì‚°**: ë“±ë¡ì ìˆ˜ë§Œ Ã— 1,000,000ì› (ìŠ¹ê¸‰ì/ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì ì œì™¸)
- **ë“±ê¸‰ë³„ ë°°ë¶„**: ì§€ê¸‰ ëŒ€ìƒì ì „ì²´(ë“±ë¡ì+ìŠ¹ê¸‰ì+ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì)ì˜ ë“±ê¸‰ ë¶„í¬ ê¸°ì¤€
- **paymentTargets**: 3ê°€ì§€ ìœ í˜• ëª…í™•íˆ êµ¬ë¶„

**ì¸ë±ìŠ¤:**
- `monthKey` (unique)
- `registrations.userId`
- `paymentTargets.registrants.userId`
- `paymentTargets.promoted.userId`
- `paymentTargets.additionalPayments.userId`

**ì—…ë°ì´íŠ¸ ì‹œì :**
- ìš©ì—­ì ë“±ë¡ ì‹œ (ë“±ê¸‰ ì¬ê³„ì‚° í›„)
- ë§¤ì›” ì§€ê¸‰ ê³„íš ìƒì„± ì‹œ (ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì í™•ì¸)

---

#### 2.2.2 weeklyPaymentPlans (ê°œë³„ ì§€ê¸‰ ê³„íš) â­ v7.0 ë³€ê²½

**ëª©ì **: ìš©ì—­ìë³„ 10íšŒ ë‹¨ìœ„ ì§€ê¸‰ ê³„íš ê´€ë¦¬

```javascript
{
  _id: ObjectId,
  userId: String,
  userName: String,

  // ê³„íš ìœ í˜• â­ v7.0: ì¶”ê°€ì§€ê¸‰ ë‹¨ê³„ ì¶”ê°€
  planType: String,              // 'initial' | 'promotion'
  ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: Number,          // 0: ê¸°ë³¸, 1: ì¶”ê°€1ì°¨, 2: ì¶”ê°€2ì°¨, ... â­ v7.0
  installmentType: String,       // 'basic' | 'additional' â­ v7.0 ì‹ ê·œ

  // ê¸°ì¤€ ì •ë³´
  baseGrade: String,             // ê³„íš ìƒì„± ì‹œì  ë“±ê¸‰
  revenueMonth: String,          // ë§¤ì¶œ ê·€ì† ì›” (YYYY-MM) â­
  startDate: Date,               // ì§€ê¸‰ ì‹œì‘ì¼ (ì²« ê¸ˆìš”ì¼)

  // ì§„í–‰ ì •ë³´
  totalInstallments: Number,     // ì´ í• ë¶€ íšŸìˆ˜ (í•­ìƒ 10)
  completedInstallments: Number, // ì™„ë£Œëœ íšŸìˆ˜
  planStatus: String,            // 'active' | 'completed' | 'terminated'

  // í• ë¶€ ìƒì„¸ (10ê°œ)
  installments: [{
    week: Number,                // íšŒì°¨ (1~10)
    weekNumber: String,          // ISO ì£¼ì°¨ (2025-W31)
    scheduledDate: Date,         // ì§€ê¸‰ ì˜ˆì •ì¼ (ê¸ˆìš”ì¼)

    revenueMonth: String,        // ë§¤ì¶œ ê·€ì† ì›” â­
    gradeAtPayment: String,      // ì‹¤ì œ ì§€ê¸‰ ì‹œì  ë“±ê¸‰ (ì§€ê¸‰ ì‹œ ê¸°ë¡)

    baseAmount: Number,          // ê¸°ì¤€ ê¸ˆì•¡ (ë“±ê¸‰ë³„ ë°°ë¶„ì•¡)
    installmentAmount: Number,   // íšŒì°¨ ì§€ê¸‰ì•¡ (ê¸°ì¤€Ã·10)
    withholdingTax: Number,      // ì›ì²œì§•ìˆ˜ì„¸ (3.3%)
    netAmount: Number,           // ì‹¤ìˆ˜ë ¹ì•¡

    status: String,              // 'pending' | 'paid' | 'skipped' | 'terminated' â­
    paidDate: Date,              // ì‹¤ì œ ì§€ê¸‰ì¼
    insuranceSkipped: Boolean,   // ë³´í—˜ ë¯¸ê°€ì…ìœ¼ë¡œ ê±´ë„ˆëœ€
    terminatedReason: String     // â­ v7.0: 'promotion' (ìŠ¹ê¸‰ìœ¼ë¡œ ì¸í•œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨)
  }],

  // ì¶”ê°€ ì •ë³´
  parentPlanId: ObjectId,        // ì´ì „ 10íšŒ ê³„íš ID (ì—°ê²° ì¶”ì ìš©)
  createdBy: String,             // 'registration' | 'promotion' | 'monthly_check' â­
  terminatedBy: String,          // â­ v7.0: 'promotion' (ìŠ¹ê¸‰ìœ¼ë¡œ ì¤‘ë‹¨)
  terminatedAt: Date,            // â­ v7.0: ì¤‘ë‹¨ ì‹œì 

  createdAt: Date,
  updatedAt: Date
}
```

**â­ v7.0 ì£¼ìš” ë³€ê²½:**
- `ì¶”ê°€ì§€ê¸‰ë‹¨ê³„`: 0(ê¸°ë³¸), 1(ì¶”ê°€1ì°¨), 2(ì¶”ê°€2ì°¨), ...
- `installmentType`: 'basic'(ê¸°ë³¸ 10íšŒ) | 'additional'(ì¶”ê°€ì§€ê¸‰)
- `terminatedBy`, `terminatedAt`: ìŠ¹ê¸‰ìœ¼ë¡œ ì¸í•œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨ ì¶”ì 
- `createdBy`: 'monthly_check' ì¶”ê°€ (ë§¤ì›” ìŠ¹ê¸‰ í™•ì¸ ì‹œ ìƒì„±)
- `status`: 'terminated' ì¶”ê°€ (ìŠ¹ê¸‰ìœ¼ë¡œ ì¤‘ë‹¨ëœ í• ë¶€)

**ì¸ë±ìŠ¤:**
- `userId`
- `planType`
- `ì¶”ê°€ì§€ê¸‰ë‹¨ê³„`
- `installmentType`
- `baseGrade`
- `revenueMonth`
- `planStatus`
- `installments.weekNumber`
- `installments.status`

---

#### 2.2.3 weeklyPaymentSummary (ì£¼ì°¨ë³„ ì´ê³„)

**ëª©ì **: ì£¼ì°¨ë³„ ì „ì²´ ì§€ê¸‰ ì´ê³„ ë° í†µê³„ (ë¹ ë¥¸ ì¡°íšŒìš©) + **ì£¼ì°¨ë³„ ì§€ê¸‰ëŒ€ì¥ ê´€ë¦¬**

```javascript
{
  _id: ObjectId,
  weekNumber: String,            // ISO ì£¼ì°¨ (2025-W31)
  weekDate: Date,                // í•´ë‹¹ ê¸ˆìš”ì¼ ë‚ ì§œ
  monthKey: String,              // ì›” í‚¤ (2025-08)

  // ì§€ê¸‰ ì´ê³„
  totalAmount: Number,           // ì§€ê¸‰ ì´ì•¡
  totalTax: Number,              // ì›ì²œì§•ìˆ˜ ì´ì•¡
  totalNet: Number,              // ì‹¤ìˆ˜ë ¹ ì´ì•¡
  recipientCount: Number,        // ì§€ê¸‰ ëŒ€ìƒì ìˆ˜

  // í†µê³„
  status: String,                // 'pending' | 'paid' | 'processing'
  processedAt: Date,             // ì²˜ë¦¬ ì™„ë£Œ ì‹œê°

  createdAt: Date,
  updatedAt: Date
}
```

**v7.0 í•µì‹¬ ì—­í• :**
1. **ì£¼ì°¨ë³„ ì§€ê¸‰ëŒ€ì¥**: ë§¤ì£¼ ì§€ê¸‰ ëŒ€ìƒ ë° ê¸ˆì•¡ ê´€ë¦¬
2. **ê¸ˆìš”ì¼ ìë™ì²˜ë¦¬ ì¤‘ì‹¬**: ì§€ê¸‰ ì²˜ë¦¬ í›„ Summary ì—…ë°ì´íŠ¸
3. **ë¹ ë¥¸ ì¡°íšŒ**: ì£¼ì°¨ë³„ ì´ê³„ë¥¼ WeeklyPaymentPlans ì¡°íšŒ ì—†ì´ ì¦‰ì‹œ í™•ì¸
4. **í†µê³„ ê¸°ë°˜**: ëŒ€ì‹œë³´ë“œ, ë³´ê³ ì„œ ë“±ì—ì„œ ì‚¬ìš©

**ì—…ë°ì´íŠ¸ ì‹œì :**
- ë“±ë¡/ìŠ¹ê¸‰/ì¶”ê°€ì§€ê¸‰ ì‹œ: ì§€ê¸‰ ê³„íš ìƒì„± â†’ Summaryì— ì˜ˆìƒ ê¸ˆì•¡ ì¶”ê°€
- ê¸ˆìš”ì¼ ìë™ì²˜ë¦¬: ì‹¤ì œ ì§€ê¸‰ â†’ Summary ì—…ë°ì´íŠ¸

**ì¸ë±ìŠ¤:**
- `weekNumber` (unique)
- `weekDate`
- `monthKey`
- `status`

---

## 3. ì§€ê¸‰ ê³„íš ì²˜ë¦¬ ë°©ì•ˆ

### 3.1 ì´ˆê¸° ê³„íš ìƒì„± (ë“±ë¡ ì‹œ) â­ v7.0

#### 3.1.1 ë“±ë¡ ì‹œ Initial ê³„íš ìƒì„±

**ìƒì„± ì¡°ê±´:**
- ìš©ì—­ì ì‹ ê·œ ë“±ë¡ ì‹œ
- ë“±ê¸‰ ì¬ê³„ì‚° ì™„ë£Œ í›„

**ìƒì„± ë‚´ìš©:**
```javascript
{
  planType: 'initial',
  ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0,               // ê¸°ë³¸ ì§€ê¸‰ â­
  installmentType: 'basic',      // ê¸°ë³¸ 10íšŒ â­
  baseGrade: user.grade,         // ë“±ë¡ ì‹œì  ë“±ê¸‰
  revenueMonth: '2025-07',       // ë“±ë¡ì›”
  totalInstallments: 10,         // 10íšŒ ê³ ì •
  installments: [
    {
      week: 1,
      weekNumber: '2025-W31',
      scheduledDate: new Date('2025-08-01'),
      revenueMonth: '2025-07',   // ë“±ë¡ì›” ë§¤ì¶œ â­
      installmentAmount: 24000,  // ë“±ë¡ì›” ë§¤ì¶œ ê¸°ì¤€
    },
    // ... 10ê°œ
  ]
}
```

**ë§¤ì¶œ ê¸°ì¤€:**
- ë“±ë¡ì›”(registrationDateì˜ YYYY-MM)ì˜ ë§¤ì¶œ
- `monthlyRegistrations`ì—ì„œ ì¡°íšŒ
- **ë“±ë¡ì ìˆ˜ë§Œ** Ã— 1,000,000ì› â­ v7.0

**ì§€ê¸‰ ì‹œì‘ì¼:**
- ë“±ë¡ì¼ + 1ê°œì›” í›„ ì²« ê¸ˆìš”ì¼

---

### 3.2 ìŠ¹ê¸‰ ì‹œ ì²˜ë¦¬ â­ v7.0 ë³€ê²½

#### 3.2.1 ìŠ¹ê¸‰ ì‹œ ê¸°ë³¸ì§€ê¸‰ ì²˜ë¦¬

**ì²˜ë¦¬ ì›ì¹™:**
- âœ… ê¸°ë³¸ì§€ê¸‰(ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0) ê³„íšì€ **ê³„ì† ì§„í–‰** (ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ)
- âœ… ìƒˆ ë“±ê¸‰ ê¸°ë³¸ì§€ê¸‰ ê³„íš ìƒì„±

#### 3.2.2 ìŠ¹ê¸‰ ì‹œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨ â­ v7.0 ì‹ ê·œ

**ì²˜ë¦¬ ì›ì¹™:**
- âŒ ì¶”ê°€ì§€ê¸‰(ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1+) ê³„íšì€ **ì¦‰ì‹œ ì¤‘ë‹¨**
- ì¤‘ë‹¨ëœ í• ë¶€ëŠ” `status: 'terminated'`, `terminatedReason: 'promotion'`

**ì¤‘ë‹¨ ë¡œì§:**
```javascript
// ìŠ¹ê¸‰ ê°ì§€ ì‹œ
if (user.oldGrade < user.newGrade) {
  // ì§„í–‰ ì¤‘ì¸ ì¶”ê°€ì§€ê¸‰ ê³„íš ì°¾ê¸°
  const additionalPlans = await WeeklyPaymentPlans.find({
    userId: user.loginId,
    installmentType: 'additional',  // ì¶”ê°€ì§€ê¸‰ë§Œ
    planStatus: 'active'
  });

  for (const plan of additionalPlans) {
    // ë¯¸ì§€ê¸‰ í• ë¶€ë¥¼ terminatedë¡œ ë³€ê²½
    for (const inst of plan.installments) {
      if (inst.status === 'pending') {
        inst.status = 'terminated';
        inst.terminatedReason = 'promotion';
      }
    }

    plan.planStatus = 'terminated';
    plan.terminatedBy = 'promotion';
    plan.terminatedAt = new Date();
    await plan.save();

    console.log(`[${user.loginId}] ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨: ${plan.revenueMonth} ë§¤ì¶œë¶„`);
  }
}
```

#### 3.2.3 ìŠ¹ê¸‰ ì‹œ Promotion ê³„íš ìƒì„±

**ìƒì„± ì¡°ê±´:**
- ë“±ê¸‰ ì¬ê³„ì‚° í›„ ìŠ¹ê¸‰ í™•ì¸ë¨
- ê¸°ì¡´ ê¸°ë³¸ì§€ê¸‰ì€ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ (ë³‘í–‰ ì§€ê¸‰)

**ìƒì„± ë‚´ìš©:**
```javascript
{
  planType: 'promotion',
  ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0,               // ìƒˆ ë“±ê¸‰ ê¸°ë³¸ ì§€ê¸‰ â­
  installmentType: 'basic',      // ê¸°ë³¸ 10íšŒ â­
  baseGrade: newGrade,           // ìŠ¹ê¸‰ í›„ ë“±ê¸‰
  revenueMonth: '2025-10',       // ìŠ¹ê¸‰ ì‹œì  ì›”
  totalInstallments: 10,         // 10íšŒ ê³ ì •
  installments: [
    {
      week: 1,
      weekNumber: '2025-W41',
      scheduledDate: new Date('2025-10-10'),
      revenueMonth: '2025-10',   // ìŠ¹ê¸‰ì›” ë§¤ì¶œ â­
      installmentAmount: 81000,  // ìŠ¹ê¸‰ ì‹œì  ì›” ë§¤ì¶œ ê¸°ì¤€
    },
    // ... 10ê°œ
  ]
}
```

---

### 3.3 ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„± (ë§¤ì›” ìŠ¹ê¸‰ í™•ì¸) â­ v7.0 í•µì‹¬ ë³€ê²½

#### 3.3.1 ìƒì„± ì‹œì 

**â­ v7.0 í•µì‹¬ ë³€ê²½: ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì‹œì ì— í™•ì¸**

```javascript
// ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì‹œ
async function monthlyPaymentCheck(currentMonth) {
  // 1. ì´ì „ ì›”ì— ë“±ë¡/ìŠ¹ê¸‰í•œ ì‚¬ìš©ì ì¡°íšŒ
  const previousMonth = getPreviousMonth(currentMonth);

  // 2. ì´ì „ ì›” ë“±ë¡ì
  const prevMonthRegistrants = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 3. ì´ì „ ì›” ìŠ¹ê¸‰ì
  const prevMonthPromoted = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 4. ê° ì‚¬ìš©ìì— ëŒ€í•´ í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸
  for (const user of [...prevMonthRegistrants.registrations, ...prevMonthPromoted.paymentTargets.promoted]) {
    const currentUser = await User.findOne({ loginId: user.userId });

    // í˜„ì¬ ì›”ì— ìŠ¹ê¸‰í–ˆëŠ”ì§€ í™•ì¸
    const hasPromotionThisMonth = await checkPromotionInMonth(user.userId, currentMonth);

    if (!hasPromotionThisMonth) {
      // ìŠ¹ê¸‰ ì—†ìŒ â†’ ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì
      await createAdditionalPaymentPlan(user.userId, previousMonth);
    }
  }
}
```

#### 3.3.2 ìƒì„± ì¡°ê±´ í™•ì¸

**1ë‹¨ê³„: ìµœëŒ€ íšŸìˆ˜ í™•ì¸**
```javascript
const MAX_INSTALLMENTS = {
  F1: 20, F2: 30, F3: 40, F4: 40,
  F5: 50, F6: 50, F7: 60, F8: 60
};

// í•´ë‹¹ ë“±ê¸‰ì˜ ì „ì²´ ì™„ë£Œ íšŒì°¨ ê³„ì‚°
const totalCompleted = await WeeklyPaymentPlans.aggregate([
  {
    $match: {
      userId,
      baseGrade: currentGrade,
      planStatus: { $in: ['completed', 'active'] }
    }
  },
  {
    $group: {
      _id: null,
      total: { $sum: '$completedInstallments' }
    }
  }
]);

// ì˜ˆì •ëœ ì¶”ê°€ì§€ê¸‰ê¹Œì§€ í¬í•¨
const plannedInstallments = await WeeklyPaymentPlans.countDocuments({
  userId,
  baseGrade: currentGrade,
  planStatus: 'active'
}) * 10;

const totalExpected = totalCompleted + plannedInstallments;

const maxForGrade = MAX_INSTALLMENTS[currentGrade];
if (totalExpected >= maxForGrade) {
  // ìµœëŒ€ íšŸìˆ˜ ë„ë‹¬ - ìƒì„± ì•ˆ í•¨
  console.log(`[${userId}] ${currentGrade} ìµœëŒ€ ${maxForGrade}íšŒ ë„ë‹¬`);
  return;
}
```

**2ë‹¨ê³„: ë“±ê¸‰ í™•ì¸**
```javascript
const currentGrade = user.grade;
const previousGrade = await getPreviousGrade(user.userId, previousMonth);

if (currentGrade < previousGrade) {
  // ë“±ê¸‰ í•˜ë½ - ìƒì„± ì•ˆ í•¨
  console.log(`[${userId}] ë“±ê¸‰ í•˜ë½: ${previousGrade} â†’ ${currentGrade}`);
  return;
}
```

**3ë‹¨ê³„: ë³´í—˜ í™•ì¸ (F3 ì´ìƒ)**
```javascript
if (currentGrade >= 'F3') {
  const insurance = user.insuranceSettings;
  if (!insurance || !insurance.maintained) {
    // ë³´í—˜ ë¯¸ê°€ì…/ë¯¸ìœ ì§€ - ìƒì„± ì•ˆ í•¨
    console.log(`[${userId}] ë³´í—˜ ë¯¸ê°€ì…`);
    return;
  }
}
```

#### 3.3.3 ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„±

**ë§¤ì¶œì›” ê²°ì •:**
```javascript
// ì´ì „ ì›” ë§¤ì¶œ ê¸°ì¤€ â­ v7.0
const revenueMonth = previousMonth; // ì˜ˆ: '2025-08'
```

**ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ ê³„ì‚°:**
```javascript
// í•´ë‹¹ ë“±ê¸‰ì—ì„œ ìµœëŒ€ ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ ê³„ì‚°
const existingPlans = await WeeklyPaymentPlans.find({
  userId,
  baseGrade: currentGrade,
  planType: { $in: ['initial', 'promotion'] }
}).sort({ ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: -1 });

const nextì¶”ê°€ì§€ê¸‰ë‹¨ê³„ = existingPlans.length > 0
  ? existingPlans[0].ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ + 1
  : 1;
```

**ìƒì„± ë‚´ìš©:**
```javascript
{
  planType: lastPlan.planType,   // 'initial' | 'promotion' ìœ ì§€
  ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: nextì¶”ê°€ì§€ê¸‰ë‹¨ê³„,  // 1, 2, 3, ... â­
  installmentType: 'additional', // ì¶”ê°€ì§€ê¸‰ â­
  baseGrade: currentGrade,       // í˜„ì¬ ë“±ê¸‰
  revenueMonth: previousMonth,   // ì´ì „ ì›” ë§¤ì¶œ â­
  totalInstallments: 10,
  parentPlanId: lastPlan._id,    // ì´ì „ ê³„íš ì—°ê²°
  createdBy: 'monthly_check',    // ë§¤ì›” í™•ì¸ìœ¼ë¡œ ìƒì„± â­
  installments: [
    {
      week: 1,                   // ìƒˆë¡œìš´ 10íšŒ ì‹œì‘
      weekNumber: nextWeekNumber,
      scheduledDate: nextFriday, // ë‹¤ìŒ ê¸ˆìš”ì¼
      revenueMonth: previousMonth, // ì´ì „ ì›” ë§¤ì¶œ â­
      installmentAmount: newAmount, // ì´ì „ ì›” ë§¤ì¶œ ê¸°ì¤€ ì¬ê³„ì‚°
    },
    // ... 10ê°œ
  ]
}
```

**ë§¤ì¶œ ê¸°ì¤€:**
- **ì´ì „ ì›” ë§¤ì¶œ**ë¡œ ê¸ˆì•¡ ê³„ì‚°
- ì§€ê¸‰ ëŒ€ìƒì(ë“±ë¡ì+ìŠ¹ê¸‰ì+ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì) ì „ì²´ì˜ ë“±ê¸‰ ë¶„í¬ ê¸°ì¤€

**ì˜ˆì‹œ:**
```
F2 ë“±ê¸‰ 8ì›” ë“±ë¡:
- 8ì›”: ë“±ë¡ â†’ 8ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ê¸°ë³¸)
- 9ì›”: ìŠ¹ê¸‰ ì—†ìŒ â†’ 8ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ì¶”ê°€ 1ì°¨) â­
- 10ì›”: ìŠ¹ê¸‰ ì—†ìŒ â†’ 9ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ì¶”ê°€ 2ì°¨) â­
- 11ì›”: F2 ìµœëŒ€ 30íšŒ ë„ë‹¬ (8ì›”+9ì›”+10ì›”) â†’ ìƒì„± ì•ˆ í•¨
```

---

### 3.4 ë³‘í–‰ ì§€ê¸‰ ê´€ë¦¬ â­ v7.0

#### 3.4.1 ë³‘í–‰ ì§€ê¸‰ ì‹œë‚˜ë¦¬ì˜¤

**ì‹œë‚˜ë¦¬ì˜¤ 1: F1 ê¸°ë³¸ 10íšŒ â†’ F2 ìŠ¹ê¸‰**
```
íƒ€ì„ë¼ì¸:
- 2025-07-01: ë“±ë¡ (F1)
  â†’ Initial-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„0 ìƒì„± (1~10íšŒ, F1, 7ì›” ë§¤ì¶œë¶„)

- 2025-08-01: ì§€ê¸‰ ê³„íš í™•ì¸
  â†’ 7ì›” ë“±ë¡ì, 8ì›” ìŠ¹ê¸‰ ì—†ìŒ
  â†’ Initial-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„1 ìƒì„± (11~20íšŒ, F1, 7ì›” ë§¤ì¶œë¶„) â­ ì¶”ê°€ì§€ê¸‰
  â†’ F1 ìµœëŒ€ 20íšŒ ë„ë‹¬!

- 2025-09-05: F2 ìŠ¹ê¸‰!
  â†’ Initial-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„1(11~20íšŒ) ì¤‘ë‹¨ âŒ (ì¶”ê°€ì§€ê¸‰ì´ë¯€ë¡œ)
  â†’ Promotion-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„0 ìƒì„± (1~10íšŒ, F2, 9ì›” ë§¤ì¶œë¶„) âœ…

- 2025-09-12: ê¸ˆìš”ì¼ ì§€ê¸‰
  â†’ Initial-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„0: 5íšŒ (F1 ê¸°ë³¸ì§€ê¸‰ ê³„ì†) âœ…
  â†’ Promotion-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„0: 1íšŒ (F2 ê¸°ë³¸ì§€ê¸‰ ì‹œì‘) âœ…
  â†’ ë³‘í–‰ ì§€ê¸‰! â­

- 2025-10-01: ì§€ê¸‰ ê³„íš í™•ì¸
  â†’ 9ì›” ìŠ¹ê¸‰ì, 10ì›” ìŠ¹ê¸‰ ì—†ìŒ
  â†’ Promotion-ì¶”ê°€ì§€ê¸‰ë‹¨ê³„1 ìƒì„±? (11~20íšŒ, F2, 9ì›” ë§¤ì¶œë¶„) âœ…
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: ì „ì²´ ê³„ì‚° ì˜ˆì‹œ (7ì›”-10ì›”) â­ ì‹¤ì œ ê³„ì‚°**

**ì´ˆê¸° ìƒíƒœ:**
```
7ì›”: A, B, C ë“±ë¡ (A ì•„ë˜ B, C)
- íŠ¸ë¦¬: A(F2) - B(F1), C(F1)
- ë§¤ì¶œ: 3ëª… Ã— 1,000,000ì› = 3,000,000ì›

8ì›”: D, E, F ë“±ë¡ (B ì•„ë˜ D,E / C ì•„ë˜ F)
- íŠ¸ë¦¬: A(F2), B(F2), C(F1), D(F1), E(F1), F(F1)
- ë§¤ì¶œ: 3ëª… Ã— 1,000,000ì› = 3,000,000ì›

9ì›”: G ë“±ë¡ (D ì•„ë˜ G)
- íŠ¸ë¦¬: A(F2), B(F2), C(F1), D(F1), E(F1), F(F1), G(F1)
- ë§¤ì¶œ: 1ëª… Ã— 1,000,000ì› = 1,000,000ì›
```

**7ì›” ë§¤ì¶œ (3,000,000ì›) â†’ 8ì›”ë¶€í„° ì§€ê¸‰:**
```
ì§€ê¸‰ ëŒ€ìƒì: A(F2), B(F1), C(F1) = 3ëª…
ë“±ê¸‰ ë¶„í¬: F1=2ëª…, F2=1ëª…

ê³„ì‚°:
F1: (3,000,000 Ã— 0.24) / (2+1) = 720,000 / 3 = 240,000ì›
F2: (3,000,000 Ã— 0.19) / (1+0) = 570,000 / 1 = 570,000ì›
    570,000 + 240,000 = 810,000ì›

10ë¶„í• :
A(F2): 810,000 Ã· 10 Ã· 100 Ã— 100 = 81,000ì›/íšŒ
B(F1): 240,000 Ã· 10 Ã· 100 Ã— 100 = 24,000ì›/íšŒ
C(F1): 240,000 Ã· 10 Ã· 100 Ã— 100 = 24,000ì›/íšŒ
```

**8ì›” ë§¤ì¶œ (3,000,000ì›) â†’ 9ì›”ë¶€í„° ì§€ê¸‰:**
```
ì§€ê¸‰ ëŒ€ìƒì:
- ë“±ë¡ì: D(F1), E(F1), F(F1) = 3ëª…
- ìŠ¹ê¸‰ì: B(F1â†’F2) = 1ëª…
- ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì: A(F2), C(F1) = 2ëª…
- ì´ 6ëª…

ë“±ê¸‰ ë¶„í¬: F1=4ëª…[C,D,E,F], F2=2ëª…[A,B]

ê³„ì‚°:
F1: (3,000,000 Ã— 0.24) / (4+2) = 720,000 / 6 = 120,000ì›
F2: (3,000,000 Ã— 0.19) / (2+0) = 570,000 / 2 = 285,000ì›
    285,000 + 120,000 = 405,000ì›

10ë¶„í• :
A(F2 ì¶”ê°€1ì°¨): 405,000 Ã· 10 Ã· 100 Ã— 100 = 40,500ì›/íšŒ
B(F2 ê¸°ë³¸): 405,000 Ã· 10 Ã· 100 Ã— 100 = 40,500ì›/íšŒ
C(F1 ì¶”ê°€1ì°¨): 120,000 Ã· 10 Ã· 100 Ã— 100 = 12,000ì›/íšŒ
D(F1 ê¸°ë³¸): 120,000 Ã· 10 Ã· 100 Ã— 100 = 12,000ì›/íšŒ
E(F1 ê¸°ë³¸): 120,000 Ã· 10 Ã· 100 Ã— 100 = 12,000ì›/íšŒ
F(F1 ê¸°ë³¸): 120,000 Ã· 10 Ã· 100 Ã— 100 = 12,000ì›/íšŒ
```

**9ì›” ë§¤ì¶œ (1,000,000ì›) â†’ 10ì›”ë¶€í„° ì§€ê¸‰:**
```
ì§€ê¸‰ ëŒ€ìƒì:
- ë“±ë¡ì: G(F1) = 1ëª…
- ìŠ¹ê¸‰ì: ì—†ìŒ
- ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì: A(F2), B(F2), D(F1), E(F1), F(F1) = 5ëª…
  (C ì œì™¸: F1 ìµœëŒ€ 20íšŒ ë„ë‹¬ - 7ì›”10íšŒ+8ì›”10íšŒ=20íšŒ)
- ì´ 6ëª…

ë“±ê¸‰ ë¶„í¬: F1=4ëª…[D,E,F,G], F2=2ëª…[A,B]

ê³„ì‚°:
F1: (1,000,000 Ã— 0.24) / (4+2) = 240,000 / 6 = 40,000ì›
F2: (1,000,000 Ã— 0.19) / (2+0) = 190,000 / 2 = 95,000ì›
    95,000 + 40,000 = 135,000ì›

10ë¶„í• :
A(F2 ì¶”ê°€2ì°¨): 135,000 Ã· 10 Ã· 100 Ã— 100 = 13,500ì›/íšŒ
B(F2 ì¶”ê°€1ì°¨): 135,000 Ã· 10 Ã· 100 Ã— 100 = 13,500ì›/íšŒ
D(F1 ì¶”ê°€1ì°¨): 40,000 Ã· 10 Ã· 100 Ã— 100 = 4,000ì›/íšŒ
E(F1 ì¶”ê°€1ì°¨): 40,000 Ã· 10 Ã· 100 Ã— 100 = 4,000ì›/íšŒ
F(F1 ì¶”ê°€1ì°¨): 40,000 Ã· 10 Ã· 100 Ã— 100 = 4,000ì›/íšŒ
G(F1 ê¸°ë³¸): 40,000 Ã· 10 Ã· 100 Ã— 100 = 4,000ì›/íšŒ
```

**ì§€ê¸‰ ê³„íš ìƒì„± ìš”ì•½:**
```
7ì›” ì²˜ë¦¬ (8ì›” ì§€ê¸‰ ì‹œì‘):
- A: 7ì›”F2 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)
- B: 7ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)
- C: 7ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)

8ì›” ì²˜ë¦¬ (9ì›” ì§€ê¸‰ ì‹œì‘):
- A: 7ì›”F2 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 7ì›” ë§¤ì¶œ) â­
- B: 8ì›”F2 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0, ìŠ¹ê¸‰ìœ¼ë¡œ ìƒˆ ì‹œì‘)
- C: 7ì›”F1 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 7ì›” ë§¤ì¶œ) â­ â†’ F1 20íšŒ ë„ë‹¬!
- D: 8ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)
- E: 8ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)
- F: 8ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)

9ì›” ì²˜ë¦¬ (10ì›” ì§€ê¸‰ ì‹œì‘):
- A: 8ì›”F2 ì¶”ê°€2ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:2, 8ì›” ë§¤ì¶œ) â­ â†’ F2 30íšŒ ë„ë‹¬!
- B: 8ì›”F2 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 8ì›” ë§¤ì¶œ) â­
- C: ìƒì„± ì•ˆ í•¨ (F1 ìµœëŒ€ 20íšŒ ë„ë‹¬)
- D: 8ì›”F1 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 8ì›” ë§¤ì¶œ) â­ â†’ F1 20íšŒ ë„ë‹¬!
- E: 8ì›”F1 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 8ì›” ë§¤ì¶œ) â­ â†’ F1 20íšŒ ë„ë‹¬!
- F: 8ì›”F1 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 8ì›” ë§¤ì¶œ) â­ â†’ F1 20íšŒ ë„ë‹¬!
- G: 9ì›”F1 ê¸°ë³¸ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0)

10ì›” ì²˜ë¦¬ (11ì›” ì§€ê¸‰ ì‹œì‘):
- A: ìƒì„± ì•ˆ í•¨ (F2 ìµœëŒ€ 30íšŒ ë„ë‹¬)
- B: 9ì›”F2 ì¶”ê°€2ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:2, 9ì›” ë§¤ì¶œ) â­ â†’ F2 30íšŒ ë„ë‹¬!
- D,E,F: ìƒì„± ì•ˆ í•¨ (F1 ìµœëŒ€ 20íšŒ ë„ë‹¬)
- G: 9ì›”F1 ì¶”ê°€1ì°¨ (ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1, 9ì›” ë§¤ì¶œ)
```

**í•µì‹¬ í¬ì¸íŠ¸:**
1. **ë§¤ì¶œ**: ì‹ ê·œ ë“±ë¡ì ìˆ˜ë§Œ ê³„ì‚°
2. **ì§€ê¸‰ ëŒ€ìƒì**: ë“±ë¡ì + ìŠ¹ê¸‰ì + ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì (ìµœëŒ€ íšŸìˆ˜ ë¯¸ë„ë‹¬ì)
3. **ë“±ê¸‰ë³„ ë°°ë¶„**: ì§€ê¸‰ ëŒ€ìƒìì˜ ë“±ê¸‰ ë¶„í¬ ê¸°ì¤€
4. **ì¶”ê°€ì§€ê¸‰ ë§¤ì¶œì›”**: ëŒ€ìƒìê°€ ì†í•œ ì›”ì˜ ë§¤ì¶œ ì‚¬ìš©
   - 8ì›” ì²˜ë¦¬ ì‹œ â†’ 7ì›” ëŒ€ìƒì â†’ 7ì›” ë§¤ì¶œ ì‚¬ìš©
   - 9ì›” ì²˜ë¦¬ ì‹œ â†’ 8ì›” ëŒ€ìƒì â†’ 8ì›” ë§¤ì¶œ ì‚¬ìš©
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: ë§¤ì¶œì›” ë³‘í–‰ ì§€ê¸‰ (7ì›”+8ì›”+9ì›”)**
```
íƒ€ì„ë¼ì¸:
- 2025-07-01: ë“±ë¡ (F2)
  â†’ 7ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„±

- 2025-08-01: ìŠ¹ê¸‰ ì—†ìŒ
  â†’ 7ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ì¶”ê°€ 1ì°¨)

- 2025-09-01: ìŠ¹ê¸‰ ì—†ìŒ
  â†’ 8ì›” ë§¤ì¶œë¶„ 10íšŒ ìƒì„± (ì¶”ê°€ 2ì°¨)
  â†’ F2 ìµœëŒ€ 30íšŒ ë„ë‹¬!

- 2025-09-06 (ê¸ˆìš”ì¼):
  â†’ 7ì›” ë§¤ì¶œë¶„ 1íšŒ: 24,000ì› (ê¸°ë³¸)
  â†’ 7ì›” ë§¤ì¶œë¶„ 1íšŒ: 24,000ì› (ì¶”ê°€ 1ì°¨)
  â†’ 8ì›” ë§¤ì¶œë¶„ 1íšŒ: 27,000ì› (ì¶”ê°€ 2ì°¨, 8ì›” ë§¤ì¶œ ë‹¤ë¦„)
  â†’ ì´ 3ê°œ ê³„íš ë³‘í–‰ ì§€ê¸‰! â­ v7.0
```

---

## 4. ìë™í™” í”„ë¡œì„¸ìŠ¤

### 4.1 ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰ í”„ë¡œì„¸ìŠ¤ â­ v7.0

**ì‹¤í–‰ ì‹œì :** ë§¤ì£¼ ê¸ˆìš”ì¼ 00:00

**ì²˜ë¦¬ íë¦„:**

```javascript
async function processFridayPayments() {
  const today = new Date();
  const weekNumber = getISOWeek(today);

  // === 1ë‹¨ê³„: ì§€ê¸‰ ì²˜ë¦¬ ===
  const plans = await WeeklyPaymentPlans.find({
    'installments': {
      $elemMatch: {
        weekNumber: weekNumber,
        status: 'pending'
      }
    },
    planStatus: 'active'  // â­ v7.0: terminated ì œì™¸
  });

  for (const plan of plans) {
    // ì§€ê¸‰ ëŒ€ìƒ í• ë¶€ ì°¾ê¸°
    const installment = plan.installments.find(
      inst => inst.weekNumber === weekNumber && inst.status === 'pending'
    );

    // ë³´í—˜ í™•ì¸ (F3 ì´ìƒ)
    const user = await User.findOne({ loginId: plan.userId });
    if (user.grade >= 'F3' && !user.insuranceSettings?.maintained) {
      installment.status = 'skipped';
      installment.insuranceSkipped = true;
      continue;
    }

    // ì§€ê¸‰ ì²˜ë¦¬
    installment.status = 'paid';
    installment.paidDate = today;
    installment.gradeAtPayment = user.grade;

    plan.completedInstallments++;

    // ê³„íš ì™„ë£Œ í™•ì¸
    if (plan.completedInstallments === plan.totalInstallments) {
      plan.planStatus = 'completed';
    }

    await plan.save();
  }

  // === 2ë‹¨ê³„: WeeklyPaymentSummary ì—…ë°ì´íŠ¸ ===
  await updateWeeklySummary(weekNumber, plans);

  // === ë! ì¶”ê°€ì§€ê¸‰ í™•ì¸ì€ ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì‹œì ì— ìˆ˜í–‰ ===
}
```

**â­ v7.0 ì¤‘ìš” ë³€ê²½:**
- ê¸ˆìš”ì¼ ì²˜ë¦¬ëŠ” **ìˆœìˆ˜í•˜ê²Œ ì§€ê¸‰ë§Œ** ìˆ˜í–‰
- ì¶”ê°€ì§€ê¸‰ í™•ì¸ ë° ìƒì„±ì€ **ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì‹œì **ì— ìˆ˜í–‰

---

### 4.2 ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸ ë¡œì§ â­ v7.0 ì‹ ê·œ

**ì‹¤í–‰ ì‹œì :** ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì‹œì 

**íŠ¸ë¦¬ê±°:** ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì™„ë£Œ í›„

```javascript
// ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì‹œ ì‹¤í–‰
async function checkAndCreateMonthlyAdditionalPayments(currentMonth) {
  console.log(`[ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸] ${currentMonth} ì‹œì‘`);

  const previousMonth = getPreviousMonth(currentMonth);

  // 1. ì´ì „ ì›” ë“±ë¡ì ì¡°íšŒ
  const prevMonthReg = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 2. ì´ì „ ì›” ìŠ¹ê¸‰ì ì¡°íšŒ
  const prevMonthPromoted = prevMonthReg?.paymentTargets?.promoted || [];

  // 3. ëŒ€ìƒì ëª©ë¡ ìƒì„±
  const candidates = [
    ...(prevMonthReg?.registrations || []),
    ...prevMonthPromoted
  ];

  console.log(`[ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸] ì´ì „ ì›”(${previousMonth}) ëŒ€ìƒì: ${candidates.length}ëª…`);

  let createdCount = 0;
  let skippedCount = 0;

  for (const candidate of candidates) {
    const user = await User.findOne({ loginId: candidate.userId });
    if (!user) continue;

    // 4. í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸
    const hasPromotion = await checkPromotionInMonth(user.loginId, currentMonth);

    if (hasPromotion) {
      console.log(`[${user.loginId}] ${currentMonth} ìŠ¹ê¸‰ ë°œìƒ - ì¶”ê°€ì§€ê¸‰ ìƒì„± ì•ˆ í•¨`);
      skippedCount++;
      continue;
    }

    // 5. ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„± ì‹œë„
    const result = await createAdditionalPaymentPlan(user, previousMonth);

    if (result.created) {
      createdCount++;
      console.log(`[${user.loginId}] ì¶”ê°€ì§€ê¸‰ ìƒì„±: ${previousMonth} ë§¤ì¶œë¶„ ${result.ì¶”ê°€ì§€ê¸‰ë‹¨ê³„}ë‹¨ê³„`);
    } else {
      skippedCount++;
      console.log(`[${user.loginId}] ì¶”ê°€ì§€ê¸‰ ìƒì„± ì•ˆ í•¨: ${result.reason}`);
    }
  }

  console.log(`[ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸] ì™„ë£Œ: ìƒì„± ${createdCount}ê±´, ì œì™¸ ${skippedCount}ê±´`);

  // 6. MonthlyRegistrationsì— ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì ê¸°ë¡
  await MonthlyRegistrations.updateOne(
    { monthKey: currentMonth },
    {
      $set: {
        'paymentTargets.additionalPayments': await getAdditionalPaymentTargets(currentMonth)
      }
    }
  );

  return { created: createdCount, skipped: skippedCount };
}

// ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„±
async function createAdditionalPaymentPlan(user, revenueMonth) {
  // 1. ìµœëŒ€ íšŸìˆ˜ í™•ì¸
  const MAX_INSTALLMENTS = { F1: 20, F2: 30, F3: 40, F4: 40, F5: 50, F6: 50, F7: 60, F8: 60 };
  const totalCompleted = await calculateTotalInstallmentsForGrade(user.loginId, user.grade);

  if (totalCompleted >= MAX_INSTALLMENTS[user.grade]) {
    return { created: false, reason: 'ìµœëŒ€ íšŸìˆ˜ ë„ë‹¬' };
  }

  // 2. ë“±ê¸‰ í™•ì¸
  const lastPlan = await WeeklyPaymentPlans.findOne({
    userId: user.loginId
  }).sort({ createdAt: -1 });

  if (user.grade < lastPlan.baseGrade) {
    return { created: false, reason: 'ë“±ê¸‰ í•˜ë½' };
  }

  // 3. ë³´í—˜ í™•ì¸ (F3 ì´ìƒ)
  if (user.grade >= 'F3' && !user.insuranceSettings?.maintained) {
    return { created: false, reason: 'ë³´í—˜ ë¯¸ê°€ì…' };
  }

  // 4. ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ ê³„ì‚°
  const existingPlans = await WeeklyPaymentPlans.find({
    userId: user.loginId,
    baseGrade: user.grade,
    planType: lastPlan.planType
  }).sort({ ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: -1 });

  const nextì¶”ê°€ì§€ê¸‰ë‹¨ê³„ = existingPlans.length > 0
    ? existingPlans[0].ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ + 1
    : 1;

  // 5. ë§¤ì¶œ ì¡°íšŒ ë° ê¸ˆì•¡ ê³„ì‚°
  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: revenueMonth });
  if (!monthlyReg) {
    return { created: false, reason: 'ë§¤ì¶œ ì •ë³´ ì—†ìŒ' };
  }

  const revenue = monthlyReg.getEffectiveRevenue();
  const gradePayments = calculateGradePayments(revenue, monthlyReg.gradeDistribution);
  const baseAmount = gradePayments[user.grade];
  const installmentAmount = Math.floor(baseAmount / 10 / 100) * 100;

  // 6. ì¶”ê°€ 10íšŒ ê³„íš ìƒì„±
  const startDate = getNextFriday(new Date());

  const installments = [];
  for (let i = 1; i <= 10; i++) {
    const scheduledDate = new Date(startDate);
    scheduledDate.setDate(scheduledDate.getDate() + (i - 1) * 7);

    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      gradeAtPayment: null,
      baseAmount,
      installmentAmount,
      withholdingTax: Math.round(installmentAmount * 0.033),
      netAmount: installmentAmount - Math.round(installmentAmount * 0.033),
      status: 'pending',
      insuranceSkipped: false
    });
  }

  // 7. DB ì €ì¥
  const newPlan = await WeeklyPaymentPlans.create({
    userId: user.loginId,
    userName: user.name,
    planType: lastPlan.planType,
    ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: nextì¶”ê°€ì§€ê¸‰ë‹¨ê³„,
    installmentType: 'additional',
    baseGrade: user.grade,
    revenueMonth,
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    planStatus: 'active',
    installments,
    parentPlanId: lastPlan._id,
    createdBy: 'monthly_check'
  });

  // 8. ì£¼ì°¨ë³„ ì´ê³„ ì—…ë°ì´íŠ¸
  await updateWeeklyProjections(newPlan, 'add');

  return {
    created: true,
    ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: nextì¶”ê°€ì§€ê¸‰ë‹¨ê³„,
    planId: newPlan._id
  };
}
```

---

### 4.3 ìš©ì—­ì ë“±ë¡ í”„ë¡œì„¸ìŠ¤ â­ v7.0 ë³€ê²½

```javascript
async function processUserRegistration(userIds) {
  const currentMonth = getCurrentMonth(); // '2025-10'

  // 1. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  const users = await User.find({ _id: { $in: userIds } });

  // 2. ë“±ê¸‰ ì¬ê³„ì‚° (ë¨¼ì € ì‹¤í–‰!)
  const gradeChangeResult = await recalculateAllGrades();
  const affectedUsers = gradeChangeResult.changedUsers || [];

  // 3. ë“±ê¸‰ ì¬ê³„ì‚° í›„ users ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ (ìµœì‹  ë“±ê¸‰ ë°˜ì˜)
  const updatedUsers = await User.find({ _id: { $in: userIds } });

  // 4. ì›”ë³„ ë“±ë¡ ì •ë³´ ì—…ë°ì´íŠ¸ (ìµœì‹  ë“±ê¸‰ìœ¼ë¡œ)
  await updateMonthlyRegistrations(updatedUsers, currentMonth);

  // 5. ì›”ë³„ íŠ¸ë¦¬ ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸
  await updateMonthlyTreeSnapshots(updatedUsers, affectedUsers);

  // 6. ì§€ê¸‰ ê³„íš ì²˜ë¦¬
  const paymentPlanResults = [];

  // 6-1. ì‹ ê·œ ë“±ë¡ì Initial ê³„íš ìƒì„± (10íšŒë§Œ, ê¸°ë³¸ì§€ê¸‰)
  for (const user of updatedUsers) {
    const plan = await createInitialPaymentPlan(
      user.loginId,
      user.name,
      user.grade,
      user.registrationDate || user.createdAt
    );
    paymentPlanResults.push({
      userId: user.loginId,
      type: 'initial',
      ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0,
      plan: plan._id
    });
  }

  // 6-2. ìŠ¹ê¸‰ì Promotion ê³„íš ìƒì„± (10íšŒë§Œ, ê¸°ë³¸ì§€ê¸‰)
  const promotedUsers = affectedUsers.filter(u =>
    u.changeType === 'grade_change' && u.oldGrade && u.newGrade && u.oldGrade < u.newGrade
  );

  for (const promoted of promotedUsers) {
    const user = await User.findOne({ loginId: promoted.userId });

    // â­ v7.0: ìŠ¹ê¸‰ ì‹œ ì§„í–‰ ì¤‘ì¸ ì¶”ê°€ì§€ê¸‰ ê³„íš ì¤‘ë‹¨
    await terminateAdditionalPaymentPlans(user.loginId);

    const plan = await createPromotionPaymentPlan(
      user.loginId,
      user.name,
      promoted.newGrade,
      new Date()
    );
    paymentPlanResults.push({
      userId: user.loginId,
      type: 'promotion',
      ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0,
      plan: plan._id
    });
  }

  // 7. â­ v7.0: ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸ ë° ìƒì„±
  console.log('[ë“±ë¡ì²˜ë¦¬ 7ë‹¨ê³„] ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸ ì‹œì‘');

  const additionalPaymentResult = await checkAndCreateMonthlyAdditionalPayments(currentMonth);

  console.log(`[ë“±ë¡ì²˜ë¦¬ 7ë‹¨ê³„] ì¶”ê°€ì§€ê¸‰ ìƒì„± ì™„ë£Œ: ${additionalPaymentResult.created}ê±´, ì œì™¸: ${additionalPaymentResult.skipped}ê±´`);

  return {
    success: true,
    registeredUsers: updatedUsers.length,
    affectedUsers: affectedUsers.length,
    promotedUsers: promotedUsers.length,
    paymentPlans: paymentPlanResults,
    additionalPayments: additionalPaymentResult  // â­ v7.0 ì‹ ê·œ
  };
}

// â­ v7.0 ì‹ ê·œ: ì¶”ê°€ì§€ê¸‰ ê³„íš ì¤‘ë‹¨
async function terminateAdditionalPaymentPlans(userId) {
  const additionalPlans = await WeeklyPaymentPlans.find({
    userId,
    installmentType: 'additional',
    planStatus: 'active'
  });

  for (const plan of additionalPlans) {
    // ë¯¸ì§€ê¸‰ í• ë¶€ë¥¼ terminatedë¡œ ë³€ê²½
    for (const inst of plan.installments) {
      if (inst.status === 'pending') {
        inst.status = 'terminated';
        inst.terminatedReason = 'promotion';
      }
    }

    plan.planStatus = 'terminated';
    plan.terminatedBy = 'promotion';
    plan.terminatedAt = new Date();
    await plan.save();

    console.log(`[${userId}] ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨: ${plan.revenueMonth} ë§¤ì¶œë¶„ ${plan.ì¶”ê°€ì§€ê¸‰ë‹¨ê³„}ë‹¨ê³„`);

    // WeeklyPaymentSummaryì—ì„œ ì˜ˆìƒ ê¸ˆì•¡ ì œê±°
    await updateWeeklyProjections(plan, 'remove');
  }

  return additionalPlans.length;
}
```

---

## 5. ì›¹ API ì„¤ê³„

### 5.1 ìš©ì—­ë¹„ ì§€ê¸‰ëª…ë¶€ ì¡°íšŒ API â­ v7.0 ë³€ê²½

#### 5.1.1 ë‹¨ì¼ ì£¼ì°¨ ì¡°íšŒ

**GET** `/api/admin/payment/weekly?year=2025&month=10&week=2`

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "grandTotal": {
      "totalAmount": 75000,
      "totalTax": 2475,
      "totalNet": 72525
    },
    "week": "2025ë…„ 10ì›” 2ì£¼",
    "weekNumber": "2025-W41",
    "payments": [
      {
        "no": 1,
        "userId": "ì‚¬ì¥ë‹˜",
        "userName": "ì‚¬ì¥ë‹˜",
        "grade": "F2",
        "actualAmount": 75000,
        "taxAmount": 2475,
        "netAmount": 72525,
        "installments": [
          {
            "planType": "initial",
            "ì¶”ê°€ì§€ê¸‰ë‹¨ê³„": 0,
            "installmentType": "basic",
            "week": 10,
            "revenueMonth": "2025-07",
            "amount": 24000,
            "tax": 792,
            "net": 23208
          },
          {
            "planType": "initial",
            "ì¶”ê°€ì§€ê¸‰ë‹¨ê³„": 1,
            "installmentType": "additional",
            "week": 3,
            "revenueMonth": "2025-07",
            "amount": 24000,
            "tax": 792,
            "net": 23208
          },
          {
            "planType": "initial",
            "ì¶”ê°€ì§€ê¸‰ë‹¨ê³„": 2,
            "installmentType": "additional",
            "week": 2,
            "revenueMonth": "2025-08",
            "amount": 27000,
            "tax": 891,
            "net": 26109
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "totalPages": 1,
      "totalItems": 3,
      "itemsPerPage": 20
    }
  }
}
```

**â­ v7.0 ë³€ê²½:**
- `ì¶”ê°€ì§€ê¸‰ë‹¨ê³„` í•„ë“œ ì¶”ê°€
- `installmentType` í•„ë“œ ì¶”ê°€ ('basic' | 'additional')
- ê°™ì€ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë§¤ì¶œì›” ì§€ê¸‰ì„ ë³‘í–‰ ë°›ì„ ìˆ˜ ìˆìŒ

---

## 6. ë°ì´í„° íë¦„ë„

### 6.1 ë“±ë¡ ì‹œ ë°ì´í„° íë¦„ â­ v7.0

```
[ì—‘ì…€ ì—…ë¡œë“œ/ê°œë³„ ë“±ë¡]
    â†“
[User ìƒì„±/ì €ì¥]
    â†“
[ë“±ê¸‰ ì¬ê³„ì‚°]
    â†“
[MonthlyRegistrations ì—…ë°ì´íŠ¸] â­ v7.0 ë³€ê²½
    - ë“±ë¡ì ì •ë³´ ì¶”ê°€ (ì‹ ê·œ ë“±ë¡ìë§Œ)
    - ë§¤ì¶œ ê³„ì‚° (ë“±ë¡ì ìˆ˜ë§Œ Ã— 1,000,000ì›)
    - ì§€ê¸‰ ëŒ€ìƒì ê¸°ë¡ (ë“±ë¡ì + ìŠ¹ê¸‰ì + ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì)
    - ë“±ê¸‰ë³„ ë°°ë¶„ì•¡ ê³„ì‚° (ì§€ê¸‰ ëŒ€ìƒì ì „ì²´ ê¸°ì¤€)
    â†“
[MonthlyTreeSnapshots ì—…ë°ì´íŠ¸]
    - íŠ¸ë¦¬ êµ¬ì¡° ìŠ¤ëƒ…ìƒ·
    - ë“±ê¸‰ ë¶„í¬
    â†“
[WeeklyPaymentPlans ìƒì„±] â­ 10íšŒë§Œ, ê¸°ë³¸ì§€ê¸‰
    - planType: 'initial'
    - ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0
    - installmentType: 'basic'
    - totalInstallments: 10
    - revenueMonth: ë“±ë¡ì›”
    â†“
[WeeklyPaymentSummary ì—…ë°ì´íŠ¸]
    - ì£¼ì°¨ë³„ ì˜ˆìƒ ì´ê³„ ì—…ë°ì´íŠ¸
    â†“
[ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸] â­ v7.0 ì‹ ê·œ
    - ì´ì „ ì›” ë“±ë¡ì/ìŠ¹ê¸‰ì ì¡°íšŒ
    - í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸
    - ìŠ¹ê¸‰ ì—†ìœ¼ë©´ ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„±
```

---

### 6.2 ê¸ˆìš”ì¼ ìë™ì²˜ë¦¬ ë°ì´í„° íë¦„ â­ v7.0

```
[ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰: ë§¤ì£¼ ê¸ˆìš”ì¼ 00:00]
    â†“
[1ë‹¨ê³„: í•´ë‹¹ ì£¼ì°¨ ì§€ê¸‰ ëŒ€ìƒ ì¡°íšŒ]
    - WeeklyPaymentPlansì—ì„œ weekNumberë¡œ í•„í„°ë§
    - installments.status: 'pending'
    - planStatus: 'active' (terminated ì œì™¸) â­
    â†“
[1ë‹¨ê³„: ì§€ê¸‰ ì²˜ë¦¬]
    - ë³´í—˜ í™•ì¸ (F3 ì´ìƒ)
    - status: 'pending' â†’ 'paid'
    - completedInstallments++
    - planStatus: ì™„ë£Œ ì‹œ 'completed'
    â†“
[2ë‹¨ê³„: WeeklyPaymentSummary ì—…ë°ì´íŠ¸]
    - ì‹¤ì œ ì§€ê¸‰ì•¡ ì§‘ê³„
    - totalAmount, totalTax, totalNet ì—…ë°ì´íŠ¸
    - recipientCount ì—…ë°ì´íŠ¸
    - status: 'paid', processedAt ê¸°ë¡
    â†“
[ì™„ë£Œ: ë¡œê¹…]
    - ì§€ê¸‰ ì™„ë£Œ ë¡œê·¸
    - (ì¶”ê°€ì§€ê¸‰ í™•ì¸ì€ ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì‹œì ì— ìˆ˜í–‰)
```

**â­ v7.0 í•µì‹¬ ë³€ê²½:**
- ê¸ˆìš”ì¼ ì²˜ë¦¬ëŠ” **ìˆœìˆ˜í•˜ê²Œ ì§€ê¸‰ë§Œ** ìˆ˜í–‰
- ì¶”ê°€ì§€ê¸‰ í™•ì¸ ë° ìƒì„±ì€ **ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì‹œì **ì— ìˆ˜í–‰

---

### 6.3 ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸ íë¦„ â­ v7.0 ì‹ ê·œ

```
[ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì™„ë£Œ]
    â†“
[í˜„ì¬ ì›” = YYYY-MM]
    â†“
[ì´ì „ ì›” ë“±ë¡ì/ìŠ¹ê¸‰ì ì¡°íšŒ]
    - MonthlyRegistrations(ì´ì „ ì›”).registrations
    - MonthlyRegistrations(ì´ì „ ì›”).paymentTargets.promoted
    â†“
[FOR EACH candidate:]
    â†“
[í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸]
    - ìŠ¹ê¸‰ ìˆìŒ â†’ SKIP (ìƒˆ ë“±ê¸‰ ê¸°ë³¸ì§€ê¸‰ ì´ë¯¸ ìƒì„±ë¨)
    - ìŠ¹ê¸‰ ì—†ìŒ â†’ ê³„ì†
    â†“
[ì¡°ê±´ í™•ì¸]
    â”œâ”€ ìµœëŒ€ íšŸìˆ˜ í™•ì¸ (F1:20, F2:30, ...)
    â”œâ”€ ë“±ê¸‰ ìœ ì§€/ìƒìŠ¹ í™•ì¸
    â””â”€ ë³´í—˜ ìœ ì§€ í™•ì¸ (F3 ì´ìƒ)
    â†“
[ì´ì „ ì›” ë§¤ì¶œ ê¸°ì¤€ ê¸ˆì•¡ ê³„ì‚°]
    - revenueMonth = ì´ì „ ì›”
    - MonthlyRegistrations(ì´ì „ ì›”)ì—ì„œ ë§¤ì¶œ ì¡°íšŒ
    - ì§€ê¸‰ ëŒ€ìƒì ì „ì²´ ë“±ê¸‰ ë¶„í¬ ê¸°ì¤€ ë°°ë¶„ì•¡ ê³„ì‚°
    - installmentAmount = baseAmount Ã· 10
    â†“
[ì¶”ê°€ì§€ê¸‰ ê³„íš ìƒì„±]
    - WeeklyPaymentPlans.create({
        ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: N+1,
        installmentType: 'additional',
        revenueMonth: ì´ì „ ì›”,
        parentPlanId: ì´ì „ ê³„íš ID,
        createdBy: 'monthly_check',
        totalInstallments: 10
      })
    â†“
[WeeklyPaymentSummary ì—…ë°ì´íŠ¸]
    - ì‹ ê·œ ìƒì„±ëœ ê³„íšì˜ ë¯¸ë˜ ì£¼ì°¨ì—
    - ì˜ˆìƒ ì§€ê¸‰ì•¡ ì¶”ê°€ (incrementPayment)
    - ì§€ê¸‰ëŒ€ìƒì ìˆ˜ ì—…ë°ì´íŠ¸
    â†“
[MonthlyRegistrations ì—…ë°ì´íŠ¸]
    - paymentTargets.additionalPayments ê¸°ë¡
    â†“
[ë¡œê¹… ë° ì•Œë¦¼]
    - ì¶”ê°€ì§€ê¸‰ ìƒì„± ë¡œê·¸
    - ì¡°ê±´ ë¯¸ì¶©ì¡± ì•Œë¦¼
```

---

### 6.4 ìŠ¹ê¸‰ ì‹œ ë°ì´í„° íë¦„ â­ v7.0 ë³€ê²½

```
[ë“±ê¸‰ ì¬ê³„ì‚°]
    â†“
[ìŠ¹ê¸‰ ê°ì§€]
    â†“
[ê¸°ì¡´ ê³„íš í™•ì¸]
    â”œâ”€ ê¸°ë³¸ì§€ê¸‰(ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:0) â†’ ê³„ì† ì§„í–‰ âœ…
    â””â”€ ì¶”ê°€ì§€ê¸‰(ì¶”ê°€ì§€ê¸‰ë‹¨ê³„:1+) â†’ ì¦‰ì‹œ ì¤‘ë‹¨ âŒ â­ v7.0
    â†“
[ì¶”ê°€ì§€ê¸‰ ê³„íš ì¤‘ë‹¨] â­ v7.0 ì‹ ê·œ
    - installments[].status: 'pending' â†’ 'terminated'
    - installments[].terminatedReason: 'promotion'
    - planStatus: 'terminated'
    - terminatedBy: 'promotion'
    - WeeklyPaymentSummaryì—ì„œ ì˜ˆìƒ ê¸ˆì•¡ ì œê±°
    â†“
[Promotion ê³„íš ìƒì„±] (10íšŒë§Œ, ê¸°ë³¸ì§€ê¸‰)
    - planType: 'promotion'
    - ì¶”ê°€ì§€ê¸‰ë‹¨ê³„: 0
    - installmentType: 'basic'
    - totalInstallments: 10
    - revenueMonth: ìŠ¹ê¸‰ ì‹œì  ì›”
    â†“
[ë³‘í–‰ ì§€ê¸‰ ì‹œì‘]
    - ê¸°ì¡´ ê¸°ë³¸ì§€ê¸‰ ê³„íš + ì‹ ê·œ Promotion ê³„íš ë™ì‹œ ì§„í–‰
```

---

## 7. v6.0 â†’ v7.0 ë³€ê²½ì‚¬í•­ ìš”ì•½

| í•­ëª© | v6.0 | v7.0 |
|------|------|------|
| **ë“±ë¡ ì‹œ ê³„íš ìƒì„±** | 10íšŒë§Œ ìƒì„± | 10íšŒë§Œ ìƒì„± (ë™ì¼) |
| **ì¶”ê°€ì§€ê¸‰ ìƒì„± ì‹œì ** | 10íšŒ ì™„ë£Œ ì¦‰ì‹œ | ë§¤ì›” ë“±ë¡/ìŠ¹ê¸‰ ì²˜ë¦¬ ì‹œ â­ |
| **ì¶”ê°€ì§€ê¸‰ ì¡°ê±´** | 10íšŒ ì™„ë£Œ | ì´ì „ ì›” ë“±ë¡/ìŠ¹ê¸‰ + í˜„ì¬ ì›” ìŠ¹ê¸‰ ì—†ìŒ â­ |
| **ìŠ¹ê¸‰ ì‹œ ì¶”ê°€ì§€ê¸‰** | - | ì¦‰ì‹œ ì¤‘ë‹¨ â­ |
| **ë§¤ì¶œ ê³„ì‚°** | ë“±ë¡ì + ìŠ¹ê¸‰ì | ë“±ë¡ìë§Œ â­ |
| **ë“±ê¸‰ë³„ ë°°ë¶„** | - | ì§€ê¸‰ ëŒ€ìƒì ì „ì²´ ê¸°ì¤€ â­ |
| **ê¸ˆìš”ì¼ ì²˜ë¦¬** | ì§€ê¸‰ + 10íšŒ ì™„ë£Œ í™•ì¸ | ì§€ê¸‰ë§Œ â­ |
| **ë§¤ì¶œì›” ë³‘í–‰ ì§€ê¸‰** | - | 7ì›”+8ì›”+9ì›” ë™ì‹œ ê°€ëŠ¥ â­ |
| **generation í•„ë“œ** | generation | ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ â­ |
| **installmentType** | ì—†ìŒ | basic/additional â­ |
| **terminatedBy** | ì—†ìŒ | promotion â­ |
| **createdBy** | auto_generation | monthly_check â­ |

---

## 8. êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1: í•µì‹¬ ë¡œì§ ë³€ê²½ â­ v7.0
1. WeeklyPaymentPlans ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
   - `generation` â†’ `ì¶”ê°€ì§€ê¸‰ë‹¨ê³„` ë³€ê²½
   - `installmentType` ì¶”ê°€ ('basic' | 'additional')
   - `terminatedBy`, `terminatedAt` ì¶”ê°€
   - `installments[].terminatedReason` ì¶”ê°€

2. MonthlyRegistrations ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
   - `paymentTargets` ì¶”ê°€ (ë“±ë¡ì/ìŠ¹ê¸‰ì/ì¶”ê°€ì§€ê¸‰ ëŒ€ìƒì)
   - `gradeDistribution` ì˜ë¯¸ ë³€ê²½ (ì§€ê¸‰ ëŒ€ìƒì ì „ì²´)

3. ì¶”ê°€ì§€ê¸‰ ë¡œì§ ë³€ê²½
   - `checkAndCreateAdditionalPlan` ì‚­ì œ
   - `checkAndCreateMonthlyAdditionalPayments` ì‹ ê·œ êµ¬í˜„
   - `createAdditionalPaymentPlan` ì‹ ê·œ êµ¬í˜„

4. ìŠ¹ê¸‰ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
   - `terminateAdditionalPaymentPlans` ì‹ ê·œ êµ¬í˜„
   - `createPromotionPaymentPlan` ìˆ˜ì • (ì¤‘ë‹¨ ë¡œì§ ì¶”ê°€)

5. ê¸ˆìš”ì¼ ìë™ì²˜ë¦¬ ìˆ˜ì •
   - ì¶”ê°€ì§€ê¸‰ í™•ì¸ ë¡œì§ ì œê±°
   - ìˆœìˆ˜ ì§€ê¸‰ ì²˜ë¦¬ë§Œ

### Phase 2: API ë° UI
1. API ì‘ë‹µì— `ì¶”ê°€ì§€ê¸‰ë‹¨ê³„`, `installmentType` ì •ë³´ ì¶”ê°€
2. ì§€ê¸‰ëª…ë¶€ì— ì¶”ê°€ì§€ê¸‰ë‹¨ê³„ í‘œì‹œ
3. ë§¤ì¶œì›”ë³„ ë³‘í–‰ ì§€ê¸‰ í‘œì‹œ
4. ìŠ¹ê¸‰ìœ¼ë¡œ ì¤‘ë‹¨ëœ ì¶”ê°€ì§€ê¸‰ í‘œì‹œ

### Phase 3: ëª¨ë‹ˆí„°ë§ ë° ìµœì í™”
1. ë§¤ì›” ì¶”ê°€ì§€ê¸‰ ìƒì„± ë¡œê·¸
2. ìŠ¹ê¸‰ìœ¼ë¡œ ì¸í•œ ì¤‘ë‹¨ ì•Œë¦¼
3. ì¡°ê±´ ë¯¸ì¶©ì¡± ì•Œë¦¼
4. ì„±ëŠ¥ ìµœì í™”

---

**ë¬¸ì„œ ë²„ì „ íˆìŠ¤í† ë¦¬:**

- v7.0 (2025-10-12): ì¶”ê°€ì§€ê¸‰ ì‹œê¸° ë³€ê²½ (ë§¤ì›” ìŠ¹ê¸‰ í™•ì¸), ë§¤ì¶œ ê³„ì‚° ë³€ê²½ (ë“±ë¡ìë§Œ), ìŠ¹ê¸‰ ì‹œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨
- v6.0 (2025-10-11): ë™ì  ì§€ê¸‰ ê³„íš ìƒì„± ë°©ì‹ìœ¼ë¡œ ë³€ê²½
- v5.0 (2025-10-11): ë³‘í–‰ ì§€ê¸‰ ë° ì¶”ê°€ ì§€ê¸‰ê¸°ê°„ ë„ì…
- v4.0 (2025-09-20): ë“±ê¸‰ë³„ ìµœëŒ€ ìˆ˜ë ¹ íšŸìˆ˜ ì¶”ê°€
- v3.0 (2025-09-15): ì£¼ì°¨ë³„ ì´ê³„ ì»¬ë ‰ì…˜ ì¶”ê°€
- v2.0 (2025-09-10): ì›”ë³„ ìŠ¤ëƒ…ìƒ· êµ¬ì¡° ê°œì„ 
- v1.0 (2025-09-01): ì´ˆê¸° ë²„ì „
