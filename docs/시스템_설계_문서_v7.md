# MLM 시스템 설계 문서 v7.0

**버전**: 7.0
**작성일**: 2025년 10월 12일
**기준 요구사항**: 시스템_요구사항_검토문서_v5.0

**주요 변경사항 (v7.0)**:
- **추가지급 시기 변경**: 10회 완료 즉시 생성 → 매월 승급 없는 경우 다음달 생성
- **지급 대상자 명확화**: 등록자(매출 기여) + 승급자 + 추가지급 대상자
- **매출 계산 변경**: 등록자 수만 매출 기여 (승급자/추가지급 대상자 제외)
- **매출월 기준 병행 지급**: 7월분+8월분+9월분 동시 지급 가능
- **승급 시 추가지급 중단**: 기본지급 유지, 추가지급 즉시 중단, 새 등급 시작

---

## 📋 목차

1. [시스템 개요](#1-시스템-개요)
2. [데이터베이스 설계](#2-데이터베이스-설계)
3. [지급 계획 처리 방안](#3-지급-계획-처리-방안)
4. [자동화 프로세스](#4-자동화-프로세스)
5. [웹 API 설계](#5-웹-api-설계)
6. [데이터 흐름도](#6-데이터-흐름도)

---

## 1. 시스템 개요

### 1.1 핵심 원칙

**v5.0 요구사항 기반 설계 원칙**:

1. **병행 지급**: 승급 시 기존 기본지급 유지 + 새 등급 지급 추가
2. **추가지급 중단**: 승급 시 기존 추가지급 즉시 중단 ⭐ v7.0 신규
3. **매월 승급 확인**: 매달 승급 여부 확인 후 추가지급 생성 ⭐ v7.0 신규
4. **매출월 기준 병행**: 7월분+8월분+9월분 동시 지급 가능 ⭐ v7.0 신규
5. **지급 대상자 3유형**: 등록자(매출 기여) + 승급자 + 추가지급 대상자 ⭐ v7.0 신규
6. **주간 집계**: 금요일마다 자동 지급 (WeeklyPaymentSummary 기반)

### 1.2 시스템 구성도

```
[용역자 등록]
    ↓
[트리/등급 재계산] ← 영향받는 사용자만
    ↓
[지급 대상자 분류] ⭐ v7.0 신규
    ├─ 등록자 (신규)
    ├─ 승급자 (등급 상승)
    └─ 추가지급 대상자 (이전 월 등록/승급, 현재 월 승급 없음)
    ↓
[지급 계획 생성]
    ├─ 등록자: 등록월 매출분 10회 생성
    ├─ 승급자: 승급월 매출분 10회 생성, 기존 추가지급 중단 ⭐
    └─ 추가지급 대상자: 이전월 매출분 10회 생성 (최대 횟수 미만)
    ↓
[주차별 총계 업데이트]
    ↓
[매주 금요일 자동 지급]
    ↓
[통계 업데이트]
```

---

## 2. 데이터베이스 설계

### 2.1 컬렉션 개요

전체 **4개 핵심 컬렉션** 구성:

| 컬렉션명 | 목적 | 업데이트 시점 | 조회 빈도 |
|---------|------|--------------|----------|
| **monthlyRegistrations** | 월별 등록/매출 관리 ⭐ 등록자만 | 용역자 등록 시 | 낮음 |
| **monthlyTreeSnapshots** | 월별 계층도/등급 확정 | 등록 시 + 월말 | 중간 |
| **weeklyPaymentPlans** | 개별 지급 계획 | 등록/승급/추가지급 시 ⭐ | 높음 |
| **weeklyPaymentSummary** | 주차별 총계 (통계) | 등록/지급 시 | 매우 높음 |

---

### 2.2 컬렉션 상세 설계

#### 2.2.1 monthlyRegistrations (월별 등록 관리) ⭐ v7.0 변경

**목적**: 매월 용역자 **등록(신규 등록자)** 및 매출 관리

**⭐ v7.0 중요 변경**: 승급자는 registrations에 포함되지 않음 (등록자만)

```javascript
{
  _id: ObjectId,
  monthKey: String,              // "2025-10" (YYYY-MM)

  // 등록 정보 ⭐ 등록자만 (신규 등록자)
  registrationCount: Number,     // 해당 월 신규 등록 인원
  totalRevenue: Number,          // 총매출 (등록 인원 × 100만원) ⭐
  adjustedRevenue: Number,       // 관리자 수동 조정 금액 (null이면 자동)

  // 등록자 목록 ⭐ 신규 등록자만
  registrations: [{
    userId: String,
    userName: String,
    registrationDate: Date,      // 실제 등록일
    sponsorId: String,           // 후원자
    grade: String,               // 등록 시점 등급 (등급 재계산 후)
    position: String             // 'left' | 'right' | 'root'
  }],

  // 지급 대상자 정보 ⭐ v7.0 신규
  paymentTargets: {
    // 신규 등록자
    registrants: [{
      userId: String,
      userName: String,
      grade: String
    }],

    // 승급자 (매출 기여 없음)
    promoted: [{
      userId: String,
      userName: String,
      oldGrade: String,
      newGrade: String,
      promotionDate: Date
    }],

    // 추가지급 대상자 (매출 기여 없음)
    additionalPayments: [{
      userId: String,
      userName: String,
      grade: String,
      추가지급단계: Number  // 몇 번째 추가지급인지
    }]
  },

  // 등급별 분포 (지급 대상자 전체 기준) ⭐ v7.0 중요
  gradeDistribution: {
    F1: Number,  // 등록자 + 승급자 + 추가지급 대상자 중 F1
    F2: Number,
    F3: Number,
    F4: Number,
    F5: Number,
    F6: Number,
    F7: Number,
    F8: Number
  },

  // 등급별 배분 금액 (누적 방식)
  gradePayments: {
    F1: Number,  // 8%
    F2: Number,  // 27%
    F3: Number,  // 42%
    F4: Number,  // 55%
    F5: Number,  // 67%
    F6: Number,  // 78%
    F7: Number,  // 88%
    F8: Number   // 97%
  },

  createdAt: Date,
  updatedAt: Date
}
```

**⭐ v7.0 핵심 변경:**
- **매출 계산**: 등록자 수만 × 1,000,000원 (승급자/추가지급 대상자 제외)
- **등급별 배분**: 지급 대상자 전체(등록자+승급자+추가지급 대상자)의 등급 분포 기준
- **paymentTargets**: 3가지 유형 명확히 구분

**인덱스:**
- `monthKey` (unique)
- `registrations.userId`
- `paymentTargets.registrants.userId`
- `paymentTargets.promoted.userId`
- `paymentTargets.additionalPayments.userId`

**업데이트 시점:**
- 용역자 등록 시 (등급 재계산 후)
- 매월 지급 계획 생성 시 (추가지급 대상자 확인)

---

#### 2.2.2 weeklyPaymentPlans (개별 지급 계획) ⭐ v7.0 변경

**목적**: 용역자별 10회 단위 지급 계획 관리

```javascript
{
  _id: ObjectId,
  userId: String,
  userName: String,

  // 계획 유형 ⭐ v7.0: 추가지급 단계 추가
  planType: String,              // 'initial' | 'promotion'
  추가지급단계: Number,          // 0: 기본, 1: 추가1차, 2: 추가2차, ... ⭐ v7.0
  installmentType: String,       // 'basic' | 'additional' ⭐ v7.0 신규

  // 기준 정보
  baseGrade: String,             // 계획 생성 시점 등급
  revenueMonth: String,          // 매출 귀속 월 (YYYY-MM) ⭐
  startDate: Date,               // 지급 시작일 (첫 금요일)

  // 진행 정보
  totalInstallments: Number,     // 총 할부 횟수 (항상 10)
  completedInstallments: Number, // 완료된 횟수
  planStatus: String,            // 'active' | 'completed' | 'terminated'

  // 할부 상세 (10개)
  installments: [{
    week: Number,                // 회차 (1~10)
    weekNumber: String,          // ISO 주차 (2025-W31)
    scheduledDate: Date,         // 지급 예정일 (금요일)

    revenueMonth: String,        // 매출 귀속 월 ⭐
    gradeAtPayment: String,      // 실제 지급 시점 등급 (지급 시 기록)

    baseAmount: Number,          // 기준 금액 (등급별 배분액)
    installmentAmount: Number,   // 회차 지급액 (기준÷10)
    withholdingTax: Number,      // 원천징수세 (3.3%)
    netAmount: Number,           // 실수령액

    status: String,              // 'pending' | 'paid' | 'skipped' | 'terminated' ⭐
    paidDate: Date,              // 실제 지급일
    insuranceSkipped: Boolean,   // 보험 미가입으로 건너뜀
    terminatedReason: String     // ⭐ v7.0: 'promotion' (승급으로 인한 추가지급 중단)
  }],

  // 추가 정보
  parentPlanId: ObjectId,        // 이전 10회 계획 ID (연결 추적용)
  createdBy: String,             // 'registration' | 'promotion' | 'monthly_check' ⭐
  terminatedBy: String,          // ⭐ v7.0: 'promotion' (승급으로 중단)
  terminatedAt: Date,            // ⭐ v7.0: 중단 시점

  createdAt: Date,
  updatedAt: Date
}
```

**⭐ v7.0 주요 변경:**
- `추가지급단계`: 0(기본), 1(추가1차), 2(추가2차), ...
- `installmentType`: 'basic'(기본 10회) | 'additional'(추가지급)
- `terminatedBy`, `terminatedAt`: 승급으로 인한 추가지급 중단 추적
- `createdBy`: 'monthly_check' 추가 (매월 승급 확인 시 생성)
- `status`: 'terminated' 추가 (승급으로 중단된 할부)

**인덱스:**
- `userId`
- `planType`
- `추가지급단계`
- `installmentType`
- `baseGrade`
- `revenueMonth`
- `planStatus`
- `installments.weekNumber`
- `installments.status`

---

#### 2.2.3 weeklyPaymentSummary (주차별 총계)

**목적**: 주차별 전체 지급 총계 및 통계 (빠른 조회용) + **주차별 지급대장 관리**

```javascript
{
  _id: ObjectId,
  weekNumber: String,            // ISO 주차 (2025-W31)
  weekDate: Date,                // 해당 금요일 날짜
  monthKey: String,              // 월 키 (2025-08)

  // 지급 총계
  totalAmount: Number,           // 지급 총액
  totalTax: Number,              // 원천징수 총액
  totalNet: Number,              // 실수령 총액
  recipientCount: Number,        // 지급 대상자 수

  // 통계
  status: String,                // 'pending' | 'paid' | 'processing'
  processedAt: Date,             // 처리 완료 시각

  createdAt: Date,
  updatedAt: Date
}
```

**v7.0 핵심 역할:**
1. **주차별 지급대장**: 매주 지급 대상 및 금액 관리
2. **금요일 자동처리 중심**: 지급 처리 후 Summary 업데이트
3. **빠른 조회**: 주차별 총계를 WeeklyPaymentPlans 조회 없이 즉시 확인
4. **통계 기반**: 대시보드, 보고서 등에서 사용

**업데이트 시점:**
- 등록/승급/추가지급 시: 지급 계획 생성 → Summary에 예상 금액 추가
- 금요일 자동처리: 실제 지급 → Summary 업데이트

**인덱스:**
- `weekNumber` (unique)
- `weekDate`
- `monthKey`
- `status`

---

## 3. 지급 계획 처리 방안

### 3.1 초기 계획 생성 (등록 시) ⭐ v7.0

#### 3.1.1 등록 시 Initial 계획 생성

**생성 조건:**
- 용역자 신규 등록 시
- 등급 재계산 완료 후

**생성 내용:**
```javascript
{
  planType: 'initial',
  추가지급단계: 0,               // 기본 지급 ⭐
  installmentType: 'basic',      // 기본 10회 ⭐
  baseGrade: user.grade,         // 등록 시점 등급
  revenueMonth: '2025-07',       // 등록월
  totalInstallments: 10,         // 10회 고정
  installments: [
    {
      week: 1,
      weekNumber: '2025-W31',
      scheduledDate: new Date('2025-08-01'),
      revenueMonth: '2025-07',   // 등록월 매출 ⭐
      installmentAmount: 24000,  // 등록월 매출 기준
    },
    // ... 10개
  ]
}
```

**매출 기준:**
- 등록월(registrationDate의 YYYY-MM)의 매출
- `monthlyRegistrations`에서 조회
- **등록자 수만** × 1,000,000원 ⭐ v7.0

**지급 시작일:**
- 등록일 + 1개월 후 첫 금요일

---

### 3.2 승급 시 처리 ⭐ v7.0 변경

#### 3.2.1 승급 시 기본지급 처리

**처리 원칙:**
- ✅ 기본지급(추가지급단계:0) 계획은 **계속 진행** (중단하지 않음)
- ✅ 새 등급 기본지급 계획 생성

#### 3.2.2 승급 시 추가지급 중단 ⭐ v7.0 신규

**처리 원칙:**
- ❌ 추가지급(추가지급단계:1+) 계획은 **즉시 중단**
- 중단된 할부는 `status: 'terminated'`, `terminatedReason: 'promotion'`

**중단 로직:**
```javascript
// 승급 감지 시
if (user.oldGrade < user.newGrade) {
  // 진행 중인 추가지급 계획 찾기
  const additionalPlans = await WeeklyPaymentPlans.find({
    userId: user.loginId,
    installmentType: 'additional',  // 추가지급만
    planStatus: 'active'
  });

  for (const plan of additionalPlans) {
    // 미지급 할부를 terminated로 변경
    for (const inst of plan.installments) {
      if (inst.status === 'pending') {
        inst.status = 'terminated';
        inst.terminatedReason = 'promotion';
      }
    }

    plan.planStatus = 'terminated';
    plan.terminatedBy = 'promotion';
    plan.terminatedAt = new Date();
    await plan.save();

    console.log(`[${user.loginId}] 추가지급 중단: ${plan.revenueMonth} 매출분`);
  }
}
```

#### 3.2.3 승급 시 Promotion 계획 생성

**생성 조건:**
- 등급 재계산 후 승급 확인됨
- 기존 기본지급은 중단하지 않음 (병행 지급)

**생성 내용:**
```javascript
{
  planType: 'promotion',
  추가지급단계: 0,               // 새 등급 기본 지급 ⭐
  installmentType: 'basic',      // 기본 10회 ⭐
  baseGrade: newGrade,           // 승급 후 등급
  revenueMonth: '2025-10',       // 승급 시점 월
  totalInstallments: 10,         // 10회 고정
  installments: [
    {
      week: 1,
      weekNumber: '2025-W41',
      scheduledDate: new Date('2025-10-10'),
      revenueMonth: '2025-10',   // 승급월 매출 ⭐
      installmentAmount: 81000,  // 승급 시점 월 매출 기준
    },
    // ... 10개
  ]
}
```

---

### 3.3 추가지급 계획 생성 (매월 승급 확인) ⭐ v7.0 핵심 변경

#### 3.3.1 생성 시점

**⭐ v7.0 핵심 변경: 매월 등록/승급 처리 시점에 확인**

```javascript
// 매월 등록/승급 처리 시
async function monthlyPaymentCheck(currentMonth) {
  // 1. 이전 월에 등록/승급한 사용자 조회
  const previousMonth = getPreviousMonth(currentMonth);

  // 2. 이전 월 등록자
  const prevMonthRegistrants = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 3. 이전 월 승급자
  const prevMonthPromoted = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 4. 각 사용자에 대해 현재 월 승급 여부 확인
  for (const user of [...prevMonthRegistrants.registrations, ...prevMonthPromoted.paymentTargets.promoted]) {
    const currentUser = await User.findOne({ loginId: user.userId });

    // 현재 월에 승급했는지 확인
    const hasPromotionThisMonth = await checkPromotionInMonth(user.userId, currentMonth);

    if (!hasPromotionThisMonth) {
      // 승급 없음 → 추가지급 대상자
      await createAdditionalPaymentPlan(user.userId, previousMonth);
    }
  }
}
```

#### 3.3.2 생성 조건 확인

**1단계: 최대 횟수 확인**
```javascript
const MAX_INSTALLMENTS = {
  F1: 20, F2: 30, F3: 40, F4: 40,
  F5: 50, F6: 50, F7: 60, F8: 60
};

// 해당 등급의 전체 완료 회차 계산
const totalCompleted = await WeeklyPaymentPlans.aggregate([
  {
    $match: {
      userId,
      baseGrade: currentGrade,
      planStatus: { $in: ['completed', 'active'] }
    }
  },
  {
    $group: {
      _id: null,
      total: { $sum: '$completedInstallments' }
    }
  }
]);

// 예정된 추가지급까지 포함
const plannedInstallments = await WeeklyPaymentPlans.countDocuments({
  userId,
  baseGrade: currentGrade,
  planStatus: 'active'
}) * 10;

const totalExpected = totalCompleted + plannedInstallments;

const maxForGrade = MAX_INSTALLMENTS[currentGrade];
if (totalExpected >= maxForGrade) {
  // 최대 횟수 도달 - 생성 안 함
  console.log(`[${userId}] ${currentGrade} 최대 ${maxForGrade}회 도달`);
  return;
}
```

**2단계: 등급 확인**
```javascript
const currentGrade = user.grade;
const previousGrade = await getPreviousGrade(user.userId, previousMonth);

if (currentGrade < previousGrade) {
  // 등급 하락 - 생성 안 함
  console.log(`[${userId}] 등급 하락: ${previousGrade} → ${currentGrade}`);
  return;
}
```

**3단계: 보험 확인 (F3 이상)**
```javascript
if (currentGrade >= 'F3') {
  const insurance = user.insuranceSettings;
  if (!insurance || !insurance.maintained) {
    // 보험 미가입/미유지 - 생성 안 함
    console.log(`[${userId}] 보험 미가입`);
    return;
  }
}
```

#### 3.3.3 추가지급 계획 생성

**매출월 결정:**
```javascript
// 이전 월 매출 기준 ⭐ v7.0
const revenueMonth = previousMonth; // 예: '2025-08'
```

**추가지급단계 계산:**
```javascript
// 해당 등급에서 최대 추가지급단계 계산
const existingPlans = await WeeklyPaymentPlans.find({
  userId,
  baseGrade: currentGrade,
  planType: { $in: ['initial', 'promotion'] }
}).sort({ 추가지급단계: -1 });

const next추가지급단계 = existingPlans.length > 0
  ? existingPlans[0].추가지급단계 + 1
  : 1;
```

**생성 내용:**
```javascript
{
  planType: lastPlan.planType,   // 'initial' | 'promotion' 유지
  추가지급단계: next추가지급단계,  // 1, 2, 3, ... ⭐
  installmentType: 'additional', // 추가지급 ⭐
  baseGrade: currentGrade,       // 현재 등급
  revenueMonth: previousMonth,   // 이전 월 매출 ⭐
  totalInstallments: 10,
  parentPlanId: lastPlan._id,    // 이전 계획 연결
  createdBy: 'monthly_check',    // 매월 확인으로 생성 ⭐
  installments: [
    {
      week: 1,                   // 새로운 10회 시작
      weekNumber: nextWeekNumber,
      scheduledDate: nextFriday, // 다음 금요일
      revenueMonth: previousMonth, // 이전 월 매출 ⭐
      installmentAmount: newAmount, // 이전 월 매출 기준 재계산
    },
    // ... 10개
  ]
}
```

**매출 기준:**
- **이전 월 매출**로 금액 계산
- 지급 대상자(등록자+승급자+추가지급 대상자) 전체의 등급 분포 기준

**예시:**
```
F2 등급 8월 등록:
- 8월: 등록 → 8월 매출분 10회 생성 (기본)
- 9월: 승급 없음 → 8월 매출분 10회 생성 (추가 1차) ⭐
- 10월: 승급 없음 → 9월 매출분 10회 생성 (추가 2차) ⭐
- 11월: F2 최대 30회 도달 (8월+9월+10월) → 생성 안 함
```

---

### 3.4 병행 지급 관리 ⭐ v7.0

#### 3.4.1 병행 지급 시나리오

**시나리오 1: F1 기본 10회 → F2 승급**
```
타임라인:
- 2025-07-01: 등록 (F1)
  → Initial-추가지급단계0 생성 (1~10회, F1, 7월 매출분)

- 2025-08-01: 지급 계획 확인
  → 7월 등록자, 8월 승급 없음
  → Initial-추가지급단계1 생성 (11~20회, F1, 7월 매출분) ⭐ 추가지급
  → F1 최대 20회 도달!

- 2025-09-05: F2 승급!
  → Initial-추가지급단계1(11~20회) 중단 ❌ (추가지급이므로)
  → Promotion-추가지급단계0 생성 (1~10회, F2, 9월 매출분) ✅

- 2025-09-12: 금요일 지급
  → Initial-추가지급단계0: 5회 (F1 기본지급 계속) ✅
  → Promotion-추가지급단계0: 1회 (F2 기본지급 시작) ✅
  → 병행 지급! ⭐

- 2025-10-01: 지급 계획 확인
  → 9월 승급자, 10월 승급 없음
  → Promotion-추가지급단계1 생성? (11~20회, F2, 9월 매출분) ✅
```

**시나리오 2: 전체 계산 예시 (7월-10월) ⭐ 실제 계산**

**초기 상태:**
```
7월: A, B, C 등록 (A 아래 B, C)
- 트리: A(F2) - B(F1), C(F1)
- 매출: 3명 × 1,000,000원 = 3,000,000원

8월: D, E, F 등록 (B 아래 D,E / C 아래 F)
- 트리: A(F2), B(F2), C(F1), D(F1), E(F1), F(F1)
- 매출: 3명 × 1,000,000원 = 3,000,000원

9월: G 등록 (D 아래 G)
- 트리: A(F2), B(F2), C(F1), D(F1), E(F1), F(F1), G(F1)
- 매출: 1명 × 1,000,000원 = 1,000,000원
```

**7월 매출 (3,000,000원) → 8월부터 지급:**
```
지급 대상자: A(F2), B(F1), C(F1) = 3명
등급 분포: F1=2명, F2=1명

계산:
F1: (3,000,000 × 0.24) / (2+1) = 720,000 / 3 = 240,000원
F2: (3,000,000 × 0.19) / (1+0) = 570,000 / 1 = 570,000원
    570,000 + 240,000 = 810,000원

10분할:
A(F2): 810,000 ÷ 10 ÷ 100 × 100 = 81,000원/회
B(F1): 240,000 ÷ 10 ÷ 100 × 100 = 24,000원/회
C(F1): 240,000 ÷ 10 ÷ 100 × 100 = 24,000원/회
```

**8월 매출 (3,000,000원) → 9월부터 지급:**
```
지급 대상자:
- 등록자: D(F1), E(F1), F(F1) = 3명
- 승급자: B(F1→F2) = 1명
- 추가지급 대상자: A(F2), C(F1) = 2명
- 총 6명

등급 분포: F1=4명[C,D,E,F], F2=2명[A,B]

계산:
F1: (3,000,000 × 0.24) / (4+2) = 720,000 / 6 = 120,000원
F2: (3,000,000 × 0.19) / (2+0) = 570,000 / 2 = 285,000원
    285,000 + 120,000 = 405,000원

10분할:
A(F2 추가1차): 405,000 ÷ 10 ÷ 100 × 100 = 40,500원/회
B(F2 기본): 405,000 ÷ 10 ÷ 100 × 100 = 40,500원/회
C(F1 추가1차): 120,000 ÷ 10 ÷ 100 × 100 = 12,000원/회
D(F1 기본): 120,000 ÷ 10 ÷ 100 × 100 = 12,000원/회
E(F1 기본): 120,000 ÷ 10 ÷ 100 × 100 = 12,000원/회
F(F1 기본): 120,000 ÷ 10 ÷ 100 × 100 = 12,000원/회
```

**9월 매출 (1,000,000원) → 10월부터 지급:**
```
지급 대상자:
- 등록자: G(F1) = 1명
- 승급자: 없음
- 추가지급 대상자: A(F2), B(F2), D(F1), E(F1), F(F1) = 5명
  (C 제외: F1 최대 20회 도달 - 7월10회+8월10회=20회)
- 총 6명

등급 분포: F1=4명[D,E,F,G], F2=2명[A,B]

계산:
F1: (1,000,000 × 0.24) / (4+2) = 240,000 / 6 = 40,000원
F2: (1,000,000 × 0.19) / (2+0) = 190,000 / 2 = 95,000원
    95,000 + 40,000 = 135,000원

10분할:
A(F2 추가2차): 135,000 ÷ 10 ÷ 100 × 100 = 13,500원/회
B(F2 추가1차): 135,000 ÷ 10 ÷ 100 × 100 = 13,500원/회
D(F1 추가1차): 40,000 ÷ 10 ÷ 100 × 100 = 4,000원/회
E(F1 추가1차): 40,000 ÷ 10 ÷ 100 × 100 = 4,000원/회
F(F1 추가1차): 40,000 ÷ 10 ÷ 100 × 100 = 4,000원/회
G(F1 기본): 40,000 ÷ 10 ÷ 100 × 100 = 4,000원/회
```

**지급 계획 생성 요약:**
```
7월 처리 (8월 지급 시작):
- A: 7월F2 기본 (추가지급단계:0)
- B: 7월F1 기본 (추가지급단계:0)
- C: 7월F1 기본 (추가지급단계:0)

8월 처리 (9월 지급 시작):
- A: 7월F2 추가1차 (추가지급단계:1, 7월 매출) ⭐
- B: 8월F2 기본 (추가지급단계:0, 승급으로 새 시작)
- C: 7월F1 추가1차 (추가지급단계:1, 7월 매출) ⭐ → F1 20회 도달!
- D: 8월F1 기본 (추가지급단계:0)
- E: 8월F1 기본 (추가지급단계:0)
- F: 8월F1 기본 (추가지급단계:0)

9월 처리 (10월 지급 시작):
- A: 8월F2 추가2차 (추가지급단계:2, 8월 매출) ⭐ → F2 30회 도달!
- B: 8월F2 추가1차 (추가지급단계:1, 8월 매출) ⭐
- C: 생성 안 함 (F1 최대 20회 도달)
- D: 8월F1 추가1차 (추가지급단계:1, 8월 매출) ⭐ → F1 20회 도달!
- E: 8월F1 추가1차 (추가지급단계:1, 8월 매출) ⭐ → F1 20회 도달!
- F: 8월F1 추가1차 (추가지급단계:1, 8월 매출) ⭐ → F1 20회 도달!
- G: 9월F1 기본 (추가지급단계:0)

10월 처리 (11월 지급 시작):
- A: 생성 안 함 (F2 최대 30회 도달)
- B: 9월F2 추가2차 (추가지급단계:2, 9월 매출) ⭐ → F2 30회 도달!
- D,E,F: 생성 안 함 (F1 최대 20회 도달)
- G: 9월F1 추가1차 (추가지급단계:1, 9월 매출)
```

**핵심 포인트:**
1. **매출**: 신규 등록자 수만 계산
2. **지급 대상자**: 등록자 + 승급자 + 추가지급 대상자 (최대 횟수 미도달자)
3. **등급별 배분**: 지급 대상자의 등급 분포 기준
4. **추가지급 매출월**: 대상자가 속한 월의 매출 사용
   - 8월 처리 시 → 7월 대상자 → 7월 매출 사용
   - 9월 처리 시 → 8월 대상자 → 8월 매출 사용
```

**시나리오 3: 매출월 병행 지급 (7월+8월+9월)**
```
타임라인:
- 2025-07-01: 등록 (F2)
  → 7월 매출분 10회 생성

- 2025-08-01: 승급 없음
  → 7월 매출분 10회 생성 (추가 1차)

- 2025-09-01: 승급 없음
  → 8월 매출분 10회 생성 (추가 2차)
  → F2 최대 30회 도달!

- 2025-09-06 (금요일):
  → 7월 매출분 1회: 24,000원 (기본)
  → 7월 매출분 1회: 24,000원 (추가 1차)
  → 8월 매출분 1회: 27,000원 (추가 2차, 8월 매출 다름)
  → 총 3개 계획 병행 지급! ⭐ v7.0
```

---

## 4. 자동화 프로세스

### 4.1 금요일 자동 지급 프로세스 ⭐ v7.0

**실행 시점:** 매주 금요일 00:00

**처리 흐름:**

```javascript
async function processFridayPayments() {
  const today = new Date();
  const weekNumber = getISOWeek(today);

  // === 1단계: 지급 처리 ===
  const plans = await WeeklyPaymentPlans.find({
    'installments': {
      $elemMatch: {
        weekNumber: weekNumber,
        status: 'pending'
      }
    },
    planStatus: 'active'  // ⭐ v7.0: terminated 제외
  });

  for (const plan of plans) {
    // 지급 대상 할부 찾기
    const installment = plan.installments.find(
      inst => inst.weekNumber === weekNumber && inst.status === 'pending'
    );

    // 보험 확인 (F3 이상)
    const user = await User.findOne({ loginId: plan.userId });
    if (user.grade >= 'F3' && !user.insuranceSettings?.maintained) {
      installment.status = 'skipped';
      installment.insuranceSkipped = true;
      continue;
    }

    // 지급 처리
    installment.status = 'paid';
    installment.paidDate = today;
    installment.gradeAtPayment = user.grade;

    plan.completedInstallments++;

    // 계획 완료 확인
    if (plan.completedInstallments === plan.totalInstallments) {
      plan.planStatus = 'completed';
    }

    await plan.save();
  }

  // === 2단계: WeeklyPaymentSummary 업데이트 ===
  await updateWeeklySummary(weekNumber, plans);

  // === 끝! 추가지급 확인은 매월 등록/승급 시점에 수행 ===
}
```

**⭐ v7.0 중요 변경:**
- 금요일 처리는 **순수하게 지급만** 수행
- 추가지급 확인 및 생성은 **매월 등록/승급 시점**에 수행

---

### 4.2 매월 추가지급 확인 로직 ⭐ v7.0 신규

**실행 시점:** 매월 등록/승급 처리 시점

**트리거:** 등록/승급 처리 완료 후

```javascript
// 매월 등록/승급 처리 시 실행
async function checkAndCreateMonthlyAdditionalPayments(currentMonth) {
  console.log(`[매월 추가지급 확인] ${currentMonth} 시작`);

  const previousMonth = getPreviousMonth(currentMonth);

  // 1. 이전 월 등록자 조회
  const prevMonthReg = await MonthlyRegistrations.findOne({
    monthKey: previousMonth
  });

  // 2. 이전 월 승급자 조회
  const prevMonthPromoted = prevMonthReg?.paymentTargets?.promoted || [];

  // 3. 대상자 목록 생성
  const candidates = [
    ...(prevMonthReg?.registrations || []),
    ...prevMonthPromoted
  ];

  console.log(`[매월 추가지급 확인] 이전 월(${previousMonth}) 대상자: ${candidates.length}명`);

  let createdCount = 0;
  let skippedCount = 0;

  for (const candidate of candidates) {
    const user = await User.findOne({ loginId: candidate.userId });
    if (!user) continue;

    // 4. 현재 월 승급 여부 확인
    const hasPromotion = await checkPromotionInMonth(user.loginId, currentMonth);

    if (hasPromotion) {
      console.log(`[${user.loginId}] ${currentMonth} 승급 발생 - 추가지급 생성 안 함`);
      skippedCount++;
      continue;
    }

    // 5. 추가지급 계획 생성 시도
    const result = await createAdditionalPaymentPlan(user, previousMonth);

    if (result.created) {
      createdCount++;
      console.log(`[${user.loginId}] 추가지급 생성: ${previousMonth} 매출분 ${result.추가지급단계}단계`);
    } else {
      skippedCount++;
      console.log(`[${user.loginId}] 추가지급 생성 안 함: ${result.reason}`);
    }
  }

  console.log(`[매월 추가지급 확인] 완료: 생성 ${createdCount}건, 제외 ${skippedCount}건`);

  // 6. MonthlyRegistrations에 추가지급 대상자 기록
  await MonthlyRegistrations.updateOne(
    { monthKey: currentMonth },
    {
      $set: {
        'paymentTargets.additionalPayments': await getAdditionalPaymentTargets(currentMonth)
      }
    }
  );

  return { created: createdCount, skipped: skippedCount };
}

// 추가지급 계획 생성
async function createAdditionalPaymentPlan(user, revenueMonth) {
  // 1. 최대 횟수 확인
  const MAX_INSTALLMENTS = { F1: 20, F2: 30, F3: 40, F4: 40, F5: 50, F6: 50, F7: 60, F8: 60 };
  const totalCompleted = await calculateTotalInstallmentsForGrade(user.loginId, user.grade);

  if (totalCompleted >= MAX_INSTALLMENTS[user.grade]) {
    return { created: false, reason: '최대 횟수 도달' };
  }

  // 2. 등급 확인
  const lastPlan = await WeeklyPaymentPlans.findOne({
    userId: user.loginId
  }).sort({ createdAt: -1 });

  if (user.grade < lastPlan.baseGrade) {
    return { created: false, reason: '등급 하락' };
  }

  // 3. 보험 확인 (F3 이상)
  if (user.grade >= 'F3' && !user.insuranceSettings?.maintained) {
    return { created: false, reason: '보험 미가입' };
  }

  // 4. 추가지급단계 계산
  const existingPlans = await WeeklyPaymentPlans.find({
    userId: user.loginId,
    baseGrade: user.grade,
    planType: lastPlan.planType
  }).sort({ 추가지급단계: -1 });

  const next추가지급단계 = existingPlans.length > 0
    ? existingPlans[0].추가지급단계 + 1
    : 1;

  // 5. 매출 조회 및 금액 계산
  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: revenueMonth });
  if (!monthlyReg) {
    return { created: false, reason: '매출 정보 없음' };
  }

  const revenue = monthlyReg.getEffectiveRevenue();
  const gradePayments = calculateGradePayments(revenue, monthlyReg.gradeDistribution);
  const baseAmount = gradePayments[user.grade];
  const installmentAmount = Math.floor(baseAmount / 10 / 100) * 100;

  // 6. 추가 10회 계획 생성
  const startDate = getNextFriday(new Date());

  const installments = [];
  for (let i = 1; i <= 10; i++) {
    const scheduledDate = new Date(startDate);
    scheduledDate.setDate(scheduledDate.getDate() + (i - 1) * 7);

    installments.push({
      week: i,
      weekNumber: getISOWeek(scheduledDate),
      scheduledDate,
      revenueMonth,
      gradeAtPayment: null,
      baseAmount,
      installmentAmount,
      withholdingTax: Math.round(installmentAmount * 0.033),
      netAmount: installmentAmount - Math.round(installmentAmount * 0.033),
      status: 'pending',
      insuranceSkipped: false
    });
  }

  // 7. DB 저장
  const newPlan = await WeeklyPaymentPlans.create({
    userId: user.loginId,
    userName: user.name,
    planType: lastPlan.planType,
    추가지급단계: next추가지급단계,
    installmentType: 'additional',
    baseGrade: user.grade,
    revenueMonth,
    startDate,
    totalInstallments: 10,
    completedInstallments: 0,
    planStatus: 'active',
    installments,
    parentPlanId: lastPlan._id,
    createdBy: 'monthly_check'
  });

  // 8. 주차별 총계 업데이트
  await updateWeeklyProjections(newPlan, 'add');

  return {
    created: true,
    추가지급단계: next추가지급단계,
    planId: newPlan._id
  };
}
```

---

### 4.3 용역자 등록 프로세스 ⭐ v7.0 변경

```javascript
async function processUserRegistration(userIds) {
  const currentMonth = getCurrentMonth(); // '2025-10'

  // 1. 사용자 정보 조회
  const users = await User.find({ _id: { $in: userIds } });

  // 2. 등급 재계산 (먼저 실행!)
  const gradeChangeResult = await recalculateAllGrades();
  const affectedUsers = gradeChangeResult.changedUsers || [];

  // 3. 등급 재계산 후 users 정보 다시 조회 (최신 등급 반영)
  const updatedUsers = await User.find({ _id: { $in: userIds } });

  // 4. 월별 등록 정보 업데이트 (최신 등급으로)
  await updateMonthlyRegistrations(updatedUsers, currentMonth);

  // 5. 월별 트리 스냅샷 업데이트
  await updateMonthlyTreeSnapshots(updatedUsers, affectedUsers);

  // 6. 지급 계획 처리
  const paymentPlanResults = [];

  // 6-1. 신규 등록자 Initial 계획 생성 (10회만, 기본지급)
  for (const user of updatedUsers) {
    const plan = await createInitialPaymentPlan(
      user.loginId,
      user.name,
      user.grade,
      user.registrationDate || user.createdAt
    );
    paymentPlanResults.push({
      userId: user.loginId,
      type: 'initial',
      추가지급단계: 0,
      plan: plan._id
    });
  }

  // 6-2. 승급자 Promotion 계획 생성 (10회만, 기본지급)
  const promotedUsers = affectedUsers.filter(u =>
    u.changeType === 'grade_change' && u.oldGrade && u.newGrade && u.oldGrade < u.newGrade
  );

  for (const promoted of promotedUsers) {
    const user = await User.findOne({ loginId: promoted.userId });

    // ⭐ v7.0: 승급 시 진행 중인 추가지급 계획 중단
    await terminateAdditionalPaymentPlans(user.loginId);

    const plan = await createPromotionPaymentPlan(
      user.loginId,
      user.name,
      promoted.newGrade,
      new Date()
    );
    paymentPlanResults.push({
      userId: user.loginId,
      type: 'promotion',
      추가지급단계: 0,
      plan: plan._id
    });
  }

  // 7. ⭐ v7.0: 매월 추가지급 확인 및 생성
  console.log('[등록처리 7단계] 매월 추가지급 확인 시작');

  const additionalPaymentResult = await checkAndCreateMonthlyAdditionalPayments(currentMonth);

  console.log(`[등록처리 7단계] 추가지급 생성 완료: ${additionalPaymentResult.created}건, 제외: ${additionalPaymentResult.skipped}건`);

  return {
    success: true,
    registeredUsers: updatedUsers.length,
    affectedUsers: affectedUsers.length,
    promotedUsers: promotedUsers.length,
    paymentPlans: paymentPlanResults,
    additionalPayments: additionalPaymentResult  // ⭐ v7.0 신규
  };
}

// ⭐ v7.0 신규: 추가지급 계획 중단
async function terminateAdditionalPaymentPlans(userId) {
  const additionalPlans = await WeeklyPaymentPlans.find({
    userId,
    installmentType: 'additional',
    planStatus: 'active'
  });

  for (const plan of additionalPlans) {
    // 미지급 할부를 terminated로 변경
    for (const inst of plan.installments) {
      if (inst.status === 'pending') {
        inst.status = 'terminated';
        inst.terminatedReason = 'promotion';
      }
    }

    plan.planStatus = 'terminated';
    plan.terminatedBy = 'promotion';
    plan.terminatedAt = new Date();
    await plan.save();

    console.log(`[${userId}] 추가지급 중단: ${plan.revenueMonth} 매출분 ${plan.추가지급단계}단계`);

    // WeeklyPaymentSummary에서 예상 금액 제거
    await updateWeeklyProjections(plan, 'remove');
  }

  return additionalPlans.length;
}
```

---

## 5. 웹 API 설계

### 5.1 용역비 지급명부 조회 API ⭐ v7.0 변경

#### 5.1.1 단일 주차 조회

**GET** `/api/admin/payment/weekly?year=2025&month=10&week=2`

**응답:**
```json
{
  "success": true,
  "data": {
    "grandTotal": {
      "totalAmount": 75000,
      "totalTax": 2475,
      "totalNet": 72525
    },
    "week": "2025년 10월 2주",
    "weekNumber": "2025-W41",
    "payments": [
      {
        "no": 1,
        "userId": "사장님",
        "userName": "사장님",
        "grade": "F2",
        "actualAmount": 75000,
        "taxAmount": 2475,
        "netAmount": 72525,
        "installments": [
          {
            "planType": "initial",
            "추가지급단계": 0,
            "installmentType": "basic",
            "week": 10,
            "revenueMonth": "2025-07",
            "amount": 24000,
            "tax": 792,
            "net": 23208
          },
          {
            "planType": "initial",
            "추가지급단계": 1,
            "installmentType": "additional",
            "week": 3,
            "revenueMonth": "2025-07",
            "amount": 24000,
            "tax": 792,
            "net": 23208
          },
          {
            "planType": "initial",
            "추가지급단계": 2,
            "installmentType": "additional",
            "week": 2,
            "revenueMonth": "2025-08",
            "amount": 27000,
            "tax": 891,
            "net": 26109
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "totalPages": 1,
      "totalItems": 3,
      "itemsPerPage": 20
    }
  }
}
```

**⭐ v7.0 변경:**
- `추가지급단계` 필드 추가
- `installmentType` 필드 추가 ('basic' | 'additional')
- 같은 사용자가 여러 매출월 지급을 병행 받을 수 있음

---

## 6. 데이터 흐름도

### 6.1 등록 시 데이터 흐름 ⭐ v7.0

```
[엑셀 업로드/개별 등록]
    ↓
[User 생성/저장]
    ↓
[등급 재계산]
    ↓
[MonthlyRegistrations 업데이트] ⭐ v7.0 변경
    - 등록자 정보 추가 (신규 등록자만)
    - 매출 계산 (등록자 수만 × 1,000,000원)
    - 지급 대상자 기록 (등록자 + 승급자 + 추가지급 대상자)
    - 등급별 배분액 계산 (지급 대상자 전체 기준)
    ↓
[MonthlyTreeSnapshots 업데이트]
    - 트리 구조 스냅샷
    - 등급 분포
    ↓
[WeeklyPaymentPlans 생성] ⭐ 10회만, 기본지급
    - planType: 'initial'
    - 추가지급단계: 0
    - installmentType: 'basic'
    - totalInstallments: 10
    - revenueMonth: 등록월
    ↓
[WeeklyPaymentSummary 업데이트]
    - 주차별 예상 총계 업데이트
    ↓
[매월 추가지급 확인] ⭐ v7.0 신규
    - 이전 월 등록자/승급자 조회
    - 현재 월 승급 여부 확인
    - 승급 없으면 추가지급 계획 생성
```

---

### 6.2 금요일 자동처리 데이터 흐름 ⭐ v7.0

```
[스케줄러 실행: 매주 금요일 00:00]
    ↓
[1단계: 해당 주차 지급 대상 조회]
    - WeeklyPaymentPlans에서 weekNumber로 필터링
    - installments.status: 'pending'
    - planStatus: 'active' (terminated 제외) ⭐
    ↓
[1단계: 지급 처리]
    - 보험 확인 (F3 이상)
    - status: 'pending' → 'paid'
    - completedInstallments++
    - planStatus: 완료 시 'completed'
    ↓
[2단계: WeeklyPaymentSummary 업데이트]
    - 실제 지급액 집계
    - totalAmount, totalTax, totalNet 업데이트
    - recipientCount 업데이트
    - status: 'paid', processedAt 기록
    ↓
[완료: 로깅]
    - 지급 완료 로그
    - (추가지급 확인은 매월 등록/승급 시점에 수행)
```

**⭐ v7.0 핵심 변경:**
- 금요일 처리는 **순수하게 지급만** 수행
- 추가지급 확인 및 생성은 **매월 등록/승급 시점**에 수행

---

### 6.3 매월 추가지급 확인 흐름 ⭐ v7.0 신규

```
[등록/승급 처리 완료]
    ↓
[현재 월 = YYYY-MM]
    ↓
[이전 월 등록자/승급자 조회]
    - MonthlyRegistrations(이전 월).registrations
    - MonthlyRegistrations(이전 월).paymentTargets.promoted
    ↓
[FOR EACH candidate:]
    ↓
[현재 월 승급 여부 확인]
    - 승급 있음 → SKIP (새 등급 기본지급 이미 생성됨)
    - 승급 없음 → 계속
    ↓
[조건 확인]
    ├─ 최대 횟수 확인 (F1:20, F2:30, ...)
    ├─ 등급 유지/상승 확인
    └─ 보험 유지 확인 (F3 이상)
    ↓
[이전 월 매출 기준 금액 계산]
    - revenueMonth = 이전 월
    - MonthlyRegistrations(이전 월)에서 매출 조회
    - 지급 대상자 전체 등급 분포 기준 배분액 계산
    - installmentAmount = baseAmount ÷ 10
    ↓
[추가지급 계획 생성]
    - WeeklyPaymentPlans.create({
        추가지급단계: N+1,
        installmentType: 'additional',
        revenueMonth: 이전 월,
        parentPlanId: 이전 계획 ID,
        createdBy: 'monthly_check',
        totalInstallments: 10
      })
    ↓
[WeeklyPaymentSummary 업데이트]
    - 신규 생성된 계획의 미래 주차에
    - 예상 지급액 추가 (incrementPayment)
    - 지급대상자 수 업데이트
    ↓
[MonthlyRegistrations 업데이트]
    - paymentTargets.additionalPayments 기록
    ↓
[로깅 및 알림]
    - 추가지급 생성 로그
    - 조건 미충족 알림
```

---

### 6.4 승급 시 데이터 흐름 ⭐ v7.0 변경

```
[등급 재계산]
    ↓
[승급 감지]
    ↓
[기존 계획 확인]
    ├─ 기본지급(추가지급단계:0) → 계속 진행 ✅
    └─ 추가지급(추가지급단계:1+) → 즉시 중단 ❌ ⭐ v7.0
    ↓
[추가지급 계획 중단] ⭐ v7.0 신규
    - installments[].status: 'pending' → 'terminated'
    - installments[].terminatedReason: 'promotion'
    - planStatus: 'terminated'
    - terminatedBy: 'promotion'
    - WeeklyPaymentSummary에서 예상 금액 제거
    ↓
[Promotion 계획 생성] (10회만, 기본지급)
    - planType: 'promotion'
    - 추가지급단계: 0
    - installmentType: 'basic'
    - totalInstallments: 10
    - revenueMonth: 승급 시점 월
    ↓
[병행 지급 시작]
    - 기존 기본지급 계획 + 신규 Promotion 계획 동시 진행
```

---

## 7. v6.0 → v7.0 변경사항 요약

| 항목 | v6.0 | v7.0 |
|------|------|------|
| **등록 시 계획 생성** | 10회만 생성 | 10회만 생성 (동일) |
| **추가지급 생성 시점** | 10회 완료 즉시 | 매월 등록/승급 처리 시 ⭐ |
| **추가지급 조건** | 10회 완료 | 이전 월 등록/승급 + 현재 월 승급 없음 ⭐ |
| **승급 시 추가지급** | - | 즉시 중단 ⭐ |
| **매출 계산** | 등록자 + 승급자 | 등록자만 ⭐ |
| **등급별 배분** | - | 지급 대상자 전체 기준 ⭐ |
| **금요일 처리** | 지급 + 10회 완료 확인 | 지급만 ⭐ |
| **매출월 병행 지급** | - | 7월+8월+9월 동시 가능 ⭐ |
| **generation 필드** | generation | 추가지급단계 ⭐ |
| **installmentType** | 없음 | basic/additional ⭐ |
| **terminatedBy** | 없음 | promotion ⭐ |
| **createdBy** | auto_generation | monthly_check ⭐ |

---

## 8. 구현 우선순위

### Phase 1: 핵심 로직 변경 ⭐ v7.0
1. WeeklyPaymentPlans 스키마 수정
   - `generation` → `추가지급단계` 변경
   - `installmentType` 추가 ('basic' | 'additional')
   - `terminatedBy`, `terminatedAt` 추가
   - `installments[].terminatedReason` 추가

2. MonthlyRegistrations 스키마 수정
   - `paymentTargets` 추가 (등록자/승급자/추가지급 대상자)
   - `gradeDistribution` 의미 변경 (지급 대상자 전체)

3. 추가지급 로직 변경
   - `checkAndCreateAdditionalPlan` 삭제
   - `checkAndCreateMonthlyAdditionalPayments` 신규 구현
   - `createAdditionalPaymentPlan` 신규 구현

4. 승급 처리 로직 추가
   - `terminateAdditionalPaymentPlans` 신규 구현
   - `createPromotionPaymentPlan` 수정 (중단 로직 추가)

5. 금요일 자동처리 수정
   - 추가지급 확인 로직 제거
   - 순수 지급 처리만

### Phase 2: API 및 UI
1. API 응답에 `추가지급단계`, `installmentType` 정보 추가
2. 지급명부에 추가지급단계 표시
3. 매출월별 병행 지급 표시
4. 승급으로 중단된 추가지급 표시

### Phase 3: 모니터링 및 최적화
1. 매월 추가지급 생성 로그
2. 승급으로 인한 중단 알림
3. 조건 미충족 알림
4. 성능 최적화

---

**문서 버전 히스토리:**

- v7.0 (2025-10-12): 추가지급 시기 변경 (매월 승급 확인), 매출 계산 변경 (등록자만), 승급 시 추가지급 중단
- v6.0 (2025-10-11): 동적 지급 계획 생성 방식으로 변경
- v5.0 (2025-10-11): 병행 지급 및 추가 지급기간 도입
- v4.0 (2025-09-20): 등급별 최대 수령 횟수 추가
- v3.0 (2025-09-15): 주차별 총계 컬렉션 추가
- v2.0 (2025-09-10): 월별 스냅샷 구조 개선
- v1.0 (2025-09-01): 초기 버전
