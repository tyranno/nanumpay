# 백업 시스템 최종 통합

**날짜**: 2025-10-26
**상태**: ✅ 완료

---

## 📋 통합 요약

백업 앱을 **기존 UI/API 구조에 맞춰** 통합 완료했습니다.

### 기존 구조 (유지)

**Admin 모델** (`systemSettings.backup`):
```javascript
{
  enabled: Boolean,
  frequency: 'daily' | 'weekly' | 'monthly',
  time: '02:00',  // HH:mm
  dayOfWeek: 0-6,
  dayOfMonth: 1-31,
  retention: {
    count: 7,    // 최대 개수
    days: 30,    // 보관 기간
    compress: true
  },
  storage: {
    type: 's3' | 'ftp',  // 하나만 선택
    s3: { region, bucket, accessKeyId, secretAccessKey, prefix },
    ftp: { host, port, username, password, remotePath, secure }
  }
}
```

### 백업 앱 변환 로직

백업 앱(`apps/backup/src/config.js`)이 기존 구조를 읽어서 내부적으로 변환합니다:

```javascript
// 읽기: systemSettings.backup
const backup = admin.systemSettings.backup;

// 변환: 백업 앱 내부 구조로
const config = {
  backupPath: process.env.BACKUP_PATH || '/opt/nanumpay/backups',
  retentionDays: backup.retention.days,
  retentionCount: backup.retention.count,
  s3: backup.storage.type === 's3' ? {
    enabled: true,
    bucket: backup.storage.s3.bucket,
    accessKeyId: backup.storage.s3.accessKeyId,
    secretAccessKey: backup.storage.s3.secretAccessKey,
    region: backup.storage.s3.region,
    prefix: backup.storage.s3.prefix
  } : null,
  ftp: backup.storage.type === 'ftp' ? {
    enabled: true,
    host: backup.storage.ftp.host,
    port: backup.storage.ftp.port,
    user: backup.storage.ftp.username,
    password: backup.storage.ftp.password,
    remotePath: backup.storage.ftp.remotePath
  } : null
};
```

---

## ✅ 테스트 결과

### 1. MongoDB 설정 업데이트
```javascript
db.admins.updateOne({}, {
  $set: {
    'systemSettings.backup.enabled': true,
    'systemSettings.backup.frequency': 'daily',
    'systemSettings.backup.time': '02:00',
    'systemSettings.backup.retention.count': 5,
    'systemSettings.backup.retention.days': 7,
    'systemSettings.backup.storage.type': 'ftp'
  }
})
```

### 2. 백업 실행 결과
```
✅ MongoDB 연결 성공
✅ 백업 설정 로드 완료
   백업 경로: /tmp/nanumpay-backups-test
   보관 기간: 7일
   보관 개수: 5개
   S3 업로드: 비활성화
   FTP 업로드: 활성화

📦 백업 시작: nanumpay-backup-2025-10-26T02-31-12
✅ mongodump 완료
✅ 압축 완료: 12K
📡 FTP 업로드 시작... (서버 없어서 연결 실패 - 정상)
✅ 보관 정책 적용: 최대 5개 유지
✅ 백업 완료!
```

### 3. 확인 사항
- [x] 기존 `systemSettings.backup` 구조 읽기 성공
- [x] retention.count/days 변환 성공
- [x] storage.type에 따른 S3/FTP 활성화 성공
- [x] 백업 파일 생성 성공 (12KB tar.gz)
- [x] 보관 정책 적용 성공

---

## 📁 변경된 파일

### 1. apps/backup/src/config.js
**변경 내용**:
- Admin 스키마를 기존 UI 구조에 맞춤 (`backup` → `systemSettings.backup`)
- `getBackupConfig()` 함수에서 구조 변환 로직 추가
- `backupPath`에 환경변수 지원 추가 (개발/프로덕션 환경 분리)

**주요 로직**:
```javascript
// 기존 구조 읽기
const backup = admin.systemSettings.backup;

// S3/FTP 설정 변환
if (backup.storage?.type === 's3') {
  config.s3 = { enabled: true, ...backup.storage.s3 };
}
if (backup.storage?.type === 'ftp') {
  config.ftp = { enabled: true, ...backup.storage.ftp };
}
```

### 2. apps/web/src/lib/server/models/Admin.js
**변경 내용**:
- `backupSettings` → `backup`으로 되돌림 (기존 UI 구조 유지)

**이유**: 기존 UI/API가 `systemSettings.backup` 구조를 사용하고 있었음

### 3. 변경 안 함 (기존 유지)
- ✅ `apps/web/src/routes/(admin)/admin/settings/+page.svelte` - UI 그대로 유지
- ✅ `apps/web/src/routes/api/admin/settings/system/+server.js` - API 그대로 유지
- ✅ `apps/web/scripts/release-linux.cjs` - 빌드 통합 코드 그대로 유지

---

## 🎯 동작 방식

### 1. UI에서 설정 저장
```
[관리자 웹 UI]
    ↓ (저장)
POST /api/admin/settings/system
    ↓
{
  backup: {
    enabled: true,
    frequency: 'daily',
    time: '02:00',
    retention: { count: 5, days: 7 },
    storage: {
      type: 'ftp',
      ftp: { host: 'ftp.example.com', ... }
    }
  }
}
    ↓
[MongoDB: admins.systemSettings.backup 업데이트]
```

### 2. 백업 실행
```
[Crontab 또는 수동 실행]
    ↓
/opt/nanumpay/bin/nanumpay-backup
    ↓
[config.js: MongoDB에서 systemSettings.backup 읽기]
    ↓
[구조 변환: backup → 내부 config]
    ↓
[백업 실행: mongodump → 압축 → S3/FTP 업로드]
    ↓
[보관 정책 적용: count/days 기준 정리]
```

---

## 🔧 환경변수

### BACKUP_PATH
백업 파일 저장 경로를 지정합니다.

```bash
# 개발 환경
BACKUP_PATH=/tmp/nanumpay-backups-test ./nanumpay-backup

# 프로덕션 환경 (기본값)
# /opt/nanumpay/backups 사용
./nanumpay-backup
```

### MONGODB_URI
MongoDB 연결 URI를 지정합니다.

```bash
# 기본값
mongodb://localhost:27017/nanumpay

# 커스텀
MONGODB_URI=mongodb://custom-host:27017/nanumpay ./nanumpay-backup
```

---

## 📝 남은 작업

백업 시스템 핵심 기능은 완료되었으며, **추가 작업 없이 바로 사용 가능**합니다.

### 선택적 개선 사항:

1. **Crontab 자동 등록 API** (선택)
   - UI에서 백업 설정 저장 시 자동으로 crontab 등록/제거
   - 현재는 수동으로 crontab 설정 필요

2. **즉시 백업 버튼** (선택)
   - UI에 "즉시 백업" 버튼 추가
   - API: `POST /api/admin/backup/execute`

3. **백업 파일 목록/다운로드** (선택)
   - UI에서 백업 파일 목록 조회
   - 다운로드/삭제 기능

4. **로그 뷰어** (선택)
   - `/opt/nanumpay/logs/backup.log` 조회
   - 실시간 로그 확인

---

## 🚀 배포 방법

### 1. 빌드
```bash
cd /home/tyranno/project/bill/nanumpay
pnpm release:linux
```

자동으로 수행되는 작업:
- SvelteKit 웹 앱 빌드
- 백업 앱 빌드 (`apps/backup/build/nanumpay-backup`)
- DEB 패키지 생성 (백업 앱 포함)

### 2. 배포
```bash
node apps/web/scripts/deploy.cjs
```

배포 후 서버 파일 위치:
```
/opt/nanumpay/
├── nanumpay              # 웹 앱
├── bin/
│   └── nanumpay-backup   # 백업 앱
├── backups/              # 백업 저장소
└── logs/                 # 로그
```

### 3. Crontab 설정 (수동)

**매일 새벽 2시 백업**:
```bash
# nanumpay 사용자로 전환
sudo -u nanumpay crontab -e

# 추가
0 2 * * * /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

**매주 일요일 새벽 3시 백업**:
```bash
0 3 * * 0 /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

**매월 1일 새벽 4시 백업**:
```bash
0 4 1 * * /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

### 4. 즉시 백업 (수동)
```bash
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup
```

### 5. 로그 확인
```bash
tail -f /opt/nanumpay/logs/backup.log
```

---

## 🔍 문제 해결

### 백업이 실행되지 않음
```bash
# 1. 백업 활성화 확인
mongosh mongodb://localhost:27017/nanumpay --eval "
db.admins.findOne({}, { 'systemSettings.backup.enabled': 1 })
"

# 2. 수동 실행 테스트
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup

# 3. 권한 확인
ls -ld /opt/nanumpay/backups
# drwxr-xr-x nanumpay nanumpay
```

### MongoDB 연결 실패
```bash
# MongoDB 상태 확인
sudo systemctl status mongod

# MongoDB 재시작
sudo systemctl restart mongod
```

### FTP/S3 업로드 실패
```bash
# 로그 확인
tail -100 /opt/nanumpay/logs/backup.log | grep -A 5 "FTP\|S3"

# 설정 확인
mongosh mongodb://localhost:27017/nanumpay --eval "
db.admins.findOne({}, { 'systemSettings.backup.storage': 1 })
"
```

---

## 📚 참고 문서

1. [백업_시스템_구현_완료.md](백업_시스템_구현_완료.md) - 전체 구현 내용
2. [백업_시스템_테스트_결과.md](백업_시스템_테스트_결과.md) - 테스트 결과
3. [apps/backup/README.md](../apps/backup/README.md) - 백업 앱 사용법

---

**작성자**: Claude AI Assistant
**최종 수정일**: 2025-10-26
