# ë°±ì—… ì‹œìŠ¤í…œ ìµœì¢… í†µí•©

**ë‚ ì§œ**: 2025-10-26
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ í†µí•© ìš”ì•½

ë°±ì—… ì•±ì„ **ê¸°ì¡´ UI/API êµ¬ì¡°ì— ë§ì¶°** í†µí•© ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

### ê¸°ì¡´ êµ¬ì¡° (ìœ ì§€)

**Admin ëª¨ë¸** (`systemSettings.backup`):
```javascript
{
  enabled: Boolean,
  frequency: 'daily' | 'weekly' | 'monthly',
  time: '02:00',  // HH:mm
  dayOfWeek: 0-6,
  dayOfMonth: 1-31,
  retention: {
    count: 7,    // ìµœëŒ€ ê°œìˆ˜
    days: 30,    // ë³´ê´€ ê¸°ê°„
    compress: true
  },
  storage: {
    type: 's3' | 'ftp',  // í•˜ë‚˜ë§Œ ì„ íƒ
    s3: { region, bucket, accessKeyId, secretAccessKey, prefix },
    ftp: { host, port, username, password, remotePath, secure }
  }
}
```

### ë°±ì—… ì•± ë³€í™˜ ë¡œì§

ë°±ì—… ì•±(`apps/backup/src/config.js`)ì´ ê¸°ì¡´ êµ¬ì¡°ë¥¼ ì½ì–´ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤:

```javascript
// ì½ê¸°: systemSettings.backup
const backup = admin.systemSettings.backup;

// ë³€í™˜: ë°±ì—… ì•± ë‚´ë¶€ êµ¬ì¡°ë¡œ
const config = {
  backupPath: process.env.BACKUP_PATH || '/opt/nanumpay/backups',
  retentionDays: backup.retention.days,
  retentionCount: backup.retention.count,
  s3: backup.storage.type === 's3' ? {
    enabled: true,
    bucket: backup.storage.s3.bucket,
    accessKeyId: backup.storage.s3.accessKeyId,
    secretAccessKey: backup.storage.s3.secretAccessKey,
    region: backup.storage.s3.region,
    prefix: backup.storage.s3.prefix
  } : null,
  ftp: backup.storage.type === 'ftp' ? {
    enabled: true,
    host: backup.storage.ftp.host,
    port: backup.storage.ftp.port,
    user: backup.storage.ftp.username,
    password: backup.storage.ftp.password,
    remotePath: backup.storage.ftp.remotePath
  } : null
};
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### 1. MongoDB ì„¤ì • ì—…ë°ì´íŠ¸
```javascript
db.admins.updateOne({}, {
  $set: {
    'systemSettings.backup.enabled': true,
    'systemSettings.backup.frequency': 'daily',
    'systemSettings.backup.time': '02:00',
    'systemSettings.backup.retention.count': 5,
    'systemSettings.backup.retention.days': 7,
    'systemSettings.backup.storage.type': 'ftp'
  }
})
```

### 2. ë°±ì—… ì‹¤í–‰ ê²°ê³¼
```
âœ… MongoDB ì—°ê²° ì„±ê³µ
âœ… ë°±ì—… ì„¤ì • ë¡œë“œ ì™„ë£Œ
   ë°±ì—… ê²½ë¡œ: /tmp/nanumpay-backups-test
   ë³´ê´€ ê¸°ê°„: 7ì¼
   ë³´ê´€ ê°œìˆ˜: 5ê°œ
   S3 ì—…ë¡œë“œ: ë¹„í™œì„±í™”
   FTP ì—…ë¡œë“œ: í™œì„±í™”

ğŸ“¦ ë°±ì—… ì‹œì‘: nanumpay-backup-2025-10-26T02-31-12
âœ… mongodump ì™„ë£Œ
âœ… ì••ì¶• ì™„ë£Œ: 12K
ğŸ“¡ FTP ì—…ë¡œë“œ ì‹œì‘... (ì„œë²„ ì—†ì–´ì„œ ì—°ê²° ì‹¤íŒ¨ - ì •ìƒ)
âœ… ë³´ê´€ ì •ì±… ì ìš©: ìµœëŒ€ 5ê°œ ìœ ì§€
âœ… ë°±ì—… ì™„ë£Œ!
```

### 3. í™•ì¸ ì‚¬í•­
- [x] ê¸°ì¡´ `systemSettings.backup` êµ¬ì¡° ì½ê¸° ì„±ê³µ
- [x] retention.count/days ë³€í™˜ ì„±ê³µ
- [x] storage.typeì— ë”°ë¥¸ S3/FTP í™œì„±í™” ì„±ê³µ
- [x] ë°±ì—… íŒŒì¼ ìƒì„± ì„±ê³µ (12KB tar.gz)
- [x] ë³´ê´€ ì •ì±… ì ìš© ì„±ê³µ

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

### 1. apps/backup/src/config.js
**ë³€ê²½ ë‚´ìš©**:
- Admin ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ì¡´ UI êµ¬ì¡°ì— ë§ì¶¤ (`backup` â†’ `systemSettings.backup`)
- `getBackupConfig()` í•¨ìˆ˜ì—ì„œ êµ¬ì¡° ë³€í™˜ ë¡œì§ ì¶”ê°€
- `backupPath`ì— í™˜ê²½ë³€ìˆ˜ ì§€ì› ì¶”ê°€ (ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ ë¶„ë¦¬)

**ì£¼ìš” ë¡œì§**:
```javascript
// ê¸°ì¡´ êµ¬ì¡° ì½ê¸°
const backup = admin.systemSettings.backup;

// S3/FTP ì„¤ì • ë³€í™˜
if (backup.storage?.type === 's3') {
  config.s3 = { enabled: true, ...backup.storage.s3 };
}
if (backup.storage?.type === 'ftp') {
  config.ftp = { enabled: true, ...backup.storage.ftp };
}
```

### 2. apps/web/src/lib/server/models/Admin.js
**ë³€ê²½ ë‚´ìš©**:
- `backupSettings` â†’ `backup`ìœ¼ë¡œ ë˜ëŒë¦¼ (ê¸°ì¡´ UI êµ¬ì¡° ìœ ì§€)

**ì´ìœ **: ê¸°ì¡´ UI/APIê°€ `systemSettings.backup` êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŒ

### 3. ë³€ê²½ ì•ˆ í•¨ (ê¸°ì¡´ ìœ ì§€)
- âœ… `apps/web/src/routes/(admin)/admin/settings/+page.svelte` - UI ê·¸ëŒ€ë¡œ ìœ ì§€
- âœ… `apps/web/src/routes/api/admin/settings/system/+server.js` - API ê·¸ëŒ€ë¡œ ìœ ì§€
- âœ… `apps/web/scripts/release-linux.cjs` - ë¹Œë“œ í†µí•© ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€

---

## ğŸ¯ ë™ì‘ ë°©ì‹

### 1. UIì—ì„œ ì„¤ì • ì €ì¥
```
[ê´€ë¦¬ì ì›¹ UI]
    â†“ (ì €ì¥)
POST /api/admin/settings/system
    â†“
{
  backup: {
    enabled: true,
    frequency: 'daily',
    time: '02:00',
    retention: { count: 5, days: 7 },
    storage: {
      type: 'ftp',
      ftp: { host: 'ftp.example.com', ... }
    }
  }
}
    â†“
[MongoDB: admins.systemSettings.backup ì—…ë°ì´íŠ¸]
```

### 2. ë°±ì—… ì‹¤í–‰
```
[Crontab ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰]
    â†“
/opt/nanumpay/bin/nanumpay-backup
    â†“
[config.js: MongoDBì—ì„œ systemSettings.backup ì½ê¸°]
    â†“
[êµ¬ì¡° ë³€í™˜: backup â†’ ë‚´ë¶€ config]
    â†“
[ë°±ì—… ì‹¤í–‰: mongodump â†’ ì••ì¶• â†’ S3/FTP ì—…ë¡œë“œ]
    â†“
[ë³´ê´€ ì •ì±… ì ìš©: count/days ê¸°ì¤€ ì •ë¦¬]
```

---

## ğŸ”§ í™˜ê²½ë³€ìˆ˜

### BACKUP_PATH
ë°±ì—… íŒŒì¼ ì €ì¥ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
# ê°œë°œ í™˜ê²½
BACKUP_PATH=/tmp/nanumpay-backups-test ./nanumpay-backup

# í”„ë¡œë•ì…˜ í™˜ê²½ (ê¸°ë³¸ê°’)
# /opt/nanumpay/backups ì‚¬ìš©
./nanumpay-backup
```

### MONGODB_URI
MongoDB ì—°ê²° URIë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
# ê¸°ë³¸ê°’
mongodb://localhost:27017/nanumpay

# ì»¤ìŠ¤í…€
MONGODB_URI=mongodb://custom-host:27017/nanumpay ./nanumpay-backup
```

---

## ğŸ“ ë‚¨ì€ ì‘ì—…

ë°±ì—… ì‹œìŠ¤í…œ í•µì‹¬ ê¸°ëŠ¥ì€ ì™„ë£Œë˜ì—ˆìœ¼ë©°, **ì¶”ê°€ ì‘ì—… ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥**í•©ë‹ˆë‹¤.

### ì„ íƒì  ê°œì„  ì‚¬í•­:

1. **Crontab ìë™ ë“±ë¡ API** (ì„ íƒ)
   - UIì—ì„œ ë°±ì—… ì„¤ì • ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ crontab ë“±ë¡/ì œê±°
   - í˜„ì¬ëŠ” ìˆ˜ë™ìœ¼ë¡œ crontab ì„¤ì • í•„ìš”

2. **ì¦‰ì‹œ ë°±ì—… ë²„íŠ¼** (ì„ íƒ)
   - UIì— "ì¦‰ì‹œ ë°±ì—…" ë²„íŠ¼ ì¶”ê°€
   - API: `POST /api/admin/backup/execute`

3. **ë°±ì—… íŒŒì¼ ëª©ë¡/ë‹¤ìš´ë¡œë“œ** (ì„ íƒ)
   - UIì—ì„œ ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ
   - ë‹¤ìš´ë¡œë“œ/ì‚­ì œ ê¸°ëŠ¥

4. **ë¡œê·¸ ë·°ì–´** (ì„ íƒ)
   - `/opt/nanumpay/logs/backup.log` ì¡°íšŒ
   - ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸

---

## ğŸš€ ë°°í¬ ë°©ë²•

### 1. ë¹Œë“œ
```bash
cd /home/tyranno/project/bill/nanumpay
pnpm release:linux
```

ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ì‘ì—…:
- SvelteKit ì›¹ ì•± ë¹Œë“œ
- ë°±ì—… ì•± ë¹Œë“œ (`apps/backup/build/nanumpay-backup`)
- DEB íŒ¨í‚¤ì§€ ìƒì„± (ë°±ì—… ì•± í¬í•¨)

### 2. ë°°í¬
```bash
node apps/web/scripts/deploy.cjs
```

ë°°í¬ í›„ ì„œë²„ íŒŒì¼ ìœ„ì¹˜:
```
/opt/nanumpay/
â”œâ”€â”€ nanumpay              # ì›¹ ì•±
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ nanumpay-backup   # ë°±ì—… ì•±
â”œâ”€â”€ backups/              # ë°±ì—… ì €ì¥ì†Œ
â””â”€â”€ logs/                 # ë¡œê·¸
```

### 3. Crontab ì„¤ì • (ìˆ˜ë™)

**ë§¤ì¼ ìƒˆë²½ 2ì‹œ ë°±ì—…**:
```bash
# nanumpay ì‚¬ìš©ìë¡œ ì „í™˜
sudo -u nanumpay crontab -e

# ì¶”ê°€
0 2 * * * /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

**ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 3ì‹œ ë°±ì—…**:
```bash
0 3 * * 0 /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

**ë§¤ì›” 1ì¼ ìƒˆë²½ 4ì‹œ ë°±ì—…**:
```bash
0 4 1 * * /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
```

### 4. ì¦‰ì‹œ ë°±ì—… (ìˆ˜ë™)
```bash
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup
```

### 5. ë¡œê·¸ í™•ì¸
```bash
tail -f /opt/nanumpay/logs/backup.log
```

---

## ğŸ” ë¬¸ì œ í•´ê²°

### ë°±ì—…ì´ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
```bash
# 1. ë°±ì—… í™œì„±í™” í™•ì¸
mongosh mongodb://localhost:27017/nanumpay --eval "
db.admins.findOne({}, { 'systemSettings.backup.enabled': 1 })
"

# 2. ìˆ˜ë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup

# 3. ê¶Œí•œ í™•ì¸
ls -ld /opt/nanumpay/backups
# drwxr-xr-x nanumpay nanumpay
```

### MongoDB ì—°ê²° ì‹¤íŒ¨
```bash
# MongoDB ìƒíƒœ í™•ì¸
sudo systemctl status mongod

# MongoDB ì¬ì‹œì‘
sudo systemctl restart mongod
```

### FTP/S3 ì—…ë¡œë“œ ì‹¤íŒ¨
```bash
# ë¡œê·¸ í™•ì¸
tail -100 /opt/nanumpay/logs/backup.log | grep -A 5 "FTP\|S3"

# ì„¤ì • í™•ì¸
mongosh mongodb://localhost:27017/nanumpay --eval "
db.admins.findOne({}, { 'systemSettings.backup.storage': 1 })
"
```

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

1. [ë°±ì—…_ì‹œìŠ¤í…œ_êµ¬í˜„_ì™„ë£Œ.md](ë°±ì—…_ì‹œìŠ¤í…œ_êµ¬í˜„_ì™„ë£Œ.md) - ì „ì²´ êµ¬í˜„ ë‚´ìš©
2. [ë°±ì—…_ì‹œìŠ¤í…œ_í…ŒìŠ¤íŠ¸_ê²°ê³¼.md](ë°±ì—…_ì‹œìŠ¤í…œ_í…ŒìŠ¤íŠ¸_ê²°ê³¼.md) - í…ŒìŠ¤íŠ¸ ê²°ê³¼
3. [apps/backup/README.md](../apps/backup/README.md) - ë°±ì—… ì•± ì‚¬ìš©ë²•

---

**ì‘ì„±ì**: Claude AI Assistant
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-26
