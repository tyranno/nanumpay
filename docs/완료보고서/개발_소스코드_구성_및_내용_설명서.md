# 나눔에셋 개발 소스코드 구성 및 내용 설명서

**문서 버전**: v1.1
**작성일**: 2026-01-18
**시스템 버전**: v8.0

**변경 이력**:
- v1.1: 사용자/설계사 화면, 계정 생성 관리 섹션 추가

---

## 목차

1. [프로젝트 구조](#1-프로젝트-구조)
2. [백엔드 서비스](#2-백엔드-서비스)
3. [데이터 모델](#3-데이터-모델)
4. [API 라우트](#4-api-라우트)
5. [프론트엔드 페이지](#5-프론트엔드-페이지)
6. [주요 컴포넌트](#6-주요-컴포넌트)
7. [사용자(용역자) 화면](#7-사용자용역자-화면)
8. [설계사 화면](#8-설계사-화면)
9. [계정 생성 및 관리](#9-계정-생성-및-관리)
10. [유틸리티 및 헬퍼](#10-유틸리티-및-헬퍼)

---

## 1. 프로젝트 구조

### 1.1 전체 디렉토리 구조

```
nanumpay/
├── apps/
│   ├── web/                          # 메인 웹 애플리케이션
│   │   ├── src/
│   │   │   ├── lib/
│   │   │   │   ├── server/           # 서버 사이드 코드
│   │   │   │   │   ├── models/       # MongoDB 모델 (Mongoose)
│   │   │   │   │   ├── services/     # 비즈니스 로직 서비스
│   │   │   │   │   └── db.js         # DB 연결 설정
│   │   │   │   ├── components/       # Svelte 컴포넌트
│   │   │   │   └── stores/           # Svelte 상태 관리
│   │   │   └── routes/               # SvelteKit 라우트
│   │   │       ├── (admin)/admin/    # 관리자 페이지
│   │   │       ├── (planner)/        # 설계사 페이지
│   │   │       ├── (user)/           # 사용자 페이지
│   │   │       └── api/              # REST API 엔드포인트
│   │   ├── scripts/                  # 배포/빌드 스크립트
│   │   └── install/linux/            # 리눅스 설치 스크립트
│   └── backup/                       # 백업 앱
├── docs/                             # 문서
├── test-data/                        # 테스트 데이터
└── db_backup/                        # DB 백업 파일
```

### 1.2 기술 스택

| 영역 | 기술 |
|------|------|
| 프론트엔드 | SvelteKit, TailwindCSS, D3.js |
| 백엔드 | SvelteKit (Node.js), Mongoose |
| 데이터베이스 | MongoDB |
| 인증 | 세션 기반 (Cookie) |
| 배포 | Debian 패키지 (.deb), Nginx |

---

## 2. 백엔드 서비스

### 2.1 registrationService.js
**경로**: `apps/web/src/lib/server/services/registrationService.js`

**역할**: 용역자 등록 및 트리/등급 재계산의 핵심 서비스

#### 주요 함수

```javascript
// 메인 등록 처리 함수
async function registerUsers(registrations, monthKey) {
  // Step 1: User 조회/생성
  // Step 2: 등급 재계산 + 승급 감지
  // Step 3: 지급 대상자 분류
  // Step 4: 지급 계획 생성
  // Step 5: 총계 업데이트
}

// 등급 재계산 (리프 상향식)
async function recalculateAllGrades() {
  // 1. 모든 사용자 조회
  // 2. 트리 맵 구성
  // 3. 리프 노드부터 상향 계산
  // 4. 승급자 감지 및 반환
}

// 서브트리 정보 수집 (DFS)
function collectSubtreeInfo(userId, treeMap) {
  // 재귀적으로 하위 노드 탐색
  // 등급별 카운트 집계
}

// 등급 판정
function determineGrade(subtreeInfo) {
  // F1~F8 조건 순차 확인
  // 조건 충족하는 최고 등급 반환
}
```

#### 등급 판정 로직

```javascript
function determineGrade(subtreeInfo) {
  const { leftChild, rightChild, leftSubtree, rightSubtree } = subtreeInfo;

  // F8: 좌우 서브트리에 각각 F7 이상 1명
  if (hasGradeOrHigher(leftSubtree, 'F7') && hasGradeOrHigher(rightSubtree, 'F7')) {
    return 'F8';
  }
  // F7~F3: 동일 패턴
  // ...

  // F2: 좌우 자식 모두 존재
  if (leftChild && rightChild) return 'F2';

  // F1: 자식 1명 이상
  if (leftChild || rightChild) return 'F1';

  return null; // 등급 없음
}
```

---

### 2.2 paymentPlanService.js
**경로**: `apps/web/src/lib/server/services/paymentPlanService.js`

**역할**: 지급 계획 생성 및 관리

#### 주요 함수

```javascript
// 신규 등록자 기본 지급 계획 생성
async function createInitialPlan(user, monthKey) {
  return await createPaymentPlan({
    userId: user._id,
    planType: 'initial',
    installmentType: 'basic',
    추가지급단계: 0,
    baseGrade: user.grade,
    revenueMonth: monthKey,
    createdBy: 'registration'
  });
}

// 승급자 기본 지급 계획 생성
async function createPromotionPlan(user, monthKey) {
  // 이전 추가지급 계획 중단
  await terminateAdditionalPlans(user._id);

  return await createPaymentPlan({
    userId: user._id,
    planType: 'promotion',
    installmentType: 'basic',
    추가지급단계: 0,
    baseGrade: user.grade,
    revenueMonth: monthKey,
    createdBy: 'promotion'
  });
}

// 추가지급 계획 생성
async function createAdditionalPlan(user, monthKey, 추가지급단계) {
  return await createPaymentPlan({
    userId: user._id,
    planType: 'additional',
    installmentType: 'additional',
    추가지급단계: 추가지급단계,
    baseGrade: user.grade,
    revenueMonth: monthKey,
    createdBy: 'additional_payment'
  });
}

// 지급 계획 공통 생성 함수
async function createPaymentPlan(options) {
  // 1. 매출 정보 조회
  const monthlyReg = await MonthlyRegistrations.findOne({ monthKey: options.revenueMonth });
  const revenue = monthlyReg.getEffectiveRevenue();

  // 2. 등급별 금액 계산
  const gradeAmount = calculateGradeAmount(revenue, monthlyReg.gradeDistribution, options.baseGrade);
  const installmentAmount = roundTo100(gradeAmount / 10);

  // 3. 시작일 계산 (등록/승급일 + 1개월 후 첫 금요일)
  const startDate = getPaymentStartDate(options.baseDate);

  // 4. 10회 일정 생성
  const installments = generateInstallments(startDate, installmentAmount);

  // 5. DB 저장
  return await WeeklyPaymentPlans.create({ ...options, installments });
}
```

#### 금액 계산 로직

```javascript
function calculateGradeAmount(totalRevenue, gradeDistribution, targetGrade) {
  // 누적 분배 방식
  // F1 → F2 → F3 → ... → F8 순서로 누적

  const gradeOrder = ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'];
  const baseRatios = {
    F1: 0.024,  // 2.4%
    F2: 0.057,  // 5.7% (누적 8.1%)
    F3: 0.108,  // 10.8% (누적 18.9%)
    // ...
  };

  let remainingRevenue = totalRevenue;
  let gradeAmounts = {};

  for (const grade of gradeOrder) {
    const count = gradeDistribution[grade] || 0;
    const ratio = baseRatios[grade];
    const amount = remainingRevenue * ratio;
    gradeAmounts[grade] = count > 0 ? amount / count : 0;
    remainingRevenue -= amount * count;
  }

  return gradeAmounts[targetGrade];
}
```

---

### 2.3 weeklyPaymentService.js
**경로**: `apps/web/src/lib/server/services/weeklyPaymentService.js`

**역할**: 매주 금요일 자동 지급 처리

#### 주요 함수

```javascript
// 주간 지급 처리 (매주 금요일 실행)
async function processWeeklyPayments(targetDate = new Date()) {
  // 1. 오늘 지급 대상 조회
  const pendingInstallments = await WeeklyPaymentPlans.find({
    planStatus: 'active',
    'installments.scheduledDate': targetDate,
    'installments.status': 'pending'
  });

  for (const plan of pendingInstallments) {
    // 2. 보험 조건 확인 (F4+)
    const insuranceOk = await checkInsuranceCondition(plan);

    if (!insuranceOk) {
      // 보험 미충족 시 skip
      await markInstallmentSkipped(plan, 'insurance_not_met');
      continue;
    }

    // 3. 지급 처리
    await processInstallment(plan, targetDate);
  }

  // 4. WeeklyPaymentSummary 업데이트
  await updateWeeklyPaymentSummary(targetDate);
}

// 보험 조건 확인
async function checkInsuranceCondition(plan) {
  const user = await User.findById(plan.userId);
  const gradeIndex = GRADE_ORDER.indexOf(plan.baseGrade);

  // F1~F3: 보험 불필요
  if (gradeIndex < 3) return true;

  // 유예기간 확인
  if (plan.graceDeadline && new Date() < plan.graceDeadline) {
    return true;
  }

  // 보험 활성화 및 금액 확인
  const requiredAmount = INSURANCE_REQUIREMENTS[plan.baseGrade];
  return user.insuranceActive && user.insuranceAmount >= requiredAmount;
}

// 과거 지급 일괄 처리 (개발용)
async function processAllPastPayments() {
  const today = new Date();
  const pendingDates = await getPendingPaymentDates();

  for (const date of pendingDates) {
    if (date < today) {
      await processWeeklyPayments(date);
    }
  }
}
```

---

### 2.4 gradeService.js
**경로**: `apps/web/src/lib/server/services/gradeService.js`

**역할**: 등급 관련 유틸리티 및 상수

```javascript
// 등급 순서
export const GRADE_ORDER = ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'];

// 등급별 최대 지급 횟수
export const MAX_INSTALLMENTS = {
  F1: 20, F2: 30, F3: 40, F4: 40,
  F5: 50, F6: 50, F7: 60, F8: 60
};

// 등급별 기본 지급액
export const BASE_AMOUNTS = {
  F1: 24000, F2: 81000, F3: 189000, F4: 324000,
  F5: 540000, F6: 810000, F7: 1215000, F8: 1620000
};

// 등급별 보험 요구 금액
export const INSURANCE_REQUIREMENTS = {
  F4: 50000, F5: 70000, F6: 70000, F7: 100000, F8: 100000
};

// 등급 비교
export function compareGrades(grade1, grade2) {
  return GRADE_ORDER.indexOf(grade1) - GRADE_ORDER.indexOf(grade2);
}

// 상위 등급 여부
export function isHigherGrade(newGrade, oldGrade) {
  return compareGrades(newGrade, oldGrade) > 0;
}
```

---

## 3. 데이터 모델

### 3.1 User.js
**경로**: `apps/web/src/lib/server/models/User.js`

**역할**: 용역자 정보 및 트리 구조 관리

```javascript
const UserSchema = new mongoose.Schema({
  // 계정 연결
  userAccountId: { type: ObjectId, ref: 'UserAccount', required: true },
  plannerAccountId: { type: ObjectId, ref: 'PlannerAccount', required: true },
  registrationNumber: { type: Number, default: 1 },

  // 기본 정보
  name: { type: String, required: true },

  // 트리 구조
  parentId: { type: ObjectId, ref: 'User' },
  position: { type: String, enum: ['L', 'R'] },
  leftChildId: { type: ObjectId, ref: 'User' },
  rightChildId: { type: ObjectId, ref: 'User' },

  // 등급
  grade: { type: String, enum: GRADES },
  gradeHistory: [{
    date: Date,
    fromGrade: String,
    toGrade: String,
    type: { type: String, enum: ['registration', 'promotion'] },
    revenueMonth: String
  }],

  // 보험
  insuranceActive: { type: Boolean, default: false },
  insuranceAmount: { type: Number, default: 0 },
  insuranceDate: Date,

  // 지급률
  ratio: { type: Number, default: 1, min: 0, max: 1 },

  // 상태
  status: { type: String, enum: ['active', 'inactive'], default: 'active' }
}, { timestamps: true });

// 인덱스
UserSchema.index({ userAccountId: 1, registrationNumber: 1 });
UserSchema.index({ plannerAccountId: 1 });
UserSchema.index({ parentId: 1, position: 1 });
```

---

### 3.2 WeeklyPaymentPlans.js
**경로**: `apps/web/src/lib/server/models/WeeklyPaymentPlans.js`

**역할**: 개별 지급 계획 (10회 단위)

```javascript
const WeeklyPaymentPlansSchema = new mongoose.Schema({
  // 사용자 연결
  userId: { type: String, required: true },
  userName: String,

  // 계획 유형
  planType: { type: String, enum: ['initial', 'promotion', 'additional'] },
  installmentType: { type: String, enum: ['basic', 'additional'] },
  추가지급단계: { type: Number, default: 0 },
  generation: { type: Number, default: 1 },

  // 등급 및 매출월
  baseGrade: { type: String, enum: GRADES },
  revenueMonth: { type: String, required: true },

  // 일정
  additionalPaymentBaseDate: Date,
  startDate: Date,

  // 진행 상태
  totalInstallments: { type: Number, default: 10 },
  completedInstallments: { type: Number, default: 0 },
  planStatus: { type: String, enum: ['active', 'completed', 'terminated'] },

  // 중단 정보
  terminatedAt: Date,
  terminatedBy: { type: String, enum: ['promotion_additional_stop', 'max_reached', 'manual'] },

  // 연결
  parentPlanId: { type: ObjectId, ref: 'WeeklyPaymentPlans' },
  createdBy: { type: String, enum: ['registration', 'promotion', 'monthly_check', 'additional_payment', 'auto_generation'] },

  // 보험
  graceDeadline: Date,
  insuranceRequired: Number,
  insuranceInherited: Boolean,

  // 할부 내역
  installments: [{
    week: Number,
    weekNumber: String,
    scheduledDate: Date,
    revenueMonth: String,
    gradeAtPayment: String,
    baseAmount: Number,
    installmentAmount: Number,
    withholdingTax: Number,
    netAmount: Number,
    status: { type: String, enum: ['pending', 'skipped', 'terminated'] },
    paidAt: Date,
    skipReason: String,
    insuranceSkipped: Boolean
  }]
}, { timestamps: true });

// 정적 메서드
WeeklyPaymentPlansSchema.statics.getISOWeek = function(date) { /* ... */ };
WeeklyPaymentPlansSchema.statics.getNextFriday = function(date) { /* ... */ };
WeeklyPaymentPlansSchema.statics.getPaymentStartDate = function(baseDate) { /* ... */ };
```

---

### 3.3 MonthlyRegistrations.js
**경로**: `apps/web/src/lib/server/models/MonthlyRegistrations.js`

**역할**: 월별 등록 및 매출 관리

```javascript
const MonthlyRegistrationsSchema = new mongoose.Schema({
  // 월 키 (유니크)
  monthKey: { type: String, required: true, unique: true },

  // 등록자 수 및 매출
  registrationCount: { type: Number, default: 0 },
  promotedCount: { type: Number, default: 0 },
  nonPromotedCount: { type: Number, default: 0 },
  totalRevenue: { type: Number, default: 0 },
  adjustedRevenue: Number,
  isManualRevenue: { type: Boolean, default: false },

  // 등록자 목록
  registrations: [{
    userId: String,
    userName: String,
    grade: String,
    registrationDate: Date
  }],

  // 지급 대상자 (3유형)
  paymentTargets: {
    registrants: [{ userId: String, userName: String, grade: String }],
    promoted: [{ userId: String, userName: String, oldGrade: String, newGrade: String, promotionDate: Date }],
    additionalPayments: [{ userId: String, userName: String, grade: String, 추가지급단계: Number }]
  },

  // 등급 분포 (지급 대상자 전체 기준)
  gradeDistribution: {
    F1: Number, F2: Number, F3: Number, F4: Number,
    F5: Number, F6: Number, F7: Number, F8: Number
  },

  // 등급별 지급액
  gradePayments: { /* F1~F8 */ },
  adjustedGradePayments: { /* 수동 조정 */ },

  // 월별 총계
  monthlyTotals: {
    F1: { userCount: Number, totalAmount: Number },
    // ...
  }
}, { timestamps: true });

// 인스턴스 메서드
MonthlyRegistrationsSchema.methods.getEffectiveRevenue = function() {
  return this.adjustedRevenue ?? this.totalRevenue;
};

// 정적 메서드
MonthlyRegistrationsSchema.statics.generateMonthKey = function(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
};
```

---

### 3.4 UserAccount.js
**경로**: `apps/web/src/lib/server/models/UserAccount.js`

**역할**: 사용자 로그인 계정 (개인정보 분리)

```javascript
const UserAccountSchema = new mongoose.Schema({
  // 로그인 정보
  loginId: { type: String, required: true, unique: true, lowercase: true },
  passwordHash: { type: String, required: true },

  // 개인정보
  name: { type: String, required: true },
  phone: String,
  idNumber: String,

  // 계좌정보
  bank: String,
  accountNumber: String,
  email: String,

  // 추가 보험
  insuranceAmount: { type: Number, default: 0 },

  // 권한
  canViewSubordinates: { type: Boolean, default: false },

  // 로그인 제한 (v8.0)
  loginRestriction: {
    isRestricted: { type: Boolean, default: false },
    restrictedAt: Date,
    restrictedBy: String,
    reason: String,
    history: [{
      action: { type: String, enum: ['restrict', 'unrestrict'] },
      date: Date,
      by: String,
      reason: String
    }]
  },

  // 상태
  status: { type: String, enum: ['active', 'inactive'], default: 'active' }
}, { timestamps: true });
```

---

### 3.5 PlannerAccount.js
**경로**: `apps/web/src/lib/server/models/PlannerAccount.js`

**역할**: 설계사 계정

```javascript
const PlannerAccountSchema = new mongoose.Schema({
  // 로그인 정보
  loginId: { type: String, required: true, unique: true },
  passwordHash: { type: String, required: true },

  // 기본 정보
  name: { type: String, required: true },
  phone: String,
  email: String,
  address: String,
  workplace: String,

  // 계좌정보 (v8.0)
  bank: String,
  accountNumber: String,

  // 상태
  status: { type: String, enum: ['active', 'inactive'], default: 'active' }
}, { timestamps: true });
```

---

## 4. API 라우트

### 4.1 사용자 등록 API
**경로**: `apps/web/src/routes/api/admin/users/bulk/+server.js`

```javascript
// POST: 대량 등록
export async function POST({ request }) {
  const { registrations, monthKey } = await request.json();

  // registrationService 호출
  const result = await registerUsers(registrations, monthKey);

  return json({
    success: true,
    registered: result.registered,
    promoted: result.promoted,
    additionalPayments: result.additionalPayments
  });
}
```

### 4.2 지급 처리 API
**경로**: `apps/web/src/routes/api/admin/payment/`

```javascript
// weekly/+server.js - 주간 지급 조회
export async function GET({ url }) {
  const weekNumber = url.searchParams.get('weekNumber');
  const summary = await WeeklyPaymentSummary.findOne({ weekNumber });
  return json(summary);
}

// process-past/+server.js - 과거 지급 일괄 처리
export async function POST() {
  const result = await processAllPastPayments();
  return json({ success: true, processed: result.processed });
}
```

### 4.3 매출 조정 API
**경로**: `apps/web/src/routes/api/admin/revenue/`

```javascript
// adjust/+server.js - 매출 수동 조정
export async function POST({ request }) {
  const { monthKey, adjustedRevenue } = await request.json();

  await MonthlyRegistrations.findOneAndUpdate(
    { monthKey },
    { adjustedRevenue, isManualRevenue: true }
  );

  // 해당 월 모든 지급 계획 금액 재계산
  await recalculatePaymentAmounts(monthKey);

  return json({ success: true });
}
```

---

## 5. 프론트엔드 페이지

### 5.1 관리자 대시보드
**경로**: `apps/web/src/routes/(admin)/admin/+page.svelte`

```svelte
<script>
  import MonthlyRevenueCard from '$lib/components/admin/MonthlyRevenueCard.svelte';
  import PaymentStatisticsCard from '$lib/components/admin/PaymentStatisticsCard.svelte';
</script>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- 월별 매출 카드 -->
  <MonthlyRevenueCard />

  <!-- 지급 통계 카드 -->
  <PaymentStatisticsCard />
</div>
```

### 5.2 용역비 지급명부
**경로**: `apps/web/src/routes/(admin)/admin/payment/+page.svelte`

```svelte
<script>
  import PaymentHeader from '$lib/components/shared/payment/PaymentHeader.svelte';
  import PaymentTable from '$lib/components/shared/payment/PaymentTable.svelte';

  let filterState = $paymentPageFilterState;
  let paymentData = [];

  async function loadPaymentData() {
    const response = await fetch(`/api/admin/payment?${buildQueryParams(filterState)}`);
    paymentData = await response.json();
  }
</script>

<PaymentHeader bind:filterState on:search={loadPaymentData} />
<PaymentTable data={paymentData} {filterState} />
```

### 5.3 용역자 관리
**경로**: `apps/web/src/routes/(admin)/admin/members/+page.svelte`

```svelte
<script>
  import MemberTable from '$lib/components/admin/members/MemberTable.svelte';
  import MemberEditModal from '$lib/components/admin/members/MemberEditModal.svelte';
  import ExcelUploadModal from '$lib/components/admin/members/ExcelUploadModal.svelte';
  import InsuranceModal from '$lib/components/admin/members/InsuranceModal.svelte';

  let showEditModal = false;
  let showUploadModal = false;
  let showInsuranceModal = false;
  let selectedMember = null;
</script>

<MemberTable
  on:edit={(e) => { selectedMember = e.detail; showEditModal = true; }}
  on:insurance={(e) => { selectedMember = e.detail; showInsuranceModal = true; }}
/>

{#if showEditModal}
  <MemberEditModal member={selectedMember} on:close={() => showEditModal = false} />
{/if}

{#if showUploadModal}
  <ExcelUploadModal on:close={() => showUploadModal = false} />
{/if}

{#if showInsuranceModal}
  <InsuranceModal member={selectedMember} on:close={() => showInsuranceModal = false} />
{/if}
```

### 5.4 계약자 산하정보 (트리 시각화)
**경로**: `apps/web/src/routes/(admin)/admin/organization/+page.svelte`

```svelte
<script>
  import BinaryTreeD3 from '$lib/components/BinaryTreeD3.svelte';

  let treeData = null;
  let searchQuery = '';
  let maxDepth = 6;
  let breadcrumbs = [];

  async function loadTreeData(rootUserId = null) {
    const url = rootUserId
      ? `/api/admin/organization/tree?root=${rootUserId}&depth=${maxDepth}`
      : `/api/admin/organization/tree?depth=${maxDepth}`;
    const response = await fetch(url);
    treeData = await response.json();
  }

  function handleNodeClick(node) {
    breadcrumbs = [...breadcrumbs, node];
    loadTreeData(node.userId);
  }
</script>

<!-- 검색 및 깊이 선택 -->
<div class="flex gap-4 mb-4">
  <input bind:value={searchQuery} placeholder="이름 검색" />
  <select bind:value={maxDepth} on:change={() => loadTreeData()}>
    {#each [4, 5, 6, 7, 8, 'all'] as depth}
      <option value={depth}>{depth === 'all' ? '전체' : `${depth}단계`}</option>
    {/each}
  </select>
</div>

<!-- 트리 시각화 -->
<BinaryTreeD3 data={treeData} on:nodeClick={handleNodeClick} />

<!-- Breadcrumb 네비게이션 -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-2">
  {#each breadcrumbs as crumb, i}
    <button on:click={() => { breadcrumbs = breadcrumbs.slice(0, i + 1); loadTreeData(crumb.userId); }}>
      {crumb.name}
    </button>
    {#if i < breadcrumbs.length - 1} > {/if}
  {/each}
</nav>
```

---

## 6. 주요 컴포넌트

### 6.1 MonthlyRevenueCard.svelte
**경로**: `apps/web/src/lib/components/admin/MonthlyRevenueCard.svelte`

**기능**:
- 월별/기간별 조회 선택
- 등급별 지급 대상자 테이블
- 등급별 지급액 표시
- 매출 조정 버튼 (관리자)

### 6.2 PaymentStatisticsCard.svelte
**경로**: `apps/web/src/lib/components/admin/PaymentStatisticsCard.svelte`

**기능**:
- 월간/주간 보기 선택
- 등급별 지급액 통계
- 고정 좌측 컬럼 (스크롤 대응)
- 합계 행

### 6.3 BinaryTreeD3.svelte
**경로**: `apps/web/src/lib/components/BinaryTreeD3.svelte`

**기능**:
- D3.js 기반 트리 렌더링
- 등급별 노드 색상
- 노드 클릭 이벤트
- 확대/축소
- PNG 다운로드

### 6.4 GradeBadge.svelte
**경로**: `apps/web/src/lib/components/GradeBadge.svelte`

```svelte
<script>
  export let grade;

  const colors = {
    F1: 'bg-gray-100 text-gray-800',
    F2: 'bg-blue-100 text-blue-800',
    F3: 'bg-green-100 text-green-800',
    F4: 'bg-yellow-100 text-yellow-800',
    F5: 'bg-orange-100 text-orange-800',
    F6: 'bg-red-100 text-red-800',
    F7: 'bg-purple-100 text-purple-800',
    F8: 'bg-pink-100 text-pink-800'
  };
</script>

<span class="px-2 py-1 rounded-full text-xs font-medium {colors[grade]}">
  {grade}
</span>
```

---

## 7. 사용자(용역자) 화면

### 7.1 대시보드 페이지
**경로**: `apps/web/src/routes/(user)/dashboard/+page.svelte`

**역할**: 용역자 메인 대시보드

```svelte
<script>
  import GradeBadge from '$lib/components/GradeBadge.svelte';
  import UserProfileModal from '$lib/components/user/UserProfileModal.svelte';

  // 보험 미유지 알림
  let showInsuranceAlert = $state(false);
  let accountsNeedingInsurance = $state([]);

  // 보험 유지 만료 날짜 계산 (승급 후 2달 첫 금요일)
  function getInsuranceDeadline(account) {
    // 현재 등급으로 승급한 날짜 찾기
    // 2개월 후 첫 금요일 계산
  }
</script>

<!-- 등록 계약 목록 -->
<!-- 이번주 지급액 요약 -->
<!-- 누적 수령액 -->
<!-- 지원비 수령 내역 테이블 -->
```

**주요 기능**:
- 등록 계약 목록 (카드/리스트 뷰)
- 이번주 지급액 (총액, 실수령)
- 누적 수령액
- 지원비 수령 내역 테이블
- 보험 미유지 알림
- 산하정보 링크

---

### 7.2 프로필 페이지
**경로**: `apps/web/src/routes/(user)/dashboard/profile/+page.svelte`

**역할**: 용역자 개인정보 조회/수정

**표시 정보**:
| 구분 | 필드 | 편집 가능 |
|------|------|----------|
| 개인정보 | 이름, 전화번호 | ✅ |
| 계좌정보 | 은행, 계좌번호 | ✅ |
| 보험정보 | 가입상태, 보험사, 상품 | ❌ (관리자 관리) |
| 소속정보 | 소속/지사, 판매인, 설계사 | ❌ |

---

### 7.3 산하정보 페이지
**경로**: `apps/web/src/routes/(user)/dashboard/network/+page.svelte`

**역할**: 자신의 하위 트리 시각화

```svelte
<script>
  import BinaryTreeD3 from '$lib/components/BinaryTreeD3.svelte';

  let treeData = null;
  let maxDepth = 6;

  async function loadTreeData() {
    const response = await fetch(`/api/user/tree?depth=${maxDepth}`);
    treeData = await response.json();
  }
</script>

<BinaryTreeD3 data={treeData} />
```

---

### 7.4 수입 내역 페이지
**경로**: `apps/web/src/routes/(user)/dashboard/income/+page.svelte`

**역할**: 상세 지급 내역 조회

**기능**:
- 기간별 필터링
- 지급 상세 내역 테이블
- 엑셀 다운로드

---

### 7.5 사용자 관련 API

| API 경로 | 메서드 | 역할 |
|----------|--------|------|
| `/api/user/dashboard` | GET | 대시보드 데이터 조회 |
| `/api/user/profile` | GET/PUT | 프로필 조회/수정 |
| `/api/user/tree` | GET | 산하 트리 조회 |
| `/api/user/payments` | GET | 지급 내역 조회 |
| `/api/user/verify-password` | POST | 비밀번호 확인 |

---

### 7.6 사용자 관련 컴포넌트

#### UserProfileModal.svelte
**경로**: `apps/web/src/lib/components/user/UserProfileModal.svelte`

**역할**: 프로필 수정 모달

```svelte
<script>
  export let isOpen = false;
  export let userInfo = null;

  let editData = { ...userInfo };

  async function handleSave() {
    const response = await fetch('/api/user/profile', {
      method: 'PUT',
      body: JSON.stringify(editData)
    });
    // ...
  }
</script>
```

---

## 8. 설계사 화면

### 8.1 설계사 대시보드
**경로**: `apps/web/src/routes/(planner)/planner/+page.svelte`

**역할**: 설계사 메인 대시보드

```svelte
<script>
  import PlannerSettingsModal from '$lib/components/planner/PlannerSettingsModal.svelte';
  import PlannerInfoCard from '$lib/components/planner/PlannerInfoCard.svelte';
  import PaymentSummaryCard from '$lib/components/planner/PaymentSummaryCard.svelte';
  import CommissionSummaryCard from '$lib/components/planner/CommissionSummaryCard.svelte';
  import PaymentListCard from '$lib/components/planner/PaymentListCard.svelte';

  let isSettingsModalOpen = false;
  let plannerInfo = null;

  async function loadPlannerInfo() {
    const response = await fetch('/api/planner/info');
    plannerInfo = await response.json();
  }
</script>

<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
  <!-- 카드 1: 설계사 정보 -->
  <PlannerInfoCard onOpenSettings={openSettingsModal} />

  <!-- 카드 2: 지원비 총액 -->
  <PaymentSummaryCard />
</div>

<!-- 카드 3: 설계사 수당 내역 -->
<CommissionSummaryCard />

<!-- 카드 4: 지원비 지급명부 -->
<PaymentListCard />
```

---

### 8.2 설계사 관련 컴포넌트

#### PlannerInfoCard.svelte
**경로**: `apps/web/src/lib/components/planner/PlannerInfoCard.svelte`

**역할**: 설계사 기본 정보 카드

```svelte
<script>
  export let onOpenSettings = () => {};

  let plannerInfo = null;
  let contractStats = null;

  async function loadData() {
    const [infoRes, statsRes] = await Promise.all([
      fetch('/api/planner/info'),
      fetch('/api/planner/contract-stats')
    ]);
    // ...
  }
</script>

<!-- 이름, 전화번호, 총 계약 건수 표시 -->
```

**표시 정보**:
- 설계사 이름 (클릭 시 설정 모달)
- 전화번호
- 총 계약 건수

---

#### PaymentSummaryCard.svelte
**경로**: `apps/web/src/lib/components/planner/PaymentSummaryCard.svelte`

**역할**: 지원비 총액 요약

```svelte
<script>
  let paymentSummary = null;

  async function loadData() {
    const response = await fetch('/api/planner/payment-summary');
    paymentSummary = await response.json();
  }
</script>

<!-- 이번주 지급액, 누적 지급액 표시 -->
```

**표시 정보**:
- 이번주 지급액 (총액/실수령)
- 누적 지급액 (총액/실수령)

---

#### CommissionSummaryCard.svelte
**경로**: `apps/web/src/lib/components/planner/CommissionSummaryCard.svelte`

**역할**: 설계사 수당 내역 (주별 집계)

```svelte
<script>
  let commissionSummary = [];

  // 기본 기간: 오늘 ~ 3주 후
  let commissionStartDate = formatDateYMD(today);
  let commissionEndDate = formatDateYMD(threeWeeksLater);

  async function loadCommissionData() {
    const params = new URLSearchParams({
      startYear, startMonth, endYear, endMonth,
      groupBy: 'week'
    });
    const response = await fetch(`/api/planner/commission-summary?${params}`);
    // ...
  }
</script>

<!-- 주별 수당액, 등록인원, 매출액 테이블 -->
```

**표시 정보**:
- 지급일 (주별)
- 수당액
- 등록인원
- 매출액
- 선택 기간 총액

---

#### PaymentListCard.svelte
**경로**: `apps/web/src/lib/components/planner/PaymentListCard.svelte`

**역할**: 지원비 지급명부

```svelte
<script>
  import PaymentHeader from '$lib/components/shared/payment/PaymentHeader.svelte';
  import PlannerPaymentTable from '$lib/components/planner/PlannerPaymentTable.svelte';

  let paymentList = [];
  let weeklyColumns = [];
  let subtotalDisplayMode = 'withSubtotals';

  async function loadPaymentData() {
    const result = await plannerPaymentService.loadPaymentData({
      filterType, selectedDate, periodType: 'weekly'
    });
    paymentList = result.paymentList;
    weeklyColumns = result.weeklyColumns;
  }
</script>

<PaymentHeader
  {grandTotal} {totalPaymentTargets}
  isPlannerMode={true}
  showSubtotalOptions={true}
  {subtotalDisplayMode}
/>

<PlannerPaymentTable
  {paymentList} {weeklyColumns} {subtotalDisplayMode}
/>
```

**기능**:
- 담당 용역자 지급 명부
- 주별 필터링
- 소계 포함/미포함 선택
- 엑셀 다운로드

---

#### PlannerPaymentTable.svelte
**경로**: `apps/web/src/lib/components/planner/PlannerPaymentTable.svelte`

**역할**: 설계사 전용 지급 테이블 (그룹핑 + 소계)

**테이블 구조**:
| 컬럼 | 설명 |
|------|------|
| 이름 | 용역자 이름 |
| 전화번호 | 연락처 |
| 등급 | 현재 등급 |
| 주차별 금액 | 주별 지급액 |
| 총액 | 기간 내 총액 |

---

#### PlannerSettingsModal.svelte
**경로**: `apps/web/src/lib/components/planner/PlannerSettingsModal.svelte`

**역할**: 설계사 설정 모달 (정보 수정, 비밀번호 변경)

**탭 구성**:
- 기본 정보: 이름, 전화번호, 이메일, 주소
- 계좌 정보: 은행, 계좌번호
- 비밀번호 변경: 현재 비밀번호, 새 비밀번호

---

### 8.3 설계사 관련 API

| API 경로 | 메서드 | 역할 |
|----------|--------|------|
| `/api/planner/info` | GET | 설계사 기본 정보 |
| `/api/planner/update-info` | POST | 설계사 정보 수정 |
| `/api/planner/update-phone` | POST | 전화번호 수정 |
| `/api/planner/contract-stats` | GET | 계약 통계 |
| `/api/planner/payment-summary` | GET | 지원비 요약 |
| `/api/planner/payment-history` | GET | 지급 내역 |
| `/api/planner/commission-summary` | GET | 수당 내역 (주별) |
| `/api/planner/payment/weekly` | GET | 주간 지급 명부 |

---

## 9. 계정 생성 및 관리

### 9.1 사용자 계정 생성 흐름

#### 엑셀 대량 등록
**경로**: `apps/web/src/routes/api/admin/users/bulk/+server.js`

```
[엑셀 파일 업로드]
    ↓
[ExcelUploadModal.svelte]
    ↓
[POST /api/admin/users/bulk]
    ↓
[userRegistrationService.registerUsers()]
    ↓
[1] UserAccount 조회/생성
    ├─ loginId = phone (전화번호)
    ├─ passwordHash = bcrypt(phone 뒤 4자리)
    └─ 개인정보 저장
    ↓
[2] PlannerAccount 조회/생성
    ├─ 설계사 전화번호로 조회
    └─ 없으면 신규 생성
    ↓
[3] User(용역자) 생성
    ├─ userAccountId, plannerAccountId 연결
    ├─ 트리 구조 설정 (parentId, position)
    └─ 등급 계산
    ↓
[4] 등급 재계산
    ├─ 리프 상향식 계산
    └─ 승급자 감지
    ↓
[5] 지급 계획 생성
```

---

#### 개별 등록
**경로**: `apps/web/src/routes/api/admin/users/register/+server.js`

```javascript
export async function POST({ request }) {
  const { ID, name, phone, autoPassword, salesperson, registrationDate } = await request.json();

  // 필수 필드 확인
  if (!ID || !name || !phone) {
    return json({ error: 'ID, 이름, 연락처는 필수입니다.' });
  }

  // 암호 설정 (전화번호 뒤 4자리)
  const password = autoPassword || phone.slice(-4);

  // 단일 사용자를 배열로 변환 (bulk 로직 재사용)
  const userData = { 'ID': ID, '성명': name, '연락처': phone, ... };
  const result = await registerUsers([userData], monthKey);

  return json({ success: true, ...result });
}
```

---

### 9.2 계정 생성 관련 컴포넌트

#### ExcelUploadModal.svelte
**경로**: `apps/web/src/lib/components/admin/members/ExcelUploadModal.svelte`

**역할**: 엑셀 파일 업로드 및 대량 등록

**엑셀 필드 매핑**:
| 엑셀 컬럼 | 시스템 필드 | 필수 |
|----------|------------|------|
| ID | loginId | ✅ |
| 성명 | name | ✅ |
| 연락처 | phone | ✅ |
| 판매인 | salesperson (부모) | ✅ |
| 설계사 | planner | ✅ |
| 주민번호 | idNumber | ❌ |
| 은행 | bank | ❌ |
| 계좌번호 | accountNumber | ❌ |
| 등록일자 | registrationDate | ❌ |

---

#### MemberRegistrationModal.svelte
**경로**: `apps/web/src/lib/components/admin/members/MemberRegistrationModal.svelte`

**역할**: 개별 용역자 등록 모달

**입력 필드**:
- ID (로그인 ID, 중복 확인)
- 성명 (중복 경고)
- 연락처 (자동 포맷팅)
- 주민번호 (마스킹 처리)
- 은행 / 계좌번호
- 판매인 (자동완성 검색)
- 설계사 (자동완성 검색)
- 등록일자

**중복 확인**:
```javascript
async function checkNameDuplicate() {
  const response = await fetch(`/api/admin/users/check-duplicates?name=${name}`);
  // 동일 이름 있으면 경고 표시
}
```

---

### 9.3 설계사 계정 생성

#### 자동 생성 (엑셀 등록 시)
```javascript
// userRegistrationService.js 내부
async function getOrCreatePlanner(plannerName, plannerPhone) {
  // 기존 설계사 조회
  let planner = await PlannerAccount.findOne({ phone: plannerPhone });

  if (!planner) {
    // 신규 설계사 생성
    planner = await PlannerAccount.create({
      loginId: plannerPhone,  // 전화번호 = 로그인 ID
      passwordHash: await hashPassword(plannerPhone.slice(-4)),
      name: plannerName,
      phone: plannerPhone,
      status: 'active'
    });
  }

  return planner;
}
```

**초기 로그인 정보**:
- 아이디: 전화번호
- 비밀번호: 전화번호 뒤 4자리

---

### 9.4 계정 관리 API

| API 경로 | 메서드 | 역할 |
|----------|--------|------|
| `/api/admin/users/bulk` | POST | 엑셀 대량 등록 |
| `/api/admin/users/register` | POST | 개별 등록 |
| `/api/admin/users/check-duplicates` | GET | 중복 확인 |
| `/api/admin/users/[id]` | GET/PUT/DELETE | 개별 조회/수정/삭제 |
| `/api/admin/users/insurance` | POST | 보험 가입/해지 |
| `/api/admin/settings/user-password-reset` | POST | 비밀번호 초기화 |
| `/api/admin/settings/user-search` | GET | 사용자 검색 |

---

### 9.5 로그인 및 세션 관리

#### 로그인 API
**경로**: `apps/web/src/routes/api/auth/login/+server.js`

```javascript
export async function POST({ request, cookies }) {
  const { loginId, password, userType } = await request.json();

  // 사용자 유형별 조회
  let account;
  if (userType === 'admin') {
    account = await AdminAccount.findOne({ loginId });
  } else if (userType === 'planner') {
    account = await PlannerAccount.findOne({ loginId });
  } else {
    account = await UserAccount.findOne({ loginId });
  }

  // 비밀번호 검증
  const isValid = await verifyPassword(password, account.passwordHash);

  // 로그인 제한 확인
  if (account.loginRestriction?.isRestricted) {
    return json({ error: '로그인이 제한되었습니다.' });
  }

  // 세션 쿠키 설정
  const session = { userId: account._id, userType, name: account.name };
  cookies.set('session', encodeSession(session), { ... });

  return json({ success: true, requirePasswordChange: isDefaultPassword });
}
```

---

### 9.6 로그인 페이지
**경로**: `apps/web/src/routes/login/+page.svelte`

```svelte
<script>
  let loginId = '';
  let password = '';
  let userType = 'user'; // 'user', 'planner', 'admin'

  async function handleLogin() {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ loginId, password, userType })
    });

    if (result.success) {
      // 사용자 유형별 리다이렉트
      if (userType === 'admin') goto('/admin');
      else if (userType === 'planner') goto('/planner');
      else goto('/dashboard');
    }
  }
</script>

<!-- 로그인 폼 -->
<form on:submit|preventDefault={handleLogin}>
  <select bind:value={userType}>
    <option value="user">용역자</option>
    <option value="planner">설계사</option>
    <option value="admin">관리자</option>
  </select>
  <input bind:value={loginId} placeholder="아이디" />
  <input type="password" bind:value={password} placeholder="비밀번호" />
  <button type="submit">로그인</button>
</form>
```

---

### 9.7 로그인 제한 관리 (v8.0)

**기능**: 관리자가 특정 사용자의 로그인을 제한/해제

**UserAccount 스키마**:
```javascript
loginRestriction: {
  isRestricted: { type: Boolean, default: false },
  restrictedAt: Date,
  restrictedBy: String,
  reason: String,
  history: [{
    action: { type: String, enum: ['restrict', 'unrestrict'] },
    date: Date,
    by: String,
    reason: String
  }]
}
```

**관리 UI**: `apps/web/src/routes/(admin)/admin/settings/+page.svelte`

---

## 10. 유틸리티 및 헬퍼

### 7.1 날짜 유틸리티
**경로**: `apps/web/src/lib/utils/date.js`

```javascript
// ISO 주차 계산
export function getISOWeek(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  const yearStart = new Date(d.getFullYear(), 0, 1);
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
}

// 다음 금요일 계산
export function getNextFriday(date) {
  const d = new Date(date);
  const day = d.getDay();
  const daysUntilFriday = (5 - day + 7) % 7 || 7;
  d.setDate(d.getDate() + daysUntilFriday);
  return d;
}

// 월키 생성
export function generateMonthKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}
```

### 7.2 금액 유틸리티
**경로**: `apps/web/src/lib/utils/currency.js`

```javascript
// 100원 단위 반올림
export function roundTo100(amount) {
  return Math.round(amount / 100) * 100;
}

// 원천징수 계산 (3.3%)
export function calculateWithholdingTax(amount) {
  return Math.round(amount * 0.033);
}

// 실수령액 계산
export function calculateNetAmount(amount) {
  return amount - calculateWithholdingTax(amount);
}

// 금액 포맷팅
export function formatCurrency(amount) {
  return new Intl.NumberFormat('ko-KR').format(amount) + '원';
}
```

### 7.3 인증 유틸리티
**경로**: `apps/web/src/lib/server/auth.js`

```javascript
import bcrypt from 'bcryptjs';

// 비밀번호 해시
export async function hashPassword(password) {
  return bcrypt.hash(password, 10);
}

// 비밀번호 검증
export async function verifyPassword(password, hash) {
  return bcrypt.compare(password, hash);
}

// 세션 검증
export function validateSession(cookies) {
  const session = cookies.get('session');
  if (!session) return null;

  try {
    return JSON.parse(Buffer.from(session, 'base64').toString());
  } catch {
    return null;
  }
}
```

---

## 파일 경로 요약

### 백엔드 서비스
| 파일 | 역할 |
|------|------|
| `services/registrationService.js` | 등록 처리, 등급 계산 |
| `services/userRegistrationService.js` | 사용자 등록 (v8.0) |
| `services/paymentPlanService.js` | 지급 계획 생성 |
| `services/weeklyPaymentService.js` | 주간 지급 처리 |
| `services/gradeService.js` | 등급 상수 및 유틸 |

### 데이터 모델
| 파일 | 역할 |
|------|------|
| `models/User.js` | 용역자 정보, 트리 구조 |
| `models/WeeklyPaymentPlans.js` | 지급 계획 |
| `models/MonthlyRegistrations.js` | 월별 등록 |
| `models/UserAccount.js` | 사용자 로그인 계정 |
| `models/PlannerAccount.js` | 설계사 계정 |
| `models/AdminAccount.js` | 관리자 계정 |

### 관리자 페이지
| 경로 | 역할 |
|------|------|
| `/admin` | 대시보드 |
| `/admin/payment` | 용역비 지급명부 |
| `/admin/members` | 용역자 관리 |
| `/admin/organization` | 계약자 산하정보 |
| `/admin/settings` | 설정 |
| `/admin/tax` | 세금 관리 |
| `/admin/planner-commission` | 설계사 수당 관리 |

### 사용자(용역자) 페이지
| 경로 | 역할 |
|------|------|
| `/dashboard` | 대시보드 |
| `/dashboard/profile` | 프로필 |
| `/dashboard/network` | 산하정보 |
| `/dashboard/income` | 수입 내역 |

### 설계사 페이지
| 경로 | 역할 |
|------|------|
| `/planner` | 대시보드 |

### 사용자/설계사 관련 컴포넌트
| 파일 | 역할 |
|------|------|
| `components/user/UserProfileModal.svelte` | 사용자 프로필 모달 |
| `components/planner/PlannerInfoCard.svelte` | 설계사 정보 카드 |
| `components/planner/PaymentSummaryCard.svelte` | 지원비 요약 |
| `components/planner/CommissionSummaryCard.svelte` | 수당 내역 |
| `components/planner/PaymentListCard.svelte` | 지급명부 카드 |
| `components/planner/PlannerPaymentTable.svelte` | 지급 테이블 |
| `components/planner/PlannerSettingsModal.svelte` | 설정 모달 |

### 계정 관리 컴포넌트
| 파일 | 역할 |
|------|------|
| `components/admin/members/ExcelUploadModal.svelte` | 엑셀 업로드 |
| `components/admin/members/MemberRegistrationModal.svelte` | 개별 등록 |
| `components/admin/members/MemberEditModal.svelte` | 수정 모달 |
| `components/admin/members/InsuranceModal.svelte` | 보험 관리 |
| `components/admin/members/MemberTable.svelte` | 용역자 테이블 |

### 주요 API
| 경로 | 역할 |
|------|------|
| `/api/auth/login` | 로그인 |
| `/api/auth/logout` | 로그아웃 |
| `/api/admin/users/bulk` | 대량 등록 |
| `/api/admin/users/register` | 개별 등록 |
| `/api/user/*` | 사용자 API |
| `/api/planner/*` | 설계사 API |
| `/api/admin/payment/*` | 지급 관리 |
| `/api/admin/revenue/*` | 매출 관리 |

---

**작성자**: Claude AI
**검토자**: _________________
**승인일**: _________________
