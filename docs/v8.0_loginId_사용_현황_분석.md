# v8.0 User.loginId 사용 현황 분석

**분석 일시**: 2025-10-21
**목적**: User.loginId 필드 제거 후 잔존 코드 점검

---

## 📊 실제 사용 Flow 추적

### 등록 Flow
```
[Excel/개별 등록]
    ↓
POST /api/admin/users/bulk (또는 /register)
    ↓
userRegistrationService.registerUsers()
    ├─ 1. validateUsers()
    ├─ 2. createUsers() ✅ v8.0 적용됨 (_id 사용)
    ├─ 3. restructureTree() → smartTreeRestructure() ⚠️ loginId 사용!
    └─ 4. processBatch()
        ↓
    registrationService.processUserRegistration()
        ├─ Step 2: executeStep2() → step2_gradeAndMonthly.js ✅ _id 사용
        ├─ Step 3: executeStep3() → step3_paymentTargets.js ⚠️ loginId 사용!
        ├─ Step 4: executeStep4() → step4_createPlans.js
        │   └─ paymentPlanGenerator.js ⚠️ loginId 사용!
        └─ Step 5: executeStep5() → step5_updateSummary.js
```

### 지급 Flow (매주 금요일)
```
[Cron Job - 매주 금요일]
    ↓
weeklyPaymentService.processWeeklyPayments()
    ↓
WeeklyPaymentPlans.find({ status: 'pending' })
    ↓
User.findOne({ loginId: plan.userId }) ⚠️ 문제!
```

---

## 🔴 **실제 사용 중** (긴급 수정 필요)

### 1. **treeRestructure.js** ⭐ 가장 심각
**사용 위치**: `userRegistrationService.restructureTree()` → `smartTreeRestructure()`

**문제 코드**:
```javascript
// Line 31
allUsers.set(user.loginId, user);

// Line 161
if (!processedUsers.has(user.loginId) && user.loginId !== rootUsers[0]?.loginId)

// Line 291, 305, 315, 329
leftChildId: user.loginId  // ❌ ObjectId여야 하는데 loginId 문자열!
rightChildId: user.loginId  // ❌ ObjectId여야 하는데 loginId 문자열!

// Line 363
userMap.set(user.loginId, user);

// Line 499
const node = await User.findOne({ loginId });  // ❌ loginId 필드 없음!
```

**영향**:
- ✅ 등록은 성공하지만 트리 구조 연결 **실패**
- ❌ leftChildId/rightChildId에 **undefined 또는 null** 저장
- ❌ 계층도가 **완전히 망가짐**

**실제 동작**: ✅ **매번 실행됨** (등록할 때마다)

---

### 2. **weeklyPaymentService.js**
**사용 위치**: 매주 금요일 자동 지급 처리

**문제 코드**:
```javascript
// Line 69
const user = await User.findOne({ loginId: plan.userId });  // ❌

// Line 142
userId: user.loginId,  // ❌ undefined

// Line 458
const user = await User.findOne({ loginId: plan.userId });  // ❌
```

**영향**:
- ❌ 사용자 조회 **실패** → user = null
- ❌ 지급 처리 **건너뜀**
- ❌ 보험 조건 확인 **불가능**

**실제 동작**: ✅ **매주 금요일 실행됨**

---

### 3. **registration/paymentTargetExtractor.js**
**사용 위치**: `executeStep3()` → 지급 대상자 추출

**문제 코드**:
```javascript
// Line 24
const registrants = users.map(user => ({
  userId: user.loginId,  // ❌ undefined
  userName: user.name,
  grade: user.grade,
}));
```

**영향**:
- ❌ WeeklyPaymentPlans.userId에 **undefined** 저장
- ❌ 지급 계획 조회 **불가능**

**실제 동작**: ✅ **매번 실행됨** (등록할 때마다)

---

### 4. **registration/paymentPlanGenerator.js**
**사용 위치**: `executeStep4()` → 승급자 지급 계획 생성

**문제 코드**:
```javascript
// Line 66
const user = await User.findOne({ loginId: prom.userId });  // ❌

// Line 73, 93
userId: user.loginId,  // ❌ undefined
```

**영향**:
- ❌ 승급자 조회 **실패**
- ❌ 승급 지급 계획 **생성 안 됨**

**실제 동작**: ✅ **등록 시 승급 발생하면 실행됨**

---

### 5. **registration/step3_paymentTargets.js**
**사용 위치**: `checkAdditionalPaymentConditions()` → 추가 지급 조건 확인

**문제 코드**:
```javascript
// Line 276
const user = await User.findOne({ loginId: userId });  // ❌
```

**영향**:
- ❌ 추가 지급 대상자 조회 **실패**
- ❌ 추가 지급 생성 **안 됨**

**실제 동작**: ✅ **매월 등록 시 실행됨**

---

### 6. **registration/step4_createPlans.js**
**사용 위치**: `executeStep4()` → 기존 승급자 확인

**문제 코드**:
```javascript
// Line 103
const user = await User.findOne({ loginId: prom.userId });  // ❌
```

**영향**:
- ❌ 기존 승급자 확인 **실패**

**실제 동작**: ✅ **등록 시 실행됨**

---

## 🟡 **사용 중이나 영향 적음** (수정 권장)

### 7. **paymentPlanService.js**
**사용 위치**: `createAdditionalPaymentForUser()` → 완료된 계획 확인

**문제 코드**:
```javascript
// Line 474
const user = await User.findOne({ loginId: completedPlan.userId });  // ❌
```

**영향**:
- ❌ 추가 지급 생성 **실패**

**실제 동작**: ⚠️ **현재는 사용 안 됨** (v7.0 10회 완료 즉시 생성 방식, v8.0에서는 매월 확인 방식으로 변경)

---

### 8. **registrationService.js**
**사용 위치**: `updateUserInsuranceSettings()` → 보험 설정 업데이트

**문제 코드**:
```javascript
// Line 127
const user = await User.findOne({ loginId: userId });  // ❌
```

**영향**:
- ❌ 보험 설정 업데이트 **실패**

**실제 동작**: ❓ **사용 여부 확인 필요**

---

## 🟢 **미사용 코드** (안전)

### 9. API 응답 필드 (4개)
- `/api/user/dashboard/+server.js`: loginId 반환
- `/api/user/tree/+server.js`: userId: user.loginId
- `/api/admin/payment/adjust/+server.js`: user.loginId 사용
- `admin/members/+page.svelte`: 개별 등록 후 표시

**영향**: 프론트엔드 표시 오류

**실제 동작**: ✅ **사용됨** (표시만, 기능 영향 없음)

---

## 📋 수정 우선순위

### 🔴 **1순위 - 즉시 수정** (시스템 오작동 발생 중)

1. ✅ **treeRestructure.js** ⭐ 계층도 망가짐
   - leftChildId/rightChildId에 loginId 저장 중
   - User.findOne({ loginId }) 사용
   - **영향**: 등록 시 계층도 연결 실패

2. ✅ **weeklyPaymentService.js** ⭐ 지급 실패
   - User.findOne({ loginId: plan.userId })
   - **영향**: 매주 금요일 지급 실패

3. ✅ **registration/paymentTargetExtractor.js** ⭐ 지급 계획 생성 실패
   - userId: user.loginId
   - **영향**: WeeklyPaymentPlans.userId가 undefined

4. ✅ **registration/paymentPlanGenerator.js** ⭐ 승급 지급 실패
   - User.findOne({ loginId: prom.userId })
   - userId: user.loginId
   - **영향**: 승급자 지급 계획 생성 안 됨

5. ✅ **registration/step3_paymentTargets.js** ⭐ 추가 지급 실패
   - User.findOne({ loginId: userId })
   - **영향**: 추가 지급 생성 안 됨

6. ✅ **registration/step4_createPlans.js**
   - User.findOne({ loginId: prom.userId })
   - **영향**: 기존 승급자 확인 실패

---

### 🟡 **2순위 - 조만간 수정** (일부 기능 오작동)

7. ⚠️ **paymentPlanService.js**
   - 현재는 사용 안 됨 (v8.0에서 로직 변경)
   - 향후 사용될 가능성 있음

8. ❓ **registrationService.js**
   - updateUserInsuranceSettings() 사용 여부 확인 필요

---

### 🟢 **3순위 - 여유 있을 때 수정** (표시만 영향)

9. 🎨 **API endpoints** (4개)
   - 프론트엔드 표시용
   - 기능에는 영향 없음
   - UserAccount join으로 해결 가능

---

## 🎯 수정 전략

### Step 1: 핵심 서비스 수정 (1-6번)
```javascript
// Before
const user = await User.findOne({ loginId: userId });
userId: user.loginId

// After
const user = await User.findById(userId);  // userId는 ObjectId
userId: user._id.toString()

// treeRestructure.js는 별도
allUsers.set(user._id.toString(), user);
leftChildId: user._id  // ObjectId
```

### Step 2: API 응답 수정 (9번)
```javascript
// UserAccount populate
const user = await User.findById(userId)
  .populate('userAccountId', 'loginId');

// 응답
loginId: user.userAccountId?.loginId
```

---

## ✅ 이미 수정 완료

- ✅ **gradeCalculation.js** (4ae72ab) - userMap을 _id 기준으로 변경
- ✅ **weekly/+server.js** (9239005) - 지급명부 API _id 기준으로 변경
- ✅ **step2_gradeAndMonthly.js** - userIdStr = user._id.toString() 사용 중

---

## 🔍 결론

**현재 상황**:
- User.loginId는 **제거**되었으나
- 7개 핵심 파일에서 **여전히 사용 중**
- **등록, 지급, 승급, 추가지급** 모두 영향받음

**긴급도**:
- 🔴 **즉시 수정 필요**: 6개 파일 (시스템 오작동 중)
- 🟡 **조만간 수정**: 2개 파일 (일부 기능 오작동)
- 🟢 **여유 있을 때**: 4개 파일 (표시만 영향)

**다음 작업**:
1. treeRestructure.js 수정 (가장 심각)
2. weeklyPaymentService.js 수정
3. registration 서비스들 일괄 수정 (3-6번)
4. API 응답 수정 (9번)

---

**작성 일시**: 2025-10-21
**작성자**: Claude (AI Assistant)
