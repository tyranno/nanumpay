# v8.0 구현 완료 세션 정리

**작업 일시**: 2025-10-20
**커밋**: b9eed2f
**버전**: v8.0

---

## 📌 작업 개요

사용자 ID 기반 계정 관리 시스템 구현 완료

### 핵심 변경사항
1. Excel 구조 변경: "ID" 컬럼 추가
2. 계정 분리: Admin, UserAccount, PlannerAccount (3개 컬렉션)
3. 다중 등록 지원: 같은 ID로 여러 용역 계약 가능
4. 자동 이름 번호 부여: 홍길동, 홍길동2, 홍길동3

---

## ✅ 구현 완료 항목

### 1. 신규 모델 생성

#### UserAccount 모델
**파일**: [apps/web/src/lib/server/models/UserAccount.js](../apps/web/src/lib/server/models/UserAccount.js)

```javascript
{
  loginId: String (unique, lowercase),
  passwordHash: String,
  name: String,
  phone: String,
  idNumber: String,
  bank: String,
  accountNumber: String,
  email: String,
  status: 'active' | 'inactive',
  createdAt: Date,
  updatedAt: Date
}
```

**특징**:
- 로그인 계정 정보 + 개인정보 저장
- 첫 등록 시 정보 고정 (재등록 시 업데이트 안 함)
- 한 계정에 여러 User(용역 계약) 가능

#### PlannerAccount 모델
**파일**: [apps/web/src/lib/server/models/PlannerAccount.js](../apps/web/src/lib/server/models/PlannerAccount.js)

```javascript
{
  loginId: String (unique), // 설계사 이름
  passwordHash: String,
  name: String,
  phone: String,
  status: 'active' | 'inactive',
  createdAt: Date,
  updatedAt: Date
}
```

**특징**:
- Excel 등록 시 자동 생성
- 초기 비밀번호: 전화번호 뒷자리 4자리
- loginId = 설계사 이름

### 2. User 모델 변경

**파일**: [apps/web/src/lib/server/models/User.js](../apps/web/src/lib/server/models/User.js)

**추가된 필드**:
```javascript
userAccountId: {
  type: ObjectId,
  ref: 'UserAccount',
  required: true,
  index: true
}

registrationNumber: {
  type: Number,
  required: true,
  default: 1
}

plannerAccountId: {
  type: ObjectId,
  ref: 'PlannerAccount',
  required: true,
  index: true
}
```

**제거된 필드**:
- `loginId`, `passwordHash` → UserAccount로 이동
- `phone`, `idNumber`, `bank`, `accountNumber`, `email` → UserAccount로 이동
- `planner`, `plannerPhone` → plannerAccountId (FK)로 대체

**인덱스 추가**:
```javascript
userSchema.index({ userAccountId: 1, registrationNumber: 1 });
userSchema.index({ plannerAccountId: 1 });
```

### 3. 등록 서비스 수정

**파일**: [apps/web/src/lib/server/services/userRegistrationService.js](../apps/web/src/lib/server/services/userRegistrationService.js)

#### Excel 필드 매핑 변경
```javascript
// v8.0 (ID 컬럼 추가로 +1 shift)
loginId = getValue(userData, ['ID', 'id', '__EMPTY_1']);
name = getValue(userData, ['성명', '이름', 'name', '__EMPTY_2']);
phone = getValue(userData, ['연락처', '전화번호', 'phone', '__EMPTY_3']);
idNumber = getValue(userData, ['주민번호', '__EMPTY_4']);
bank = getValue(userData, ['은행', 'bank', '__EMPTY_5']);
accountNumber = getValue(userData, ['계좌번호', '계좌', 'accountNumber', '__EMPTY_6']);
salesperson = getValue(userData, ['판매인', '추천인', 'salesperson', '__EMPTY_7']);
salespersonPhone = getValue(userData, ['판매인 연락처', '연락처.1', 'salespersonPhone', '__EMPTY_8']);
plannerName = getValue(userData, ['설계사', 'planner', '__EMPTY_9']);
plannerPhone = getValue(userData, ['설계사 연락처', '연락처.2', 'plannerPhone', '__EMPTY_10']);
insuranceProduct = getValue(userData, ['보험상품명', '보험상품', 'insuranceProduct', '__EMPTY_11']);
insuranceCompany = getValue(userData, ['보험회사', 'insuranceCompany', '__EMPTY_12']);
branch = getValue(userData, ['지사', '소속/지사', 'branch', '__EMPTY_13']);
```

#### 등록 프로세스
```
1. Excel ID 필드 파싱 (__EMPTY_1)
   ↓
2. UserAccount 생성/조회
   - 신규: 개인정보 + 암호 저장
   - 재등록: 기존 정보 재사용 (업데이트 안 함)
   ↓
3. PlannerAccount 자동 생성/조회
   - 신규: 이름 + 전화번호 뒷자리 암호
   - 기존: 재사용
   ↓
4. registrationNumber 계산
   - User.find({ userAccountId }).sort({ registrationNumber: -1 }).limit(1)
   - maxNumber + 1 (없으면 1)
   ↓
5. 표시 이름 생성
   - registrationNumber === 1: "홍길동"
   - registrationNumber > 1: "홍길동2", "홍길동3", ...
   ↓
6. User 생성 (FK 연결)
   - userAccountId: FK
   - registrationNumber: 1, 2, 3...
   - plannerAccountId: FK (required)
   - name: 표시 이름
```

### 4. 로그인 API 수정

**파일**: [apps/web/src/routes/api/auth/login/+server.js](../apps/web/src/routes/api/auth/login/+server.js)

#### 3-Collection Sequential Check
```javascript
// 1) Admin
let account = await Admin.findOne({ loginId: loginId.toLowerCase() });
let accountType = 'admin';

// 2) UserAccount
if (!account) {
  account = await UserAccount.findOne({ loginId: loginId.toLowerCase() });
  accountType = 'user';
}

// 3) PlannerAccount
if (!account) {
  account = await PlannerAccount.findOne({ loginId });
  accountType = 'planner';
}
```

#### 계정 타입별 추가 처리

**UserAccount 로그인**:
```javascript
// primaryUser 조회 (registrationNumber: 1)
primaryUser = await User.findOne({
  userAccountId: account._id,
  registrationNumber: 1
});

// 모든 User 조회
allUsers = await User.find({ userAccountId: account._id })
  .sort({ registrationNumber: 1 });

// 응답 데이터
response.primaryUser = { id, name, grade, registrationNumber };
response.allRegistrations = [{ id, name, grade, registrationNumber, createdAt }, ...];
```

**PlannerAccount 로그인**:
```javascript
// 담당 고객 조회
clients = await User.find({ plannerAccountId: account._id })
  .sort({ createdAt: -1 })
  .limit(100);

// 응답 데이터
response.clientCount = clients.length;
response.recentClients = [{ id, name, grade, createdAt }, ...];
```

### 5. DB 초기화 스크립트

**파일**: [apps/web/install/linux/db/init.mongo.js](../apps/web/install/linux/db/init.mongo.js)

#### 변경 사항
```javascript
// 컬렉션 생성
dbx.createCollection('admins');
dbx.createCollection('useraccounts');      // v8.0 신규
dbx.createCollection('planneraccounts');   // v8.0 신규

// 인덱스 생성
// admins
dbx.admins.createIndex({ loginId: 1 }, { unique: true });
dbx.admins.createIndex({ createdAt: 1 });

// useraccounts
dbx.useraccounts.createIndex({ loginId: 1 }, { unique: true });
dbx.useraccounts.createIndex({ status: 1 });

// planneraccounts
dbx.planneraccounts.createIndex({ loginId: 1 }, { unique: true });
dbx.planneraccounts.createIndex({ status: 1 });
```

#### --force 옵션
```javascript
// v8.0: useraccounts, planneraccounts는 보존
if (force) {
  allCollections.forEach(function (colName) {
    if (colName !== 'admins' &&
        colName !== 'useraccounts' &&
        colName !== 'planneraccounts') {
      dbx.getCollection(colName).drop();
    }
  });
}
```

---

## 📊 Excel 구조 변경

### v7.0 (이전)
```
순번 | 날짜 | 성명 | 연락처 | 주민번호 | 은행 | 계좌번호 | 판매인 | 판매인연락처 | 설계사 | ...
```

### v8.0 (신규)
```
순번 | 날짜 | ID | 성명 | 연락처 | 주민번호 | 은행 | 계좌번호 | 판매인 | 판매인연락처 | 설계사 | ...
             ↑ 신규 추가
```

### 필드 매핑
| 필드 | v7.0 | v8.0 | 설명 |
|-----|------|------|------|
| 순번 | `용 역 자 관 리 명 부` | `용 역 자 관 리 명 부` | 변경 없음 |
| 날짜 | `__EMPTY` | `__EMPTY` | 변경 없음 |
| **ID** | - | `__EMPTY_1` | **신규 추가** |
| 성명 | `__EMPTY_1` | `__EMPTY_2` | +1 |
| 연락처 | `__EMPTY_2` | `__EMPTY_3` | +1 |
| 주민번호 | `__EMPTY_3` | `__EMPTY_4` | +1 |
| 은행 | `__EMPTY_4` | `__EMPTY_5` | +1 |
| 계좌번호 | `__EMPTY_5` | `__EMPTY_6` | +1 |
| 판매인 | `__EMPTY_6` | `__EMPTY_7` | +1 |
| 판매인연락처 | `__EMPTY_7` | `__EMPTY_8` | +1 |
| 설계사 | `__EMPTY_8` | `__EMPTY_9` | +1 |
| 설계사연락처 | `__EMPTY_9` | `__EMPTY_10` | +1 |
| 보험상품명 | `__EMPTY_10` | `__EMPTY_11` | +1 |
| 보험회사 | `__EMPTY_11` | `__EMPTY_12` | +1 |
| 지사 | `__EMPTY_12` | `__EMPTY_13` | +1 |

---

## 🔄 데이터 흐름

### 등록 흐름
```
[Excel 업로드]
    ↓
[ID 필드 파싱]
    ↓
[UserAccount 생성/조회]
    ├─ 신규: 개인정보 저장
    └─ 재등록: 기존 정보 재사용
    ↓
[PlannerAccount 자동 생성/조회]
    ↓
[registrationNumber 계산]
    ↓
[표시 이름 생성]
    ├─ 1: "홍길동"
    ├─ 2: "홍길동2"
    └─ 3: "홍길동3"
    ↓
[User 생성 (FK 연결)]
    ├─ userAccountId: FK
    ├─ registrationNumber: 1, 2, 3...
    ├─ plannerAccountId: FK
    └─ name: 표시 이름
```

### 로그인 흐름
```
[로그인 요청]
    ↓
[1. Admin 확인]
    ├─ 있음 → Admin 로그인
    └─ 없음 → 다음 단계
    ↓
[2. UserAccount 확인]
    ├─ 있음 → UserAccount 로그인
    │   ├─ primaryUser 조회 (registrationNumber: 1)
    │   ├─ 모든 User 조회
    │   └─ 계층도 root = primaryUser
    └─ 없음 → 다음 단계
    ↓
[3. PlannerAccount 확인]
    ├─ 있음 → PlannerAccount 로그인
    │   ├─ 담당 고객 조회
    │   └─ 최근 100명 반환
    └─ 없음 → 로그인 실패
```

---

## 🗂️ 변경 파일 목록

### 신규 파일 (2개)
1. `apps/web/src/lib/server/models/UserAccount.js` ⭐
2. `apps/web/src/lib/server/models/PlannerAccount.js` ⭐

### 수정 파일 (4개)
1. `apps/web/src/lib/server/models/User.js`
2. `apps/web/src/lib/server/services/userRegistrationService.js`
3. `apps/web/src/routes/api/auth/login/+server.js`
4. `apps/web/install/linux/db/init.mongo.js`

---

## 🎯 핵심 원칙

### 1. 최소 변경 원칙
- 기존 User 모델의 트리/등급/지급 로직은 **100% 그대로 유지**
- 추가된 필드: userAccountId, registrationNumber, plannerAccountId (3개)
- FK 관계로 연결, User 자체 로직은 변경 없음

### 2. 개인정보 고정 원칙
- UserAccount 정보는 **첫 등록 시 저장**
- 재등록 시 **업데이트 안 함** (v8.0 설계 원칙)
- 개인정보 변경 필요 시 별도 UI 필요

### 3. 자동 생성 원칙
- PlannerAccount: Excel 등록 시 **자동 생성**
- 초기 비밀번호: 전화번호 뒷자리 4자리
- 이미 존재하면 재사용

### 4. 삭제 없음 원칙
- UserAccount, PlannerAccount **삭제 기능 없음**
- FK cascade delete 불필요
- status 필드로 비활성화만 가능

---

## 📝 다음 단계 (향후 작업)

### 1. 마이그레이션 스크립트
- 기존 User 데이터 → v8.0 구조로 변환
- UserAccount 생성 (기존 User 정보 기반)
- User 업데이트 (userAccountId, registrationNumber 설정)

### 2. 프론트엔드 업데이트
- Excel 템플릿 변경 (ID 컬럼 추가)
- 로그인 응답 처리 (accountType 분기)
- UserAccount 대시보드 (모든 등록 정보 표시)
- PlannerAccount 대시보드 (담당 고객 목록)

### 3. 테스트
- 신규 등록 테스트
- 재등록 테스트 (같은 ID, 다른 이름)
- 로그인 테스트 (3가지 계정 타입)
- PlannerAccount 자동 생성 테스트

---

## 🔍 주요 체크포인트

### 등록 시 확인사항
- [ ] Excel ID 컬럼이 __EMPTY_1에 있는가?
- [ ] UserAccount가 정확히 생성/조회되는가?
- [ ] PlannerAccount가 자동 생성되는가?
- [ ] registrationNumber가 올바르게 계산되는가?
- [ ] 표시 이름이 정확한가? (홍길동, 홍길동2, 홍길동3)
- [ ] User가 FK로 연결되는가?

### 로그인 시 확인사항
- [ ] Admin 로그인이 작동하는가?
- [ ] UserAccount 로그인이 작동하는가?
- [ ] PlannerAccount 로그인이 작동하는가?
- [ ] primaryUser가 정확히 조회되는가?
- [ ] 모든 등록 정보가 반환되는가?
- [ ] 설계사 담당 고객 목록이 반환되는가?

### DB 초기화 확인사항
- [ ] useraccounts 컬렉션이 생성되는가?
- [ ] planneraccounts 컬렉션이 생성되는가?
- [ ] 인덱스가 정확히 생성되는가?
- [ ] --force 옵션 시 보존되는가?

---

## 📞 관련 문서

1. **설계 문서**: [docs/사용자_ID_관리_시스템_변경안_v8.0_최종.md](사용자_ID_관리_시스템_변경안_v8.0_최종.md)
2. **v7.0 문서**: [docs/시스템_설계_문서_v7.md](시스템_설계_문서_v7.md)
3. **요구사항 문서**: [docs/시스템_요구사항_검토문서_v5.0.md](시스템_요구사항_검토문서_v5.0.md)
4. **Claude 세션 컨텍스트**: [CLAUDE.md](../CLAUDE.md)

---

**작업 완료 일시**: 2025-10-20
**커밋 해시**: b9eed2f
**작업자**: Claude (AI Assistant)

✅ v8.0 ID 기반 계정 관리 시스템 구현 완료
