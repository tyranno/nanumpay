# 백업 시스템 구현 완료 보고서

**날짜**: 2025-10-26
**버전**: v1.0
**상태**: ✅ 구현 완료 (UI 제외)

---

## 📋 구현 내용

### 1. 백업 앱 개발 (apps/backup/)

#### 디렉토리 구조
```
apps/backup/
├── package.json
├── build.sh
├── README.md
└── src/
    ├── index.js          # 메인 진입점
    ├── config.js         # MongoDB 연결 및 설정 읽기
    ├── backup.js         # mongodump 실행 및 압축
    └── storage/
        ├── s3.js         # AWS S3 업로드
        └── ftp.js        # FTP 업로드
```

#### 주요 기능
- ✅ MongoDB 데이터베이스 백업 (mongodump)
- ✅ tar.gz 압축
- ✅ AWS S3 업로드 (선택)
- ✅ FTP 업로드 (선택)
- ✅ 보관 정책 (개수/날짜 기반)
- ✅ DB 기반 설정 읽기
- ✅ Bun 단일 실행 파일 빌드

#### 빌드 프로세스
```bash
cd apps/backup
./build.sh
# 결과: build/nanumpay-backup (~25MB)
```

### 2. 빌드 통합 (apps/web/scripts/release-linux.cjs)

#### 변경 사항
1. **binDir 생성**: `/opt/nanumpay/bin/` 디렉토리 추가
2. **백업 앱 빌드**: release:linux 실행 시 자동 빌드
3. **실행 파일 포함**: DEB 패키지에 nanumpay-backup 포함
4. **postinst 수정**: 백업 디렉토리 및 로그 디렉토리 생성
5. **prerm 수정**: crontab 정리 추가

#### 설치 경로
```
/opt/nanumpay/
├── bin/
│   └── nanumpay-backup      # 백업 실행 파일
├── backups/                 # 백업 저장소
├── logs/                    # 로그 디렉토리
└── tools/
    └── db_init.sh
```

### 3. 데이터 모델 수정 (Admin.js)

#### 기존 구조 (변경 전)
```javascript
systemSettings: {
  backup: {
    enabled: Boolean,
    frequency: String,  // 'daily', 'weekly', 'monthly'
    time: String,       // 'HH:mm'
    storage: { type, s3, ftp }
  }
}
```

#### 새 구조 (변경 후) ⭐
```javascript
systemSettings: {
  backupSettings: {
    enabled: Boolean,
    schedule: String,           // cron 형식: '0 2 * * *'
    backupPath: String,         // '/opt/nanumpay/backups'
    retentionDays: Number,      // 7일
    retentionCount: Number,     // 5개
    s3: {
      enabled: Boolean,
      bucket: String,
      accessKeyId: String,
      secretAccessKey: String,
      region: String,           // 'us-east-1'
      prefix: String            // 'backups/'
    },
    ftp: {
      enabled: Boolean,
      host: String,
      port: Number,             // 21
      user: String,
      password: String,
      remotePath: String        // '/backups'
    }
  }
}
```

### 4. 배포 통합

#### 빌드 명령어
```bash
# 기존 방식과 동일
pnpm release:linux

# 자동으로 수행되는 작업:
# 1. SvelteKit 앱 빌드 (dist/nanumpay)
# 2. 백업 앱 빌드 (apps/backup/build/nanumpay-backup)
# 3. DEB 패키지 생성 (apps/web/release/*.deb)
```

#### DEB 패키지 내용
```
nanumpay_0.0.1-YYYYMMDD_amd64.deb
├── opt/nanumpay/
│   ├── nanumpay              # 웹 앱
│   ├── bin/
│   │   └── nanumpay-backup   # 백업 앱
│   ├── tools/
│   │   └── db_init.sh
│   └── db/
│       └── init.mongo.js
├── etc/nanumpay/
│   └── nanumpay.env
├── etc/systemd/system/
│   └── nanumpay.service
└── DEBIAN/
    ├── control
    ├── postinst              # 백업 디렉토리 생성
    ├── prerm                 # crontab 정리
    └── conffiles
```

#### postinst 스크립트 (설치 시)
```bash
# 사용자 생성
adduser --system --group --no-create-home nanumpay

# 디렉토리 생성 및 권한 설정
mkdir -p /opt/nanumpay/backups
mkdir -p /opt/nanumpay/logs
chown -R nanumpay:nanumpay /opt/nanumpay/backups
chown -R nanumpay:nanumpay /opt/nanumpay/logs
chmod 755 /opt/nanumpay/backups
chmod 755 /opt/nanumpay/logs

# systemd 등록 및 시작
systemctl daemon-reload
systemctl enable nanumpay.service
systemctl start nanumpay.service
```

#### prerm 스크립트 (제거 시)
```bash
# crontab 정리
crontab -u nanumpay -l | grep -v '/opt/nanumpay/bin/nanumpay-backup' | crontab -u nanumpay -

# 서비스 중지
systemctl stop nanumpay.service
systemctl disable nanumpay.service
```

---

## 🔄 백업 워크플로우

### 설정 흐름
```
[관리자 웹 UI]
    ↓ (설정 저장)
[MongoDB admins.systemSettings.backupSettings]
    ↓ (읽기)
[백업 앱: /opt/nanumpay/bin/nanumpay-backup]
    ↓ (실행)
[백업 생성 → S3/FTP 업로드 → 오래된 백업 정리]
```

### Crontab 관리
```
[웹 UI에서 백업 설정 활성화]
    ↓
[API: POST /api/admin/backup/schedule]
    ↓
[crontab 등록]
    0 2 * * * /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1
    ↓
[매일 새벽 2시 자동 실행]
```

### 즉시 백업
```
[웹 UI: "즉시 백업" 버튼]
    ↓
[API: POST /api/admin/backup/execute]
    ↓
[백업 앱 즉시 실행]
    ↓
[결과 반환]
```

---

## 🧪 테스트 방법

### 1. 개발 환경 테스트

#### MongoDB 설정 확인
```bash
mongosh mongodb://localhost:27017/nanumpay --quiet --eval "
db.admins.updateOne({}, {
  \$set: {
    'systemSettings.backupSettings.enabled': true,
    'systemSettings.backupSettings.backupPath': '/tmp/nanumpay-backups-test',
    'systemSettings.backupSettings.retentionDays': 7,
    'systemSettings.backupSettings.retentionCount': 5
  }
})
"
```

#### 백업 앱 빌드 및 실행
```bash
# 1. 빌드
cd apps/backup
./build.sh

# 2. 백업 실행
./build/nanumpay-backup

# 3. 결과 확인
ls -lh /tmp/nanumpay-backups-test/
# 예상 결과: nanumpay-backup-2025-10-26T14-30-00.tar.gz
```

#### 로그 확인
```bash
# 실행 로그 예시:
🚀 NanumPay 백업 시스템 시작
==============================
실행 시간: 2025-10-26 14:30:00

✅ MongoDB 연결 성공
✅ 백업 설정 로드 완료
   백업 경로: /tmp/nanumpay-backups-test
   보관 기간: 7일
   보관 개수: 5개
   S3 업로드: 비활성화
   FTP 업로드: 비활성화

📦 백업 시작: nanumpay-backup-2025-10-26T14-30-00
🗄️  mongodump 실행 중...
✅ mongodump 완료
🗜️  압축 중...
✅ 압축 완료: nanumpay-backup-2025-10-26T14-30-00.tar.gz

🧹 오래된 백업 정리 중...
📊 전체 백업 파일 수: 1개
🔢 개수 기준 삭제 대상: 0개 (최대 5개 유지)
📅 날짜 기준 삭제 대상: 0개 (7일 이상 경과)
✅ 정리 완료: 0개 파일 삭제
📊 남은 백업 파일 수: 1개

✅ MongoDB 연결 종료

==============================
✅ 백업 완료!
종료 시간: 2025-10-26 14:30:05
```

### 2. 보관 정책 테스트

```bash
# 여러 번 실행하여 백업 파일 생성
for i in {1..10}; do
  ./build/nanumpay-backup
  sleep 2
done

# 개수 제한 확인 (retentionCount: 5)
ls /tmp/nanumpay-backups-test/*.tar.gz | wc -l
# 예상 결과: 5개
```

### 3. S3 업로드 테스트

```bash
# S3 설정 활성화
mongosh mongodb://localhost:27017/nanumpay --quiet --eval "
db.admins.updateOne({}, {
  \$set: {
    'systemSettings.backupSettings.s3.enabled': true,
    'systemSettings.backupSettings.s3.bucket': 'your-bucket',
    'systemSettings.backupSettings.s3.accessKeyId': 'YOUR_ACCESS_KEY',
    'systemSettings.backupSettings.s3.secretAccessKey': 'YOUR_SECRET_KEY',
    'systemSettings.backupSettings.s3.region': 'us-east-1'
  }
})
"

# 백업 실행
./build/nanumpay-backup

# S3 확인
aws s3 ls s3://your-bucket/backups/
```

### 4. FTP 업로드 테스트

```bash
# FTP 설정 활성화
mongosh mongodb://localhost:27017/nanumpay --quiet --eval "
db.admins.updateOne({}, {
  \$set: {
    'systemSettings.backupSettings.ftp.enabled': true,
    'systemSettings.backupSettings.ftp.host': 'ftp.example.com',
    'systemSettings.backupSettings.ftp.port': 21,
    'systemSettings.backupSettings.ftp.user': 'username',
    'systemSettings.backupSettings.ftp.password': 'password',
    'systemSettings.backupSettings.ftp.remotePath': '/backups'
  }
})
"

# 백업 실행
./build/nanumpay-backup
```

### 5. 프로덕션 배포 테스트

```bash
# 1. 빌드
pnpm release:linux

# 2. 확인
ls -lh apps/web/release/*.deb

# 3. 배포
node apps/web/scripts/deploy.cjs

# 4. 서버에서 확인
ssh -i ~/.ssh/ocp_tyranno tyranno@34.170.107.151

# 5. 백업 앱 확인
ls -l /opt/nanumpay/bin/nanumpay-backup
/opt/nanumpay/bin/nanumpay-backup

# 6. 로그 확인
tail -f /opt/nanumpay/logs/backup.log
```

---

## 📝 남은 작업 (TODO)

### 1. 백업 관리 API 구현 ⭐ 필수

#### API 엔드포인트
```javascript
// apps/web/src/routes/api/admin/backup/

// 1. 설정 조회
GET /api/admin/backup/settings
→ systemSettings.backupSettings 반환

// 2. 설정 저장 + crontab 업데이트
POST /api/admin/backup/settings
→ DB 업데이트 + crontab 등록/제거

// 3. 즉시 백업 실행
POST /api/admin/backup/execute
→ execSync('/opt/nanumpay/bin/nanumpay-backup')

// 4. 백업 파일 목록
GET /api/admin/backup/files
→ readdir('/opt/nanumpay/backups')

// 5. 백업 파일 다운로드
GET /api/admin/backup/download/:filename
→ createReadStream()

// 6. 백업 파일 삭제
DELETE /api/admin/backup/files/:filename
→ unlink()

// 7. 로그 조회
GET /api/admin/backup/logs
→ readFile('/opt/nanumpay/logs/backup.log')
```

### 2. 백업 설정 UI 구현 ⭐ 필수

#### 화면 위치
```
/admin/settings → "백업 설정" 탭 추가
```

#### UI 구성 요소
```svelte
<!-- apps/web/src/routes/(admin)/admin/settings/+page.svelte -->

<script>
  let backupSettings = {
    enabled: false,
    schedule: '0 2 * * *',
    backupPath: '/opt/nanumpay/backups',
    retentionDays: 7,
    retentionCount: 5,
    s3: {
      enabled: false,
      bucket: '',
      accessKeyId: '',
      secretAccessKey: '',
      region: 'us-east-1',
      prefix: 'backups/'
    },
    ftp: {
      enabled: false,
      host: '',
      port: 21,
      user: '',
      password: '',
      remotePath: '/backups'
    }
  };

  async function saveSettings() {
    await fetch('/api/admin/backup/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(backupSettings)
    });
  }

  async function runBackupNow() {
    await fetch('/api/admin/backup/execute', { method: 'POST' });
  }
</script>

<!-- UI 구성 -->
<div class="backup-settings">
  <h2>백업 설정</h2>

  <!-- 1. 활성화 토글 -->
  <label>
    <input type="checkbox" bind:checked={backupSettings.enabled} />
    자동 백업 활성화
  </label>

  <!-- 2. 스케줄 (cron 형식) -->
  <input type="text" bind:value={backupSettings.schedule} placeholder="0 2 * * *" />

  <!-- 3. 보관 정책 -->
  <input type="number" bind:value={backupSettings.retentionDays} min="1" />
  <input type="number" bind:value={backupSettings.retentionCount} min="1" />

  <!-- 4. S3 설정 (접기/펼치기) -->
  <details>
    <summary>AWS S3 업로드</summary>
    <label>
      <input type="checkbox" bind:checked={backupSettings.s3.enabled} />
      S3 업로드 활성화
    </label>
    <input type="text" bind:value={backupSettings.s3.bucket} placeholder="버킷명" />
    <input type="text" bind:value={backupSettings.s3.accessKeyId} placeholder="Access Key" />
    <input type="password" bind:value={backupSettings.s3.secretAccessKey} placeholder="Secret Key" />
    <input type="text" bind:value={backupSettings.s3.region} placeholder="리전" />
  </details>

  <!-- 5. FTP 설정 (접기/펼치기) -->
  <details>
    <summary>FTP 업로드</summary>
    <label>
      <input type="checkbox" bind:checked={backupSettings.ftp.enabled} />
      FTP 업로드 활성화
    </label>
    <input type="text" bind:value={backupSettings.ftp.host} placeholder="FTP 서버" />
    <input type="number" bind:value={backupSettings.ftp.port} placeholder="포트" />
    <input type="text" bind:value={backupSettings.ftp.user} placeholder="사용자명" />
    <input type="password" bind:value={backupSettings.ftp.password} placeholder="비밀번호" />
  </details>

  <!-- 6. 버튼 -->
  <button on:click={saveSettings}>설정 저장</button>
  <button on:click={runBackupNow}>즉시 백업</button>
</div>
```

#### 백업 파일 목록 UI
```svelte
<div class="backup-files">
  <h3>백업 파일 목록</h3>
  <table>
    <thead>
      <tr>
        <th>파일명</th>
        <th>크기</th>
        <th>생성일</th>
        <th>작업</th>
      </tr>
    </thead>
    <tbody>
      {#each backupFiles as file}
        <tr>
          <td>{file.name}</td>
          <td>{file.sizeMB} MB</td>
          <td>{file.created}</td>
          <td>
            <button on:click={() => downloadBackup(file.name)}>다운로드</button>
            <button on:click={() => deleteBackup(file.name)}>삭제</button>
          </td>
        </tr>
      {/each}
    </tbody>
  </table>
</div>
```

#### 로그 뷰어 UI
```svelte
<div class="backup-logs">
  <h3>백업 로그</h3>
  <button on:click={refreshLogs}>새로고침</button>
  <pre>{backupLogs}</pre>
</div>
```

### 3. Crontab 관리 헬퍼 함수

```javascript
// apps/web/src/lib/server/utils/crontab.js

import { execSync } from 'child_process';

export function updateBackupCrontab(schedule) {
  try {
    // 현재 crontab 읽기
    let currentCrontab = '';
    try {
      currentCrontab = execSync('crontab -u nanumpay -l 2>/dev/null', {
        encoding: 'utf8'
      });
    } catch {
      // crontab 없음
    }

    // nanumpay-backup 관련 항목 제거
    const lines = currentCrontab
      .split('\n')
      .filter(line => !line.includes('/opt/nanumpay/bin/nanumpay-backup'));

    // 새 스케줄 추가 (활성화된 경우)
    if (schedule) {
      const newEntry = `${schedule} /opt/nanumpay/bin/nanumpay-backup >> /opt/nanumpay/logs/backup.log 2>&1`;
      lines.push(newEntry);
    }

    // crontab 업데이트
    const newCrontab = lines.filter(l => l.trim()).join('\n') + '\n';
    execSync(`echo "${newCrontab}" | crontab -u nanumpay -`, {
      encoding: 'utf8'
    });

    return true;
  } catch (error) {
    console.error('Crontab 업데이트 실패:', error);
    return false;
  }
}
```

---

## 🎯 배포 체크리스트

### 빌드 전 확인
- [ ] Bun 설치 확인: `bun --version`
- [ ] apps/backup/ 코드 확인
- [ ] Admin 모델 스키마 확인

### 빌드
```bash
cd /home/tyranno/project/bill/nanumpay
pnpm release:linux
```

### 빌드 후 확인
- [ ] apps/backup/build/nanumpay-backup 생성 확인
- [ ] apps/web/release/*.deb 생성 확인
- [ ] DEB 패키지 내용 확인:
  ```bash
  dpkg-deb -c apps/web/release/nanumpay_*.deb | grep backup
  # 예상 결과:
  # ./opt/nanumpay/bin/nanumpay-backup
  ```

### 배포
```bash
node apps/web/scripts/deploy.cjs
```

### 배포 후 확인 (서버)
```bash
ssh -i ~/.ssh/ocp_tyranno tyranno@34.170.107.151

# 1. 파일 확인
ls -l /opt/nanumpay/bin/nanumpay-backup
ls -ld /opt/nanumpay/backups
ls -ld /opt/nanumpay/logs

# 2. 권한 확인
ls -l /opt/nanumpay/bin/nanumpay-backup
# -rwxr-xr-x 1 nanumpay nanumpay ... nanumpay-backup

# 3. 실행 테스트
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup

# 4. 로그 확인
tail -f /opt/nanumpay/logs/backup.log

# 5. 백업 파일 확인
ls -lh /opt/nanumpay/backups/
```

---

## 🔍 문제 해결

### MongoDB 연결 실패
```bash
# MongoDB 상태 확인
sudo systemctl status mongod

# MongoDB 재시작
sudo systemctl restart mongod

# 연결 테스트
mongosh mongodb://localhost:27017/nanumpay
```

### mongodump 명령 없음
```bash
# MongoDB Database Tools 설치
sudo apt-get update
sudo apt-get install mongodb-database-tools
```

### 권한 오류
```bash
# 백업 디렉토리 권한 확인
ls -ld /opt/nanumpay/backups

# 권한 수정
sudo chown -R nanumpay:nanumpay /opt/nanumpay/backups
sudo chmod 755 /opt/nanumpay/backups
```

### Bun 설치
```bash
# Bun 설치
curl -fsSL https://bun.sh/install | bash

# 설치 확인
bun --version
```

---

## 📚 참고 문서

1. [백업 시스템 최종 설계](백업_시스템_최종_설계.md)
2. [백업 시스템 배포 통합](백업_시스템_배포_통합.md)
3. [백업 앱 README](../apps/backup/README.md)

---

**작성자**: Claude AI Assistant
**최종 수정일**: 2025-10-26
