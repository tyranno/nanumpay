# 추가지급 로직 1번안

**작성일**: 2024-12-12
**상태**: 현재 코드 기반 분석 + 수정 제안

---

## 1. 핵심 룰 (가장 중요!)

### 해당 등급으로 몇 개월째인가?

```
추가지급 대상 = "해당 등급 유지 개월 수"로 판단

┌─────────────────────────────────────────────────┐
│  등급 유지 개월 수 = 추가지급 차수              │
│                                                 │
│  1개월째 → 추가1차                              │
│  2개월째 → 추가2차                              │
│  3개월째 → 추가3차                              │
│  ...                                            │
│  N개월째 → 추가N차 (최대 차수까지)              │
└─────────────────────────────────────────────────┘
```

### 예시: F4, 10월 승급

| 시점 | F4 유지 기간 | 결과 |
|-----|-------------|------|
| 10월 | 승급 (0개월) | 기본지급 10회 |
| 11월 등록처리 | **1개월째** | 추가1차 |
| 12월 등록처리 | **2개월째** | 추가2차 |
| 1월 등록처리 | **3개월째** | 추가3차 |
| 2월 등록처리 | 4개월째 | F4는 3차까지 → **종료** |

---

## 2. 등급별 최대 차수

| 등급 | maxInstallments | 최대 추가지급 차수 |
|-----|-----------------|-------------------|
| F1 | 20 | 1차 (1개월까지) |
| F2 | 30 | 2차 (2개월까지) |
| F3 | 30 | 2차 (2개월까지) |
| F4 | 40 | 3차 (3개월까지) |
| F5 | 40 | 3차 (3개월까지) |
| F6 | 50 | 4차 (4개월까지) |
| F7 | 50 | 4차 (4개월까지) |
| F8 | 50 | 4차 (4개월까지) |

**계산 공식**: `최대 차수 = (maxInstallments - 10) / 10`

---

## 3. 탐색 로직 (단순화)

### 3.1 N월 등록 처리 시

```
FOR EACH 사용자:
  │
  ├─ 현재 등급 확인
  │
  ├─ "이 등급으로 몇 개월째인가?" 계산
  │   └─ 등급 유지 개월 수 = N월 - 승급/등록월
  │
  ├─ 제외 조건 확인
  │   ├─ N월에 승급/등록했나? → 제외 (0개월째 = 기본지급)
  │   ├─ 최대 차수 초과? → 제외
  │   └─ 이미 N월 추가지급 생성됨? → 제외
  │
  └─ 통과 시 → 추가지급 대상 (차수 = 유지 개월 수)
```

### 3.2 핵심 원칙

- **등록 = 승급**: 등록한 사람도 "승급"으로 간주 (0개월째 시작)
- **승급하면 리셋**: 새 등급에서 0개월째부터 다시 시작
- **하나의 등급에서만**: 해당 등급 유지 기간 동안만 추가지급

---

## 4. 설정값 통일

### 4.1 Single Source of Truth: constants.js

```javascript
// utils/constants.js

// 기본 설정
export const GRADE_LIMITS = {
  F1: { maxInstallments: 20, insuranceRequired: false },
  F2: { maxInstallments: 30, insuranceRequired: false },
  F3: { maxInstallments: 30, insuranceRequired: false },
  F4: { maxInstallments: 40, insuranceRequired: true, insuranceAmount: 70000 },
  F5: { maxInstallments: 40, insuranceRequired: true, insuranceAmount: 70000 },
  F6: { maxInstallments: 50, insuranceRequired: true, insuranceAmount: 90000 },
  F7: { maxInstallments: 50, insuranceRequired: true, insuranceAmount: 90000 },
  F8: { maxInstallments: 50, insuranceRequired: true, insuranceAmount: 110000 }
};

// 파생 설정 (자동 계산)
export const MAX_ADDITIONAL_PAYMENTS = Object.fromEntries(
  Object.entries(GRADE_LIMITS).map(([grade, limits]) => [
    grade,
    Math.floor((limits.maxInstallments - 10) / 10)
  ])
);
// 결과: { F1:1, F2:2, F3:2, F4:3, F5:3, F6:4, F7:4, F8:4 }
```

### 4.2 사용하는 곳에서는 import만

```javascript
import { MAX_ADDITIONAL_PAYMENTS } from '../../utils/constants.js';

const maxMonths = MAX_ADDITIONAL_PAYMENTS[grade];  // 최대 유지 개월 수
```

---

## 5. 현재 코드 문제점

### 5.1 문제 1: maxPreviousMonths 하드코딩

**파일**: `step3_paymentTargets.js` (220-229줄)

```javascript
// 현재 (잘못됨) - 값도 틀리고 하드코딩
const maxPreviousMonths = {
  F1: 1, F2: 2, F3: 3, F4: 3, F5: 4, F6: 4, F7: 5, F8: 5
};
```

**수정**: constants.js에서 `MAX_ADDITIONAL_PAYMENTS` import 사용

### 5.2 문제 2: 등록자 제외 누락

**파일**: `step3_paymentTargets.js` (232줄)

```javascript
// 현재 (잘못됨) - 승급자만 제외
const currentPromotedIds = promoted.map((p) => p.userId);
```

**수정**: 등록자도 제외 (등록 = 승급 = 0개월째)

```javascript
const currentExcludeIds = [
  ...promoted.map((p) => p.userId),
  ...monthlyReg.registrations.map((r) => r.userId)
];
```

---

## 6. 수정 작업 체크리스트

- [ ] `constants.js`: `MAX_ADDITIONAL_PAYMENTS` export 추가
- [ ] `step3_paymentTargets.js`: `maxPreviousMonths` 하드코딩 제거
- [ ] `step3_paymentTargets.js`: `MAX_ADDITIONAL_PAYMENTS` import 사용
- [ ] `step3_paymentTargets.js`: 등록자 제외 로직 추가
- [ ] 테스트: 등급별 추가지급 차수 확인
- [ ] 테스트: 등록자가 추가지급 대상에서 제외되는지 확인

---

## 7. 변경 영향 범위

| 파일 | 변경 내용 |
|-----|----------|
| `constants.js` | `MAX_ADDITIONAL_PAYMENTS` export 추가 |
| `step3_paymentTargets.js` | `maxPreviousMonths` 제거, import 사용, 등록자 제외 추가 |

---

## 8. 요약

```
┌────────────────────────────────────────────────────────┐
│                                                        │
│  핵심 질문: "이 등급으로 몇 개월째인가?"               │
│                                                        │
│  0개월째 (승급/등록월) → 기본지급                      │
│  1개월째 → 추가1차                                     │
│  2개월째 → 추가2차                                     │
│  ...                                                   │
│  N개월째 → 추가N차 (최대 차수까지)                     │
│                                                        │
│  최대 차수 = (maxInstallments - 10) / 10               │
│                                                        │
└────────────────────────────────────────────────────────┘
```
