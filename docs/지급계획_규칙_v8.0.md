# 지급 계획 규칙 v8.0

**최종 업데이트**: 2025-12-07
**버전**: v8.0

---

## 1. 지급 유형 정의

| 유형 | planType | installmentType | 설명 |
|------|----------|-----------------|------|
| 기본지급 | `initial` | `basic` | 최초 등록 시 생성되는 10회 지급 |
| 승급지급 | `promotion` | `basic` | 승급 시 생성되는 10회 지급 |
| 추가지급 | `additional` | `additional` | 매월 미승급자에게 생성되는 추가 10회 지급 |

---

## 2. 핵심 규칙

### 2.1 승급 시 처리: 모든 기존 플랜 terminate

**규칙**: 승급 발생 시 **기본지급, 승급지급, 추가지급 모두** 새 등급 첫 지급일부터 terminate

```
예시: F1 기본 5회 + F1 추가 3회 진행 중 → F2 승급

결과:
- F1 기본: ❌ terminate (F2 첫 지급일부터)
- F1 추가: ❌ terminate (F2 첫 지급일부터)
- F2 기본: ✅ 새로 시작
```

**코드 구현** (`terminateActivePlansFromDate`):
```javascript
// 모든 active 플랜 조회 (새로 생성된 플랜 제외)
// 승급 시 기본지급, 승급지급, 추가지급 모두 terminate
const plans = await WeeklyPaymentPlans.find({
  userId: userId,
  planStatus: 'active',
  _id: { $ne: excludePlanId }
});
```

### 2.2 추가지급 병행: 미승급 시에만

**규칙**: 기본/승급 지급 진행 중 + 미승급 → 추가지급 동시 진행 가능

```
7월: 등록 (F1)
     → F1 기본지급 시작

8월: 미승급
     → F1 추가지급 생성
     → F1 기본 + F1 추가 병행 ✅

9월: F2 승급
     → F1 기본 terminate
     → F1 추가 terminate
     → F2 기본 시작
```

---

## 3. 상세 시나리오

### 시나리오 A: 등록 → 미승급 → 미승급

```
7월: 등록 (F1 기본 시작)
8월: 미승급 → F1 추가1 생성
9월: 미승급 → F1 추가2 생성

진행 중인 플랜:
- F1 기본 (7월분)
- F1 추가1 (8월분) ← 병행!
- F1 추가2 (9월분) ← 병행!
```

### 시나리오 B: 등록 → 미승급 → 승급

```
7월: 등록 (F1 기본 시작)
8월: 미승급 → F1 추가1 생성
9월: F2 승급

9월 처리 결과:
- F1 기본: ❌ terminated
- F1 추가1: ❌ terminated
- F2 기본: ✅ 시작
```

### 시나리오 C: 등록 → 승급 → 승급 (연속 승급)

```
7월: 등록 (F1)
8월: F2 승급
9월: F3 승급

결과:
- 7월 F1 기본 → 8월 F2 첫 지급일부터 terminated
- 8월 F2 기본 → 9월 F3 첫 지급일부터 terminated
- 9월 F3 기본 → active
```

---

## 4. 지급 일정 예시

### 등록 후 첫 지급까지

```
10/5 등록 → 첫 지급일 = 등록일 이후 첫 금요일 + 4주
           = 10/10(금) + 4주 = 11/7(금)
```

### 승급 후 terminate 시점

```
10/5 등록 (F1)
10/20 승급 (F2)

F1 첫 지급일: 11/7 (등록일 기준)
F2 첫 지급일: 11/21 (승급일 기준)

결과:
- 11/7: F1 지급 ✅
- 11/14: F1 지급 ✅
- 11/21: F2 지급 ✅, F1 terminated ❌
```

---

## 5. 보험 조건 (v8.0 변경)

### 5.1 등급별 보험 요건

| 등급 | 보험 필수 | 필요 금액 | 비고 |
|------|----------|----------|------|
| F1 | ❌ | - | 보험 불필요 |
| F2 | ❌ | - | 보험 불필요 |
| F3 | ❌ | - | 보험 불필요 (v8.0 변경) |
| F4 | ✅ | 7만원 | 승급 후 1달 내 가입 필요 |
| F5 | ✅ | 7만원 | |
| F6 | ✅ | 9만원 | |
| F7 | ✅ | 9만원 | |
| F8 | ✅ | 11만원 | |

### 5.2 보험 미가입 시 처리 (F4-F8)

**규칙**: 추가지급 계획은 생성하되, 보험 미가입 시 **skip + 횟수 증가**

```
F4 승급 → 추가지급 계획 생성 (10회)
↓
지급일 도래 (보험 미가입)
↓
지급: ❌ skip
횟수: ✅ 증가 (지급한 것으로 인정)
status: 'skipped'
↓
이후 보험 가입 시
↓
남은 회차부터 정상 지급
```

**예시**:
```
F4 추가지급 10회 중:
- 1회: 보험 미가입 → skip (횟수 1/10)
- 2회: 보험 미가입 → skip (횟수 2/10)
- 3회: 보험 가입 → paid ✅ (횟수 3/10)
- 4~10회: 보험 유지 → paid ✅
```

### 5.3 코드 구현

**weeklyPaymentService.js** - `checkInsuranceCondition`:
```javascript
// F1-F3: 보험 불필요 → null 반환
// F4-F8: 보험 부족 시 → { skip: true, reason: ... } 반환

if (!gradeLimit?.insuranceRequired) {
  return null;  // 보험 불필요
}

if (insuranceAmount < requiredAmount) {
  return {
    skip: true,
    reason: `insufficient_insurance_amount: ${insuranceAmount} < ${requiredAmount}`
  };
}
```

---

## 6. installment 상태 변화

| 상태 | 설명 |
|------|------|
| `pending` | 지급 대기 |
| `paid` | 지급 완료 |
| `skipped` | 보험 미가입으로 건너뜀 (횟수는 증가) |
| `terminated` | 승급으로 인해 중단 |

### plan 상태

| 상태 | 설명 |
|------|------|
| `active` | 진행 중 |
| `completed` | 10회 모두 완료 |
| `terminated` | 승급으로 인해 중단 |

---

## 7. 규칙 요약표

| 상황 | 기본지급 | 승급지급 | 추가지급 |
|------|---------|---------|---------|
| 승급 발생 | ❌ terminate | ❌ terminate | ❌ terminate |
| 미승급 (추가지급 조건) | 계속 진행 | 계속 진행 | ✅ 새로 생성 + 병행 |
| 10회 완료 | completed | completed | completed |

---

## 8. 핵심 원칙

> **승급하면 모든 기존 지급이 멈춘다.**
> (기본지급, 승급지급, 추가지급 모두)

> **추가지급 병행은 미승급 상태에서만 가능하다.**
> (기본/승급 진행 중 + 미승급 → 추가지급 생성 및 병행)

---

## 9. 관련 코드 파일

- [step4_createPlans.js](../apps/web/src/lib/server/services/registration/step4_createPlans.js)
  - `terminateActivePlansFromDate()`: 승급 시 모든 기존 플랜 종료
  - `createInitialPaymentPlan()`: 기본지급 생성
  - `createPromotionPaymentPlan()`: 승급지급 생성
  - `createAdditionalPaymentPlan()`: 추가지급 생성

- [step3_paymentTargets.js](../apps/web/src/lib/server/services/registration/step3_paymentTargets.js)
  - 지급 대상자 분류 (승급자, 미승급 등록자, 추가지급 대상자)

- [weeklyPaymentService.js](../apps/web/src/lib/server/services/weeklyPaymentService.js)
  - `processWeeklyPayments()`: 매주 금요일 지급 처리
  - `checkInsuranceCondition()`: 보험 조건 확인 (F4-F8)
  - 보험 미가입 시 skip + 횟수 증가 로직

- [constants.js](../apps/web/src/lib/server/utils/constants.js)
  - `GRADE_LIMITS`: 등급별 보험 조건 정의

---

**작성자**: Claude (AI Assistant)
**검토일**: 2025-12-07
