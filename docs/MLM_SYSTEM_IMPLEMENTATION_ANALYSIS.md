# MLM ì‹œìŠ¤í…œ êµ¬í˜„ ë¶„ì„ ë¬¸ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 9ì›” 21ì¼
**ì‹œìŠ¤í…œëª…**: ë‚˜ëˆ”í˜ì´ MLM ìš©ì—­ë¹„ ì§€ê¸‰ ì‹œìŠ¤í…œ

---

## ğŸ“Œ ì‹œìŠ¤í…œ í•µì‹¬ ê°œìš”

### ì‹œìŠ¤í…œì˜ 5ëŒ€ í•µì‹¬ ê¸°ëŠ¥
1. **ìš©ì—­ì ë“±ë¡** - ë§¤ì¶œì˜ ì‹œì‘ì 
2. **ë“±ê¸‰ ìë™ ê³„ì‚°** - 2ì§„ íŠ¸ë¦¬ êµ¬ì¡° ê¸°ë°˜
3. **ë§¤ì¶œ ìë™ ë°œìƒ** - ë“±ë¡ ì¦‰ì‹œ ë§¤ì¶œ ìƒì„±
4. **ë“±ê¸‰ë³„ ì°¨ë“± ì§€ê¸‰** - ëˆ„ì ì‹ ê³„ì‚°
5. **ì£¼ê°„ ë¶„í•  ì§€ê¸‰** - 10ì£¼ê°„ ìë™ ë¶„í• 

---

## 1ï¸âƒ£ ìš©ì—­ì ë“±ë¡ ì‹œìŠ¤í…œ

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /routes/api/admin/users/register/+server.js  (ê°œë³„ ë“±ë¡)
- /routes/api/admin/users/bulk/+server.js      (ì—‘ì…€ ì¼ê´„ ë“±ë¡)
- /lib/server/models/User.js                    (ì‚¬ìš©ì ëª¨ë¸)
```

### ğŸ’¡ êµ¬í˜„ ë‚´ìš©
```javascript
// ìš©ì—­ì ë“±ë¡ ì‹œ ìë™ ì²˜ë¦¬
1. loginId ìë™ ìƒì„± (í•œê¸€ ì´ë¦„ ê¸°ë°˜)
   - ì¤‘ë³µ ì‹œ A, B, C ì ‘ë¯¸ì‚¬ ì¶”ê°€

2. 2ì§„ íŠ¸ë¦¬ ìœ„ì¹˜ ì§€ì •
   - parentId: ë¶€ëª¨ ë…¸ë“œ
   - position: 'L' or 'R'
   - leftChildId, rightChildId ìë™ ì—…ë°ì´íŠ¸

3. ë“±ë¡ ì¦‰ì‹œ BatchProcessor ì‹¤í–‰
   - ì „ì²´ ë“±ê¸‰ ì¬ê³„ì‚°
   - ë§¤ì¶œ ê³„ì‚°
   - ì§€ê¸‰ ìŠ¤ì¼€ì¤„ ìƒì„±
```

### âœ… ê²€ì¦ ìƒíƒœ
- ê°œë³„ ë“±ë¡: ì •ìƒ ì‘ë™
- ì—‘ì…€ ì¼ê´„ ë“±ë¡: ì •ìƒ ì‘ë™
- í•œê¸€ loginId: êµ¬í˜„ ì™„ë£Œ
- íŠ¸ë¦¬ êµ¬ì¡° ìœ ì§€: ê²€ì¦ ì™„ë£Œ

---

## 2ï¸âƒ£ ë“±ê¸‰ ê³„ì‚° ì‹œìŠ¤í…œ

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /lib/server/services/gradeCalculation.js
- /lib/server/services/treeExtractor.js
```

### ğŸ’¡ ë“±ê¸‰ ì¡°ê±´ (work_plan.txt ê¸°ì¤€)
```javascript
F1: ìì‹ 0ê°œ ë˜ëŠ” 1ê°œ
F2: ì¢Œìš° ìì‹ ëª¨ë‘ ìˆìŒ
F3: í•˜ìœ„ F2ê°€ 2ê°œ && ì¢Œìš° ê° 1ê°œì”©
F4: í•˜ìœ„ F3ê°€ 2ê°œ && ì¢Œìš° ê° 1ê°œì”©
F5: í•˜ìœ„ F4ê°€ 2ê°œ && (ì¢Œ2ìš°1 ë˜ëŠ” ì¢Œ1ìš°2)
F6: í•˜ìœ„ F5ê°€ 2ê°œ && (ì¢Œ2ìš°1 ë˜ëŠ” ì¢Œ1ìš°2)
F7: í•˜ìœ„ F6ê°€ 2ê°œ && (ì¢Œ2ìš°1 ë˜ëŠ” ì¢Œ1ìš°2)
F8: í•˜ìœ„ F7ê°€ 2ê°œ && (ì¢Œ2ìš°1 ë˜ëŠ” ì¢Œ1ìš°2)
```

### ğŸ’¡ êµ¬í˜„ ë¡œì§
```javascript
// gradeCalculation.js
async function calculateGrade(userId) {
  const tree = await extractDescendants(userId);

  // 1. ì§ê³„ ìì‹ í™•ì¸ (F1, F2 íŒì •)
  if (!leftChild && !rightChild) return 'F1';
  if (!leftChild || !rightChild) return 'F1';
  if (leftChild && rightChild) {
    // 2. í•˜ìœ„ ë“±ê¸‰ ë¶„í¬ ê³„ì‚°
    const gradeCount = countGradesInSubtree(tree);

    // 3. ë“±ê¸‰ë³„ ì¡°ê±´ ì²´í¬
    if (checkF8Conditions(gradeCount)) return 'F8';
    if (checkF7Conditions(gradeCount)) return 'F7';
    // ... ìˆœì°¨ì  ì²´í¬
  }
}
```

### âœ… ê²€ì¦ ìƒíƒœ
- íŠ¸ë¦¬ ì¶”ì¶œ: ì •ìƒ ì‘ë™
- ë“±ê¸‰ ê³„ì‚° ë¡œì§: ì •ìƒ ì‘ë™
- ì¬ê·€ì  ê³„ì‚°: êµ¬í˜„ ì™„ë£Œ
- 0ëª… ì²˜ë¦¬: ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ

---

## 3ï¸âƒ£ ë§¤ì¶œ ë°œìƒ ì‹œìŠ¤í…œ

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /lib/server/models/MonthlyRevenue.js
- /lib/server/services/revenueCalculation.js
- /lib/server/services/batchProcessor.js
```

### ğŸ’¡ ë§¤ì¶œ ê³„ì‚° ê³µì‹
```javascript
// ë§¤ì¶œ ë°œìƒ ì‹œì : ìš©ì—­ì ë“±ë¡ ì›”
ì´ë§¤ì¶œ = ì‹ ê·œ ê°€ì…ì ìˆ˜ Ã— 1,000ë§Œì›
íšŒë‹¹ ì§€ê¸‰ì•¡ = ì´ë§¤ì¶œ Ã· 10íšŒ
```

### ğŸ’¡ MonthlyRevenue ìŠ¤í‚¤ë§ˆ
```javascript
{
  year: 2025,
  month: 9,
  newUsersCount: 6,           // ì‹ ê·œ ê°€ì…ì
  totalRevenue: 60000000,      // 6ì²œë§Œì›
  revenuePerInstallment: 6000000, // 600ë§Œì›/íšŒ
  gradeDistribution: {         // ë“±ê¸‰ë³„ ì¸ì›
    F1: 5, F2: 1, F3: 0, ...
  },
  gradePayments: {             // ë“±ê¸‰ë³„ íšŒë‹¹ ì§€ê¸‰ì•¡
    F1: 240000,
    F2: 1440000,
    ...
  }
}
```

### âœ… ê²€ì¦ ìƒíƒœ
- ì›”ë³„ ë§¤ì¶œ ê³„ì‚°: ì •ìƒ ì‘ë™
- ìë™ ê³„ì‚° íŠ¸ë¦¬ê±°: êµ¬í˜„ ì™„ë£Œ
- ì¤‘ë³µ ê³„ì‚° ë°©ì§€: êµ¬í˜„ ì™„ë£Œ

---

## 4ï¸âƒ£ ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ê³„ì‚°

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /lib/server/services/batchProcessor.js (calculateGradePayments)
- /lib/server/services/revenueCalculation.js
```

### ğŸ’¡ ëˆ„ì ì‹ ê³„ì‚° ë°©ì‹
```javascript
// ë“±ê¸‰ë³„ ë¹„ìœ¨
const gradeRatios = {
  F1: 24%, F2: 19%, F3: 14%, F4: 9%,
  F5: 5%, F6: 3%, F7: 2%, F8: 1%
};

// ì§€ê¸‰ì•¡ ê³„ì‚° (íšŒë‹¹)
F1_ì§€ê¸‰ì•¡ = (ì´ë§¤ì¶œ/10 Ã— 24%) Ã· (F1ì¸ì› + F2ì¸ì›)

F2_ì§€ê¸‰ì•¡ = F1_ì§€ê¸‰ì•¡ + [(ì´ë§¤ì¶œ/10 Ã— 19%) Ã· (F2ì¸ì› + F3ì¸ì›)]

F3_ì§€ê¸‰ì•¡ = F2_ì§€ê¸‰ì•¡ + [(ì´ë§¤ì¶œ/10 Ã— 14%) Ã· (F3ì¸ì› + F4ì¸ì›)]

// 0ëª… ì²˜ë¦¬
if (F3ì¸ì› + F4ì¸ì› === 0) {
  F3_ì§€ê¸‰ì•¡ = F2_ì§€ê¸‰ì•¡;  // ì´ì „ ë“±ê¸‰ ê¸ˆì•¡ ìœ ì§€
}
```

### ğŸ’¡ ì‹¤ì œ êµ¬í˜„ ì½”ë“œ
```javascript
// batchProcessor.js - calculateGradePayments()
const f1Total = revenuePerInstallment * 0.24;
const f1Divisor = gradeCount.F1 + gradeCount.F2;
gradePayments.F1 = f1Divisor > 0 ? f1Total / f1Divisor : 0;

const f2Total = revenuePerInstallment * 0.19;
const f2Divisor = gradeCount.F2 + gradeCount.F3;
gradePayments.F2 = f2Divisor > 0 ?
  (f2Total / f2Divisor) + gradePayments.F1 : gradePayments.F1;
```

### âœ… ê²€ì¦ ìƒíƒœ
- ëˆ„ì ì‹ ê³„ì‚°: ì •ìƒ ì‘ë™
- 0ëª… ì²˜ë¦¬: ì •ìƒ ì‘ë™
- ì†Œìˆ˜ì  ì²˜ë¦¬: Math.floor ì ìš©

---

## 5ï¸âƒ£ ì§€ê¸‰ ìŠ¤ì¼€ì¤„ ì‹œìŠ¤í…œ

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /lib/server/models/UserPaymentPlan.js   (ê°œì¸ë³„ ì§€ê¸‰ ê³„íš)
- /lib/server/models/WeeklyPayment.js     (ì£¼ë³„ ì‹¤ì œ ì§€ê¸‰)
- /lib/server/services/paymentService.js
```

### ğŸ’¡ ì§€ê¸‰ ìŠ¤ì¼€ì¤„ ê·œì¹™
```
Nì›” ë§¤ì¶œ â†’ N+1ì›”ë¶€í„° 10ì£¼ê°„ ë¶„í•  ì§€ê¸‰

ì˜ˆì‹œ: 9ì›” ë§¤ì¶œ
- 1íšŒì°¨: 10ì›” 1ì£¼ì°¨
- 2íšŒì°¨: 10ì›” 2ì£¼ì°¨
- 3íšŒì°¨: 10ì›” 3ì£¼ì°¨
- 4íšŒì°¨: 10ì›” 4ì£¼ì°¨
- 5íšŒì°¨: 11ì›” 1ì£¼ì°¨
- 6íšŒì°¨: 11ì›” 2ì£¼ì°¨
- ...
- 10íšŒì°¨: 12ì›” 2ì£¼ì°¨
```

### ğŸ’¡ UserPaymentPlan êµ¬ì¡°
```javascript
{
  revenueMonth: { year: 2025, month: 9 },
  userId: "í™ê¸¸ë™",
  grade: "F2",  // 9ì›” ë‹¹ì‹œ ë“±ê¸‰ (ê³ ì •)
  amountPerInstallment: 1440000,  // íšŒë‹¹ ì§€ê¸‰ì•¡ (ê³ ì •)
  installments: [
    {
      installmentNumber: 1,
      scheduledDate: { year: 2025, month: 10, week: 1 },
      amount: 1440000,
      status: "pending"
    },
    // ... 10íšŒë¶„
  ]
}
```

### âš ï¸ í•µì‹¬ ì›ì¹™: ë“±ê¸‰ ê³ ì •
```javascript
// ë§¤ì¶œ ë°œìƒ ì‹œì (9ì›”)ì˜ ë“±ê¸‰ê³¼ ê¸ˆì•¡ìœ¼ë¡œ ê³ ì •
// 10ì›”ì— ë“±ê¸‰ì´ ë³€ê²½ë˜ì–´ë„ 9ì›” ë§¤ì¶œì˜ ì§€ê¸‰ì•¡ì€ ë¶ˆë³€
const paymentPlan = new UserPaymentPlan({
  grade: user.grade,  // 9ì›” ë“±ê¸‰ ì €ì¥
  amountPerInstallment: gradePayments[user.grade],  // 9ì›” ê¸ˆì•¡ ê³ ì •
});
```

### âœ… ê²€ì¦ ìƒíƒœ
- 10ì£¼ ìŠ¤ì¼€ì¤„ ìƒì„±: ì •ìƒ ì‘ë™
- ë“±ê¸‰ ê³ ì • ì›ì¹™: êµ¬í˜„ ì™„ë£Œ
- ì›ì²œì§•ìˆ˜ 3.3%: êµ¬í˜„ ì™„ë£Œ

---

## 6ï¸âƒ£ BatchProcessor (ìë™ ì²˜ë¦¬ ì—”ì§„)

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /lib/server/services/batchProcessor.js
```

### ğŸ’¡ ìë™ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤
```javascript
ìš©ì—­ì ë“±ë¡ â†’ BatchProcessor.processNewUsers() ì‹¤í–‰

1ë‹¨ê³„: recalculateGrades()
  - ì „ì²´ íŠ¸ë¦¬ ìˆœíšŒ
  - ëª¨ë“  ì‚¬ìš©ì ë“±ê¸‰ ì¬ê³„ì‚°

2ë‹¨ê³„: calculateMonthlyRevenue()
  - ì´ë²ˆë‹¬ ì‹ ê·œ ê°€ì…ì ìˆ˜ ê³„ì‚°
  - ì´ë§¤ì¶œ ê³„ì‚°
  - ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ ê³„ì‚°
  - MonthlyRevenue ì €ì¥

3ë‹¨ê³„: createPaymentSchedules()
  - 10ì£¼ ì§€ê¸‰ ì¼ì • ìƒì„±
  - ì£¼ì°¨ë³„ ë‚ ì§œ ê³„ì‚°

4ë‹¨ê³„: createUserPaymentPlans()
  - ê°œì¸ë³„ ì§€ê¸‰ ê³„íš ìƒì„±
  - ë“±ê¸‰ê³¼ ê¸ˆì•¡ ê³ ì •
  - UserPaymentPlan ì €ì¥
```

### âœ… ê²€ì¦ ìƒíƒœ
- ìë™ ì‹¤í–‰: ì •ìƒ ì‘ë™
- íŠ¸ëœì­ì…˜ ì²˜ë¦¬: êµ¬í˜„ í•„ìš”
- ì—ëŸ¬ í•¸ë“¤ë§: ê¸°ë³¸ êµ¬í˜„

---

## 7ï¸âƒ£ ì£¼ë³„ ì§€ê¸‰ ì²˜ë¦¬

### ğŸ“‚ ê´€ë ¨ íŒŒì¼
```
- /routes/api/admin/payment/weekly/+server.js
- /lib/server/models/WeeklyPayment.js
```

### ğŸ’¡ WeeklyPayment êµ¬ì¡°
```javascript
{
  userId: ObjectId,
  year: 2025,
  month: 10,
  week: 1,
  installments: [
    {
      revenueYear: 2025,
      revenueMonth: 9,
      installmentNumber: 1,
      amount: 1440000
    }
  ],
  totalAmount: 1440000,
  taxAmount: 47520,    // 3.3%
  netAmount: 1392480   // ì‹¤ì§€ê¸‰ì•¡
}
```

### âœ… ê²€ì¦ ìƒíƒœ
- ì£¼ë³„ ì§‘ê³„: êµ¬í˜„ ì™„ë£Œ
- ì›ì²œì§•ìˆ˜ ê³„ì‚°: ì •ìƒ ì‘ë™
- ë‹¤ì¤‘ ë§¤ì¶œì› ì²˜ë¦¬: ì„¤ê³„ ì™„ë£Œ

---

## ğŸ“Š í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ (2025.09.21)

### ë°ì´í„° í˜„í™©
```
- ì´ ìš©ì—­ì: 6ëª… (9ì›” ë“±ë¡)
- ë“±ê¸‰ ë¶„í¬: F1(5ëª…), F2(1ëª…)
- 9ì›” ì´ë§¤ì¶œ: 6ì²œë§Œì›
- íšŒë‹¹ ì§€ê¸‰ì•¡: 600ë§Œì›
- ì§€ê¸‰ ê¸°ê°„: 10ì›” 1ì£¼ì°¨ ~ 12ì›” 2ì£¼ì°¨
```

### ë“±ê¸‰ë³„ ì§€ê¸‰ì•¡ (íšŒë‹¹)
```
F1: 240,000ì› Ã— 5ëª… = 1,200,000ì›
F2: 1,440,000ì› Ã— 1ëª… = 1,440,000ì›
----------------------------------
í•©ê³„: 2,640,000ì›/íšŒ
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê°œì„  í•„ìš” ì‚¬í•­

### 1. íŠ¸ëœì­ì…˜ ì²˜ë¦¬
- í˜„ì¬: ê° ë‹¨ê³„ë³„ ë…ë¦½ ì‹¤í–‰
- í•„ìš”: ì „ì²´ ê³¼ì • íŠ¸ëœì­ì…˜ ë¬¶ìŒ ì²˜ë¦¬

### 2. ë™ì‹œì„± ì œì–´
- í˜„ì¬: ë™ì‹œ ë“±ë¡ ì‹œ ì¶©ëŒ ê°€ëŠ¥
- í•„ìš”: Queue ë˜ëŠ” Lock ë©”ì»¤ë‹ˆì¦˜

### 3. ì¬ê³„ì‚° ê¸°ëŠ¥
- í˜„ì¬: ìˆ˜ë™ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- í•„ìš”: ê´€ë¦¬ì UIì—ì„œ ì¬ê³„ì‚° ë²„íŠ¼

### 4. ì§€ê¸‰ ì‹¤í–‰
- í˜„ì¬: WeeklyPayment ìƒì„±ë§Œ
- í•„ìš”: ì‹¤ì œ ì†¡ê¸ˆ ì—°ë™ (ì€í–‰ API)

### 5. ê°ì‚¬ ë¡œê·¸
- í˜„ì¬: ê¸°ë³¸ ë¡œê¹…ë§Œ
- í•„ìš”: ëª¨ë“  ê¸ˆì•¡ ë³€ê²½ ì´ë ¥ ì¶”ì 

---

## ğŸ“ ì£¼ìš” ìŠ¤í¬ë¦½íŠ¸

### ë°ì´í„° ì´ˆê¸°í™”
```bash
node scripts/reset-all-data.js
```

### ë“±ê¸‰ ì¬ê³„ì‚°
```bash
node scripts/recalculate-grades.js
```

### ë§¤ì¶œ ì¬ê³„ì‚°
```bash
node scripts/fix-monthly-revenue.js
```

### íŠ¸ë¦¬ êµ¬ì¡° í™•ì¸
```bash
node scripts/check-tree-structure.js
```

---

## ğŸ” ë””ë²„ê¹… íŒ

### 1. ë“±ê¸‰ì´ ì˜ëª» ê³„ì‚°ë  ë•Œ
```javascript
// check-tree-structure.js ì‹¤í–‰
// íŠ¸ë¦¬ êµ¬ì¡°ì™€ ë“±ê¸‰ ì¡°ê±´ í™•ì¸
```

### 2. ë§¤ì¶œì´ 0ì›ì¼ ë•Œ
```javascript
// MonthlyRevenue ì»¬ë ‰ì…˜ í™•ì¸
// newUsersCount í•„ë“œ ì²´í¬
```

### 3. ì§€ê¸‰ì•¡ì´ ì—†ì„ ë•Œ
```javascript
// UserPaymentPlan ì»¬ë ‰ì…˜ í™•ì¸
// gradeì™€ amountPerInstallment í™•ì¸
```

---

**ë¬¸ì„œ ì‘ì„±**: Claude Code Assistant
**ìµœì¢… ê²€í† **: 2025.09.21