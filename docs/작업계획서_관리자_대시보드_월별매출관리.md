# 작업 계획서: 관리자 대시보드 월별 매출 관리 기능

**작성일**: 2025-10-15
**버전**: v7.1
**목적**: MonthlyRegistrations 기반 월별 통계 표출 및 매출액 수동 조정 기능

---

## 📋 프로젝트 개요

### 배경
- v7.0에서 MonthlyRegistrations에 지급 대상자 정보(paymentTargets)와 등급 분포(gradeDistribution) 저장 구조 확립
- 현재 관리자 대시보드의 GradePaymentCard는 전체 사용자 기준으로 구성되어 월별 통계와 불일치
- 매출 계산이 자동화되었으나, 예외 상황(오류 수정, 특수 인센티브)을 위한 수동 조정 기능 필요

### 목표
1. **월별 매출 통계 대시보드** 구축
   - 용역비 지급명부와 동일한 UI/UX (날짜/기간 선택)
   - MonthlyRegistrations 기반 등급별 통계 표출
   - 자동 매출 vs 수동 매출 명확한 구분

2. **매출액 수동 조정 기능**
   - 관리자가 월별 매출액을 수동으로 설정 가능
   - 지급 계획 자동 재생성
   - 변경 이력 로깅 및 감사 추적

3. **안전 장치**
   - 이미 지급 진행 중인 월 수정 시 경고
   - 관리자 권한 검증
   - 변경 사유 기록

---

## 🎯 작업 범위

### Phase 1: 데이터 모델 및 API (백엔드)
**예상 기간**: 2-3일

#### 1.1 MonthlyRegistrations 스키마 수정
- [x] 기존 필드 확인
  - `totalRevenue`: 자동 계산 매출
  - `adjustedRevenue`: 수동 설정 매출 (이미 존재)
- [ ] 신규 필드 추가
  ```javascript
  {
    isManualRevenue: Boolean,           // 수동 설정 여부
    revenueModifiedBy: ObjectId,        // 수정한 관리자 ID
    revenueModifiedAt: Date,            // 수정 시각
    revenueChangeReason: String,        // 변경 사유
    revenueChangeHistory: [{            // 변경 이력
      previousRevenue: Number,
      newRevenue: Number,
      modifiedBy: ObjectId,
      modifiedAt: Date,
      reason: String
    }]
  }
  ```

#### 1.2 매출 변경 API 구현
- [ ] `POST /api/admin/revenue/adjust` 생성
  - 파라미터:
    ```javascript
    {
      monthKey: "2025-10",
      adjustedRevenue: 5000000,
      reason: "회계 조정 - 특별 인센티브",
      force: false  // paid 있어도 강제 실행
    }
    ```
  - 응답:
    ```javascript
    {
      success: true,
      message: "매출이 변경되고 60개의 지급 계획이 재생성되었습니다",
      details: {
        previousRevenue: 3000000,
        newRevenue: 5000000,
        deletedPlans: 60,
        recreatedPlans: 60,
        affectedUsers: 6,
        paidInstallments: 12
      }
    }
    ```

#### 1.3 지급 상태 확인 로직
- [ ] `checkPaymentStatus(monthKey)` 함수
  - 해당 월의 WeeklyPaymentPlans 중 paid 상태 확인
  - 반환: `{ hasPaid: boolean, paidCount: number, totalCount: number }`

#### 1.4 지급 계획 재생성 서비스
- [ ] `regeneratePaymentPlans(monthKey, newRevenue)` 함수
  - Step 1: MonthlyRegistrations 조회 (paymentTargets, gradeDistribution)
  - Step 2: 기존 WeeklyPaymentPlans 삭제 (revenueMonth = monthKey)
  - Step 3: 새 매출 기준으로 금액 재계산
  - Step 4: paymentTargets 기준으로 계획 재생성
    - 등록자 → 기본지급 10회
    - 승급자 → 기본지급 10회
    - 추가지급 대상자 → 추가지급 10회
  - Step 5: WeeklyPaymentSummary 재계산

#### 1.5 월별 통계 조회 API
- [ ] `GET /api/admin/revenue/monthly?monthKey=2025-10` 생성
  - MonthlyRegistrations 조회
  - 응답:
    ```javascript
    {
      monthKey: "2025-10",
      totalRevenue: 5000000,
      adjustedRevenue: null,
      isManualRevenue: false,
      registrationCount: 5,
      paymentTargets: {
        registrants: [...],
        promoted: [...],
        additionalPayments: [...]
      },
      gradeDistribution: { F1: 7, F2: 2, F3: 1 },
      paymentStatus: {
        hasPaid: false,
        paidCount: 0,
        totalCount: 100
      }
    }
    ```

- [ ] `GET /api/admin/revenue/range?start=2025-07&end=2025-10` 생성
  - 기간별 MonthlyRegistrations 조회
  - 월별 데이터 배열 반환

---

### Phase 2: UI 컴포넌트 (프론트엔드)
**예상 기간**: 3-4일

#### 2.1 GradePaymentCard 개편
**위치**: `/home/doowon/project/my/nanumpay/apps/web/src/lib/components/admin/GradePaymentCard.svelte`

**현재 문제점**:
- 전체 사용자 기준 통계 (월별 개념 없음)
- MonthlyRegistrations와 불일치

**새로운 구조**:
```
┌─────────────────────────────────────────────────────┐
│ 📊 월별 매출 및 등급 통계                          │
├─────────────────────────────────────────────────────┤
│ 조회 기간:                                          │
│  ○ 단일 월  ◉ 기간                                 │
│                                                     │
│  [2025-10] ↔ [2025-10]  [조회]                    │
│                                                     │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 2025-10월 현황                                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                     │
│ 📈 매출 정보                                        │
│   자동 매출: 5,000,000원 (등록자 5명)              │
│   수동 매출: 설정 안 됨                            │
│   └─ [수동 설정] 버튼                              │
│                                                     │
│ 👥 지급 대상자                                      │
│   • 등록자: 5명                                    │
│   • 승급자: 2명                                    │
│   • 추가지급: 3명                                  │
│   • 총 대상자: 10명                                │
│                                                     │
│ 📊 등급별 분포 및 지급액 (10명 기준)               │
│ ┌──────┬──────┬─────────┬──────────────┐      │
│ │ 등급 │ 인원 │ 1회지급액 │ 총지급예정액   │      │
│ ├──────┼──────┼─────────┼──────────────┤      │
│ │ F1   │  7명 │  14,285원 │ 1,000,000원  │      │
│ │ F2   │  2명 │  48,000원 │   960,000원  │      │
│ │ F3   │  1명 │ 112,000원 │ 1,120,000원  │      │
│ ├──────┼──────┼─────────┼──────────────┤      │
│ │ 합계 │ 10명 │          │ 5,000,000원  │      │
│ └──────┴──────┴─────────┴──────────────┘      │
│                                                     │
│ ⚙️ 지급 상태                                        │
│   ✅ 대기 중 (변경 가능)                           │
│   • 총 계획: 100개 (10명 × 10회)                  │
│   • 완료: 0개                                      │
│   • 대기: 100개                                    │
└─────────────────────────────────────────────────────┘
```

**기간 조회 시**:
```
┌─────────────────────────────────────────────────────┐
│ 📊 월별 매출 및 등급 통계                          │
├─────────────────────────────────────────────────────┤
│ 조회 기간: 2025-07 ~ 2025-10                       │
│                                                     │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                     │
│ 2025-07월 │ 2025-08월 │ 2025-09월 │ 2025-10월    │
│ [상세]    │ [상세]    │ [상세]    │ [상세]       │
│                                                     │
│ 월별 누적 테이블:                                   │
│ ┌──────┬─────────┬──────┬──────┬─────────┐    │
│ │ 월   │ 매출액   │등록자│대상자│ 지급완료  │    │
│ ├──────┼─────────┼──────┼──────┼─────────┤    │
│ │07월  │3,000,000│  3명 │  3명 │ 30/30   │    │
│ │08월  │3,000,000│  3명 │  6명 │ 48/60   │    │
│ │09월  │4,000,000│  4명 │  9명 │ 12/90   │    │
│ │10월  │5,000,000│  5명 │ 10명 │  0/100  │    │
│ └──────┴─────────┴──────┴──────┴─────────┘    │
│                                                     │
│ 📈 기간 합계                                        │
│   • 총 매출: 15,000,000원                          │
│   • 총 등록자: 15명                                │
│   • 평균 월 매출: 3,750,000원                      │
└─────────────────────────────────────────────────────┘
```

#### 2.2 매출 수동 설정 모달
**컴포넌트**: `RevenueAdjustModal.svelte` (신규)

```
┌─────────────────────────────────────────┐
│ 📝 매출 수동 설정                      │
├─────────────────────────────────────────┤
│                                         │
│ 대상 월: 2025-10                       │
│                                         │
│ 현재 매출:                              │
│   자동 계산: 5,000,000원 (등록자 5명)  │
│                                         │
│ 새 매출액:                              │
│   [8,000,000] 원                       │
│                                         │
│ 변경 사유: (선택)                       │
│   [특별 인센티브 포함____________]     │
│                                         │
│ ⚠️ 주의사항                            │
│   • 모든 지급 계획이 재생성됩니다       │
│   • 변경 이력이 기록되며 감사됩니다     │
│   • 긴급 상황에만 사용하세요           │
│                                         │
│ 지급 상태:                              │
│   ✅ 대기 중 (안전하게 변경 가능)      │
│                                         │
│         [취소]  [변경 적용]            │
└─────────────────────────────────────────┘
```

**지급 진행 중일 때**:
```
┌─────────────────────────────────────────┐
│ ⚠️ 경고: 이미 지급이 진행된 월입니다   │
├─────────────────────────────────────────┤
│                                         │
│ 2025-09월                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 완료된 지급: 12건 (144,000원)       │
│ • 대기 중인 지급: 48건                 │
│                                         │
│ 매출을 변경하면:                        │
│ ✓ 모든 지급 계획 삭제                  │
│ ✓ 새 매출 기준으로 재생성              │
│ ⚠️ 이미 지급된 금액과 향후 금액이      │
│    달라질 수 있습니다!                 │
│                                         │
│ 변경 사유: (필수)                       │
│   [회계 오류 수정_____________]        │
│                                         │
│ □ 위험성을 이해했으며 변경을 원합니다   │
│                                         │
│     [취소]  [변경 진행 (위험)]         │
└─────────────────────────────────────────┘
```

#### 2.3 변경 이력 표시
- [ ] 매출 수동 설정 시 이력 아이콘 표시
- [ ] 클릭 시 변경 이력 팝오버
  ```
  변경 이력:
  • 2025-10-15 14:30 - 김관리자
    5,000,000원 → 8,000,000원
    사유: 특별 인센티브 포함

  • 2025-09-20 10:15 - 박관리자
    3,000,000원 → 5,000,000원
    사유: 회계 조정
  ```

---

### Phase 3: 서비스 로직 통합
**예상 기간**: 2일

#### 3.1 registrationService.js 수정
- [ ] 매출 계산 시 adjustedRevenue 우선 사용
  ```javascript
  // 기존
  const revenue = registrationCount * 1000000;

  // 수정
  const autoRevenue = registrationCount * 1000000;
  const finalRevenue = monthlyReg.adjustedRevenue || autoRevenue;
  ```

#### 3.2 paymentPlanService.js 수정
- [ ] 지급액 계산 시 adjustedRevenue 기준
- [ ] 재생성 시 기존 계획 삭제 로직

#### 3.3 권한 검증
- [ ] 관리자 권한 미들웨어
- [ ] API 엔드포인트별 권한 체크

---

### Phase 4: 테스트 및 검증
**예상 기간**: 2일

#### 4.1 단위 테스트
- [ ] 매출 변경 API 테스트
- [ ] 지급 계획 재생성 테스트
- [ ] 지급 상태 확인 테스트

#### 4.2 통합 테스트
- [ ] 시나리오 1: 지급 전 매출 변경
  - 7월 3명 등록 (자동 3,000,000원)
  - 매출 5,000,000원으로 변경
  - 지급액 확인 (증가 확인)

- [ ] 시나리오 2: 지급 진행 중 매출 변경
  - 8월 3명 등록, 일부 지급 완료
  - 매출 변경 시도
  - 경고 메시지 확인

- [ ] 시나리오 3: 기간 조회
  - 7-10월 기간 조회
  - 월별 통계 정확성 확인

#### 4.3 UI 테스트
- [ ] 반응형 디자인 확인 (모바일, 태블릿, 데스크톱)
- [ ] 접근성 확인
- [ ] 브라우저 호환성

---

## 📂 파일 구조

```
apps/web/src/
├── lib/
│   ├── server/
│   │   ├── models/
│   │   │   └── MonthlyRegistrations.js          # 스키마 수정
│   │   ├── services/
│   │   │   ├── revenueService.js                # 신규 (매출 관리)
│   │   │   ├── registrationService.js           # 수정
│   │   │   └── paymentPlanService.js            # 수정
│   │   └── middleware/
│   │       └── adminAuth.js                     # 권한 검증
│   └── components/
│       └── admin/
│           ├── GradePaymentCard.svelte          # 대폭 수정
│           ├── RevenueAdjustModal.svelte        # 신규
│           └── RevenueHistoryPopover.svelte     # 신규
└── routes/
    ├── (admin)/
    │   └── admin/
    │       └── +page.svelte                     # 유지 (GradePaymentCard 사용)
    └── api/
        └── admin/
            └── revenue/
                ├── adjust/
                │   └── +server.js               # 신규 (매출 변경)
                ├── monthly/
                │   └── +server.js               # 신규 (월별 조회)
                └── range/
                    └── +server.js               # 신규 (기간 조회)
```

---

## 🔐 보안 및 권한

### 관리자 권한 체크
```javascript
// 모든 revenue API에 적용
if (!locals.user || !locals.user.isAdmin) {
  return json({ error: 'Unauthorized' }, { status: 401 });
}
```

### 감사 로그
```javascript
// 모든 매출 변경 시 로그 기록
auditLogger.info('Revenue adjusted', {
  monthKey,
  previousRevenue,
  newRevenue,
  admin: locals.user.name,
  reason,
  timestamp: new Date().toISOString()
});
```

---

## ⚠️ 주의사항 및 제약

### 사용 원칙
1. **기본은 자동 계산**: 수동 조정은 예외 상황에만 사용
2. **지급 전 변경 권장**: 지급 시작 후 변경은 위험성 높음
3. **사유 필수 기록**: 모든 변경은 사유와 함께 기록
4. **감사 대상**: 변경 이력은 감사 시 확인됨

### 제약사항
- ❌ 미래 월은 지급 대상자가 없어서 설정 불가
- ❌ 이미 지급 완료된 월 변경 시 회계 불일치 발생 가능
- ⚠️ 지급 진행 중인 월 변경 시 강력한 경고 필요

### UI 경고 문구
```
⚠️ 주의: 이 기능은 긴급 상황 전용입니다

자동 계산이 정확하므로 특별한 사유가 없다면
수동 조정하지 마세요.

모든 변경은 기록되며 감사 대상입니다.
```

---

## 📊 성공 기준

### 기능적 요구사항
- [x] 월별 매출 통계가 MonthlyRegistrations 기반으로 정확히 표시됨
- [ ] 단일 월/기간 조회 모두 정상 작동
- [ ] 매출 수동 설정 시 지급 계획이 정확히 재생성됨
- [ ] 지급 상태에 따른 경고 메시지 표시
- [ ] 변경 이력 추적 가능

### 비기능적 요구사항
- [ ] 관리자만 접근 가능
- [ ] 모든 변경 사항 로그 기록
- [ ] 반응형 UI (모바일 대응)
- [ ] 페이지 로딩 시간 < 2초
- [ ] API 응답 시간 < 500ms

### 사용성
- [ ] 용역비 지급명부와 일관된 UI/UX
- [ ] 직관적인 날짜 선택 인터페이스
- [ ] 명확한 경고 및 안내 메시지
- [ ] 변경 전 확인 모달

---

## 📅 일정 계획

### Week 1 (예상 5일)
- Day 1-2: Phase 1 (백엔드) - 스키마, API
- Day 3-4: Phase 2 (프론트엔드) - GradePaymentCard 개편
- Day 5: Phase 2 - 모달 및 세부 UI

### Week 2 (예상 4일)
- Day 1: Phase 3 (통합) - 서비스 로직
- Day 2-3: Phase 4 (테스트) - 단위/통합 테스트
- Day 4: Phase 4 - UI 테스트 및 버그 수정

### 총 예상 기간: **9일 (약 2주)**

---

## 🚀 다음 단계

### 즉시 시작 가능한 작업
1. MonthlyRegistrations 스키마 수정
2. `/api/admin/revenue/monthly` API 구현
3. GradePaymentCard.svelte 백업 및 리팩토링 시작

### 병렬 진행 가능
- 백엔드 API 개발과 프론트엔드 UI 개발 병렬 진행
- API 개발 완료 후 통합 테스트

---

## 📝 작업 추적

### 진행 상태 표시
- ⬜ 대기 중
- 🟦 진행 중
- ✅ 완료
- ⚠️ 이슈 발생
- 🔄 재작업 필요

### 마일스톤
1. ⬜ Phase 1 백엔드 완료
2. ⬜ Phase 2 프론트엔드 완료
3. ⬜ Phase 3 통합 완료
4. ⬜ Phase 4 테스트 완료
5. ⬜ 프로덕션 배포

---

**작성자**: Claude (AI Assistant)
**검토자**: 개발팀
**승인자**: 프로젝트 관리자
