# êµ¬í˜„ ë³€ê²½ ê³„íš (v4.0 ì„¤ê³„ ê¸°ì¤€)

## ğŸ“… ì‘ì„±ì¼: 2025-10-04

## 1. ì‚­ì œ ëŒ€ìƒ

### 1.1 MongoDB ì»¬ë ‰ì…˜
```bash
# ì‚­ì œí•  ì»¬ë ‰ì…˜ë“¤
- monthlyrevenues  # APIë¡œ ì‹¤ì‹œê°„ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
- weeklypayments   # userpaymentplansì— í†µí•©
- revenues         # ë¶ˆí•„ìš” (users.createdAt ì‚¬ìš©)
- paymentschedules # userpaymentplansì— í†µí•©
- treestats        # ì‹¤ì‹œê°„ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
```

### 1.2 ëª¨ë¸ íŒŒì¼
```
- /lib/server/models/MonthlyRevenue.js  # ì‚­ì œ
- /lib/server/models/Payment.js ë‚´ MonthlyRevenue, WeeklyPayment ìŠ¤í‚¤ë§ˆ # ì‚­ì œ
- /lib/server/models/Revenue.js (ìˆë‹¤ë©´) # ì‚­ì œ
```

### 1.3 ì„œë¹„ìŠ¤ íŒŒì¼
```
- revenueCalculation.jsì˜ MonthlyRevenue ê´€ë ¨ ì½”ë“œ # ì œê±°
- paymentService.jsì˜ WeeklyPayment ê´€ë ¨ ì½”ë“œ # ì œê±°
```

## 2. ìˆ˜ì • ëŒ€ìƒ

### 2.1 UserPaymentPlan ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
**í˜„ì¬ êµ¬ì¡° â†’ v4.0 êµ¬ì¡°**

```javascript
// ë³€ê²½ ì „
{
  userId, revenueMonth, installments: [...]
}

// ë³€ê²½ í›„ (v4.0)
{
  userId: String,
  revenueMonth: String,
  isManualOverride: Boolean,  // ì¶”ê°€
  manualTotalAmount: Number,   // ì¶”ê°€
  installments: [{
    installmentNumber: Number,
    scheduledDate: Date,
    gradeReferenceDate: Date,
    gradeAtPayment: String,     // ì§€ê¸‰ ì‹œ ì±„ì›Œì§
    calculatedAmount: Number,   // ì§€ê¸‰ ì‹œ ê³„ì‚°
    withholdingTax: Number,
    netAmount: Number,
    status: String,
    blockedReason: String,      // ì¶”ê°€
    paidDate: Date,
    transactionId: String       // ì¶”ê°€
  }],
  isEligible: Boolean,
  ineligibleReason: String,
  totalPaidAmount: Number,
  totalPaidCount: Number
}
```

### 2.2 ë§¤ì¶œ ê³„ì‚° ë¡œì§ ë³€ê²½
```javascript
// ê¸°ì¡´: MonthlyRevenue ì»¬ë ‰ì…˜ì—ì„œ ì¡°íšŒ
const revenue = await MonthlyRevenue.findOne({ year, month });

// ë³€ê²½: ì‹¤ì‹œê°„ ê³„ì‚°
const revenue = await User.countDocuments({
  createdAt: { $gte: startDate, $lt: endDate },
  type: 'user'
}) * 1000000;
```

### 2.3 ì£¼ê°„ ì§€ê¸‰ ì²˜ë¦¬ ë³€ê²½
```javascript
// ê¸°ì¡´: WeeklyPayment ìƒì„±
await WeeklyPayment.create({...});

// ë³€ê²½: UserPaymentPlan ì—…ë°ì´íŠ¸
await UserPaymentPlan.updateOne(
  { userId, 'installments.scheduledDate': friday },
  { $set: {
    'installments.$.status': 'paid',
    'installments.$.paidDate': new Date(),
    'installments.$.calculatedAmount': amount
  }}
);
```

## 3. ì‹ ê·œ ìƒì„±

### 3.1 SystemConfig ì´ˆê¸°í™”
```javascript
// systemConfigs ì»¬ë ‰ì…˜ ìƒì„± ë° ì´ˆê¸° ë°ì´í„°
{
  configType: 'current',
  gradeRatios: {
    F1: 0.24, F2: 0.19, F3: 0.14, F4: 0.09,
    F5: 0.05, F6: 0.03, F7: 0.02, F8: 0.01
  },
  maxPaymentCounts: {
    F1: 20, F2: 30, F3: 40, F4: 40,
    F5: 50, F6: 50, F7: 60, F8: 60
  },
  minInsuranceAmounts: {
    F3: 50000, F4: 50000,
    F5: 70000, F6: 70000,
    F7: 100000, F8: 100000
  },
  withholdingTaxRate: 0.033,
  revenuePerUser: 1000000,
  installmentCount: 10
}
```

### 3.2 ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸
```
- GET /api/admin/revenue/monthly?month=2024-09  # ì›”ê°„ ë§¤ì¶œ ì‹¤ì‹œê°„ ê³„ì‚°
- GET /api/tree/user/:userId?depth=3            # íŠ¸ë¦¬ depth ì œí•œ ì¡°íšŒ
- GET /api/tree/path/:userId                    # ê²½ë¡œ ì¡°íšŒ
```

### 3.3 ê²€ì¦ ë¡œì§ ì¶”ê°€
```javascript
// validateRegistration.js
- ìê¸° ìì‹  íŒë§¤ì¸ ë°©ì§€
- ë£¨íŠ¸ ë…¸ë“œ ë‹¨ì¼ì„± ì²´í¬
- ì¢Œìš° ìë¦¬ ì²´í¬ (ëª¨ë‘ ì°¬ ê²½ìš° ë“±ë¡ ë¶ˆê°€)
```

## 4. ì‘ì—… ìˆœì„œ

### Phase 1: ë°±ì—… ë° ì¤€ë¹„
1. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
2. ê¸°ì¡´ ì½”ë“œ ë°±ì—…

### Phase 2: ì‚­ì œ ì‘ì—…
1. ë¶ˆí•„ìš”í•œ ì»¬ë ‰ì…˜ ì‚­ì œ
2. ê´€ë ¨ ëª¨ë¸ íŒŒì¼ ì‚­ì œ
3. ì°¸ì¡° ì½”ë“œ ì œê±°

### Phase 3: ìˆ˜ì • ì‘ì—…
1. UserPaymentPlan ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
2. ë§¤ì¶œ ê³„ì‚° ë¡œì§ APIë¡œ ë³€ê²½
3. ì§€ê¸‰ ì²˜ë¦¬ ë¡œì§ í†µí•©

### Phase 4: ì‹ ê·œ ìƒì„±
1. SystemConfig ìƒì„± ë° ì´ˆê¸°í™”
2. ìƒˆ API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
3. ê²€ì¦ ë¡œì§ ì¶”ê°€

### Phase 5: í…ŒìŠ¤íŠ¸
1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
2. í†µí•© í…ŒìŠ¤íŠ¸
3. ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

## 5. ì˜í–¥ë°›ëŠ” íŒŒì¼ ëª©ë¡

### ì‚­ì œ
- [ ] models/MonthlyRevenue.js
- [ ] models/Payment.js (ì¼ë¶€)

### ìˆ˜ì •
- [ ] models/UserPaymentPlan.js
- [ ] services/paymentService.js
- [ ] services/revenueCalculation.js
- [ ] services/batchProcessor.js
- [ ] routes/api/admin/revenue/monthly/+server.js
- [ ] routes/api/admin/payment/weekly/+server.js

### ì‹ ê·œ
- [ ] models/SystemConfig.js
- [ ] services/validationService.js
- [ ] routes/api/tree/user/[userId]/+server.js
- [ ] routes/api/tree/path/[userId]/+server.js
- [ ] scripts/init-system-config.js

## 6. ì£¼ì˜ì‚¬í•­

âš ï¸ **ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”**
- ê¸°ì¡´ monthlyrevenues ë°ì´í„°ëŠ” ì‚­ì œ ì „ ë°±ì—…
- ê¸°ì¡´ weeklypayments ë°ì´í„°ëŠ” userpaymentplansë¡œ ë³‘í•©

âš ï¸ **í•˜ìœ„ í˜¸í™˜ì„±**
- API ë³€ê²½ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì • í•„ìš”
- ê¸°ì¡´ APIëŠ” deprecated ì²˜ë¦¬ í›„ ë‹¨ê³„ì  ì œê±°

âš ï¸ **ì„±ëŠ¥ ê³ ë ¤**
- ì›”ê°„ ë§¤ì¶œ ì‹¤ì‹œê°„ ê³„ì‚° ì‹œ ì¸ë±ìŠ¤ í•„ìš”
- íŠ¸ë¦¬ ì¡°íšŒ depth ì œí•œìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”