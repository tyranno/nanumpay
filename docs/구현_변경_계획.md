# 구현 변경 계획 (v4.0 설계 기준)

## 📅 작성일: 2025-10-04

## 1. 삭제 대상

### 1.1 MongoDB 컬렉션
```bash
# 삭제할 컬렉션들
- monthlyrevenues  # API로 실시간 계산으로 대체
- weeklypayments   # userpaymentplans에 통합
- revenues         # 불필요 (users.createdAt 사용)
- paymentschedules # userpaymentplans에 통합
- treestats        # 실시간 계산으로 대체
```

### 1.2 모델 파일
```
- /lib/server/models/MonthlyRevenue.js  # 삭제
- /lib/server/models/Payment.js 내 MonthlyRevenue, WeeklyPayment 스키마 # 삭제
- /lib/server/models/Revenue.js (있다면) # 삭제
```

### 1.3 서비스 파일
```
- revenueCalculation.js의 MonthlyRevenue 관련 코드 # 제거
- paymentService.js의 WeeklyPayment 관련 코드 # 제거
```

## 2. 수정 대상

### 2.1 UserPaymentPlan 스키마 수정
**현재 구조 → v4.0 구조**

```javascript
// 변경 전
{
  userId, revenueMonth, installments: [...]
}

// 변경 후 (v4.0)
{
  userId: String,
  revenueMonth: String,
  isManualOverride: Boolean,  // 추가
  manualTotalAmount: Number,   // 추가
  installments: [{
    installmentNumber: Number,
    scheduledDate: Date,
    gradeReferenceDate: Date,
    gradeAtPayment: String,     // 지급 시 채워짐
    calculatedAmount: Number,   // 지급 시 계산
    withholdingTax: Number,
    netAmount: Number,
    status: String,
    blockedReason: String,      // 추가
    paidDate: Date,
    transactionId: String       // 추가
  }],
  isEligible: Boolean,
  ineligibleReason: String,
  totalPaidAmount: Number,
  totalPaidCount: Number
}
```

### 2.2 매출 계산 로직 변경
```javascript
// 기존: MonthlyRevenue 컬렉션에서 조회
const revenue = await MonthlyRevenue.findOne({ year, month });

// 변경: 실시간 계산
const revenue = await User.countDocuments({
  createdAt: { $gte: startDate, $lt: endDate },
  type: 'user'
}) * 1000000;
```

### 2.3 주간 지급 처리 변경
```javascript
// 기존: WeeklyPayment 생성
await WeeklyPayment.create({...});

// 변경: UserPaymentPlan 업데이트
await UserPaymentPlan.updateOne(
  { userId, 'installments.scheduledDate': friday },
  { $set: {
    'installments.$.status': 'paid',
    'installments.$.paidDate': new Date(),
    'installments.$.calculatedAmount': amount
  }}
);
```

## 3. 신규 생성

### 3.1 SystemConfig 초기화
```javascript
// systemConfigs 컬렉션 생성 및 초기 데이터
{
  configType: 'current',
  gradeRatios: {
    F1: 0.24, F2: 0.19, F3: 0.14, F4: 0.09,
    F5: 0.05, F6: 0.03, F7: 0.02, F8: 0.01
  },
  maxPaymentCounts: {
    F1: 20, F2: 30, F3: 40, F4: 40,
    F5: 50, F6: 50, F7: 60, F8: 60
  },
  minInsuranceAmounts: {
    F3: 50000, F4: 50000,
    F5: 70000, F6: 70000,
    F7: 100000, F8: 100000
  },
  withholdingTaxRate: 0.033,
  revenuePerUser: 1000000,
  installmentCount: 10
}
```

### 3.2 새로운 API 엔드포인트
```
- GET /api/admin/revenue/monthly?month=2024-09  # 월간 매출 실시간 계산
- GET /api/tree/user/:userId?depth=3            # 트리 depth 제한 조회
- GET /api/tree/path/:userId                    # 경로 조회
```

### 3.3 검증 로직 추가
```javascript
// validateRegistration.js
- 자기 자신 판매인 방지
- 루트 노드 단일성 체크
- 좌우 자리 체크 (모두 찬 경우 등록 불가)
```

## 4. 작업 순서

### Phase 1: 백업 및 준비
1. 데이터베이스 백업
2. 기존 코드 백업

### Phase 2: 삭제 작업
1. 불필요한 컬렉션 삭제
2. 관련 모델 파일 삭제
3. 참조 코드 제거

### Phase 3: 수정 작업
1. UserPaymentPlan 스키마 수정
2. 매출 계산 로직 API로 변경
3. 지급 처리 로직 통합

### Phase 4: 신규 생성
1. SystemConfig 생성 및 초기화
2. 새 API 엔드포인트 구현
3. 검증 로직 추가

### Phase 5: 테스트
1. 단위 테스트
2. 통합 테스트
3. 시나리오 테스트

## 5. 영향받는 파일 목록

### 삭제
- [ ] models/MonthlyRevenue.js
- [ ] models/Payment.js (일부)

### 수정
- [ ] models/UserPaymentPlan.js
- [ ] services/paymentService.js
- [ ] services/revenueCalculation.js
- [ ] services/batchProcessor.js
- [ ] routes/api/admin/revenue/monthly/+server.js
- [ ] routes/api/admin/payment/weekly/+server.js

### 신규
- [ ] models/SystemConfig.js
- [ ] services/validationService.js
- [ ] routes/api/tree/user/[userId]/+server.js
- [ ] routes/api/tree/path/[userId]/+server.js
- [ ] scripts/init-system-config.js

## 6. 주의사항

⚠️ **데이터 마이그레이션 필요**
- 기존 monthlyrevenues 데이터는 삭제 전 백업
- 기존 weeklypayments 데이터는 userpaymentplans로 병합

⚠️ **하위 호환성**
- API 변경으로 프론트엔드 수정 필요
- 기존 API는 deprecated 처리 후 단계적 제거

⚠️ **성능 고려**
- 월간 매출 실시간 계산 시 인덱스 필요
- 트리 조회 depth 제한으로 성능 최적화