# 백업 파일 자동 정리 기능

**날짜**: 2025-10-26
**상태**: ✅ 완료

---

## 📋 문제점

1. **/tmp 디렉토리에 백업 파일이 계속 쌓임** → 디스크 공간 부족 가능성
2. **FTP/S3 업로드 실패 시 오류로 표시** → 백업은 성공했지만 사용자에게 오류 메시지

---

## ✅ 해결 방안

### 1. 백업 파일 자동 정리 (최신 1개만 유지)

웹 백업 실행 시 **최신 백업 파일 1개만 유지**하고 나머지 삭제

#### 정리 대상
- ✅ **오래된 백업 파일** (.tar.gz)
- ✅ **압축 해제된 임시 디렉토리**

#### 정리 시점
- 백업 성공 후 자동 실행
- 다운로드 완료 여부와 무관하게 즉시 정리

### 2. FTP/S3 업로드 실패 무시

백업 앱이 exit code 1을 반환해도 **압축 파일이 생성되었으면 성공으로 처리**

---

## 🔧 구현 내용

### 파일 위치

[apps/web/src/routes/api/admin/backup/execute/+server.js](../apps/web/src/routes/api/admin/backup/execute/+server.js)

### 1. Exit Code 1 무시

```javascript
// 백업 실행 (타임아웃 5분)
// exit code 1은 FTP/S3 업로드 실패일 수 있으므로 무시
let stdout;
try {
  const result = await execFileAsync(actualBackupPath, [], {
    timeout: 300000,
    env: {
      ...process.env,
      MONGODB_URI: process.env.MONGODB_URI || 'mongodb://localhost:27017/nanumpay',
      BACKUP_PATH: backupDir
    }
  });
  stdout = result.stdout;
} catch (error) {
  // exit code 1이지만 stdout이 있으면 백업은 성공한 것
  if (error.stdout && error.stdout.includes('✅ 압축 완료')) {
    stdout = error.stdout;
    console.log('[backup-execute] 백업 성공 (업로드 일부 실패 무시)');
  } else {
    throw error;
  }
}
```

### 2. 자동 정리 로직

```javascript
// 오래된 백업 파일 정리 (최신 1개만 유지)
try {
  const files = await fs.readdir(backupDir);

  // 1) 백업 파일 찾기
  const backupFiles = files
    .filter(f => f.startsWith('nanumpay-backup-') && f.endsWith('.tar.gz'))
    .map(f => ({
      name: f,
      path: path.join(backupDir, f),
      stat: null
    }));

  // 2) 파일 정보 가져오기
  for (const file of backupFiles) {
    try {
      file.stat = await fs.stat(file.path);
    } catch (e) {
      // 파일 접근 실패 시 무시
    }
  }

  // 3) 시간순 정렬 (최신 먼저)
  backupFiles.sort((a, b) => {
    if (!a.stat || !b.stat) return 0;
    return b.stat.mtime - a.stat.mtime;
  });

  // 4) 최신 1개 제외하고 삭제
  const filesToDelete = backupFiles.slice(1);
  for (const file of filesToDelete) {
    try {
      await fs.unlink(file.path);
      console.log(`[backup-cleanup] 오래된 백업 삭제: ${file.name}`);
    } catch (e) {
      console.error(`[backup-cleanup] 삭제 실패: ${file.name}`, e.message);
    }
  }

  // 5) 압축 해제된 임시 디렉토리 정리
  const dirs = files.filter(f => f.startsWith('nanumpay-backup-') && !f.endsWith('.tar.gz'));
  for (const dir of dirs) {
    try {
      const dirPath = path.join(backupDir, dir);
      await fs.rm(dirPath, { recursive: true, force: true });
      console.log(`[backup-cleanup] 임시 디렉토리 삭제: ${dir}`);
    } catch (e) {
      console.error(`[backup-cleanup] 디렉토리 삭제 실패: ${dir}`, e.message);
    }
  }

  console.log(`[backup-cleanup] 정리 완료 (유지: ${backupFiles[0]?.name || filename})`);
} catch (cleanupError) {
  // 정리 실패해도 백업은 성공으로 처리
  console.error('[backup-cleanup] 정리 중 오류:', cleanupError.message);
}
```

---

## 🧪 동작 예시

### 시나리오: 백업 3번 실행

#### 1차 백업
```
/tmp/nanumpay-backups/
└── nanumpay-backup-2025-10-26T04-19-56.tar.gz (12KB)

✅ 유지: nanumpay-backup-2025-10-26T04-19-56.tar.gz
```

#### 2차 백업
```
/tmp/nanumpay-backups/
└── nanumpay-backup-2025-10-26T04-25-30.tar.gz (12KB)

🗑️ 삭제: nanumpay-backup-2025-10-26T04-19-56.tar.gz
✅ 유지: nanumpay-backup-2025-10-26T04-25-30.tar.gz
```

#### 3차 백업
```
/tmp/nanumpay-backups/
└── nanumpay-backup-2025-10-26T04-30-15.tar.gz (12KB)

🗑️ 삭제: nanumpay-backup-2025-10-26T04-25-30.tar.gz
✅ 유지: nanumpay-backup-2025-10-26T04-30-15.tar.gz
```

**결과**: 항상 최신 백업 파일 1개만 유지

---

## 📊 디스크 사용량 비교

### 정리 전 (1일 10회 백업 기준)

```
10회 × 12KB = 120KB (1일)
120KB × 30일 = 3.6MB (1개월)
```

### 정리 후

```
1개 × 12KB = 12KB (항상)
```

**절감 효과**: 99.7% 디스크 공간 절감

---

## 🔍 로그 예시

### 성공 로그

```
[backup-execute] 백업 실행 시작: /home/tyranno/project/bill/nanumpay/apps/backup/build/nanumpay-backup
[backup-execute] 백업 성공 (업로드 일부 실패 무시)
[backup-execute] 백업 파일: /tmp/nanumpay-backups/nanumpay-backup-2025-10-26T04-30-15.tar.gz
[backup-cleanup] 오래된 백업 삭제: nanumpay-backup-2025-10-26T04-25-30.tar.gz
[backup-cleanup] 임시 디렉토리 삭제: nanumpay-backup-2025-10-26T04-19-56
[backup-cleanup] 정리 완료 (유지: nanumpay-backup-2025-10-26T04-30-15.tar.gz)
```

### FTP 실패 무시

```
NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
...
❌ FTP 연결 실패: connect ECONNREFUSED 127.0.0.1:21
⚠️  FTP 업로드 실패 (백업은 로컬에 저장됨)

[backup-execute] 백업 성공 (업로드 일부 실패 무시)  ← 오류 무시!
✅ 백업이 성공적으로 완료되었습니다.
```

---

## ⚙️ 설정 변경 (선택)

### 최신 1개 → 최신 N개 유지

코드에서 `backupFiles.slice(1)` 부분을 수정:

```javascript
// 최신 3개 유지
const filesToDelete = backupFiles.slice(3);
```

### 정리 비활성화

환경변수 추가:

```bash
BACKUP_CLEANUP_ENABLED=false
```

코드 수정:
```javascript
if (process.env.BACKUP_CLEANUP_ENABLED !== 'false') {
  // 정리 로직
}
```

---

## ✅ 완료 항목

- [x] FTP/S3 업로드 실패 시 백업 성공으로 처리
- [x] exit code 1 무시 (stdout에 "압축 완료" 있으면)
- [x] 오래된 백업 파일 자동 삭제 (최신 1개만 유지)
- [x] 압축 해제된 임시 디렉토리 정리
- [x] 정리 실패해도 백업 성공 유지
- [x] 로그 출력 (삭제/유지 파일)
- [x] 문서화

---

## 🎉 효과

1. **디스크 공간 절약**: 99.7% 절감
2. **사용자 경험 개선**: FTP/S3 오류 메시지 제거
3. **안정성 향상**: 정리 실패해도 백업은 성공
4. **자동화**: 수동 정리 불필요

---

**작성자**: Claude AI Assistant
**최종 수정일**: 2025-10-26
