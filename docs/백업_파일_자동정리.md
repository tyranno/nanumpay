# ë°±ì—… íŒŒì¼ ìë™ ì •ë¦¬ ê¸°ëŠ¥

**ë‚ ì§œ**: 2025-10-26
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ë¬¸ì œì 

1. **/tmp ë””ë ‰í† ë¦¬ì— ë°±ì—… íŒŒì¼ì´ ê³„ì† ìŒ“ì„** â†’ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± ê°€ëŠ¥ì„±
2. **FTP/S3 ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ë¡œ í‘œì‹œ** â†’ ë°±ì—…ì€ ì„±ê³µí–ˆì§€ë§Œ ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€

---

## âœ… í•´ê²° ë°©ì•ˆ

### 1. ë°±ì—… íŒŒì¼ ìë™ ì •ë¦¬ (ìµœì‹  1ê°œë§Œ ìœ ì§€)

ì›¹ ë°±ì—… ì‹¤í–‰ ì‹œ **ìµœì‹  ë°±ì—… íŒŒì¼ 1ê°œë§Œ ìœ ì§€**í•˜ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ

#### ì •ë¦¬ ëŒ€ìƒ
- âœ… **ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼** (.tar.gz)
- âœ… **ì••ì¶• í•´ì œëœ ì„ì‹œ ë””ë ‰í† ë¦¬**

#### ì •ë¦¬ ì‹œì 
- ë°±ì—… ì„±ê³µ í›„ ìë™ ì‹¤í–‰
- ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ì¦‰ì‹œ ì •ë¦¬

### 2. FTP/S3 ì—…ë¡œë“œ ì‹¤íŒ¨ ë¬´ì‹œ

ë°±ì—… ì•±ì´ exit code 1ì„ ë°˜í™˜í•´ë„ **ì••ì¶• íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬**

---

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### íŒŒì¼ ìœ„ì¹˜

[apps/web/src/routes/api/admin/backup/execute/+server.js](../apps/web/src/routes/api/admin/backup/execute/+server.js)

### 1. Exit Code 1 ë¬´ì‹œ

```javascript
// ë°±ì—… ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 5ë¶„)
// exit code 1ì€ FTP/S3 ì—…ë¡œë“œ ì‹¤íŒ¨ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
let stdout;
try {
  const result = await execFileAsync(actualBackupPath, [], {
    timeout: 300000,
    env: {
      ...process.env,
      MONGODB_URI: process.env.MONGODB_URI || 'mongodb://localhost:27017/nanumpay',
      BACKUP_PATH: backupDir
    }
  });
  stdout = result.stdout;
} catch (error) {
  // exit code 1ì´ì§€ë§Œ stdoutì´ ìˆìœ¼ë©´ ë°±ì—…ì€ ì„±ê³µí•œ ê²ƒ
  if (error.stdout && error.stdout.includes('âœ… ì••ì¶• ì™„ë£Œ')) {
    stdout = error.stdout;
    console.log('[backup-execute] ë°±ì—… ì„±ê³µ (ì—…ë¡œë“œ ì¼ë¶€ ì‹¤íŒ¨ ë¬´ì‹œ)');
  } else {
    throw error;
  }
}
```

### 2. ìë™ ì •ë¦¬ ë¡œì§

```javascript
// ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (ìµœì‹  1ê°œë§Œ ìœ ì§€)
try {
  const files = await fs.readdir(backupDir);

  // 1) ë°±ì—… íŒŒì¼ ì°¾ê¸°
  const backupFiles = files
    .filter(f => f.startsWith('nanumpay-backup-') && f.endsWith('.tar.gz'))
    .map(f => ({
      name: f,
      path: path.join(backupDir, f),
      stat: null
    }));

  // 2) íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  for (const file of backupFiles) {
    try {
      file.stat = await fs.stat(file.path);
    } catch (e) {
      // íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
    }
  }

  // 3) ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹  ë¨¼ì €)
  backupFiles.sort((a, b) => {
    if (!a.stat || !b.stat) return 0;
    return b.stat.mtime - a.stat.mtime;
  });

  // 4) ìµœì‹  1ê°œ ì œì™¸í•˜ê³  ì‚­ì œ
  const filesToDelete = backupFiles.slice(1);
  for (const file of filesToDelete) {
    try {
      await fs.unlink(file.path);
      console.log(`[backup-cleanup] ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ: ${file.name}`);
    } catch (e) {
      console.error(`[backup-cleanup] ì‚­ì œ ì‹¤íŒ¨: ${file.name}`, e.message);
    }
  }

  // 5) ì••ì¶• í•´ì œëœ ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
  const dirs = files.filter(f => f.startsWith('nanumpay-backup-') && !f.endsWith('.tar.gz'));
  for (const dir of dirs) {
    try {
      const dirPath = path.join(backupDir, dir);
      await fs.rm(dirPath, { recursive: true, force: true });
      console.log(`[backup-cleanup] ì„ì‹œ ë””ë ‰í† ë¦¬ ì‚­ì œ: ${dir}`);
    } catch (e) {
      console.error(`[backup-cleanup] ë””ë ‰í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨: ${dir}`, e.message);
    }
  }

  console.log(`[backup-cleanup] ì •ë¦¬ ì™„ë£Œ (ìœ ì§€: ${backupFiles[0]?.name || filename})`);
} catch (cleanupError) {
  // ì •ë¦¬ ì‹¤íŒ¨í•´ë„ ë°±ì—…ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
  console.error('[backup-cleanup] ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', cleanupError.message);
}
```

---

## ğŸ§ª ë™ì‘ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤: ë°±ì—… 3ë²ˆ ì‹¤í–‰

#### 1ì°¨ ë°±ì—…
```
/tmp/nanumpay-backups/
â””â”€â”€ nanumpay-backup-2025-10-26T04-19-56.tar.gz (12KB)

âœ… ìœ ì§€: nanumpay-backup-2025-10-26T04-19-56.tar.gz
```

#### 2ì°¨ ë°±ì—…
```
/tmp/nanumpay-backups/
â””â”€â”€ nanumpay-backup-2025-10-26T04-25-30.tar.gz (12KB)

ğŸ—‘ï¸ ì‚­ì œ: nanumpay-backup-2025-10-26T04-19-56.tar.gz
âœ… ìœ ì§€: nanumpay-backup-2025-10-26T04-25-30.tar.gz
```

#### 3ì°¨ ë°±ì—…
```
/tmp/nanumpay-backups/
â””â”€â”€ nanumpay-backup-2025-10-26T04-30-15.tar.gz (12KB)

ğŸ—‘ï¸ ì‚­ì œ: nanumpay-backup-2025-10-26T04-25-30.tar.gz
âœ… ìœ ì§€: nanumpay-backup-2025-10-26T04-30-15.tar.gz
```

**ê²°ê³¼**: í•­ìƒ ìµœì‹  ë°±ì—… íŒŒì¼ 1ê°œë§Œ ìœ ì§€

---

## ğŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ë¹„êµ

### ì •ë¦¬ ì „ (1ì¼ 10íšŒ ë°±ì—… ê¸°ì¤€)

```
10íšŒ Ã— 12KB = 120KB (1ì¼)
120KB Ã— 30ì¼ = 3.6MB (1ê°œì›”)
```

### ì •ë¦¬ í›„

```
1ê°œ Ã— 12KB = 12KB (í•­ìƒ)
```

**ì ˆê° íš¨ê³¼**: 99.7% ë””ìŠ¤í¬ ê³µê°„ ì ˆê°

---

## ğŸ” ë¡œê·¸ ì˜ˆì‹œ

### ì„±ê³µ ë¡œê·¸

```
[backup-execute] ë°±ì—… ì‹¤í–‰ ì‹œì‘: /home/tyranno/project/bill/nanumpay/apps/backup/build/nanumpay-backup
[backup-execute] ë°±ì—… ì„±ê³µ (ì—…ë¡œë“œ ì¼ë¶€ ì‹¤íŒ¨ ë¬´ì‹œ)
[backup-execute] ë°±ì—… íŒŒì¼: /tmp/nanumpay-backups/nanumpay-backup-2025-10-26T04-30-15.tar.gz
[backup-cleanup] ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ: nanumpay-backup-2025-10-26T04-25-30.tar.gz
[backup-cleanup] ì„ì‹œ ë””ë ‰í† ë¦¬ ì‚­ì œ: nanumpay-backup-2025-10-26T04-19-56
[backup-cleanup] ì •ë¦¬ ì™„ë£Œ (ìœ ì§€: nanumpay-backup-2025-10-26T04-30-15.tar.gz)
```

### FTP ì‹¤íŒ¨ ë¬´ì‹œ

```
NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
...
âŒ FTP ì—°ê²° ì‹¤íŒ¨: connect ECONNREFUSED 127.0.0.1:21
âš ï¸  FTP ì—…ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—…ì€ ë¡œì»¬ì— ì €ì¥ë¨)

[backup-execute] ë°±ì—… ì„±ê³µ (ì—…ë¡œë“œ ì¼ë¶€ ì‹¤íŒ¨ ë¬´ì‹œ)  â† ì˜¤ë¥˜ ë¬´ì‹œ!
âœ… ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
```

---

## âš™ï¸ ì„¤ì • ë³€ê²½ (ì„ íƒ)

### ìµœì‹  1ê°œ â†’ ìµœì‹  Nê°œ ìœ ì§€

ì½”ë“œì—ì„œ `backupFiles.slice(1)` ë¶€ë¶„ì„ ìˆ˜ì •:

```javascript
// ìµœì‹  3ê°œ ìœ ì§€
const filesToDelete = backupFiles.slice(3);
```

### ì •ë¦¬ ë¹„í™œì„±í™”

í™˜ê²½ë³€ìˆ˜ ì¶”ê°€:

```bash
BACKUP_CLEANUP_ENABLED=false
```

ì½”ë“œ ìˆ˜ì •:
```javascript
if (process.env.BACKUP_CLEANUP_ENABLED !== 'false') {
  // ì •ë¦¬ ë¡œì§
}
```

---

## âœ… ì™„ë£Œ í•­ëª©

- [x] FTP/S3 ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë°±ì—… ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
- [x] exit code 1 ë¬´ì‹œ (stdoutì— "ì••ì¶• ì™„ë£Œ" ìˆìœ¼ë©´)
- [x] ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ìë™ ì‚­ì œ (ìµœì‹  1ê°œë§Œ ìœ ì§€)
- [x] ì••ì¶• í•´ì œëœ ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
- [x] ì •ë¦¬ ì‹¤íŒ¨í•´ë„ ë°±ì—… ì„±ê³µ ìœ ì§€
- [x] ë¡œê·¸ ì¶œë ¥ (ì‚­ì œ/ìœ ì§€ íŒŒì¼)
- [x] ë¬¸ì„œí™”

---

## ğŸ‰ íš¨ê³¼

1. **ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½**: 99.7% ì ˆê°
2. **ì‚¬ìš©ì ê²½í—˜ ê°œì„ **: FTP/S3 ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
3. **ì•ˆì •ì„± í–¥ìƒ**: ì •ë¦¬ ì‹¤íŒ¨í•´ë„ ë°±ì—…ì€ ì„±ê³µ
4. **ìë™í™”**: ìˆ˜ë™ ì •ë¦¬ ë¶ˆí•„ìš”

---

**ì‘ì„±ì**: Claude AI Assistant
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-26
