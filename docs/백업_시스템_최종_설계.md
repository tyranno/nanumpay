# 나눔페이 백업 시스템 최종 설계

**작성일**: 2025-10-26  
**버전**: v1.0 Final  
**기술 스택**: Bun + JavaScript, MongoDB, Crontab

---

## 📋 핵심 구조

### 간단 요약:

```
웹 UI (설정 변경)
    ↓ (DB 저장)
MongoDB (systemSettings.backup)
    ↓ (Crontab 업데이트)
Crontab (시간 스케줄링)
    ↓ (정해진 시간에 실행)
nanumpay-backup (Bun 실행파일)
    ↓ (DB에서 설정 읽기)
MongoDB (설정 조회)
    ↓ (백업 수행)
mongodump → 압축 → S3/FTP 업로드 → 보관정책
```

---

## 🏗️ 시스템 구성 요소

### 1. **백업 실행기** (`nanumpay-backup`)

**역할**: 백업 실제 수행
**기술**: Bun으로 컴파일된 단일 실행파일 (~25MB)
**위치**: `/opt/nanumpay/bin/nanumpay-backup`

**동작**:
1. MongoDB 연결
2. `db.admins.findOne().systemSettings.backup` 설정 읽기
3. `enabled: false` → 종료
4. `enabled: true` → 백업 수행:
   - mongodump 실행
   - 압축 (설정 시)
   - S3/FTP 업로드 (설정 시)
   - 보관 정책 적용
5. 로그 기록

**특징**:
- ✅ DB에서 직접 설정 읽음 (설정 파일 없음)
- ✅ MongoDB 없으면 실행 안 됨 (정상 - 백업 대상이 없으므로)
- ✅ 단독 실행 가능 (수동 백업 가능)

---

### 2. **Crontab 관리**

**역할**: 백업 시간 스케줄링
**방식**: 웹 API에서 Crontab 직접 업데이트

**Crontab 예시**:
```bash
# nanumpay-backup
0 2 * * * /opt/nanumpay/bin/nanumpay-backup >> /logs/backup.log 2>&1
```

**설정 변경 시**:
```
웹 UI에서 저장 버튼 클릭
    ↓
API: PUT /api/admin/settings/system
    ↓
1. MongoDB 업데이트
2. Cron 표현식 생성
3. crontab 업데이트 (exec 명령)
    ↓
Crontab 반영 (즉시)
```

---

### 3. **웹 UI**

**위치**: 관리자 설정 > 시스템 설정 > 백업 설정

**기능**:
- ✅ 백업 활성화/비활성화
- ✅ 주기: daily/weekly/monthly
- ✅ 시간, 요일, 일자 설정
- ✅ 보관 정책 (개수/기간/압축)
- ✅ 저장소 설정 (S3/FTP)
- ✅ **즉시 백업** 버튼 (수동 실행)
- ✅ **백업 목록 조회** (선택)

---

## 📁 프로젝트 구조

```
nanumpay/
├── apps/
│   ├── web/                          # 기존 웹 앱
│   │   └── src/routes/api/admin/
│   │       └── settings/system/
│   │           └── +server.js        # Crontab 업데이트 포함
│   │
│   └── backup/                       # 새로운 백업 앱
│       ├── package.json
│       ├── src/
│       │   ├── index.js              # 메인 진입점
│       │   ├── config.js             # DB 설정 읽기
│       │   ├── backup.js             # mongodump 실행
│       │   ├── compress.js           # tar.gz 압축
│       │   ├── storage/
│       │   │   ├── s3.js             # AWS S3 업로드
│       │   │   └── ftp.js            # FTP 업로드
│       │   └── retention.js          # 보관 정책
│       ├── build.sh                  # Bun 빌드 스크립트
│       └── build/
│           └── nanumpay-backup       # 빌드된 실행파일
│
└── apps/web/install/linux/
    └── bin/
        └── nanumpay-backup           # DEB 패키지에 포함
```

---

## 💻 코드 구조

### `apps/backup/package.json`
```json
{
  "name": "@nanumpay/backup",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "bun run src/index.js",
    "build": "bash build.sh",
    "test": "bun run src/index.js --test"
  },
  "dependencies": {
    "mongodb": "^6.10.0",
    "aws-sdk": "^2.1691.0",
    "archiver": "^7.0.0"
  }
}
```

### `apps/backup/src/index.js`
```javascript
import { getBackupConfig } from './config.js';
import { runMongoDump } from './backup.js';
import { compress } from './compress.js';
import { uploadToS3, uploadToFTP } from './storage/index.js';
import { applyRetention } from './retention.js';
import { execSync } from 'child_process';
import * as fs from 'fs';

async function main() {
  console.log('🚀 Nanumpay Backup starting...');

  try {
    // 1. DB에서 설정 읽기
    const config = await getBackupConfig();

    if (!config.enabled) {
      console.log('⏸️  Backup is disabled');
      return;
    }

    // 2. 백업 디렉토리 생성
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupDir = `/opt/nanumpay/data/backups/${timestamp}`;

    // 3. mongodump 실행
    console.log('📦 Running mongodump...');
    await runMongoDump(backupDir);

    // 4. 압축 (선택)
    let finalPath = backupDir;
    if (config.retention.compress) {
      console.log('🗜️  Compressing...');
      finalPath = await compress(backupDir);
      // 압축 후 원본 삭제
      fs.rmSync(backupDir, { recursive: true, force: true });
    }

    // 5. 업로드
    if (config.storage.type === 's3') {
      console.log('☁️  Uploading to S3...');
      await uploadToS3(finalPath, config.storage.s3);
    } else if (config.storage.type === 'ftp') {
      console.log('📤 Uploading to FTP...');
      await uploadToFTP(finalPath, config.storage.ftp);
    }

    // 6. 보관 정책 적용
    console.log('🧹 Applying retention policy...');
    await applyRetention(config.retention);

    console.log(`✅ Backup completed: ${finalPath}`);

  } catch (error) {
    console.error('❌ Backup failed:', error.message);
    process.exit(1);
  }
}

main();
```

### `apps/backup/src/config.js`
```javascript
import { MongoClient } from 'mongodb';

export async function getBackupConfig() {
  const uri = process.env.MONGO_URI || 'mongodb://localhost:27017';
  const client = await MongoClient.connect(uri, {
    serverSelectionTimeoutMS: 5000
  });

  try {
    const db = client.db('nanumpay');
    const admin = await db.collection('admins').findOne();

    if (!admin?.systemSettings?.backup) {
      throw new Error('Backup configuration not found in database');
    }

    return admin.systemSettings.backup;

  } finally {
    await client.close();
  }
}
```

### `apps/backup/src/backup.js`
```javascript
import { execSync } from 'child_process';

export async function runMongoDump(outputDir) {
  const uri = process.env.MONGO_URI || 'mongodb://localhost:27017';
  const db = process.env.DB_NAME || 'nanumpay';

  const cmd = `mongodump --uri="${uri}" --db="${db}" --out="${outputDir}"`;

  try {
    execSync(cmd, { stdio: 'inherit' });
  } catch (error) {
    throw new Error(`mongodump failed: ${error.message}`);
  }
}
```

### `apps/backup/build.sh`
```bash
#!/bin/bash
set -e

echo "🔨 Building nanumpay-backup..."

# Bun 설치 확인
if ! command -v bun &> /dev/null; then
    echo "❌ Bun is not installed. Install from https://bun.sh"
    exit 1
fi

# 의존성 설치
bun install

# 빌드 (Linux x64 타겟)
bun build src/index.js \
  --compile \
  --outfile build/nanumpay-backup \
  --target bun-linux-x64 \
  --minify

echo "✅ Build complete!"
ls -lh build/nanumpay-backup
```

---

## 🔧 Crontab 관리 (웹 API)

### `apps/web/src/routes/api/admin/settings/system/+server.js`

```javascript
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

async function updateCrontab(backup) {
  if (!backup.enabled) {
    // 비활성화 - crontab에서 제거
    await removeCrontab();
    return;
  }

  // Cron 표현식 생성
  const [hour, minute] = backup.time.split(':');
  let cronExpr = '';

  switch (backup.frequency) {
    case 'daily':
      cronExpr = `${minute} ${hour} * * *`;
      break;
    case 'weekly':
      cronExpr = `${minute} ${hour} * * ${backup.dayOfWeek}`;
      break;
    case 'monthly':
      cronExpr = `${minute} ${hour} ${backup.dayOfMonth} * *`;
      break;
  }

  // 기존 crontab 읽기
  let existingCrontab = '';
  try {
    const { stdout } = await execAsync('crontab -l 2>/dev/null || echo ""');
    existingCrontab = stdout;
  } catch {}

  // nanumpay-backup 라인 제거
  const lines = existingCrontab
    .split('\n')
    .filter(line => line && !line.includes('nanumpay-backup'));

  // 새 라인 추가
  lines.push('# nanumpay-backup');
  lines.push(`${cronExpr} /opt/nanumpay/bin/nanumpay-backup >> /logs/backup.log 2>&1`);

  // crontab 업데이트
  const newCrontab = lines.join('\n') + '\n';
  await execAsync(`echo "${newCrontab}" | crontab -`);

  console.log(`✅ Crontab updated: ${cronExpr}`);
}

async function removeCrontab() {
  try {
    const { stdout } = await execAsync('crontab -l 2>/dev/null || echo ""');
    const lines = stdout
      .split('\n')
      .filter(line => line && !line.includes('nanumpay-backup'));
    
    const newCrontab = lines.join('\n') + '\n';
    await execAsync(`echo "${newCrontab}" | crontab -`);
    
    console.log('✅ Backup crontab removed');
  } catch {}
}

export async function PUT({ request, locals }) {
  // ... 권한 확인 ...

  const { backup } = await request.json();

  // 1. DB 저장
  await Admin.findByIdAndUpdate(adminId, {
    'systemSettings.backup': backup
  });

  // 2. Crontab 업데이트
  await updateCrontab(backup);

  return json({ success: true, message: '설정이 저장되었습니다.' });
}
```

---

## 🧪 테스트 방법

### 1. **개발 환경 테스트**

```bash
# 백업 앱 직접 실행
cd apps/backup
bun run src/index.js

# 빌드 테스트
bun run build
./build/nanumpay-backup
```

**확인 사항**:
- ✅ MongoDB 연결 성공
- ✅ 설정 읽기 성공
- ✅ mongodump 실행
- ✅ 백업 파일 생성 확인

---

### 2. **DB 설정 테스트**

```bash
# MongoDB에서 설정 확인
mongosh nanumpay --eval "db.admins.findOne().systemSettings.backup"

# 설정 변경 테스트 (웹 UI 사용)
# 1. 관리자 로그인
# 2. 설정 > 시스템 설정 > 백업 설정
# 3. 활성화 ON
# 4. 주기: daily, 시간: 03:00
# 5. 저장

# Crontab 확인
crontab -l | grep nanumpay-backup
# 출력 예상:
# # nanumpay-backup
# 0 3 * * * /opt/nanumpay/bin/nanumpay-backup >> /logs/backup.log 2>&1
```

---

### 3. **즉시 백업 테스트 (웹 UI)**

**API 추가 필요**:
```javascript
// apps/web/src/routes/api/admin/backup/run-now/+server.js
import { exec } from 'child_process';

export async function POST({ locals }) {
  if (!locals.user?.isAdmin) {
    return json({ success: false }, { status: 403 });
  }

  // 백그라운드에서 실행
  exec('/opt/nanumpay/bin/nanumpay-backup >> /logs/backup.log 2>&1 &');

  return json({
    success: true,
    message: '백업이 시작되었습니다. 로그를 확인하세요.'
  });
}
```

**웹 UI에 버튼 추가**:
```svelte
<!-- apps/web/src/routes/(admin)/admin/settings/+page.svelte -->
<button onclick={handleBackupNow}>즉시 백업</button>

<script>
async function handleBackupNow() {
  const response = await fetch('/api/admin/backup/run-now', {
    method: 'POST'
  });
  
  if (response.ok) {
    alert('백업이 시작되었습니다.');
  }
}
</script>
```

---

### 4. **Crontab 자동 실행 테스트**

```bash
# 1. 현재 시간 확인
date
# 출력: 2025-10-26 14:30:00

# 2. Crontab에 1분 후 시간 설정
crontab -e
# 추가:
# 31 14 * * * /opt/nanumpay/bin/nanumpay-backup >> /logs/backup.log 2>&1

# 3. 로그 모니터링
tail -f /logs/backup.log

# 4. 1분 후 확인
# 출력 예상:
# 🚀 Nanumpay Backup starting...
# 📦 Running mongodump...
# ✅ Backup completed: /opt/nanumpay/data/backups/2025-10-26T14-31-00
```

---

### 5. **S3 업로드 테스트**

```bash
# 1. S3 설정 (웹 UI)
# - Region: ap-northeast-2
# - Bucket: my-nanumpay-backups
# - Access Key ID: AKIA...
# - Secret Access Key: ***

# 2. 즉시 백업 실행
/opt/nanumpay/bin/nanumpay-backup

# 3. S3 확인
aws s3 ls s3://my-nanumpay-backups/nanumpay-backup/
# 출력:
# 2025-10-26 14:31:00  12345678  2025-10-26T14-31-00.tar.gz
```

---

### 6. **FTP 업로드 테스트**

```bash
# 1. FTP 설정 (웹 UI)
# - Host: ftp.example.com
# - Port: 21
# - Username: backup
# - Password: ***
# - Path: /backup/nanumpay

# 2. 즉시 백업 실행
/opt/nanumpay/bin/nanumpay-backup

# 3. FTP 확인
lftp -u backup,*** ftp.example.com
lftp> ls /backup/nanumpay
# 출력:
# -rw-r--r--   1 backup  backup  12345678 Oct 26 14:31 2025-10-26T14-31-00.tar.gz
```

---

### 7. **보관 정책 테스트**

```bash
# 1. 설정: 최근 3개만 유지
# 2. 백업 5번 실행
for i in {1..5}; do
  /opt/nanumpay/bin/nanumpay-backup
  sleep 2
done

# 3. 백업 목록 확인
ls -lht /opt/nanumpay/data/backups/
# 출력: 최신 3개만 남아있어야 함
```

---

### 8. **에러 처리 테스트**

```bash
# MongoDB 중지
sudo systemctl stop mongod

# 백업 실행
/opt/nanumpay/bin/nanumpay-backup
# 출력 예상:
# 🚀 Nanumpay Backup starting...
# ❌ Backup failed: MongoServerSelectionError: connect ECONNREFUSED

# 종료 코드 확인
echo $?
# 출력: 1 (실패)

# MongoDB 재시작
sudo systemctl start mongod
```

---

## 📊 테스트 체크리스트

### 기본 기능
- [ ] DB에서 설정 읽기 성공
- [ ] `enabled: false` 시 즉시 종료
- [ ] mongodump 실행 성공
- [ ] 백업 파일 생성 확인
- [ ] 압축 성공 (설정 시)
- [ ] 로그 기록 확인

### Crontab
- [ ] 웹 UI에서 설정 변경 시 crontab 업데이트
- [ ] daily/weekly/monthly 모두 테스트
- [ ] 비활성화 시 crontab에서 제거
- [ ] 설정 시간에 자동 실행

### 업로드
- [ ] S3 업로드 성공
- [ ] FTP 업로드 성공
- [ ] 업로드 실패 시에도 로컬 백업 유지

### 보관 정책
- [ ] 개수 기준 정리 동작
- [ ] 기간 기준 정리 동작
- [ ] 압축 파일만 남김

### 에러 처리
- [ ] MongoDB 연결 실패 시 에러 메시지
- [ ] mongodump 실패 시 에러 메시지
- [ ] 디스크 용량 부족 시 처리
- [ ] FTP/S3 연결 실패 시에도 로컬 백업 유지

---

## 🚀 배포 프로세스

### 1. 빌드
```bash
cd apps/backup
bun run build
```

### 2. DEB 패키지에 포함
```bash
cp apps/backup/build/nanumpay-backup apps/web/install/linux/bin/
```

### 3. postinst 수정
```bash
# apps/web/install/linux/postinst

# 백업 디렉토리 생성
mkdir -p /opt/nanumpay/data/backups
chown nanumpay:nanumpay /opt/nanumpay/data/backups

# 실행 권한
chmod +x /opt/nanumpay/bin/nanumpay-backup

echo "Backup system installed. Configure via Admin Settings."
```

### 4. prerm 수정
```bash
# apps/web/install/linux/prerm

# Crontab 정리
crontab -l 2>/dev/null | grep -v "nanumpay-backup" | crontab - || true
echo "Backup crontab removed"
```

---

## 📝 운영 가이드

### 수동 백업 실행
```bash
sudo -u nanumpay /opt/nanumpay/bin/nanumpay-backup
```

### 로그 확인
```bash
tail -f /logs/backup.log
```

### Crontab 확인
```bash
crontab -l
```

### 백업 목록 확인
```bash
ls -lht /opt/nanumpay/data/backups/
```

### 백업 복원
```bash
# 압축 해제
tar -xzf /opt/nanumpay/data/backups/2025-10-26T14-31-00.tar.gz

# mongorestore
mongorestore --uri="mongodb://localhost:27017" --db="nanumpay" --drop ./nanumpay
```

---

## ✅ 완료 체크리스트

### 개발
- [ ] Bun 프로젝트 생성 (`apps/backup/`)
- [ ] `config.js` - DB 설정 읽기
- [ ] `backup.js` - mongodump 실행
- [ ] `compress.js` - tar.gz 압축
- [ ] `storage/s3.js` - S3 업로드
- [ ] `storage/ftp.js` - FTP 업로드
- [ ] `retention.js` - 보관 정책
- [ ] `index.js` - 메인 로직

### 웹 통합
- [ ] API: Crontab 업데이트 기능
- [ ] API: 즉시 백업 실행
- [ ] UI: 즉시 백업 버튼
- [ ] UI: 백업 목록 조회 (선택)

### 빌드 & 배포
- [ ] `build.sh` 작성
- [ ] Linux 빌드 테스트
- [ ] DEB 패키지 통합
- [ ] postinst/prerm 수정

### 테스트
- [ ] 개발 환경 테스트
- [ ] Crontab 자동 실행 테스트
- [ ] S3 업로드 테스트
- [ ] FTP 업로드 테스트
- [ ] 보관 정책 테스트
- [ ] 에러 처리 테스트

---

**다음 단계**: 단계별 구현 시작!
