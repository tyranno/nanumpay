# 서비스 모듈 구조 분석 (2025-10-13)

## 📁 현재 서비스 파일 목록

### 1. registrationService.js ✅ **핵심 - 사용 중**
**목적**: 용역자 등록 전체 프로세스 통합 관리
**주요 기능**:
- `processUserRegistration()` - 메인 등록 처리
- `updateMonthlyRegistrations()` - 월별 등록 정보 업데이트
- `updateMonthlyTreeSnapshots()` - 월별 스냅샷 업데이트
- `updateUserInsuranceSettings()` - 보험 설정 업데이트

**호출 관계**:
```
registrationService.js
  ├─> gradeCalculation.js (recalculateAllGrades)
  ├─> paymentPlanService.js (createInitialPlan, createPromotionPlan, createMonthlyAdditionalPayments)
  └─> models (User, MonthlyRegistrations, MonthlyTreeSnapshots)
```

**문제점**:
- 너무 많은 책임 (등록, 트리, 등급, 스냅샷, 지급계획, 추가지급)
- 함수가 매우 김 (300줄+)
- 등급 분포를 여러 단계에서 각각 계산

---

### 2. paymentPlanService.js ✅ **핵심 - 사용 중**
**목적**: 지급 계획 생성 및 관리
**주요 기능**:
- `createInitialPaymentPlan()` - 신규 등록 시 기본 10회 생성
- `createPromotionPaymentPlan()` - 승급 시 10회 생성
- `createMonthlyAdditionalPayments()` - v7.0 매월 추가지급 확인
- `checkAndCreateAdditionalPlan()` - v6.0 10회 완료 후 추가 생성
- `terminateAdditionalPlansOnPromotion()` - v7.0 승급 시 추가지급 중단

**호출 관계**:
```
paymentPlanService.js
  ├─> MonthlyRegistrations (매출 정보)
  ├─> MonthlyTreeSnapshots (등급 분포)
  └─> WeeklyPaymentPlans (계획 생성)
```

**문제점**:
- 금액 계산 로직이 복잡하고 여러 곳에 분산
- MonthlyTreeSnapshots와 MonthlyRegistrations의 gradeDistribution을 혼용
- `createAdditionalPaymentForUser()`에서 currentMonth vs revenueMonth 혼란

---

### 3. weeklyPaymentService.js ✅ **핵심 - 사용 중**
**목적**: 매주 금요일 자동 지급 처리
**주요 기능**:
- `processWeeklyPayments()` - 금요일 자동 지급
- `processAllPastPayments()` - 과거 지급 일괄 처리
- `getWeeklyPaymentReport()` - 주간 지급 보고서

**호출 관계**:
```
weeklyPaymentService.js
  ├─> WeeklyPaymentPlans (지급 대상 조회)
  ├─> WeeklyPaymentSummary (주차별 총계)
  └─> MonthlyRegistrations (금액 계산)
```

**상태**: v7.0 원칙 준수 (순수 지급만, 추가지급 확인 안 함) ✅

---

### 4. gradeCalculation.js ✅ **핵심 - 사용 중**
**목적**: 등급 계산 로직
**주요 기능**:
- `calculateGradeForUser()` - 특정 사용자 등급 계산
- `recalculateAllGrades()` - 전체 등급 재계산 (상향식)
- `updateParentGrade()` - 부모 등급 업데이트

**호출 관계**:
```
gradeCalculation.js
  └─> User (트리 구조 순회)
```

**상태**: 단순하고 명확함 ✅

---

### 5. batchProcessor.js ⚠️ **Wrapper - 제거 고려**
**목적**: registrationService로의 단순 위임
**주요 기능**:
- `processNewUsers()` → `processUserRegistration()` 호출

**문제점**:
- 실제 로직 없음, 단순 wrapper
- 삭제하고 registrationService 직접 호출 권장

---

### 6. validationService.js ✅ **사용 중**
**목적**: 등록 전 검증 로직
**주요 기능**:
- `validateRegistration()` - 등록 전 검증
- `validateInsuranceRequirement()` - 보험 조건 검증
- `validatePaymentEligibility()` - 지급 자격 검증

**호출 위치**:
- `apps/web/src/routes/api/admin/users/bulk/+server.js` (라인 288)

**상태**: 유지 필요 ✅

---

### 7. gradeService.js ❌ **구버전 - 사용 안 함**
**목적**: TreeStats 기반 등급 관리
**문제점**:
- TreeStats 모델 사용 (현재 User 모델에 grade 직접 저장)
- PaymentScheduler 의존 (gradePaymentCount 개념은 v7.0에서 폐기)
- gradeCalculation.js와 중복

**결론**: 삭제 필요 ❌

---

### 8. treeService.js ❌ **구버전 - 사용 안 함**
**목적**: TreeStats 기반 트리 관리
**문제점**:
- TreeStats 모델 의존
- 현재는 User 모델에서 트리 구조 직접 관리
- isDirty 메커니즘 등 복잡한 로직 (현재 사용 안 함)

**결론**: 삭제 필요 ❌

---

### 9. paymentScheduler.js ⚠️ **Wrapper - 단순화 고려**
**목적**: Cron 스케줄러 설정
**주요 기능**:
- 금요일 00:00 자동 지급
- 매일 00:00 놓친 지급 확인

**상태**: weeklyPaymentService로 위임만 함
**개선**: Cron 설정은 필요하지만 로직은 최소화

---

### 10. treeRestructure.js ✅ **사용 중**
**목적**: 스마트 트리 재구성 (판매인 관계 고려 자동 배치)
**주요 기능**:
- `smartTreeRestructure()` - 트리 자동 재구성

**호출 위치**:
- `apps/web/src/routes/api/admin/users/bulk/+server.js` (라인 7, 416)

**상태**: 유지 필요 ✅

---

### 11. treeExtractor.js ❌ **사용 안 함**
**목적**: 트리 구조 추출 (계층도 그리기용)
**주요 기능**:
- `extractFullTree()` - 전체 트리 추출
- `extractUserTree()` - 특정 사용자 트리 추출

**문제점**:
- 어디서도 import되지 않음
- 계층도 표시는 다른 방법 사용

**결론**: 삭제 고려 ❌

---

## 🎯 삭제/수정 대상 (우선순위)

### 즉시 삭제 (P0) - 사용 안 함 확인
1. ✅ **gradeService.js** - TreeStats 기반, gradeCalculation.js와 중복, 어디서도 import 안 됨
2. ✅ **treeService.js** - TreeStats 기반, 구버전 API 3곳에서만 사용 (deprecated)
3. ✅ **treeExtractor.js** - 어디서도 import 안 됨

### 단순화 필요 (P1) - wrapper 역할만 함
4. **batchProcessor.js** - registrationService로 단순 위임만 함
   - **옵션 1**: 삭제하고 직접 호출
   - **옵션 2**: 실제 배치 로직 추가 (큐 시스템 등)

### 유지 (현재 사용 중)
- ✅ validationService.js (bulk upload에서 사용)
- ✅ treeRestructure.js (bulk upload에서 사용)

---

## 📊 핵심 모듈 (유지)

| 모듈 | 목적 | 상태 | 리팩토링 필요 |
|------|------|------|--------------|
| registrationService.js | 등록 통합 관리 | 사용 중 | ✅ 높음 |
| paymentPlanService.js | 지급 계획 생성 | 사용 중 | ✅ 높음 |
| weeklyPaymentService.js | 금요일 지급 | 사용 중 | ⚠️ 중간 |
| gradeCalculation.js | 등급 계산 | 사용 중 | ✅ 낮음 |
| paymentScheduler.js | Cron 스케줄 | 사용 중 | ⚠️ 낮음 |

---

## 🔧 리팩토링 계획

### 1단계: 불필요한 파일 삭제
- ✅ gradeService.js 삭제
- ✅ treeService.js 삭제 (또는 deprecated API 함께 제거)
- ✅ treeExtractor.js 삭제
- ⚠️ batchProcessor.js - 검토 후 결정

### 2단계: 핵심 모듈 분리
**새 모듈 생성**:
- `gradeDistributionService.js` - 등급 분포 계산 통합
- `paymentCalculationService.js` - 지급액 계산 통합
- `additionalPaymentService.js` - 추가지급 로직 분리

### 3단계: registrationService 단순화
- 각 단계를 독립 함수로 분리
- 등급 분포 계산을 gradeDistributionService로 위임
- 추가지급 로직을 additionalPaymentService로 위임

---

## 🐛 현재 버그의 원인

### 추가지급 금액 계산 오류
**위치**: `paymentPlanService.js` - `createAdditionalPaymentForUser()`

**문제**:
```javascript
// 현재 코드 (751라인 부근)
const currentSnapshot = await MonthlyTreeSnapshots.findOne({ monthKey: currentMonth });
const currentMonthReg = await MonthlyRegistrations.findOne({ monthKey: currentMonth });

// ⚠️ 문제: currentSnapshot.gradeDistribution을 사용
const gradePayments = calculateGradePayments(revenue, currentSnapshot.gradeDistribution);
```

**해결 방안**:
1. **단일 진실의 소스** 결정: MonthlyRegistrations.gradeDistribution만 사용
2. MonthlyTreeSnapshots.gradeDistribution은 읽기 전용 참조용으로만
3. 등급 분포 업데이트는 한 곳(gradeDistributionService)에서만

---

## 📝 다음 단계

1. ✅ **서비스 구조 분석 완료** (현재 문서)
2. ⏳ validationService, treeRestructure, treeExtractor 사용 여부 확인
3. ⏳ 불필요한 파일 삭제
4. ⏳ DB 초기화 후 7월 첫 인원 등록 테스트
5. ⏳ 디버깅하며 문제점 확인
6. ⏳ 핵심 모듈 분리 시작

---

**작성일**: 2025-10-13
**작성자**: Claude AI
**목적**: 코드 작업 전 구조 파악 및 리팩토링 계획 수립
