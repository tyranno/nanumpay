# ì„œë¹„ìŠ¤ ëª¨ë“ˆ êµ¬ì¡° ë¶„ì„ (2025-10-13)

## ğŸ“ í˜„ì¬ ì„œë¹„ìŠ¤ íŒŒì¼ ëª©ë¡

### 1. registrationService.js âœ… **í•µì‹¬ - ì‚¬ìš© ì¤‘**
**ëª©ì **: ìš©ì—­ì ë“±ë¡ ì „ì²´ í”„ë¡œì„¸ìŠ¤ í†µí•© ê´€ë¦¬
**ì£¼ìš” ê¸°ëŠ¥**:
- `processUserRegistration()` - ë©”ì¸ ë“±ë¡ ì²˜ë¦¬
- `updateMonthlyRegistrations()` - ì›”ë³„ ë“±ë¡ ì •ë³´ ì—…ë°ì´íŠ¸
- `updateMonthlyTreeSnapshots()` - ì›”ë³„ ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸
- `updateUserInsuranceSettings()` - ë³´í—˜ ì„¤ì • ì—…ë°ì´íŠ¸

**í˜¸ì¶œ ê´€ê³„**:
```
registrationService.js
  â”œâ”€> gradeCalculation.js (recalculateAllGrades)
  â”œâ”€> paymentPlanService.js (createInitialPlan, createPromotionPlan, createMonthlyAdditionalPayments)
  â””â”€> models (User, MonthlyRegistrations, MonthlyTreeSnapshots)
```

**ë¬¸ì œì **:
- ë„ˆë¬´ ë§ì€ ì±…ì„ (ë“±ë¡, íŠ¸ë¦¬, ë“±ê¸‰, ìŠ¤ëƒ…ìƒ·, ì§€ê¸‰ê³„íš, ì¶”ê°€ì§€ê¸‰)
- í•¨ìˆ˜ê°€ ë§¤ìš° ê¹€ (300ì¤„+)
- ë“±ê¸‰ ë¶„í¬ë¥¼ ì—¬ëŸ¬ ë‹¨ê³„ì—ì„œ ê°ê° ê³„ì‚°

---

### 2. paymentPlanService.js âœ… **í•µì‹¬ - ì‚¬ìš© ì¤‘**
**ëª©ì **: ì§€ê¸‰ ê³„íš ìƒì„± ë° ê´€ë¦¬
**ì£¼ìš” ê¸°ëŠ¥**:
- `createInitialPaymentPlan()` - ì‹ ê·œ ë“±ë¡ ì‹œ ê¸°ë³¸ 10íšŒ ìƒì„±
- `createPromotionPaymentPlan()` - ìŠ¹ê¸‰ ì‹œ 10íšŒ ìƒì„±
- `createMonthlyAdditionalPayments()` - v7.0 ë§¤ì›” ì¶”ê°€ì§€ê¸‰ í™•ì¸
- `checkAndCreateAdditionalPlan()` - v6.0 10íšŒ ì™„ë£Œ í›„ ì¶”ê°€ ìƒì„±
- `terminateAdditionalPlansOnPromotion()` - v7.0 ìŠ¹ê¸‰ ì‹œ ì¶”ê°€ì§€ê¸‰ ì¤‘ë‹¨

**í˜¸ì¶œ ê´€ê³„**:
```
paymentPlanService.js
  â”œâ”€> MonthlyRegistrations (ë§¤ì¶œ ì •ë³´)
  â”œâ”€> MonthlyTreeSnapshots (ë“±ê¸‰ ë¶„í¬)
  â””â”€> WeeklyPaymentPlans (ê³„íš ìƒì„±)
```

**ë¬¸ì œì **:
- ê¸ˆì•¡ ê³„ì‚° ë¡œì§ì´ ë³µì¡í•˜ê³  ì—¬ëŸ¬ ê³³ì— ë¶„ì‚°
- MonthlyTreeSnapshotsì™€ MonthlyRegistrationsì˜ gradeDistributionì„ í˜¼ìš©
- `createAdditionalPaymentForUser()`ì—ì„œ currentMonth vs revenueMonth í˜¼ë€

---

### 3. weeklyPaymentService.js âœ… **í•µì‹¬ - ì‚¬ìš© ì¤‘**
**ëª©ì **: ë§¤ì£¼ ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰ ì²˜ë¦¬
**ì£¼ìš” ê¸°ëŠ¥**:
- `processWeeklyPayments()` - ê¸ˆìš”ì¼ ìë™ ì§€ê¸‰
- `processAllPastPayments()` - ê³¼ê±° ì§€ê¸‰ ì¼ê´„ ì²˜ë¦¬
- `getWeeklyPaymentReport()` - ì£¼ê°„ ì§€ê¸‰ ë³´ê³ ì„œ

**í˜¸ì¶œ ê´€ê³„**:
```
weeklyPaymentService.js
  â”œâ”€> WeeklyPaymentPlans (ì§€ê¸‰ ëŒ€ìƒ ì¡°íšŒ)
  â”œâ”€> WeeklyPaymentSummary (ì£¼ì°¨ë³„ ì´ê³„)
  â””â”€> MonthlyRegistrations (ê¸ˆì•¡ ê³„ì‚°)
```

**ìƒíƒœ**: v7.0 ì›ì¹™ ì¤€ìˆ˜ (ìˆœìˆ˜ ì§€ê¸‰ë§Œ, ì¶”ê°€ì§€ê¸‰ í™•ì¸ ì•ˆ í•¨) âœ…

---

### 4. gradeCalculation.js âœ… **í•µì‹¬ - ì‚¬ìš© ì¤‘**
**ëª©ì **: ë“±ê¸‰ ê³„ì‚° ë¡œì§
**ì£¼ìš” ê¸°ëŠ¥**:
- `calculateGradeForUser()` - íŠ¹ì • ì‚¬ìš©ì ë“±ê¸‰ ê³„ì‚°
- `recalculateAllGrades()` - ì „ì²´ ë“±ê¸‰ ì¬ê³„ì‚° (ìƒí–¥ì‹)
- `updateParentGrade()` - ë¶€ëª¨ ë“±ê¸‰ ì—…ë°ì´íŠ¸

**í˜¸ì¶œ ê´€ê³„**:
```
gradeCalculation.js
  â””â”€> User (íŠ¸ë¦¬ êµ¬ì¡° ìˆœíšŒ)
```

**ìƒíƒœ**: ë‹¨ìˆœí•˜ê³  ëª…í™•í•¨ âœ…

---

### 5. batchProcessor.js âš ï¸ **Wrapper - ì œê±° ê³ ë ¤**
**ëª©ì **: registrationServiceë¡œì˜ ë‹¨ìˆœ ìœ„ì„
**ì£¼ìš” ê¸°ëŠ¥**:
- `processNewUsers()` â†’ `processUserRegistration()` í˜¸ì¶œ

**ë¬¸ì œì **:
- ì‹¤ì œ ë¡œì§ ì—†ìŒ, ë‹¨ìˆœ wrapper
- ì‚­ì œí•˜ê³  registrationService ì§ì ‘ í˜¸ì¶œ ê¶Œì¥

---

### 6. validationService.js âœ… **ì‚¬ìš© ì¤‘**
**ëª©ì **: ë“±ë¡ ì „ ê²€ì¦ ë¡œì§
**ì£¼ìš” ê¸°ëŠ¥**:
- `validateRegistration()` - ë“±ë¡ ì „ ê²€ì¦
- `validateInsuranceRequirement()` - ë³´í—˜ ì¡°ê±´ ê²€ì¦
- `validatePaymentEligibility()` - ì§€ê¸‰ ìê²© ê²€ì¦

**í˜¸ì¶œ ìœ„ì¹˜**:
- `apps/web/src/routes/api/admin/users/bulk/+server.js` (ë¼ì¸ 288)

**ìƒíƒœ**: ìœ ì§€ í•„ìš” âœ…

---

### 7. gradeService.js âŒ **êµ¬ë²„ì „ - ì‚¬ìš© ì•ˆ í•¨**
**ëª©ì **: TreeStats ê¸°ë°˜ ë“±ê¸‰ ê´€ë¦¬
**ë¬¸ì œì **:
- TreeStats ëª¨ë¸ ì‚¬ìš© (í˜„ì¬ User ëª¨ë¸ì— grade ì§ì ‘ ì €ì¥)
- PaymentScheduler ì˜ì¡´ (gradePaymentCount ê°œë…ì€ v7.0ì—ì„œ íê¸°)
- gradeCalculation.jsì™€ ì¤‘ë³µ

**ê²°ë¡ **: ì‚­ì œ í•„ìš” âŒ

---

### 8. treeService.js âŒ **êµ¬ë²„ì „ - ì‚¬ìš© ì•ˆ í•¨**
**ëª©ì **: TreeStats ê¸°ë°˜ íŠ¸ë¦¬ ê´€ë¦¬
**ë¬¸ì œì **:
- TreeStats ëª¨ë¸ ì˜ì¡´
- í˜„ì¬ëŠ” User ëª¨ë¸ì—ì„œ íŠ¸ë¦¬ êµ¬ì¡° ì§ì ‘ ê´€ë¦¬
- isDirty ë©”ì»¤ë‹ˆì¦˜ ë“± ë³µì¡í•œ ë¡œì§ (í˜„ì¬ ì‚¬ìš© ì•ˆ í•¨)

**ê²°ë¡ **: ì‚­ì œ í•„ìš” âŒ

---

### 9. paymentScheduler.js âš ï¸ **Wrapper - ë‹¨ìˆœí™” ê³ ë ¤**
**ëª©ì **: Cron ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
**ì£¼ìš” ê¸°ëŠ¥**:
- ê¸ˆìš”ì¼ 00:00 ìë™ ì§€ê¸‰
- ë§¤ì¼ 00:00 ë†“ì¹œ ì§€ê¸‰ í™•ì¸

**ìƒíƒœ**: weeklyPaymentServiceë¡œ ìœ„ì„ë§Œ í•¨
**ê°œì„ **: Cron ì„¤ì •ì€ í•„ìš”í•˜ì§€ë§Œ ë¡œì§ì€ ìµœì†Œí™”

---

### 10. treeRestructure.js âœ… **ì‚¬ìš© ì¤‘**
**ëª©ì **: ìŠ¤ë§ˆíŠ¸ íŠ¸ë¦¬ ì¬êµ¬ì„± (íŒë§¤ì¸ ê´€ê³„ ê³ ë ¤ ìë™ ë°°ì¹˜)
**ì£¼ìš” ê¸°ëŠ¥**:
- `smartTreeRestructure()` - íŠ¸ë¦¬ ìë™ ì¬êµ¬ì„±

**í˜¸ì¶œ ìœ„ì¹˜**:
- `apps/web/src/routes/api/admin/users/bulk/+server.js` (ë¼ì¸ 7, 416)

**ìƒíƒœ**: ìœ ì§€ í•„ìš” âœ…

---

### 11. treeExtractor.js âŒ **ì‚¬ìš© ì•ˆ í•¨**
**ëª©ì **: íŠ¸ë¦¬ êµ¬ì¡° ì¶”ì¶œ (ê³„ì¸µë„ ê·¸ë¦¬ê¸°ìš©)
**ì£¼ìš” ê¸°ëŠ¥**:
- `extractFullTree()` - ì „ì²´ íŠ¸ë¦¬ ì¶”ì¶œ
- `extractUserTree()` - íŠ¹ì • ì‚¬ìš©ì íŠ¸ë¦¬ ì¶”ì¶œ

**ë¬¸ì œì **:
- ì–´ë””ì„œë„ importë˜ì§€ ì•ŠìŒ
- ê³„ì¸µë„ í‘œì‹œëŠ” ë‹¤ë¥¸ ë°©ë²• ì‚¬ìš©

**ê²°ë¡ **: ì‚­ì œ ê³ ë ¤ âŒ

---

## ğŸ¯ ì‚­ì œ/ìˆ˜ì • ëŒ€ìƒ (ìš°ì„ ìˆœìœ„)

### ì¦‰ì‹œ ì‚­ì œ (P0) - ì‚¬ìš© ì•ˆ í•¨ í™•ì¸
1. âœ… **gradeService.js** - TreeStats ê¸°ë°˜, gradeCalculation.jsì™€ ì¤‘ë³µ, ì–´ë””ì„œë„ import ì•ˆ ë¨
2. âœ… **treeService.js** - TreeStats ê¸°ë°˜, êµ¬ë²„ì „ API 3ê³³ì—ì„œë§Œ ì‚¬ìš© (deprecated)
3. âœ… **treeExtractor.js** - ì–´ë””ì„œë„ import ì•ˆ ë¨

### ë‹¨ìˆœí™” í•„ìš” (P1) - wrapper ì—­í• ë§Œ í•¨
4. **batchProcessor.js** - registrationServiceë¡œ ë‹¨ìˆœ ìœ„ì„ë§Œ í•¨
   - **ì˜µì…˜ 1**: ì‚­ì œí•˜ê³  ì§ì ‘ í˜¸ì¶œ
   - **ì˜µì…˜ 2**: ì‹¤ì œ ë°°ì¹˜ ë¡œì§ ì¶”ê°€ (í ì‹œìŠ¤í…œ ë“±)

### ìœ ì§€ (í˜„ì¬ ì‚¬ìš© ì¤‘)
- âœ… validationService.js (bulk uploadì—ì„œ ì‚¬ìš©)
- âœ… treeRestructure.js (bulk uploadì—ì„œ ì‚¬ìš©)

---

## ğŸ“Š í•µì‹¬ ëª¨ë“ˆ (ìœ ì§€)

| ëª¨ë“ˆ | ëª©ì  | ìƒíƒœ | ë¦¬íŒ©í† ë§ í•„ìš” |
|------|------|------|--------------|
| registrationService.js | ë“±ë¡ í†µí•© ê´€ë¦¬ | ì‚¬ìš© ì¤‘ | âœ… ë†’ìŒ |
| paymentPlanService.js | ì§€ê¸‰ ê³„íš ìƒì„± | ì‚¬ìš© ì¤‘ | âœ… ë†’ìŒ |
| weeklyPaymentService.js | ê¸ˆìš”ì¼ ì§€ê¸‰ | ì‚¬ìš© ì¤‘ | âš ï¸ ì¤‘ê°„ |
| gradeCalculation.js | ë“±ê¸‰ ê³„ì‚° | ì‚¬ìš© ì¤‘ | âœ… ë‚®ìŒ |
| paymentScheduler.js | Cron ìŠ¤ì¼€ì¤„ | ì‚¬ìš© ì¤‘ | âš ï¸ ë‚®ìŒ |

---

## ğŸ”§ ë¦¬íŒ©í† ë§ ê³„íš

### 1ë‹¨ê³„: ë¶ˆí•„ìš”í•œ íŒŒì¼ ì‚­ì œ
- âœ… gradeService.js ì‚­ì œ
- âœ… treeService.js ì‚­ì œ (ë˜ëŠ” deprecated API í•¨ê»˜ ì œê±°)
- âœ… treeExtractor.js ì‚­ì œ
- âš ï¸ batchProcessor.js - ê²€í†  í›„ ê²°ì •

### 2ë‹¨ê³„: í•µì‹¬ ëª¨ë“ˆ ë¶„ë¦¬
**ìƒˆ ëª¨ë“ˆ ìƒì„±**:
- `gradeDistributionService.js` - ë“±ê¸‰ ë¶„í¬ ê³„ì‚° í†µí•©
- `paymentCalculationService.js` - ì§€ê¸‰ì•¡ ê³„ì‚° í†µí•©
- `additionalPaymentService.js` - ì¶”ê°€ì§€ê¸‰ ë¡œì§ ë¶„ë¦¬

### 3ë‹¨ê³„: registrationService ë‹¨ìˆœí™”
- ê° ë‹¨ê³„ë¥¼ ë…ë¦½ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
- ë“±ê¸‰ ë¶„í¬ ê³„ì‚°ì„ gradeDistributionServiceë¡œ ìœ„ì„
- ì¶”ê°€ì§€ê¸‰ ë¡œì§ì„ additionalPaymentServiceë¡œ ìœ„ì„

---

## ğŸ› í˜„ì¬ ë²„ê·¸ì˜ ì›ì¸

### ì¶”ê°€ì§€ê¸‰ ê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜
**ìœ„ì¹˜**: `paymentPlanService.js` - `createAdditionalPaymentForUser()`

**ë¬¸ì œ**:
```javascript
// í˜„ì¬ ì½”ë“œ (751ë¼ì¸ ë¶€ê·¼)
const currentSnapshot = await MonthlyTreeSnapshots.findOne({ monthKey: currentMonth });
const currentMonthReg = await MonthlyRegistrations.findOne({ monthKey: currentMonth });

// âš ï¸ ë¬¸ì œ: currentSnapshot.gradeDistributionì„ ì‚¬ìš©
const gradePayments = calculateGradePayments(revenue, currentSnapshot.gradeDistribution);
```

**í•´ê²° ë°©ì•ˆ**:
1. **ë‹¨ì¼ ì§„ì‹¤ì˜ ì†ŒìŠ¤** ê²°ì •: MonthlyRegistrations.gradeDistributionë§Œ ì‚¬ìš©
2. MonthlyTreeSnapshots.gradeDistributionì€ ì½ê¸° ì „ìš© ì°¸ì¡°ìš©ìœ¼ë¡œë§Œ
3. ë“±ê¸‰ ë¶„í¬ ì—…ë°ì´íŠ¸ëŠ” í•œ ê³³(gradeDistributionService)ì—ì„œë§Œ

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. âœ… **ì„œë¹„ìŠ¤ êµ¬ì¡° ë¶„ì„ ì™„ë£Œ** (í˜„ì¬ ë¬¸ì„œ)
2. â³ validationService, treeRestructure, treeExtractor ì‚¬ìš© ì—¬ë¶€ í™•ì¸
3. â³ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì‚­ì œ
4. â³ DB ì´ˆê¸°í™” í›„ 7ì›” ì²« ì¸ì› ë“±ë¡ í…ŒìŠ¤íŠ¸
5. â³ ë””ë²„ê¹…í•˜ë©° ë¬¸ì œì  í™•ì¸
6. â³ í•µì‹¬ ëª¨ë“ˆ ë¶„ë¦¬ ì‹œì‘

---

**ì‘ì„±ì¼**: 2025-10-13
**ì‘ì„±ì**: Claude AI
**ëª©ì **: ì½”ë“œ ì‘ì—… ì „ êµ¬ì¡° íŒŒì•… ë° ë¦¬íŒ©í† ë§ ê³„íš ìˆ˜ë¦½
