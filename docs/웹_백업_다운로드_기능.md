# ì›¹ ë°±ì—… ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥

**ë‚ ì§œ**: 2025-10-26
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ê°œìš”

ì›¹ UIì—ì„œ ì¦‰ì‹œ ë°±ì—…ì„ ì‹¤í–‰í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

1. **ì›¹ UIì—ì„œ ì¦‰ì‹œ ë°±ì—… ì‹¤í–‰**: "ì¦‰ì‹œ ë°±ì—… ë° ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ í´ë¦­
2. **ìë™ ë‹¤ìš´ë¡œë“œ**: ë°±ì—… ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹œì‘
3. **ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ**: ë°±ì—… ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ

---

## ğŸ¯ ì‚¬ìš© ë°©ë²•

### 1. ì›¹ UIì—ì„œ ë°±ì—…

1. ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†: http://localhost:3100/admin (ë˜ëŠ” ì„œë²„ IP)
2. ë¡œê·¸ì¸ (ê´€ë¦¬ì ê³„ì •)
3. ìƒë‹¨ ë©”ë‰´: **ê´€ë¦¬ì ì„¤ì •** í´ë¦­
4. **ì‹œìŠ¤í…œ ì„¤ì •** íƒ­ í´ë¦­
5. **ìë™ ë°±ì—…** ì„¹ì…˜ì—ì„œ **"ì¦‰ì‹œ ë°±ì—… ë° ë‹¤ìš´ë¡œë“œ"** ë²„íŠ¼ í´ë¦­
6. ë°±ì—… ì§„í–‰ ë©”ì‹œì§€ í™•ì¸:
   - "ë°±ì—…ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 5ë¶„ ì†Œìš”)"
   - "ë°±ì—… ì™„ë£Œ! ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
7. ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ í´ë”ì— ë°±ì—… íŒŒì¼ ìë™ ì €ì¥

### 2. ë°±ì—… íŒŒì¼ ì •ë³´

- **íŒŒì¼ëª… í˜•ì‹**: `nanumpay-backup-YYYY-MM-DDTHH-MM-SS.tar.gz`
- **ì˜ˆì‹œ**: `nanumpay-backup-2025-10-26T03-55-12.tar.gz`
- **ì••ì¶• í˜•ì‹**: gzip (tar.gz)
- **í‰ê·  í¬ê¸°**: 10-50KB (ë°ì´í„°ì–‘ì— ë”°ë¼ ë‹¤ë¦„)

---

## ğŸ”§ ê¸°ìˆ  êµ¬í˜„

### 1. API ì—”ë“œí¬ì¸íŠ¸

#### POST `/api/admin/backup/execute`

**ë°±ì—… ì‹¤í–‰ API**

**ìš”ì²­**:
```javascript
POST /api/admin/backup/execute
Content-Type: application/json
Cookie: token=<JWT>
```

**ì‘ë‹µ** (ì„±ê³µ):
```json
{
  "success": true,
  "message": "ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  "backupFile": {
    "path": "/tmp/nanumpay-backups/nanumpay-backup-2025-10-26T03-55-12.tar.gz",
    "filename": "nanumpay-backup-2025-10-26T03-55-12.tar.gz"
  }
}
```

**ì‘ë‹µ** (ì‹¤íŒ¨):
```json
{
  "success": false,
  "message": "ì˜¤ë¥˜ ë©”ì‹œì§€",
  "error": "ìƒì„¸ ì˜¤ë¥˜ ì •ë³´"
}
```

**íŒŒì¼ ìœ„ì¹˜**: [apps/web/src/routes/api/admin/backup/execute/+server.js](../apps/web/src/routes/api/admin/backup/execute/+server.js)

**ì£¼ìš” ë¡œì§**:
1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (`locals.user.type === 'admin'`)
2. ë°±ì—… ì•± ê²½ë¡œ í™•ì¸ (ê°œë°œ/í”„ë¡œë•ì…˜ êµ¬ë¶„)
3. ë°±ì—… ì•± ì‹¤í–‰ (ìµœëŒ€ 5ë¶„ íƒ€ì„ì•„ì›ƒ)
4. stdoutì—ì„œ ë°±ì—… íŒŒì¼ëª… ì¶”ì¶œ
5. íŒŒì¼ ì¡´ì¬ í™•ì¸ í›„ ì‘ë‹µ

#### GET `/api/admin/backup/download?file={filename}`

**ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ API**

**ìš”ì²­**:
```
GET /api/admin/backup/download?file=nanumpay-backup-2025-10-26T03-55-12.tar.gz
Cookie: token=<JWT>
```

**ì‘ë‹µ** (ì„±ê³µ):
- **Status**: 200 OK
- **Content-Type**: `application/gzip`
- **Content-Disposition**: `attachment; filename="nanumpay-backup-2025-10-26T03-55-12.tar.gz"`
- **Body**: íŒŒì¼ ìŠ¤íŠ¸ë¦¼

**ì‘ë‹µ** (ì‹¤íŒ¨):
- **Status**: 403/404/500
- **Content-Type**: `application/json`
```json
{
  "message": "ì˜¤ë¥˜ ë©”ì‹œì§€"
}
```

**íŒŒì¼ ìœ„ì¹˜**: [apps/web/src/routes/api/admin/backup/download/+server.js](../apps/web/src/routes/api/admin/backup/download/+server.js)

**ë³´ì•ˆ ê¸°ëŠ¥**:
1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
2. íŒŒì¼ëª… ê²€ì¦ (ê²½ë¡œ ì¡°ì‘ ë°©ì§€: `..`, `/`, `\` ì°¨ë‹¨)
3. íŒŒì¼ëª… íŒ¨í„´ ê²€ì¦: `nanumpay-backup-*.tar.gz`
4. ë°±ì—… ë””ë ‰í† ë¦¬ ë‚´ë¶€ íŒŒì¼ë§Œ ì ‘ê·¼ í—ˆìš©

### 2. UI ì»´í¬ë„ŒíŠ¸

**íŒŒì¼ ìœ„ì¹˜**: [apps/web/src/routes/(admin)/admin/settings/+page.svelte](../apps/web/src/routes/(admin)/admin/settings/+page.svelte)

**ì¶”ê°€ëœ ìš”ì†Œ**:

#### ë²„íŠ¼
```svelte
<button
  type="button"
  onclick={handleExecuteBackup}
  disabled={isBackupRunning}
  class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 rounded transition-colors"
>
  {isBackupRunning ? 'ë°±ì—… ì¤‘...' : 'ì¦‰ì‹œ ë°±ì—… ë° ë‹¤ìš´ë¡œë“œ'}
</button>
```

#### ìƒíƒœ ë©”ì‹œì§€
```svelte
{#if backupMessage}
  <div class="mb-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
    {backupMessage}
  </div>
{/if}
```

#### í•¸ë“¤ëŸ¬ í•¨ìˆ˜
```javascript
async function handleExecuteBackup() {
  // 1. ë°±ì—… ì‹¤í–‰ API í˜¸ì¶œ
  const response = await fetch('/api/admin/backup/execute', { method: 'POST' });
  const data = await response.json();

  // 2. ì„±ê³µ ì‹œ ìë™ ë‹¤ìš´ë¡œë“œ
  if (data.success && data.backupFile) {
    const downloadUrl = `/api/admin/backup/download?file=${encodeURIComponent(data.backupFile.filename)}`;
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = data.backupFile.filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ìë™ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼ ìœ„ì¹˜**: [scripts/test/test_web_backup_download.sh](../scripts/test/test_web_backup_download.sh)

**ì‹¤í–‰ ë°©ë²•**:
```bash
# ì„œë²„ ì‹œì‘ (í•„ìˆ˜)
BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host

# í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
bash scripts/test/test_web_backup_download.sh
```

**í…ŒìŠ¤íŠ¸ í•­ëª©**:
1. âœ… ë°±ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„
2. âœ… ì›¹ ì„œë²„ ìƒíƒœ í™•ì¸
3. âœ… ë°±ì—… íŒŒì¼ ìƒì„± (ì›¹ UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰)
4. âœ… ì••ì¶• íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
5. âœ… ë°±ì—… ë‚´ìš© í™•ì¸ (ì»¬ë ‰ì…˜ ìˆ˜)
6. âœ… ë‹¤ìš´ë¡œë“œ API í…ŒìŠ¤íŠ¸

### ìˆ˜ë™ í…ŒìŠ¤íŠ¸

1. **ì›¹ ì„œë²„ ì‹œì‘**:
   ```bash
   BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host
   ```

2. **ë¸Œë¼ìš°ì € ì ‘ì†**: http://localhost:3100/admin

3. **ë¡œê·¸ì¸**:
   - ì•„ì´ë””: `ê´€ë¦¬ì`
   - ë¹„ë°€ë²ˆí˜¸: `admin1234!!`

4. **ë°±ì—… ì‹¤í–‰**:
   - ê´€ë¦¬ì ì„¤ì • â†’ ì‹œìŠ¤í…œ ì„¤ì • íƒ­
   - "ì¦‰ì‹œ ë°±ì—… ë° ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ í´ë¦­

5. **ê²€ì¦**:
   - ë°±ì—… ì§„í–‰ ë©”ì‹œì§€ í‘œì‹œ í™•ì¸
   - ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹œì‘ í™•ì¸
   - ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì••ì¶• í•´ì œ í…ŒìŠ¤íŠ¸

---

## ğŸ” ë¬¸ì œ í•´ê²°

### 1. "ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤" ì˜¤ë¥˜

**ì›ì¸**: ì„¸ì…˜/JWT í† í° ì—†ìŒ ë˜ëŠ” ë§Œë£Œ

**í•´ê²°**:
1. ë¡œê·¸ì•„ì›ƒ í›„ ì¬ë¡œê·¸ì¸
2. ë¸Œë¼ìš°ì € ì¿ í‚¤ í™•ì¸
3. ê°œë°œì ë„êµ¬ â†’ Application â†’ Cookies â†’ `token` í™•ì¸

### 2. "ë°±ì—… ì•±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ì˜¤ë¥˜

**ì›ì¸**: ë°±ì—… ì•±ì´ ë¹Œë“œë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```bash
# ë°±ì—… ì•± ë¹Œë“œ
cd apps/backup
bash build.sh

# í™•ì¸
ls -lh build/nanumpay-backup
```

### 3. "ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ì˜¤ë¥˜

**ì›ì¸**: BACKUP_PATH í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •

**í•´ê²°**:
```bash
# ì›¹ ì„œë²„ë¥¼ BACKUP_PATHì™€ í•¨ê»˜ ì‹œì‘
BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host
```

### 4. FTP ì—…ë¡œë“œ ì‹¤íŒ¨ ê²½ê³ 

**ìƒí™©**: ë°±ì—…ì€ ì„±ê³µí•˜ì§€ë§Œ FTP ì—…ë¡œë“œ ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ

**ì˜í–¥**: ì—†ìŒ (ë¡œì»¬ ë°±ì—…ì€ ì •ìƒ ì™„ë£Œ)

**ì›ì¸**: FTP ì„œë²„ ë¯¸ì„¤ì • ë˜ëŠ” ì—°ê²° ì‹¤íŒ¨

**í•´ê²°** (ì„ íƒ):
- FTP ì„œë²„ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
- FTP ì—…ë¡œë“œê°€ í•„ìš”í•˜ë©´ ê´€ë¦¬ì ì„¤ì •ì—ì„œ FTP ì •ë³´ ì…ë ¥

### 5. ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- íŒì—… ì°¨ë‹¨
- ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •

**í•´ê²°**:
1. ë¸Œë¼ìš°ì € íŒì—… ì°¨ë‹¨ í•´ì œ
2. ë‹¤ìš´ë¡œë“œ í—ˆìš© ì„¤ì • í™•ì¸
3. ê°œë°œì ë„êµ¬ â†’ Network íƒ­ì—ì„œ ë‹¤ìš´ë¡œë“œ ìš”ì²­ í™•ì¸

---

## ğŸ“Š íŒŒì¼ êµ¬ì¡°

### ë°±ì—… íŒŒì¼ ë‚´ë¶€ êµ¬ì¡°

```
nanumpay-backup-2025-10-26T03-55-12.tar.gz
â””â”€â”€ nanumpay-backup-2025-10-26T03-55-12/
    â””â”€â”€ nanumpay/
        â”œâ”€â”€ admins.bson
        â”œâ”€â”€ admins.metadata.json
        â”œâ”€â”€ monthlyregistrations.bson
        â”œâ”€â”€ monthlyregistrations.metadata.json
        â”œâ”€â”€ planneraccounts.bson
        â”œâ”€â”€ planneraccounts.metadata.json
        â”œâ”€â”€ useraccounts.bson
        â”œâ”€â”€ useraccounts.metadata.json
        â”œâ”€â”€ users.bson
        â”œâ”€â”€ users.metadata.json
        â”œâ”€â”€ weeklypaymentplans.bson
        â”œâ”€â”€ weeklypaymentplans.metadata.json
        â”œâ”€â”€ weeklypaymentsummaries.bson
        â””â”€â”€ weeklypaymentsummaries.metadata.json
```

### ë³µì› ë°©ë²•

```bash
# 1. ì••ì¶• í•´ì œ
tar -xzf nanumpay-backup-2025-10-26T03-55-12.tar.gz

# 2. MongoDB ë³µì›
mongorestore --uri="mongodb://localhost:27017" \
  --db=nanumpay \
  ./nanumpay-backup-2025-10-26T03-55-12/nanumpay
```

---

## ğŸš€ ë°°í¬ ì‹œ ê³ ë ¤ì‚¬í•­

### 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì •

**í”„ë¡œë•ì…˜ í™˜ê²½**:
```bash
# /etc/nanumpay/nanumpay.env
BACKUP_PATH=/opt/nanumpay/backups
MONGODB_URI=mongodb://localhost:27017/nanumpay
```

**ê°œë°œ í™˜ê²½**:
```bash
# .env ë˜ëŠ” ì‹¤í–‰ ì‹œ
BACKUP_PATH=/tmp/nanumpay-backups
```

### 2. ë°±ì—… ë””ë ‰í† ë¦¬ ê¶Œí•œ

```bash
# ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /opt/nanumpay/backups

# ê¶Œí•œ ì„¤ì •
sudo chown -R nanumpay:nanumpay /opt/nanumpay/backups
sudo chmod 755 /opt/nanumpay/backups
```

### 3. ë°±ì—… íŒŒì¼ í¬ê¸° ì œí•œ

**Nginx ì„¤ì •** (í•„ìš” ì‹œ):
```nginx
# /etc/nginx/sites-available/nanumpay
server {
    # ...
    client_max_body_size 100M;  # ë°±ì—… íŒŒì¼ í¬ê¸°ì— ë§ê²Œ ì¡°ì •
}
```

### 4. íƒ€ì„ì•„ì›ƒ ì„¤ì •

- **API íƒ€ì„ì•„ì›ƒ**: 5ë¶„ (300ì´ˆ)
- **í° ë°ì´í„°ë² ì´ìŠ¤**: í•„ìš” ì‹œ `execFileAsync` íƒ€ì„ì•„ì›ƒ ì¦ê°€

---

## ğŸ” ë³´ì•ˆ

### 1. ì ‘ê·¼ ì œì–´

- âœ… ê´€ë¦¬ì ê¶Œí•œ í•„ìˆ˜ (`locals.user.type === 'admin'`)
- âœ… JWT í† í° ê¸°ë°˜ ì¸ì¦
- âœ… ì„¸ì…˜ ì¿ í‚¤ ì‚¬ìš© (httpOnly, secure, sameSite)

### 2. ê²½ë¡œ ì¡°ì‘ ë°©ì§€

- âœ… íŒŒì¼ëª…ì— `..`, `/`, `\` ì°¨ë‹¨
- âœ… íŒŒì¼ëª… íŒ¨í„´ ê²€ì¦ (ì •ê·œì‹)
- âœ… ë°±ì—… ë””ë ‰í† ë¦¬ ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨

### 3. íŒŒì¼ ê²€ì¦

- âœ… ì••ì¶• íŒŒì¼ ë¬´ê²°ì„± í™•ì¸ (tar -tzf)
- âœ… íŒŒì¼ í¬ê¸° í™•ì¸
- âœ… ì¡´ì¬ ì—¬ë¶€ í™•ì¸

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

1. [ë°±ì—…_ì‹œìŠ¤í…œ_ìµœì¢…_í†µí•©.md](ë°±ì—…_ì‹œìŠ¤í…œ_ìµœì¢…_í†µí•©.md) - ë°±ì—… ì‹œìŠ¤í…œ ì „ì²´ êµ¬ì¡°
2. [Nginx_ë¦¬ë²„ìŠ¤í”„ë¡ì‹œ_í†µí•©.md](Nginx_ë¦¬ë²„ìŠ¤í”„ë¡ì‹œ_í†µí•©.md) - Nginx ì„¤ì •
3. [CLAUDE.md](../CLAUDE.md) - í”„ë¡œì íŠ¸ ì „ì²´ ë¬¸ì„œ

---

## âœ… ì™„ë£Œ í•­ëª©

- [x] ë°±ì—… ì‹¤í–‰ API êµ¬í˜„ (`/api/admin/backup/execute`)
- [x] ë°±ì—… ë‹¤ìš´ë¡œë“œ API êµ¬í˜„ (`/api/admin/backup/download`)
- [x] UI ë²„íŠ¼ ì¶”ê°€ (ê´€ë¦¬ì ì„¤ì • â†’ ì‹œìŠ¤í…œ ì„¤ì •)
- [x] ì‹¤ì‹œê°„ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
- [x] ìë™ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
- [x] ê¶Œí•œ í™•ì¸ (ê´€ë¦¬ì ì „ìš©)
- [x] íŒŒì¼ëª… ê²€ì¦ (ë³´ì•ˆ)
- [x] ê²½ë¡œ ì¡°ì‘ ë°©ì§€
- [x] í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [x] ë¬¸ì„œí™”

---

**ì‘ì„±ì**: Claude AI Assistant
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-26
