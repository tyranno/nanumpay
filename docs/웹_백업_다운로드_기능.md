# 웹 백업 다운로드 기능

**날짜**: 2025-10-26
**상태**: ✅ 완료

---

## 📋 개요

웹 UI에서 즉시 백업을 실행하고 다운로드할 수 있는 기능이 추가되었습니다.

### 주요 기능

1. **웹 UI에서 즉시 백업 실행**: "즉시 백업 및 다운로드" 버튼 클릭
2. **자동 다운로드**: 백업 완료 후 자동으로 브라우저 다운로드 시작
3. **실시간 상태 표시**: 백업 진행 상태 메시지 표시

---

## 🎯 사용 방법

### 1. 웹 UI에서 백업

1. 브라우저로 접속: http://localhost:3100/admin (또는 서버 IP)
2. 로그인 (관리자 계정)
3. 상단 메뉴: **관리자 설정** 클릭
4. **시스템 설정** 탭 클릭
5. **자동 백업** 섹션에서 **"즉시 백업 및 다운로드"** 버튼 클릭
6. 백업 진행 메시지 확인:
   - "백업을 실행 중입니다... (최대 5분 소요)"
   - "백업 완료! 다운로드를 시작합니다..."
7. 브라우저 다운로드 폴더에 백업 파일 자동 저장

### 2. 백업 파일 정보

- **파일명 형식**: `nanumpay-backup-YYYY-MM-DDTHH-MM-SS.tar.gz`
- **예시**: `nanumpay-backup-2025-10-26T03-55-12.tar.gz`
- **압축 형식**: gzip (tar.gz)
- **평균 크기**: 10-50KB (데이터양에 따라 다름)

---

## 🔧 기술 구현

### 1. API 엔드포인트

#### POST `/api/admin/backup/execute`

**백업 실행 API**

**요청**:
```javascript
POST /api/admin/backup/execute
Content-Type: application/json
Cookie: token=<JWT>
```

**응답** (성공):
```json
{
  "success": true,
  "message": "백업이 성공적으로 완료되었습니다.",
  "backupFile": {
    "path": "/tmp/nanumpay-backups/nanumpay-backup-2025-10-26T03-55-12.tar.gz",
    "filename": "nanumpay-backup-2025-10-26T03-55-12.tar.gz"
  }
}
```

**응답** (실패):
```json
{
  "success": false,
  "message": "오류 메시지",
  "error": "상세 오류 정보"
}
```

**파일 위치**: [apps/web/src/routes/api/admin/backup/execute/+server.js](../apps/web/src/routes/api/admin/backup/execute/+server.js)

**주요 로직**:
1. 관리자 권한 확인 (`locals.user.type === 'admin'`)
2. 백업 앱 경로 확인 (개발/프로덕션 구분)
3. 백업 앱 실행 (최대 5분 타임아웃)
4. stdout에서 백업 파일명 추출
5. 파일 존재 확인 후 응답

#### GET `/api/admin/backup/download?file={filename}`

**백업 파일 다운로드 API**

**요청**:
```
GET /api/admin/backup/download?file=nanumpay-backup-2025-10-26T03-55-12.tar.gz
Cookie: token=<JWT>
```

**응답** (성공):
- **Status**: 200 OK
- **Content-Type**: `application/gzip`
- **Content-Disposition**: `attachment; filename="nanumpay-backup-2025-10-26T03-55-12.tar.gz"`
- **Body**: 파일 스트림

**응답** (실패):
- **Status**: 403/404/500
- **Content-Type**: `application/json`
```json
{
  "message": "오류 메시지"
}
```

**파일 위치**: [apps/web/src/routes/api/admin/backup/download/+server.js](../apps/web/src/routes/api/admin/backup/download/+server.js)

**보안 기능**:
1. 관리자 권한 확인
2. 파일명 검증 (경로 조작 방지: `..`, `/`, `\` 차단)
3. 파일명 패턴 검증: `nanumpay-backup-*.tar.gz`
4. 백업 디렉토리 내부 파일만 접근 허용

### 2. UI 컴포넌트

**파일 위치**: [apps/web/src/routes/(admin)/admin/settings/+page.svelte](../apps/web/src/routes/(admin)/admin/settings/+page.svelte)

**추가된 요소**:

#### 버튼
```svelte
<button
  type="button"
  onclick={handleExecuteBackup}
  disabled={isBackupRunning}
  class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 rounded transition-colors"
>
  {isBackupRunning ? '백업 중...' : '즉시 백업 및 다운로드'}
</button>
```

#### 상태 메시지
```svelte
{#if backupMessage}
  <div class="mb-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
    {backupMessage}
  </div>
{/if}
```

#### 핸들러 함수
```javascript
async function handleExecuteBackup() {
  // 1. 백업 실행 API 호출
  const response = await fetch('/api/admin/backup/execute', { method: 'POST' });
  const data = await response.json();

  // 2. 성공 시 자동 다운로드
  if (data.success && data.backupFile) {
    const downloadUrl = `/api/admin/backup/download?file=${encodeURIComponent(data.backupFile.filename)}`;
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = data.backupFile.filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
}
```

---

## 🧪 테스트

### 자동 테스트 스크립트

**파일 위치**: [scripts/test/test_web_backup_download.sh](../scripts/test/test_web_backup_download.sh)

**실행 방법**:
```bash
# 서버 시작 (필수)
BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host

# 테스트 스크립트 실행
bash scripts/test/test_web_backup_download.sh
```

**테스트 항목**:
1. ✅ 백업 디렉토리 준비
2. ✅ 웹 서버 상태 확인
3. ✅ 백업 파일 생성 (웹 UI에서 수동 실행)
4. ✅ 압축 파일 무결성 검증
5. ✅ 백업 내용 확인 (컬렉션 수)
6. ✅ 다운로드 API 테스트

### 수동 테스트

1. **웹 서버 시작**:
   ```bash
   BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host
   ```

2. **브라우저 접속**: http://localhost:3100/admin

3. **로그인**:
   - 아이디: `관리자`
   - 비밀번호: `admin1234!!`

4. **백업 실행**:
   - 관리자 설정 → 시스템 설정 탭
   - "즉시 백업 및 다운로드" 버튼 클릭

5. **검증**:
   - 백업 진행 메시지 표시 확인
   - 브라우저 다운로드 시작 확인
   - 다운로드 파일 압축 해제 테스트

---

## 🔍 문제 해결

### 1. "관리자 권한이 필요합니다" 오류

**원인**: 세션/JWT 토큰 없음 또는 만료

**해결**:
1. 로그아웃 후 재로그인
2. 브라우저 쿠키 확인
3. 개발자 도구 → Application → Cookies → `token` 확인

### 2. "백업 앱을 찾을 수 없습니다" 오류

**원인**: 백업 앱이 빌드되지 않음

**해결**:
```bash
# 백업 앱 빌드
cd apps/backup
bash build.sh

# 확인
ls -lh build/nanumpay-backup
```

### 3. "백업 파일을 찾을 수 없습니다" 오류

**원인**: BACKUP_PATH 환경변수 미설정

**해결**:
```bash
# 웹 서버를 BACKUP_PATH와 함께 시작
BACKUP_PATH=/tmp/nanumpay-backups pnpm dev:web --host
```

### 4. FTP 업로드 실패 경고

**상황**: 백업은 성공하지만 FTP 업로드 실패 메시지 표시

**영향**: 없음 (로컬 백업은 정상 완료)

**원인**: FTP 서버 미설정 또는 연결 실패

**해결** (선택):
- FTP 서버 설정이 필요하지 않으면 무시
- FTP 업로드가 필요하면 관리자 설정에서 FTP 정보 입력

### 5. 다운로드가 시작되지 않음

**원인**:
- 팝업 차단
- 브라우저 보안 설정

**해결**:
1. 브라우저 팝업 차단 해제
2. 다운로드 허용 설정 확인
3. 개발자 도구 → Network 탭에서 다운로드 요청 확인

---

## 📊 파일 구조

### 백업 파일 내부 구조

```
nanumpay-backup-2025-10-26T03-55-12.tar.gz
└── nanumpay-backup-2025-10-26T03-55-12/
    └── nanumpay/
        ├── admins.bson
        ├── admins.metadata.json
        ├── monthlyregistrations.bson
        ├── monthlyregistrations.metadata.json
        ├── planneraccounts.bson
        ├── planneraccounts.metadata.json
        ├── useraccounts.bson
        ├── useraccounts.metadata.json
        ├── users.bson
        ├── users.metadata.json
        ├── weeklypaymentplans.bson
        ├── weeklypaymentplans.metadata.json
        ├── weeklypaymentsummaries.bson
        └── weeklypaymentsummaries.metadata.json
```

### 복원 방법

```bash
# 1. 압축 해제
tar -xzf nanumpay-backup-2025-10-26T03-55-12.tar.gz

# 2. MongoDB 복원
mongorestore --uri="mongodb://localhost:27017" \
  --db=nanumpay \
  ./nanumpay-backup-2025-10-26T03-55-12/nanumpay
```

---

## 🚀 배포 시 고려사항

### 1. 환경변수 설정

**프로덕션 환경**:
```bash
# /etc/nanumpay/nanumpay.env
BACKUP_PATH=/opt/nanumpay/backups
MONGODB_URI=mongodb://localhost:27017/nanumpay
```

**개발 환경**:
```bash
# .env 또는 실행 시
BACKUP_PATH=/tmp/nanumpay-backups
```

### 2. 백업 디렉토리 권한

```bash
# 디렉토리 생성
sudo mkdir -p /opt/nanumpay/backups

# 권한 설정
sudo chown -R nanumpay:nanumpay /opt/nanumpay/backups
sudo chmod 755 /opt/nanumpay/backups
```

### 3. 백업 파일 크기 제한

**Nginx 설정** (필요 시):
```nginx
# /etc/nginx/sites-available/nanumpay
server {
    # ...
    client_max_body_size 100M;  # 백업 파일 크기에 맞게 조정
}
```

### 4. 타임아웃 설정

- **API 타임아웃**: 5분 (300초)
- **큰 데이터베이스**: 필요 시 `execFileAsync` 타임아웃 증가

---

## 🔐 보안

### 1. 접근 제어

- ✅ 관리자 권한 필수 (`locals.user.type === 'admin'`)
- ✅ JWT 토큰 기반 인증
- ✅ 세션 쿠키 사용 (httpOnly, secure, sameSite)

### 2. 경로 조작 방지

- ✅ 파일명에 `..`, `/`, `\` 차단
- ✅ 파일명 패턴 검증 (정규식)
- ✅ 백업 디렉토리 외부 접근 차단

### 3. 파일 검증

- ✅ 압축 파일 무결성 확인 (tar -tzf)
- ✅ 파일 크기 확인
- ✅ 존재 여부 확인

---

## 📚 참고 문서

1. [백업_시스템_최종_통합.md](백업_시스템_최종_통합.md) - 백업 시스템 전체 구조
2. [Nginx_리버스프록시_통합.md](Nginx_리버스프록시_통합.md) - Nginx 설정
3. [CLAUDE.md](../CLAUDE.md) - 프로젝트 전체 문서

---

## ✅ 완료 항목

- [x] 백업 실행 API 구현 (`/api/admin/backup/execute`)
- [x] 백업 다운로드 API 구현 (`/api/admin/backup/download`)
- [x] UI 버튼 추가 (관리자 설정 → 시스템 설정)
- [x] 실시간 상태 메시지 표시
- [x] 자동 다운로드 기능
- [x] 권한 확인 (관리자 전용)
- [x] 파일명 검증 (보안)
- [x] 경로 조작 방지
- [x] 테스트 스크립트 작성
- [x] 문서화

---

**작성자**: Claude AI Assistant
**최종 수정일**: 2025-10-26
