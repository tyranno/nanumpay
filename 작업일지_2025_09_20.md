# MLM 지급 시스템 개발 작업 일지

**작업 일자**: 2025년 9월 20일
**프로젝트**: Nanumpay MLM 지급 시스템

## 📋 프로젝트 개요

### 시스템 목적
- 2진 트리 계층 구조 기반의 MLM(다단계 마케팅) 지급 시스템
- 용역자 등록 시 자동 매출 계산 및 등급별 지급액 산정
- 10주 분할 지급 시스템

### 기술 스택
- **프론트엔드**: SvelteKit
- **백엔드**: Node.js, Express (SvelteKit 내장)
- **데이터베이스**: MongoDB (Mongoose ODM)
- **패키지 매니저**: pnpm (중요: npm이 아님)
- **인증**: JWT 기반

## 🎯 핵심 요구사항

### 1. 사용자 관리
- **한글 ID 사용**: loginId를 한글로 생성 (예: 홍길동, 김철수)
- **2진 트리 구조**: 각 사용자는 최대 2명의 하위 조직원 보유
- **엑셀 일괄 등록**: 대량 사용자를 엑셀로 한 번에 등록
- **자동 부모-자식 관계 설정**: 엑셀 순서대로 트리 구조 생성
- **Admin과 User 컬렉션 분리**: 관리자와 용역자는 별도 컬렉션으로 관리

### 2. 등급 시스템 (F1~F8)
- **등급 요건** (work_plan.txt 기준):
  - **F1**: 나의 자식이 없거나 하나인 경우
  - **F2**: 나의 자식이 왼쪽, 오른쪽 모두 지정된 경우
  - **F3**: 나의 아래 조직이 F2등급이 2개 존재 && 왼쪽 자식 하위 1개, 오른쪽 하위 1개
  - **F4**: 나의 아래 조직이 F3등급이 2개 존재 && 왼쪽 자식 하위 1개, 오른쪽 하위 1개
  - **F5**: 나의 아래 조직이 F4등급이 2개 존재 && (왼쪽 2개, 오른쪽 1개 또는 왼쪽 1개, 오른쪽 2개)
  - **F6**: 나의 아래 조직이 F5등급이 2개 존재 && (왼쪽 2개, 오른쪽 1개 또는 왼쪽 1개, 오른쪽 2개)
  - **F7**: 나의 아래 조직이 F6등급이 2개 존재 && (왼쪽 2개, 오른쪽 1개 또는 왼쪽 1개, 오른쪽 2개)
  - **F8**: 나의 아래 조직이 F7등급이 2개 존재 && (왼쪽 2개, 오른쪽 1개 또는 왼쪽 1개, 오른쪽 2개)

### 3. 매출 및 지급 계산

#### 매출 계산
- **기본 매출**: 신규 가입자 1인당 1천만원
- **월별 매출**: 해당 월 신규 가입자 수 × 1천만원
- **분할 지급**: 총매출을 10회로 나눔 (1회당 총매출/10)

#### 등급별 지급 비율
```
F1: 24%, F2: 19%, F3: 14%, F4: 9%
F5: 5%, F6: 3%, F7: 2%, F8: 1%
```

#### 지급액 계산 방식 (누적식)
- F1: (총매출 × 24%) ÷ (F1인원 + F2인원)
- F2: F1지급액 + [(총매출 × 19%) ÷ (F2인원 + F3인원)]
- F3: F2지급액 + [(총매출 × 14%) ÷ (F3인원 + F4인원)]
- ... (이하 동일 방식)
- **중요**: 해당 등급 인원이 0명이면 지급액도 0원

### 4. 자동화 처리 (BatchProcessor)
용역자 등록 시 자동으로 실행:
1. 전체 등급 재계산
2. 월별 매출 계산
3. 지급 스케줄 생성
4. 개인별 지급 계획 생성

## 🔧 주요 구현 사항

### 1. 데이터 모델

#### User 모델 (`src/lib/server/models/User.js`)
```javascript
{
  loginId: String,        // 한글 ID (unique)
  name: String,          // 이름
  parentId: String,      // 부모 loginId
  position: 'L' | 'R',   // 좌/우 위치
  leftChildId: String,   // 왼쪽 자식 loginId
  rightChildId: String,  // 오른쪽 자식 loginId
  grade: String,         // F1~F8
  sequence: Number       // 등록 순번
}
```

#### MonthlyRevenue 모델
```javascript
{
  year: Number,
  month: Number,
  totalRevenue: Number,
  newUsersCount: Number,
  gradeDistribution: Object,
  gradePayments: Object
}
```

#### UserPaymentPlan 모델
```javascript
{
  userId: ObjectId,
  sourceYear: Number,
  sourceMonth: Number,
  totalAmount: Number,
  installmentAmount: Number,
  installments: Array  // 10회 분할 정보
}
```

### 2. API 엔드포인트

#### 관리자 대시보드 (`/api/admin/dashboard`)
- 월별 매출 정보
- 등급별 인원 및 지급액
- 최근 가입자 목록
- 주간 지급 현황

#### 엑셀 일괄 등록 (`/api/admin/users/bulk`)
- 2단계 처리: 사용자 등록 → 관계 설정
- 자동 배치 처리 실행
- 한글 필드명 매핑

### 3. 서비스 계층

#### BatchProcessor (`src/lib/server/services/batchProcessor.js`)
- `processNewUsers()`: 신규 사용자 자동 처리
- `calculateMonthlyRevenue()`: 월별 매출 계산
- `calculateGradePayments()`: 등급별 지급액 계산
- `createUserPaymentPlans()`: 개인별 지급 계획 생성

#### TreeExtractor (`src/lib/server/services/treeExtractor.js`)
- 2진 트리 구조 추출
- 계층도 데이터 생성
- 트리 통계 분석

### 4. 유틸리티 스크립트

#### `scripts/reset-all-data.js`
모든 데이터 초기화:
- users, admins 컬렉션
- monthlyrevenues 컬렉션
- weeklypayments 컬렉션
- userpaymentplans 컬렉션

#### `scripts/fix-monthly-revenue.js`
월별 매출 재계산 스크립트

#### `scripts/check-tree-structure.js`
트리 구조 검증 및 시각화

## ⚠️ 주요 이슈 및 해결

### 1. 등급별 0명 처리 오류
**문제**: 등급에 인원이 0명일 때 0으로 나누기 오류 발생
**해결**: 모든 등급 계산에서 인원 수 체크 추가
```javascript
gradePayments.F1 = gradeCount.F1 > 0 && f1Divisor > 0 ?
  f1Total / f1Divisor : 0;
```

### 2. 월별 매출 표시 오류
**문제**: 관리자 대시보드에서 매출이 0원으로 표시
**원인**: MonthlyRevenue 모델 import 누락
**해결**: dashboard API에 import 추가

### 3. 엑셀 등록 순서 문제
**문제**: 엑셀 등록 시 순서가 뒤바뀜
**해결**:
- sequence 필드 추가
- 2단계 처리 방식 도입
- 엑셀 순서대로 등록 보장

### 4. 한글 ID 지원
**요구**: loginId를 영문이 아닌 한글로 사용
**구현**:
- loginId 타입을 String으로 변경
- 한글 유효성 검증 추가
- 엑셀 필드명 한글 매핑

## 📝 운영 가이드

### 초기 설정
```bash
# 1. 데이터베이스 초기화
node scripts/reset-all-data.js

# 2. 서버 시작
pnpm run dev

# 3. 관리자 계정 생성
pnpm run create:admin
# ID: 관리자, Password: 1234
```

### 용역자 등록
1. 엑셀 파일 준비 (이름, 판매인, 위치, 지사 컬럼)
2. 관리자 로그인 → 용역자 관리 → 엑셀 업로드
3. 자동으로 등급 계산 및 매출 생성

### 데이터 확인
- 관리자 대시보드에서 월별 매출 및 등급별 지급액 확인
- 용역자 관리에서 트리 구조 확인

## 🔄 향후 작업
1. 주간 지급 실행 기능 구현
2. 지급 내역 상세 조회 기능
3. 트리 구조 시각화 (D3.js)
4. 지급액 세금 계산 (3.3%)
5. 지급 확정 및 취소 기능

## 📌 중요 참고 문서
- `work_plan.txt`: 전체 시스템 요구사항
- `총매출_지급_방안.txt`: 지급액 계산 방식 상세
- `CLAUDE.md`: 개발 가이드라인

## ⚡ 주의사항
1. **패키지 매니저**: 반드시 pnpm 사용 (npm X)
2. **ID 형식**: loginId는 한글 사용
3. **컬렉션 분리**: Admin과 User는 별도 컬렉션
4. **자동 처리**: 용역자 등록 시 모든 계산 자동 실행
5. **0명 처리**: 등급 인원이 0명일 때 지급액 0원 처리

---

작성자: Claude Code
작성일: 2025년 9월 20일